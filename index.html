<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Gestia - Sistema POS</title>
  <link rel="icon" href="./icono.ico" type="image/x-icon" />
  <link rel="shortcut icon" href="./icono.ico" type="image/x-icon" />
  <!-- @ts-nocheck -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/heroicons/2.0.18/24/solid/css/heroicons.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="./styles/responsive.css" />

  <!-- Firebase SDKs (opcional) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, getDocs, getDoc, query, where, enableIndexedDbPersistence } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getAuth, setPersistence, browserLocalPersistence, signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, EmailAuthProvider, linkWithCredential, sendEmailVerification, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

  (async () => {
  // Support overriding config via window.FIREBASE_CONFIG, localStorage, or './firebase-config.json'
    const DEFAULT_CONFIG = {
      apiKey: "AIzaSyCPZtWKgkQORsYEP85V9mQD8tAk6gjLZwM",
      authDomain: "sr-sra-burger-tpv.firebaseapp.com",
      projectId: "sr-sra-burger-tpv",
      storageBucket: "sr-sra-burger-tpv.firebasestorage.app",
      messagingSenderId: "392520899249",
      appId: "1:392520899249:web:d5f1dd02ab1c77bb042090"
    };
    async function loadFirebaseConfig(){
      // 1) Inline global (window)
      if(window.FIREBASE_CONFIG) return window.FIREBASE_CONFIG;
      // 2) LocalStorage override
      try{ const ls = localStorage.getItem('FIREBASE_CONFIG'); if(ls){ const obj = JSON.parse(ls); if(obj?.apiKey) return obj; } }catch(_){ }
      // 3) Localhost-only dynamic import of firebase-config.js (kept out of production to avoid MIME issues)
      try{
        const host = location.hostname || '';
        const isLocal = /^(localhost|127\.0\.0\.1)$/.test(host);
        const isLAN = /^192\.168\./.test(host) || /^10\./.test(host) || /^172\.(1[6-9]|2\d|3[0-1])\./.test(host) || host === '0.0.0.0';
        if(isLocal || isLAN){
          const mod = await import('./firebase-config.js');
          const cfg = (mod && (mod.default || mod.firebaseConfig)) || null;
          if(cfg?.apiKey) return cfg;
        }
      }catch(_){ /* ignore if not present */ }
      // 4) JSON config file (works in static hosts like Vercel)
      try{
        const r = await fetch('./firebase-config.json', { cache:'no-store' });
        if(r.ok){
          // Some hosts rewrite unknown paths to index.html (HTML 200). Guard against that.
          const ct = (r.headers.get('content-type') || '').toLowerCase();
          const text = await r.text();
          const trimmed = (text || '').trimStart();
          const looksLikeJson = trimmed.startsWith('{') || trimmed.startsWith('[');
          const isJsonCt = ct.includes('application/json') || ct.includes('+json');
          if(looksLikeJson || isJsonCt){
            try{
              const json = JSON.parse(text);
              if(json?.apiKey) return json;
              console.warn('[Firebase] firebase-config.json carg√≥ pero no tiene apiKey. Ignorando.', json);
            }catch(e){
              console.warn('[Firebase] firebase-config.json no es JSON v√°lido. Ignorando.', e?.message || e);
            }
          } else {
            console.warn('[Firebase] ./firebase-config.json no devolvi√≥ JSON (posible rewrite a index.html). Ignorando. Content-Type:', ct);
          }
        }
      }catch(e){ console.warn('[Firebase] No se pudo leer ./firebase-config.json. Ignorando.', e?.message || e); }
      // 5) Fallback default (demo)
      console.warn('[Firebase] Usando DEFAULT_CONFIG (demo). Para producci√≥n, publica firebase-config.json en la ra√≠z del sitio.');
      return DEFAULT_CONFIG;
    }
    const firebaseConfig = await loadFirebaseConfig();

    const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  // Habilitar persistencia offline (mejor experiencia en m√≥vil). Ignorar si el navegador no lo permite.
  try{ enableIndexedDbPersistence(db).catch(()=>{}); }catch(_){ }
  const auth = getAuth(app);
  // Persist session locally (works well on iPad Safari if not in modo privado)
  try{ await setPersistence(auth, browserLocalPersistence); }catch(_){ }

    window.db = db;
    window.auth = auth;
  // Expose config for diagnostics
  window.firebaseConfig = firebaseConfig;
  window.firebaseModules = { setPersistence, browserLocalPersistence, signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, EmailAuthProvider, linkWithCredential, sendEmailVerification, sendPasswordResetEmail };
  window.fs = { collection, doc, setDoc, deleteDoc, onSnapshot, getDocs, getDoc, query, where };
  console.log('üî• Firebase inicializado', { projectId: firebaseConfig?.projectId, authDomain: firebaseConfig?.authDomain });
  // Helpful LAN hint
  try{
    const hint = document.createElement('div');
    hint.style.cssText = 'position:fixed;right:10px;bottom:10px;background:#00000080;color:#fff;padding:6px 10px;border-radius:8px;font-size:11px;z-index:9999';
    hint.textContent = `Origen: ${location.origin}`;
    document.body.appendChild(hint);
    setTimeout(()=>{ hint.remove(); }, 6000);
  }catch(_){ }
  })(); // Fin de async init
  </script>

  <style>
  /* Brand base Gestia */
  body{ font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; color:var(--burger-dark); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale }
    :root {
      /* Reutilizamos los mismos tokens pero con la paleta Gestia */
      --burger-bun:#E5E7EB; /* bordes suaves gris claro */
      --burger-meat:#1D4ED8; /* azul intenso para gradientes laterales */
      --burger-cheese:#2563EB; /* azul primario Gestia */
      --burger-lettuce:#10B981; /* verde √©xito Gestia */
      --burger-tomato:#0EA5E9; /* acento adicional fr√≠o */
      --burger-cream:#F8FAFC; /* fondo neutro principal */
      --burger-dark:#1E293B; /* texto principal gris pizarra */
      --burger-light:#F1F5F9; /* superficies suaves */
      --burger-accent:#2563EB; /* acento de marca (botones, links) */
      --ring: 0 0 0 3px rgba(37,99,235,.35);
      --shadow-1:0 8px 20px rgba(15,23,42,.06);
      --shadow-2:0 20px 45px rgba(15,23,42,.14);

      /* App surfaces (light) */
      --app-bg:#F8FAFC;
      --app-surface:#FFFFFF;
      --app-surface-2:#F9FAFB;
      --app-border:#E2E8F0;
      --app-text: var(--burger-dark);
      --app-muted:#64748B;

      /* Readability helpers */
      --grid-line: color-mix(in srgb, var(--app-border) 65%, transparent);
      /* Excel-like strong grid (dark in light mode, light in dark mode) */
      --grid-strong: color-mix(in srgb, var(--app-text) 86%, transparent);
    }

    /* Dark mode (global) */
    html[data-theme="dark"]{
      color-scheme: dark;
      --burger-bun:#334155;
      --burger-cream:#0B1220;
      --burger-light:#111827;
      --burger-dark:#E5E7EB;

      --app-bg:#0B1220;
      --app-surface:#0F172A;
      --app-surface-2:#111827;
      --app-border:#334155;
      --app-text:#E5E7EB;
      --app-muted:#94A3B8;

      --grid-line: color-mix(in srgb, var(--app-border) 55%, transparent);
      --grid-strong: color-mix(in srgb, var(--app-text) 78%, transparent);
    }

    body{ background: var(--app-bg) !important; color: var(--app-text); }

    html[data-theme="dark"] .panel,
    html[data-theme="dark"] .stat-card,
    html[data-theme="dark"] .product-card,
    html[data-theme="dark"] .client-card,
    html[data-theme="dark"] .insumos-panel,
    html[data-theme="dark"] .insumos-shell,
    html[data-theme="dark"] .kitchen-card{
      background: var(--app-surface) !important;
      border-color: var(--grid-strong) !important;
      color: var(--app-text) !important;
    }
    html[data-theme="dark"] .panel:hover,
    html[data-theme="dark"] .product-card:hover,
    html[data-theme="dark"] .client-card:hover{
      background: var(--app-surface-2) !important;
      border-color: #475569 !important;
    }

    html[data-theme="dark"] .table-nice,
    html[data-theme="dark"] .ingredientes-table,
    html[data-theme="dark"] .insumos-table{
      background: var(--app-surface) !important;
      border-color: var(--grid-strong) !important;
      color: var(--app-text) !important;
    }
    html[data-theme="dark"] .table-nice thead th,
    html[data-theme="dark"] .ingredientes-table thead th,
    html[data-theme="dark"] .insumos-table thead th{
      background: var(--app-surface-2) !important;
      border-bottom-color: var(--grid-strong) !important;
      color: var(--app-text) !important;
    }
    html[data-theme="dark"] .table-nice th,
    html[data-theme="dark"] .table-nice td,
    html[data-theme="dark"] .ingredientes-table th,
    html[data-theme="dark"] .ingredientes-table td,
    html[data-theme="dark"] .insumos-table th,
    html[data-theme="dark"] .insumos-table td{
      border-bottom-color: var(--grid-strong) !important;
      border-right-color: var(--grid-strong) !important;
    }
    html[data-theme="dark"] .table-nice td+td,
    html[data-theme="dark"] .table-nice th+th{
      border-left-color: var(--grid-strong) !important;
    }
    html[data-theme="dark"] .table-nice tbody tr:nth-child(even){ background: rgba(255,255,255,.03) !important; }
    html[data-theme="dark"] .table-nice tbody tr:hover{ background: rgba(96,165,250,.10) !important; }

    html[data-theme="dark"] .input-modern{
      background: rgba(15,23,42,.75) !important;
      border-color: var(--app-border) !important;
      color: var(--app-text) !important;
    }
    html[data-theme="dark"] .input-modern::placeholder{ color: rgba(148,163,184,.95) !important; }

    html[data-theme="dark"] .btn-outline{
      background: rgba(15,23,42,.75) !important;
      color: var(--app-text) !important;
      border-color: var(--grid-strong) !important;
    }

    html[data-theme="dark"] .modal-header-nice{
      background: var(--app-surface-2) !important;
      border-bottom-color: var(--grid-strong) !important;
      color: var(--app-text) !important;
    }

    /* Tailwind utility overrides used across the UI */
    html[data-theme="dark"] .bg-white{ background-color: var(--app-surface) !important; }
    html[data-theme="dark"] .bg-slate-50,
    html[data-theme="dark"] .bg-gray-50{ background-color: var(--app-surface-2) !important; }
    html[data-theme="dark"] .border-slate-200,
    html[data-theme="dark"] .border-slate-300,
    html[data-theme="dark"] .border-gray-200,
    html[data-theme="dark"] .border-gray-300{ border-color: var(--app-border) !important; }

    html[data-theme="dark"] .text-slate-900,
    html[data-theme="dark"] .text-slate-800,
    html[data-theme="dark"] .text-slate-700{ color: var(--app-text) !important; }
    html[data-theme="dark"] .text-slate-600,
    html[data-theme="dark"] .text-slate-500{ color: var(--app-muted) !important; }
    html[data-theme="dark"] .text-slate-400{ color: rgba(148,163,184,.95) !important; }
    /* Views: consistent frame + subtle grid background for readability */
    .view{display:none; position:relative; border-radius:16px; padding:14px; border:2px solid var(--grid-strong); background:var(--app-surface); overflow:hidden}
    .view.active{display:block}
    .view::before{content:''; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
      background-image:
        linear-gradient(to right, var(--grid-line) 1px, transparent 1px),
        linear-gradient(to bottom, var(--grid-line) 1px, transparent 1px);
      background-size: 24px 24px;
      opacity:.55;
    }
    .view > *{ position:relative; }
  .nav-link{display:block;padding:.75rem 1rem;border-radius:.5rem;transition:background .15s ease, transform .05s ease} .nav-link:hover{background:rgba(255,255,255,.08);transform:translateX(2px)} .nav-link.active{color:#fff;background:linear-gradient(135deg,var(--burger-accent),var(--burger-tomato))}
    .loader{width:56px;height:56px;border:6px solid var(--burger-light);border-top-color:var(--burger-accent);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  .btn-gradient{background:linear-gradient(135deg,var(--burger-cheese),var(--burger-bun));color:var(--burger-dark);font-weight:800; border:2px solid var(--burger-bun); transition:filter .15s ease, transform .06s ease} .btn-gradient:hover{filter:brightness(1.02);} .btn-gradient:active{transform:translateY(1px)}
  .btn-success{background:linear-gradient(135deg,#16a34a,#22c55e);color:#fff;font-weight:800;border:2px solid #16a34a; transition:filter .15s ease, transform .06s ease} .btn-success:hover{filter:brightness(1.03);} .btn-success:active{transform:translateY(1px)}
  .btn-danger{background:linear-gradient(135deg,#ef4444,#b91c1c);color:#fff;font-weight:800;border:2px solid #b91c1c; transition:filter .15s ease, transform .06s ease} .btn-danger:hover{filter:brightness(1.03);} .btn-danger:active{transform:translateY(1px)}
  .btn-outline{background:var(--app-surface);border:2px solid var(--grid-strong);color:var(--app-text);font-weight:800; transition:background .15s ease, border-color .15s ease, color .15s ease, transform .06s ease} .btn-outline:hover{background:var(--app-surface-2);border-color:var(--burger-accent);} .btn-outline:active{transform:translateY(1px)}
  
  /* Estaci√≥n buttons: letra dentro de cuadrado */
  .estacion-btn{background:var(--app-surface-2);border:2px solid var(--grid-strong);color:var(--app-text);font-size:.85rem;font-weight:700;width:28px;height:28px;border-radius:8px;cursor:pointer;transition:all .15s ease;display:inline-flex;align-items:center;justify-content:center;box-sizing:border-box;padding:0}
  .estacion-btn:hover{background:var(--app-surface);border-color:var(--burger-accent)}
  .estacion-btn.active{background:linear-gradient(135deg,var(--burger-accent),var(--burger-tomato));border-color:var(--burger-accent);color:#fff;transform:scale(1.03)}
  
  /* Focus styles for accessibility (sin sombras, solo contorno) */
  .nav-link:focus-visible, button:focus-visible, .btn-outline:focus-visible, .btn-success:focus-visible, .btn-danger:focus-visible, .btn-gradient:focus-visible {
    outline:2px solid rgba(37,99,235,.7);
    outline-offset:2px;
  }
    .input-modern{background:#fff;border:2px solid var(--burger-bun);color:var(--burger-dark); transition: border-color .15s ease }
    .input-modern:focus{ outline:none; border-color: var(--burger-accent); }
    .sidebar{position:relative}
    .sidebar.collapsed{ display:none !important; }
    @media(max-width:1024px){
      .sidebar{position:fixed;left:-280px;top:0;bottom:0;width:280px;z-index:60;transition:left .3s;display:none}
      .sidebar.open{left:0;display:block}
    }

  /* Sections */
  .section-title{ display:flex; align-items:center; gap:.5rem; letter-spacing:.2px; padding-bottom:.55rem; margin-bottom:.9rem; border-bottom:1px solid var(--grid-strong); }
  .section-title::after{ content:''; flex:1; height:4px; border-radius:999px; margin-left:.5rem; background:linear-gradient(90deg, rgba(255,107,53,.25), rgba(212,165,116,.15)); }

  /* Global separators for readability */
  hr{ border:0; border-top:1px solid var(--grid-strong); margin: .85rem 0; opacity:1; }
  .stat-card > :first-child{ padding-bottom:.45rem; margin-bottom:.55rem; border-bottom:1px solid var(--grid-strong); }
  /* Panel: divider between major blocks (not between individual inputs) */
  .panel > :where(div, section, article, header, footer, table, canvas, ul, ol, p, form) + :where(div, section, article, header, footer, table, canvas, ul, ol, p, form){
    margin-top: .85rem;
    padding-top: .85rem;
    border-top: 1px solid var(--grid-strong);
  }
  /* If panel starts with a toolbar/header row */
  .panel > .flex:first-child,
  .panel > .recipe-title-bar:first-child{ padding-bottom:.75rem; border-bottom:1px solid var(--grid-strong); }
  /* Cards/Panels - estilo bento minimal */
  .panel{
    background:var(--app-surface);
    border:2px solid var(--grid-strong);
    border-radius:14px;
    padding:16px;
    box-shadow:none;
    transition:border-color .15s ease, background-color .15s ease;
  }
  .panel:hover{
    background:var(--app-surface-2);
    border-color:var(--burger-accent);
  }
  .product-card{
    background:var(--app-surface);
    border:2px solid var(--grid-strong);
    border-radius:14px;
    box-shadow:none;
    transition:border-color .15s ease, background-color .15s ease, transform .06s ease;
  }
  .product-card:hover{
    border-color:var(--burger-accent);
    background:var(--app-surface-2);
    transform:translateY(-1px);
  }

    /* Recipe list: compact, responsive */
    .recipe-title-bar{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; }
    .recipe-list{ max-height:60vh; overflow-y:auto; padding-right:.25rem; }
    .recipe-row{ display:grid; grid-template-columns: 1fr 88px 36px; gap:.5rem; align-items:center; font-size:.9rem; }
    .select-compact{ padding:.5rem .5rem; font-size:.9rem; }
    .input-compact{ padding:.5rem .5rem; font-size:.9rem; }
    .btn-compact{ padding:.375rem .5rem; font-size:.85rem; }
    @media (max-width: 480px){
      .recipe-row{ grid-template-columns: 1fr 72px 32px; font-size:.85rem; gap:.4rem; }
      .select-compact, .input-compact{ padding:.4rem .45rem; font-size:.85rem; }
      .btn-compact{ padding:.3rem .45rem; font-size:.8rem; }
    }
  /* POS: Modal de personalizaci√≥n bonito */
  .opt-grid{ display:grid; grid-template-columns: 1fr; gap:.75rem; }
  @media(min-width:520px){ .opt-grid{ grid-template-columns: 1fr 1fr; } }
  .opt-card{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; padding:.75rem .9rem; border:2px solid var(--grid-strong); background:var(--app-surface); border-radius:12px; cursor:pointer; transition:border-color .15s ease, background-color .15s ease; }
  .opt-card:hover{ border-color:var(--burger-accent); background:var(--app-surface-2); }
  .opt-card.selected{ background:#ECFDF5; border-color:#10B981; }
  .opt-info{ display:flex; align-items:center; gap:.6rem; font-weight:700; color:var(--burger-dark); }
  .opt-check{ width:22px; height:22px; border:1px solid #CBD5E1; border-radius:6px; display:inline-flex; align-items:center; justify-content:center; background:#fff; }
  .opt-card.selected .opt-check{ border-color:#10B981; background:#10B981; color:#fff; }
  .price-chip{ font-size:.85rem; font-weight:800; color:#065F46; background:#D1FAE5; padding:.2rem .5rem; border-radius:999px; border:1px solid #6EE7B7; }
  .modal-header-nice{ background:var(--app-surface-2); color:var(--app-text); padding:1rem 1.25rem; border-bottom:2px solid var(--grid-strong); }
  .summary-row{ display:flex; justify-content:space-between; align-items:center; padding:.25rem 0; }

  /* Clientes: UI bento minimal */
  .client-card{
    background:var(--app-surface);
    border:2px solid var(--grid-strong);
    border-radius:14px;
    padding:16px 18px;
    box-shadow:none;
    transition:border-color .15s ease, background-color .15s ease;
    font-size:.95rem;
    line-height:1.5;
  }
  .client-card:hover{
    background:var(--app-surface-2);
    border-color:var(--burger-accent);
  }
  .pill{ display:inline-flex; align-items:center; gap:.35rem; padding:.25rem .7rem; border-radius:999px; font-size:.8rem; font-weight:800; border:1px solid #0F172A; }
  .pill-points{ background:#FEF3C7; color:#92400E; border-color:#FBBF24; }
  .pill-spend{ background:#D1FAE5; color:#065F46; border-color:#6EE7B7; }
  .icon-btn{ width:32px; height:32px; display:inline-flex; align-items:center; justify-content:center; border-radius:10px; border:1px solid var(--burger-bun); background:#fff; }
  .icon-btn:hover{ background:#fff7ed; border-color:var(--burger-accent); }
  .client-toolbar input, .client-toolbar select{ border:2px solid var(--burger-bun); }

  /* Insumos: estilos visuales */
  .insumo-badge{ font-size:.7rem; font-weight:800; padding:.15rem .4rem; border-radius:999px; border:1px solid; }
  .insumo-badge-venta{ background:#EFF6FF; color:#075985; border-color:#7DD3FC; }
  .insumo-badge-merma{ background:#FEE2E2; color:#991B1B; border-color:#FECACA; }
  .stat-card{ background:var(--app-surface); border:2px solid var(--grid-strong); border-radius:14px; padding:14px; box-shadow:none; }
  .table-nice{
    width:100%;
    border-collapse:collapse;
    border-spacing:0;
    overflow:hidden;
    border-radius:12px;
    border:2px solid var(--grid-strong);
    background:var(--app-surface);
  }
  .table-nice thead th{
    background:var(--app-surface-2);
    border-bottom:2px solid var(--grid-strong);
    position:sticky;
    top:0;
    z-index:1;
  }
  .table-nice tbody tr{ transition: background .12s ease }
  .table-nice tbody tr:nth-child(even){ background:var(--app-surface-2) }
  .table-nice tbody tr:hover{ background: rgba(37,99,235,.07) }
  .table-nice th, .table-nice td{ border-bottom:1px solid var(--grid-strong); padding:.55rem .6rem; }
  .table-nice td+td, .table-nice th+th{ border-left:1px solid var(--grid-strong); }
  /* Sticky first column for wide tables */
  .table-nice .sticky-col{ position:sticky; left:0; z-index:2; background:var(--app-surface); }
  /* Monospaced, tabular numbers for mejor alineaci√≥n */
  .num{ font-variant-numeric: tabular-nums lining-nums; font-feature-settings: "tnum" 1, "lnum" 1; }
  /* Aplica monoespaciado autom√°ticamente a columnas num√©ricas en tablas */
  .table-nice td.text-right,
  .table-nice th.text-right,
  .table-nice td.text-end,
  .table-nice th.text-end{
    font-variant-numeric: tabular-nums lining-nums;
    font-feature-settings: "tnum" 1, "lnum" 1;
  }

  /* Sidebar auth status should only show on Inicio */
  body[data-view]:not([data-view="inicio"]) #auth-status-card{ display:none !important; }

  /* Floating theme button */
  #btn-theme-fab{ position:fixed; right:16px; bottom:16px; z-index:75; width:56px; height:56px; border-radius:999px; display:flex; align-items:center; justify-content:center; color:#fff; box-shadow: 0 10px 22px rgba(15,23,42,.25); }
  #btn-theme-fab:active{ transform: translateY(1px); }
  /* Availability chips */
  .inv-chip{ display:inline-block; min-width:56px; text-align:right; font-weight:800; padding:.18rem .4rem; border-radius:999px; border:1px solid; }
  .inv-ok{ color:#065F46; background:#ECFDF5; border-color:#A7F3D0; }
  .inv-warn{ color:#92400E; background:#FFFBEB; border-color:#FCD34D; }
  .inv-bad{ color:#991B1B; background:#FEE2E2; border-color:#FECACA; }

  /* Scrollbar */
  ::-webkit-scrollbar{ width:10px; height:10px }
  ::-webkit-scrollbar-thumb{ background:linear-gradient(180deg,var(--burger-bun),#eab676); border-radius:999px; border:2px solid #fff }
  ::-webkit-scrollbar-track{ background:#fff3; }
  .kpi-trend{ font-size:.7rem; font-weight:800; padding:.1rem .4rem; border-radius:999px; border:1px solid #ddd; }
  .kpi-up{ background:#ECFDF5; color:#065F46; border-color:#A7F3D0 }
  .kpi-down{ background:#FEE2E2; color:#991B1B; border-color:#FECACA }
  .empty-state{ color: var(--app-muted); font-size: .9rem }
  h2.section-title + .text-sm{ color: var(--app-muted) }

  /* POS grid and cards (desktop and tablet, estilo bento minimal) */
  #pos-product-list { gap: .75rem; }
    // Auth (por correo). Importante: no usamos sesi√≥n an√≥nima autom√°tica.
    aspect-ratio: 3/2;
    min-height: 100px;
    padding:.65rem;
    border:1px solid var(--app-border);
    border-radius:12px;
    background:#FFFFFF;
    overflow:hidden;
    display:flex; flex-direction:column; justify-content:space-between;
    cursor:pointer; transition: border-color .15s ease, background-color .15s ease, transform .06s ease;
  }
  #pos-product-list .product-card:hover{
    border-color:var(--burger-accent);
        const { onAuthStateChanged } = window.firebaseModules;
    transform:translateY(-1px);
  }
  #pos-product-list .product-card:active{
    transform:translateY(0);
    background: rgba(37,99,235,.07);
  }
  #pos-product-list .product-card .prod-name{
          const nextUid = (user && !user.isAnonymous) ? user.uid : null;
          const userChanged = nextUid !== __activeUid;

          // Siempre cortar listeners del usuario anterior antes de cambiar UI/estado
          if(userChanged){
            if(typeof unsubscribeProducts === 'function' && unsubscribeProducts){ try{ unsubscribeProducts(); }catch(_){ }
              unsubscribeProducts = null; }
            if(typeof unsubscribeIngredientes === 'function' && unsubscribeIngredientes){ try{ unsubscribeIngredientes(); }catch(_){ } unsubscribeIngredientes = null; }
            if(typeof unsubscribeClientes === 'function' && unsubscribeClientes){ try{ unsubscribeClientes(); }catch(_){ } unsubscribeClientes = null; }
            if(typeof unsubscribeVentas === 'function' && unsubscribeVentas){ try{ unsubscribeVentas(); }catch(_){ } unsubscribeVentas = null; }
            if(typeof unsubscribeCompras === 'function' && unsubscribeCompras){ try{ unsubscribeCompras(); }catch(_){ } unsubscribeCompras = null; }
            if(typeof unsubscribeInsumos === 'function' && unsubscribeInsumos){ try{ unsubscribeInsumos(); }catch(_){ } unsubscribeInsumos = null; }
            if(typeof unsubscribePedidos === 'function' && unsubscribePedidos){ try{ unsubscribePedidos(); }catch(_){ } unsubscribePedidos = null; }
            if(typeof unsubscribeMeta === 'function' && unsubscribeMeta){ try{ unsubscribeMeta(); }catch(_){ } unsubscribeMeta = null; }
            if(typeof unsubscribeEmpleados === 'function' && unsubscribeEmpleados){ try{ unsubscribeEmpleados(); }catch(_){ } unsubscribeEmpleados = null; }
            if(typeof unsubscribeServicios === 'function' && unsubscribeServicios){ try{ unsubscribeServicios(); }catch(_){ } unsubscribeServicios = null; }
            if(typeof unsubscribeUserExtras === 'function' && unsubscribeUserExtras){ try{ unsubscribeUserExtras(); }catch(_){ } unsubscribeUserExtras = null; }
          }

          // UI: si no hay usuario con correo, dejar todo en blanco
          if(!nextUid){
            __activeUid = null;
            el && (el.textContent = 'Sin sesi√≥n');
            badge && (badge.textContent = 'UID: ‚Äî');
            authControls && authControls.classList.remove('hidden');
            authStatus && authStatus.classList.add('hidden');
            if(emailOut) emailOut.textContent = '';
            if(uidOut) uidOut.textContent = '';
            // Estado en blanco (no persistimos nada cuando no hay sesi√≥n)
            try{ resetAppState({ persist:false }); }catch(_){ }
            return;
          }

          // Usuario con correo
          __activeUid = nextUid;
          el && (el.textContent = user.uid);
          badge && (badge.textContent = 'UID: '+user.uid.slice(0,8));
          authControls && authControls.classList.add('hidden');
          authStatus && authStatus.classList.remove('hidden');
          if(emailOut) emailOut.textContent = user.email || '(sin correo)';
          if(uidOut) uidOut.textContent = user.uid.slice(0,10)+'‚Ä¶';

          // Cargar cache local de ESTE usuario (si existe) y renderizar antes de Firestore
          if(userChanged){
            try{ resetAppState({ persist:false }); }catch(_){ }
            try{ loadLSForUid(nextUid); }catch(_){ }
            try{ sanitizeState(); }catch(_){ }
            try{ assignSaleNumbersIfMissing(); }catch(_){ }
            try{ recomputeInsumosFromVentas(); }catch(_){ }
            try{ renderAll(); renderPosProductList(); renderPedidosPendientes(); renderFinanzas(); }catch(_){ }
          }

          // Activar sincronizaci√≥n Firestore por usuario
          if(typeof startFirestoreAllSync==='function') startFirestoreAllSync(); else startFirestoreProductSync?.();
    display:inline-flex;align-items:center;gap:.3rem;
  }
  .prod-class-pill{
    display:inline-flex;align-items:center;gap:.3rem;
    padding:.18rem .55rem;border-radius:999px;
    font-size:.7rem;font-weight:800;
    background:linear-gradient(135deg,#fef3c7,#fde68a);
    color:#78350f;border:1px solid #facc15;
  }
  .prod-station-wrapper{display:flex;flex-wrap:wrap;gap:.25rem;}
  .productos-table-row:hover{background:rgba(255,247,237,.9) !important;}

  /* Estaciones: dise√±o visual */
  .estaciones-kpi-value { font-size:1.1rem; font-weight:800; }
  .estaciones-kpi-label { font-size:.7rem; letter-spacing:.08em; text-transform:uppercase; opacity:.7; }
  .estacion-key-pill{
    display:inline-flex;align-items:center;gap:.25rem;
    padding:.15rem .5rem;border-radius:999px;
    font-size:.7rem;font-weight:800;
    background:linear-gradient(135deg,#e5e7eb,#f3f4f6);
    color:#111827;border:1px solid #d1d5db;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }
  .estacion-chip-fixed{
    display:inline-flex;align-items:center;gap:.25rem;
    padding:.1rem .45rem;border-radius:999px;
    font-size:.65rem;font-weight:800;
    background:linear-gradient(135deg,#dcfce7,#bbf7d0);
    color:#065f46;border:1px solid #4ade80;
  }
  .estaciones-table-row:hover{background:rgba(239,246,255,.9) !important;}

  /* Ingredientes: tablas minimalistas estilo SaaS */
  .ingredientes-table{ border-collapse:collapse; border-spacing:0; border-radius:12px; overflow:hidden; border:1px solid #0F172A; background:#FFFFFF; }
  .ingredientes-table thead th{
    background:#F9FAFB;
    border-bottom:1px solid #0F172A;
  }
  .ingredientes-table th,
  .ingredientes-table td{
    border-bottom:1px solid #0F172A;
    border-right:1px solid #0F172A;
  }
  .ingredientes-table tr:last-child td{ border-bottom:none; }
  .ingredientes-table th:last-child,
  .ingredientes-table td:last-child{ border-right:none; }
  .ingredientes-table-row:nth-child(even){ background:#F9FAFB; }
  .ingredientes-table-row:hover{background:#EFF6FF !important;}
  .ingrediente-name-cell{ font-weight:600; }
  .ingrediente-unit-cell{ font-size:.8rem; opacity:.8; }

  /* Insumos gastados: paneles y tablas tipo dashboard */
  .insumos-panel{
    position:relative;
    background:#FFFFFF;
    border-radius:14px;
    border:1px solid #0F172A;
    box-shadow:none;
    padding:1rem 1rem 1.1rem;
  }
  .insumos-panel::before{
    content:none;
  }
  .insumos-panel-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:.65rem;
    gap:.75rem;
  }
  .insumos-panel-title{
    font-weight:800;
    letter-spacing:.02em;
    font-size:.98rem;
    color:var(--burger-dark);
    display:flex;
    align-items:center;
    gap:.4rem;
  }
  .insumos-panel-pill{
    font-size:.68rem;
    text-transform:uppercase;
    letter-spacing:.16em;
    padding:.15rem .55rem;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.55);
    background:rgba(248,250,252,.9);
    color:#4b5563;
    white-space:nowrap;
  }
  .insumos-panel-subtext{ font-size:.7rem; opacity:.7; }

  .insumos-shell{
    margin-top:.25rem;
    padding:1rem 1.25rem 1.35rem;
    border-radius:16px;
    border:1px solid #0F172A;
    background:#FFFFFF;
    box-shadow:none;
  }

  .insumos-tabs{ display:flex; flex-wrap:wrap; gap:.4rem; margin-bottom:.85rem; }
  .insumos-tab-btn{
    font-size:.78rem;
    padding:.4rem .75rem;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.55);
    background:rgba(248,250,252,.85);
    color:#4b5563;
    font-weight:600;
    letter-spacing:.02em;
    cursor:pointer;
    .input-modern { padding: .45rem .55rem; }
    #pos-product-list { gap: .75rem; }
  /* Mobile: 3-column square tiles for POS product grid */
  #pos-product-list{ grid-template-columns: repeat(3, minmax(0, 1fr)) !important; gap: .5rem; }
  #pos-product-list .product-card{ aspect-ratio: 1/1; min-height: 110px; padding:.6rem; border:2px solid var(--burger-bun); border-radius:.75rem; background:#fff; overflow:hidden; display:flex; flex-direction:column; justify-content:space-between; }
  #pos-product-list .product-card .prod-desc{ display:none; }
  #pos-product-list .product-card .prod-name{ font-size:.9rem; line-height:1.1rem; font-weight:800; display:-webkit-box; -webkit-line-clamp:2; line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  #pos-product-list .product-card .btn-add-to-order{ padding:.35rem .5rem; font-size:.75rem; }
  #pos-product-list .product-card .text-lg{ font-size: .95rem; }
    .loader { width: 44px; height: 44px; border-width: 5px; }
  }
  </style>
  <link rel="stylesheet" href="./styles/saas2026.css" />
</head>
<body class="font-sans min-h-screen" style="background:#F8FAFC;">
  <!-- Loading -->
  <div id="loading-overlay" class="fixed inset-0 z-[100] flex flex-col justify-center items-center" style="background:linear-gradient(135deg,var(--burger-cream),var(--burger-light))">
    <div class="loader"></div>
    <p class="mt-4 font-bold" style="color:var(--burger-dark)">Cargando TPV...</p>
  </div>

  <div class="flex h-screen">
  <!-- Backdrop for mobile sidebar -->
  <div id="sidebar-backdrop" class="hidden fixed inset-0 z-50 bg-black/40 lg:hidden"></div>
    <!-- Bot√≥n flotante men√∫ m√≥vil -->
    <button id="mobile-menu-btn" aria-label="Abrir men√∫" class="fixed bottom-4 left-4 z-[70] rounded-full shadow-lg"
      style="background:linear-gradient(135deg,var(--burger-accent),var(--burger-tomato)); color:#fff; width:56px; height:56px; display:flex; align-items:center; justify-content:center; border:3px solid rgba(255,255,255,.6);">
      <span style="font-size:22px; line-height:1">‚ò∞</span>
    </button>

    <!-- Bot√≥n flotante modo claro/oscuro -->
    <button id="btn-theme-fab" aria-label="Cambiar tema" title="Cambiar a modo oscuro"
      style="background:linear-gradient(135deg,var(--burger-accent),var(--burger-tomato)); border:3px solid rgba(255,255,255,.6);">
      <span id="btn-theme-fab-icon" style="font-size:22px; line-height:1">üåô</span>
    </button>

    <!-- Sidebar -->
  <aside class="sidebar w-72 text-white flex flex-col flex-shrink-0 lg:block" style="background:linear-gradient(180deg,#1D4ED8 0%,#0F172A 100%);border-right:1px solid rgba(148,163,184,.35)">
      <div class="p-6 border-b border-white/10">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-2xl flex items-center justify-center text-white font-black text-xl shadow-lg" style="background:linear-gradient(135deg,#2563EB,#1D4ED8);">
            G
          </div>
          <div>
            <div class="text-[10px] uppercase tracking-[0.22em] text-white/60">Gestia POS</div>
            <h1 class="text-xl font-extrabold tracking-tight">Gestia</h1>
            <div class="text-[10px] uppercase tracking-[0.18em] text-white/70">GESTIA CONTROL EN LA PALMA DE TU MANO</div>
          </div>
        </div>
      </div>
      <nav class="flex-1 p-4 space-y-2">
  <a href="#inicio" class="nav-link active">üèÅ Inicio</a>
  <a href="#dashboard" class="nav-link">üìä Dashboard</a>
  <a href="#reportes" class="nav-link">üìà Reportes</a>
  <a href="#caja" class="nav-link">üíµ Caja</a>
  <a href="#finanzas" class="nav-link">üí∞ Finanzas</a>
        <a href="#vender" class="nav-link">üõí Punto de Venta</a>
        <a href="#pedidos-pendientes" class="nav-link">üë®‚Äçüç≥ Pedidos</a>
          <a href="#ventas" class="nav-link">üßæ Ventas</a>
          <a href="#productos" class="nav-link">üçî Productos</a>
          <a href="#estaciones" class="nav-link">üî• Estaciones</a>
        <a href="#ingredientes" class="nav-link">ü•¨ Ingredientes</a>
  <a href="#insumos" class="nav-link">üì¶ Insumos Gastados</a>
  <a href="#inventario" class="nav-link">üóÉÔ∏è Inventario</a>
  <a href="#recomendaciones" class="nav-link">üõí Recomendaci√≥n de Compras</a>
  <a href="#clientes" class="nav-link">üë• Clientes</a>
      </nav>
      <div class="p-4 border-t border-white/10 text-xs opacity-80">&nbsp;</div>
    </aside>

    <!-- Main -->
  <main class="flex-1 p-3 overflow-y-auto mx-auto max-w-[1200px] w-full">
      <!-- Inicio -->
        <section id="view-inicio" class="view active">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-6 items-stretch">
    <!-- Lado izquierdo: logo + mensaje principal -->
    <div class="panel flex flex-col justify-center gap-6">
    <div class="mb-1">
      <div class="rounded-2xl border border-slate-200 bg-white overflow-hidden">
        <img src="gestia.jpg.png" alt="Gestia" class="w-full h-auto object-contain" loading="lazy" />
      </div>
    </div>
    <p class="text-xs md:text-sm font-semibold uppercase tracking-[0.34em] text-slate-500">Plataforma de punto de venta</p>
    <h2 class="hero-title text-5xl md:text-6xl lg:text-7xl xl:text-8xl font-extrabold leading-[1.02]" style="color:var(--burger-dark)">
      Gestia te ayuda a
      <span class="block mt-1 bg-yellow-200/80 px-1 rounded-sm inline-block">controlar ventas e inventario<br class="hidden md:block" />con total claridad</span>
    </h2>
    <p class="text-lg md:text-xl text-slate-600 max-w-2xl leading-relaxed">
      Centraliza tickets, productos, ingredientes, compras y clientes en un solo tablero
      minimalista. Dise√±ado para negocios que quieren n√∫meros claros, no complicaciones.
    </p>
    <div class="flex flex-wrap items-center gap-3">
      <button id="btn-hero-login" class="px-8 py-4 rounded-full text-base md:text-lg font-semibold text-white shadow-sm" style="background:linear-gradient(135deg,var(--burger-accent),var(--burger-tomato))">Iniciar sesi√≥n</button>
      <button id="btn-hero-signup" class="px-8 py-4 rounded-full text-base md:text-lg font-semibold border border-slate-300 text-slate-800 bg-white">Crear cuenta</button>
      <button id="btn-hero-guide" class="px-6 py-3.5 rounded-full text-sm md:text-base font-semibold border border-slate-300 text-slate-700 bg-slate-50 hover:bg-slate-100 flex items-center gap-1">
        <span>üìò</span><span>Ver gu√≠a r√°pida</span>
      </button>
      <span class="text-sm md:text-base text-slate-500">Sin l√≠mites de usuarios. Tus datos se quedan contigo.</span>
    </div>
    </div>

    <!-- Lado derecho: mini resumen visual -->
    <div class="panel bg-slate-50 flex flex-col justify-between">
    <div class="mb-3">
      <p class="text-xs md:text-sm font-semibold tracking-[0.24em] text-slate-500 mb-1">QUE CONTROLA GESTIA</p>
      <p class="text-base md:text-lg text-slate-600">Una vista r√°pida de los m√≥dulos que tendr√°s siempre a la mano.</p>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
      <div class="stat-card">
      <div class="text-[11px] uppercase opacity-70">Ventas</div>
      <div class="text-xl md:text-2xl font-extrabold">Tickets y cortes</div>
      <div class="text-sm md:text-base text-slate-600 leading-snug">Registra cada venta y genera res√∫menes claros.</div>
      </div>
      <div class="stat-card">
      <div class="text-[11px] uppercase opacity-70">Inventario</div>
      <div class="text-xl md:text-2xl font-extrabold">Stock preciso</div>
      <div class="text-sm md:text-base text-slate-600 leading-snug">Insumos, recetas y compras conectadas a tu venta.</div>
      </div>
      <div class="stat-card">
      <div class="text-[11px] uppercase opacity-70">Clientes</div>
      <div class="text-xl md:text-2xl font-extrabold">Historial completo</div>
      <div class="text-sm md:text-base text-slate-600 leading-snug">Seguimiento de consumo y lealtad sin esfuerzo.</div>
      </div>
      <div class="stat-card">
      <div class="text-[11px] uppercase opacity-70">Modo offline</div>
      <div class="text-xl md:text-2xl font-extrabold">Siempre operando</div>
      <div class="text-sm md:text-base text-slate-600 leading-snug">Trabaja sin conexi√≥n; Gestia sincroniza cuando vuelves a estar en l√≠nea.</div>
      </div>
    </div>
    <p class="text-sm md:text-base text-slate-500 border-t border-slate-200 pt-4 mt-auto leading-snug">Conecta tu cuenta una vez, abre el POS y deja que Gestia mantenga tus n√∫meros en orden.</p>
    </div>
  </div>

  <div class="panel mt-6">
    <div class="flex items-center justify-between gap-3">
      <div>
        <div class="text-xs font-semibold uppercase tracking-[0.22em] text-slate-500">Respaldo y sesi√≥n</div>
        <div class="text-sm text-slate-600">Acceso, sincronizaci√≥n y copias de seguridad</div>
      </div>
      <div class="text-right">
        <div class="text-xs text-slate-500">ID Sesi√≥n</div>
        <div id="user-id-display" class="text-[11px] text-slate-700 break-all"></div>
      </div>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">
      <div class="panel bg-slate-50">
        <div class="font-extrabold mb-2" style="color:var(--burger-dark)">Respaldo</div>
        <div class="grid grid-cols-1 gap-2">
          <button id="btn-backup" class="btn-soft w-full px-3 py-2 rounded text-sm">üì§ Respaldar datos</button>
          <button id="btn-restore" class="btn-soft w-full px-3 py-2 rounded text-sm">üì• Restaurar</button>
          <input id="restore-file-input" type="file" accept="application/json" class="hidden" />
        </div>
      </div>
      <div class="panel bg-slate-50">
        <div class="font-extrabold mb-2" style="color:var(--burger-dark)">Proyecto Firebase</div>
        <div id="firebase-project-indicator" class="text-xs text-slate-600 break-all">‚Äî</div>
        <div class="text-xs text-slate-500 mt-2">Si est√° vac√≠o, revisa tu configuraci√≥n.</div>
      </div>
      <div class="panel bg-slate-50">
        <div class="flex items-center justify-between mb-2">
          <div class="font-extrabold" style="color:var(--burger-dark)">Sesi√≥n</div>
          <button id="btn-auth-toggle" class="btn-soft px-3 py-2 rounded text-sm flex items-center justify-between gap-2">
            <span>Gestionar</span>
            <span id="auth-toggle-icon" class="text-xs opacity-80">‚ñº</span>
          </button>
        </div>
        <div id="auth-controls" class="hidden">
          <input id="auth-email" type="email" placeholder="Email" class="w-full input-modern p-2 rounded" />
          <input id="auth-pass" type="password" placeholder="Contrase√±a" class="w-full mt-2 input-modern p-2 rounded" />
          <div class="grid grid-cols-2 gap-2 mt-2">
            <button id="btn-login" class="btn-soft px-2 py-2 rounded text-sm">Iniciar</button>
            <button id="btn-signup" class="btn-soft px-2 py-2 rounded text-sm">Crear cuenta</button>
          </div>
          <button id="btn-reset-pass" class="btn-soft w-full mt-2 px-3 py-2 rounded text-sm">¬øOlvidaste tu contrase√±a?</button>
          <div class="text-xs text-slate-500 mt-1">Te enviaremos un enlace de recuperaci√≥n a tu email.</div>
        </div>
        <div id="auth-status-card" class="hidden mt-3 rounded-xl border-2 p-3" style="border-color:var(--grid-strong); background:var(--app-surface);">
          <div class="flex items-center justify-between gap-2">
            <div class="font-extrabold" style="color:var(--burger-dark)">‚úÖ SESI√ìN INICIADA</div>
            <button id="btn-logout" class="btn-soft px-3 py-1.5 rounded text-xs">Cerrar sesi√≥n</button>
          </div>
          <div class="mt-2 text-sm" style="color:var(--app-muted)">
            <div class="flex items-center gap-2"><span class="opacity-80">Correo:</span> <span id="auth-status-email" class="font-semibold break-all" style="color:var(--burger-dark)"></span></div>
            <div class="flex items-center gap-2"><span class="opacity-80">UID:</span> <span id="auth-status-uid" class="text-xs break-all"></span></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </section>

      <!-- Dashboard -->
      <section id="view-dashboard" class="view">
        <h2 class="text-2xl font-extrabold mb-4 section-title" style="color:var(--burger-dark)">üìä Dashboard</h2>
        <div class="flex items-center justify-between gap-3 mb-4">
          <div class="text-sm opacity-80">Vista general de tu negocio con Gestia</div>
          <div class="flex items-center gap-2">
            <label class="text-sm font-bold">Periodo</label>
            <select id="db-period-select" class="input-modern p-2 rounded">
              <option value="7d">√öltimos 7 d√≠as</option>
              <option value="today">Hoy</option>
              <option value="30d">√öltimos 30 d√≠as</option>
              <option value="month">Este mes</option>
              <option value="all">Todo</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-4">
          <div class="panel">
            <div class="flex items-center justify-between"><div class="text-sm opacity-80">Ingresos</div><div id="kpi-revenue-trend" class="kpi-trend"></div></div>
            <div id="kpi-revenue" class="text-3xl font-extrabold">$0.00</div>
          </div>
          <div class="panel">
            <div class="flex items-center justify-between"><div class="text-sm opacity-80">√ìrdenes</div><div id="kpi-orders-trend" class="kpi-trend"></div></div>
            <div id="kpi-orders" class="text-3xl font-extrabold">0</div>
          </div>
          <div class="panel">
            <div class="flex items-center justify-between"><div class="text-sm opacity-80">Ticket promedio</div><div id="kpi-aov-trend" class="kpi-trend"></div></div>
            <div id="kpi-aov" class="text-3xl font-extrabold">$0.00</div>
          </div>
          <div class="panel">
            <div class="flex items-center justify-between"><div class="text-sm opacity-80">Items vendidos</div><div id="kpi-items-trend" class="kpi-trend"></div></div>
            <div id="kpi-items" class="text-3xl font-extrabold">0</div>
          </div>
          <div class="panel">
            <div class="text-sm opacity-80">Descuento aplicado</div>
            <div id="kpi-discount" class="text-3xl font-extrabold">$0.00</div>
          </div>
          <div class="panel">
            <div class="text-sm opacity-80">Env√≠o cobrado</div>
            <div id="kpi-shipping" class="text-3xl font-extrabold">$0.00</div>
          </div>
          <div class="panel">
            <div class="text-sm opacity-80">Mejor producto</div>
            <div id="kpi-top-product" class="text-lg font-extrabold">‚Äî</div>
          </div>
          <div class="panel">
            <div class="text-sm opacity-80">Mejor cliente</div>
            <div id="kpi-top-client" class="text-lg font-extrabold">‚Äî</div>
          </div>
        </div>
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-4 mb-4">
          <div class="panel xl:col-span-2">
            <h3 class="font-bold mb-2">Ventas recientes</h3>
            <table class="w-full text-left table-nice"><thead><tr><th class="p-2">ID</th><th class="p-2">Cliente</th><th class="p-2">Fecha</th><th class="p-2 text-right">Total</th></tr></thead><tbody id="db-ventas-recientes-body"></tbody></table>
          </div>
          <div class="panel">
            <h3 class="font-bold mb-2">Ventas por hora (hoy)</h3>
            <canvas id="sales-hourly-chart" height="150"></canvas>
            <div id="sales-hourly-empty" class="text-sm opacity-60 hidden">Sin datos de hoy</div>
          </div>
        </div>
      </section>

      <!-- Reportes -->
      <section id="view-reportes" class="view">
        <h2 class="text-2xl font-extrabold mb-4 section-title" style="color:var(--burger-dark)">üìà Reportes</h2>
        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-3 mb-4">
          <div class="text-sm opacity-80">An√°lisis visual de desempe√±o</div>
          <div class="flex flex-col md:flex-row md:items-center gap-2">
            <div class="flex items-center gap-2">
              <label class="text-sm font-bold">Periodo</label>
              <select id="rep-period-select" class="input-modern p-2 rounded">
                <option value="7d">√öltimos 7 d√≠as</option>
                <option value="today">Hoy</option>
                <option value="30d">√öltimos 30 d√≠as</option>
                <option value="month">Este mes</option>
                <option value="all">Todo</option>
                <option value="custom">Personalizado</option>
              </select>
            </div>
            <div id="rep-custom-range" class="flex items-center gap-2 hidden">
              <input id="rep-date-start" type="date" class="input-modern p-2 rounded" />
              <span class="opacity-60">a</span>
              <input id="rep-date-end" type="date" class="input-modern p-2 rounded" />
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm font-bold">Tipo</label>
              <select id="rep-filter-type" class="input-modern p-2 rounded">
                <option value="all">Todos</option>
                <option value="local">Local</option>
                <option value="para_llevar">Para llevar</option>
                <option value="envio">Env√≠o</option>
              </select>
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm font-bold">Pago</label>
              <select id="rep-filter-pay" class="input-modern p-2 rounded">
                <option value="all">Todos</option>
                <option value="Efectivo">Efectivo</option>
                <option value="Tarjeta">Tarjeta</option>
                <option value="Transferencia">Transferencia</option>
                <option value="Otro">Otro</option>
              </select>
            </div>
            <div class="flex items-center gap-2 ml-auto">
              <button id="rep-export-dashboard-pdf" class="btn-gradient px-3 py-2 rounded text-sm">üìÑ PDF general</button>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-4">
          <div class="stat-card"><div class="text-xs opacity-70">Ingresos</div><div id="rep-revenue" class="text-xl font-extrabold">$0.00</div></div>
          <div class="stat-card"><div class="text-xs opacity-70">√ìrdenes</div><div id="rep-orders" class="text-xl font-extrabold">0</div></div>
          <div class="stat-card"><div class="text-xs opacity-70">Ticket promedio</div><div id="rep-aov" class="text-xl font-extrabold">$0.00</div></div>
          <div class="stat-card"><div class="text-xs opacity-70">Margen bruto (est.)</div><div id="rep-gp" class="text-xl font-extrabold">$0.00</div></div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
          <div class="panel"><h3 class="font-bold mb-2">Ventas por per√≠odo</h3><canvas id="sales-chart"></canvas></div>
          <div class="panel"><h3 class="font-bold mb-2">Productos m√°s vendidos</h3><canvas id="products-chart"></canvas></div>
        </div>
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-4 mb-4">
          <div class="panel"><h3 class="font-bold mb-2">Tipos de orden</h3><canvas id="order-type-chart"></canvas></div>
          <div class="panel"><h3 class="font-bold mb-2">M√©todos de pago</h3><canvas id="payment-method-chart"></canvas></div>
          <div class="panel"><h3 class="font-bold mb-2">Por d√≠a de la semana</h3><canvas id="weekday-chart"></canvas></div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
          <div class="panel"><h3 class="font-bold mb-2">Top clientes</h3><canvas id="top-clients-chart"></canvas></div>
          <div class="panel"><h3 class="font-bold mb-2">Margen por producto (Top 10)</h3><canvas id="margin-chart"></canvas></div>
        </div>
        <div class="grid grid-cols-1 gap-4">
          <div class="panel"><h3 class="font-bold mb-2">Ingresos por hora</h3><canvas id="hourly-report-chart"></canvas></div>
        </div>

          <!-- Promedio de art√≠culos vendidos por semana/mes -->
          <div class="mt-6">
            <h3 class="text-xl font-extrabold mb-3" style="color:var(--burger-dark)">üìä Promedio de art√≠culos vendidos</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div class="stat-card"><div class="text-xs opacity-70">Por semana</div><div id="avg-items-week" class="text-xl font-extrabold">0</div></div>
              <div class="stat-card"><div class="text-xs opacity-70">Por mes</div><div id="avg-items-month" class="text-xl font-extrabold">0</div></div>
            </div>
          </div>

        <!-- Gastos por ingrediente (debajo de reportes) -->
        <div class="mt-6">
          <h3 class="text-xl font-extrabold mb-3" style="color:var(--burger-dark)">üì¶ Gastos por Ingrediente</h3>
          <div class="text-sm opacity-80 mb-3">Desglose de compras por ingrediente en el periodo seleccionado. √ötil para vigilar costos y m√°rgenes.</div>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
            <div class="stat-card"><div class="text-xs opacity-70">Gasto total (compras)</div><div id="exp-total-spend" class="text-xl font-extrabold">$0.00</div></div>
            <div class="stat-card"><div class="text-xs opacity-70">Ingresos (ventas)</div><div id="exp-revenue" class="text-xl font-extrabold">$0.00</div></div>
            <div class="stat-card"><div class="text-xs opacity-70">Costo estimado (COGS)</div><div id="exp-cogs" class="text-xl font-extrabold">$0.00</div></div>
            <div class="stat-card"><div class="text-xs opacity-70">Ganancia bruta (est.)</div><div id="exp-gp" class="text-xl font-extrabold">$0.00</div></div>
          </div>
          <div class="flex items-center justify-end mb-2">
            <button id="rep-export-expenses" class="btn-outline px-3 py-2 rounded text-sm">Exportar gastos CSV</button>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div class="panel overflow-x-auto">
              <h4 class="font-bold mb-2">Gastos por ingrediente</h4>
              <table class="w-full text-left table-nice">
                <thead><tr><th class="p-2">Ingrediente</th><th class="p-2 text-right">Piezas</th><th class="p-2 text-right">Unidades</th><th class="p-2 text-right">Gasto</th></tr></thead>
                <tbody id="exp-ingredientes-body"></tbody>
              </table>
            </div>
            <div class="panel">
              <h4 class="font-bold mb-2">Participaci√≥n de gastos</h4>
              <canvas id="expense-ingredient-chart" height="220"></canvas>
              <div id="expense-empty" class="text-sm opacity-60 mt-2 hidden">Sin compras en el periodo</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Caja -->
      <section id="view-caja" class="view">
        <h2 class="text-2xl font-extrabold mb-4 section-title" style="color:var(--burger-dark)">üíµ Caja</h2>
        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-3 mb-4">
          <div class="text-sm opacity-80">Balance hist√≥rico (todo el tiempo): ingresos, gastos y saldo en efectivo y tarjeta.</div>
          <div class="ml-auto">
            <button id="caja-add-pendiente-quick" class="btn-outline px-3 py-2 rounded text-sm">‚ûï Cr√©dito / Pr√©stamo (pendiente)</button>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 mb-4">
          <div class="panel">
            <div class="font-bold mb-2">Ingresos</div>
            <div class="grid grid-cols-2 gap-3">
              <div class="stat-card"><div class="text-xs opacity-70">Efectivo</div><div id="caja-ing-ef" class="text-xl font-extrabold">$0.00</div></div>
              <div class="stat-card"><div class="text-xs opacity-70">Tarjeta</div><div id="caja-ing-tar" class="text-xl font-extrabold">$0.00</div></div>
            </div>
          </div>
          <div class="panel">
            <div class="font-bold mb-2">Gastos</div>
            <div class="grid grid-cols-2 gap-3">
              <div class="stat-card"><div class="text-xs opacity-70">Efectivo</div><div id="caja-gas-ef" class="text-xl font-extrabold">$0.00</div></div>
              <div class="stat-card"><div class="text-xs opacity-70">Tarjeta</div><div id="caja-gas-tar" class="text-xl font-extrabold">$0.00</div></div>
            </div>
          </div>
          <div class="panel">
            <div class="font-bold mb-2">Saldo actual</div>
            <div class="grid grid-cols-2 gap-3 mb-3">
              <div class="stat-card"><div class="text-xs opacity-70">Disponible (Efectivo)</div><div id="caja-sal-ef" class="text-xl font-extrabold">$0.00</div></div>
              <div class="stat-card"><div class="text-xs opacity-70">Disponible (Tarjeta)</div><div id="caja-sal-tar" class="text-xl font-extrabold">$0.00</div></div>
            </div>
            <div class="stat-card"><div class="text-xs opacity-70">Disponible (Efectivo + Tarjeta)</div><div id="caja-sal-total" class="text-xl font-extrabold">$0.00</div></div>

            <div class="mt-3 grid grid-cols-2 gap-3">
              <div class="stat-card"><div class="text-xs opacity-70">No disponible (Efectivo)</div><div id="caja-nodisp-ef" class="text-xl font-extrabold">$0.00</div></div>
              <div class="stat-card"><div class="text-xs opacity-70">No disponible (Tarjeta)</div><div id="caja-nodisp-tar" class="text-xl font-extrabold">$0.00</div></div>
            </div>
            <div class="mt-3 stat-card"><div class="text-xs opacity-70">No disponible (Efectivo + Tarjeta)</div><div id="caja-nodisp-total" class="text-xl font-extrabold">$0.00</div></div>

            <div class="mt-3 grid grid-cols-2 gap-3">
              <div class="stat-card"><div class="text-xs opacity-70">Total en caja (Efectivo)</div><div id="caja-total-ef" class="text-xl font-extrabold">$0.00</div></div>
              <div class="stat-card"><div class="text-xs opacity-70">Total en caja (Tarjeta)</div><div id="caja-total-tar" class="text-xl font-extrabold">$0.00</div></div>
            </div>
            <div class="mt-3 stat-card"><div class="text-xs opacity-70">Total en caja (Efectivo + Tarjeta)</div><div id="caja-total-total" class="text-xl font-extrabold">$0.00</div></div>
            <div class="mt-3 flex items-center justify-end">
              <div class="flex flex-col sm:flex-row gap-2">
                <button id="caja-transfer-ef-a-tar" class="btn-outline px-3 py-2 rounded text-sm">‚áÑ Traspasar Efectivo ‚Üí Tarjeta</button>
                <button id="caja-transfer-tar-a-ef" class="btn-outline px-3 py-2 rounded text-sm">‚áÑ Traspasar Tarjeta ‚Üí Efectivo</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Ingresos (detalle) -->
        <div class="panel">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-bold">üì• Ingresos (detalle)</h3>
            <button id="caja-add-ingreso" class="btn-gradient px-3 py-2 rounded text-sm">‚ûï Registrar ingreso</button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-left table-nice">
              <thead>
                <tr>
                  <th class="p-2">Fecha</th>
                  <th class="p-2">M√©todo</th>
                  <th class="p-2">Descripci√≥n</th>
                  <th class="p-2 text-right">Monto</th>
                  <th class="p-2">Acciones</th>
                </tr>
              </thead>
              <tbody id="caja-ingresos-body"></tbody>
              <tfoot>
                <tr class="bg-amber-50">
                  <td colspan="3" class="p-2 text-right font-bold">Total otros ingresos (hist√≥rico):</td>
                  <td class="p-2 text-right font-bold" id="caja-ingresos-total">$0.00</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
          <div class="text-xs opacity-60 mt-2">Nota: Estos ingresos son adicionales a las ventas (ej: dep√≥sitos, ajustes, otros cobros).</div>
        </div>

        <!-- Gastos (detalle) -->
        <div class="panel">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-bold">üìã Gastos (detalle)</h3>
            <button id="caja-add-gasto" class="btn-gradient px-3 py-2 rounded text-sm">‚ûï Registrar gasto</button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-left table-nice">
              <thead>
                <tr>
                  <th class="p-2">Fecha</th>
                  <th class="p-2">Tipo</th>
                  <th class="p-2">M√©todo</th>
                  <th class="p-2">Descripci√≥n</th>
                  <th class="p-2 text-right">Monto</th>
                  <th class="p-2">Acciones</th>
                </tr>
              </thead>
              <tbody id="caja-gastos-body"></tbody>
              <tfoot>
                <tr class="bg-amber-50">
                  <td colspan="4" class="p-2 text-right font-bold">Total gastos (hist√≥rico):</td>
                  <td class="p-2 text-right font-bold" id="caja-gastos-total">$0.00</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
          <div class="text-xs opacity-60 mt-2">Nota: Ventas canceladas no se consideran. Los gastos sin m√©todo registrado se asumen como efectivo.</div>
        </div>

        <!-- Pendientes (no disponible) -->
        <div class="panel">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-bold">üßæ Pendientes (no disponible)</h3>
            <button id="caja-add-pendiente" class="btn-gradient px-3 py-2 rounded text-sm">‚ûï Agregar pendiente</button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-left table-nice">
              <thead>
                <tr>
                  <th class="p-2">Fecha</th>
                  <th class="p-2">Tipo</th>
                  <th class="p-2">M√©todo</th>
                  <th class="p-2">Descripci√≥n</th>
                  <th class="p-2 text-right">Monto</th>
                  <th class="p-2">Acciones</th>
                </tr>
              </thead>
              <tbody id="caja-pendientes-body"></tbody>
              <tfoot>
                <tr class="bg-amber-50">
                  <td colspan="4" class="p-2 text-right font-bold">Total no disponible (hist√≥rico):</td>
                  <td class="p-2 text-right font-bold" id="caja-pendientes-total">$0.00</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
          <div class="text-xs opacity-60 mt-2">Nota: Se descuenta del disponible. Al resolverlo, vuelve a estar disponible.</div>
        </div>
      </section>

      <!-- Finanzas -->
      <section id="view-finanzas" class="view">
        <h2 class="text-2xl font-extrabold mb-4 section-title" style="color:var(--burger-dark)">üí∞ Finanzas</h2>
        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-3 mb-4">
          <div class="text-sm opacity-80">Margen bruto y costos operativos (sueldos y servicios)</div>
          <div class="flex flex-col md:flex-row md:items-center gap-2">
            <div class="flex items-center gap-2">
              <label class="text-sm font-bold">Periodo</label>
              <select id="fin-period-select" class="input-modern p-2 rounded">
                <option value="7d">√öltimos 7 d√≠as</option>
                <option value="today">Hoy</option>
                <option value="30d">√öltimos 30 d√≠as</option>
                <option value="month">Este mes</option>
                <option value="all">Todo</option>
                <option value="custom">Personalizado</option>
              </select>
            </div>
            <div id="fin-custom-range" class="flex items-center gap-2 hidden">
              <input id="fin-date-start" type="date" class="input-modern p-2 rounded" />
              <span class="opacity-60">a</span>
              <input id="fin-date-end" type="date" class="input-modern p-2 rounded" />
            </div>
            <div class="ml-auto flex items-center gap-2">
              <button id="fin-export-ventas-pdf" class="btn-outline px-3 py-2 rounded text-sm">Descargar PDF ventas</button>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-7 gap-4 mb-4">
          <div class="stat-card"><div class="text-xs opacity-70">Ingresos</div><div id="fin-kpi-rev" class="text-xl font-extrabold">$0.00</div></div>
          <div class="stat-card"><div class="text-xs opacity-70">COGS est.</div><div id="fin-kpi-cogs" class="text-xl font-extrabold">$0.00</div></div>
          <div class="stat-card"><div class="text-xs opacity-70">Margen bruto</div><div id="fin-kpi-gp" class="text-xl font-extrabold">$0.00</div></div>
          <div class="stat-card"><div class="text-xs opacity-70">Sueldos (periodo)</div><div id="fin-kpi-payroll" class="text-xl font-extrabold">$0.00</div></div>
          <div class="stat-card"><div class="text-xs opacity-70">Servicios (periodo)</div><div id="fin-kpi-services" class="text-xl font-extrabold">$0.00</div></div>
          <div class="stat-card"><div class="text-xs opacity-70">Gastos diarios</div><div id="fin-kpi-gastos" class="text-xl font-extrabold">$0.00</div></div>
          <div class="stat-card"><div class="text-xs opacity-70">Utilidad neta (est.)</div><div id="fin-kpi-net" class="text-xl font-extrabold">$0.00</div></div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
          <div class="panel overflow-x-auto lg:col-span-2">
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-bold">Empleados</h3>
              <button id="fin-add-emp" class="btn-gradient px-3 py-2 rounded text-sm">‚ûï A√±adir</button>
            </div>
            <table class="w-full text-left table-nice">
              <thead><tr><th class="p-2">Nombre</th><th class="p-2 text-right">Sueldo semanal</th><th class="p-2">Activo</th><th class="p-2">Acciones</th></tr></thead>
              <tbody id="fin-emp-body"></tbody>
            </table>
          </div>
          <div class="panel overflow-x-auto">
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-bold">Servicios</h3>
              <button id="fin-add-srv" class="btn-gradient px-3 py-2 rounded text-sm">‚ûï A√±adir</button>
            </div>
            <table class="w-full text-left table-nice">
              <thead><tr><th class="p-2">Servicio</th><th class="p-2 text-right">Monto</th><th class="p-2">Frecuencia</th><th class="p-2">Acciones</th></tr></thead>
              <tbody id="fin-srv-body"></tbody>
            </table>
          </div>
        </div>
        
        <!-- Gastos Diarios -->
        <div class="panel mb-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-bold">üìã Gastos Diarios</h3>
            <button id="fin-add-gasto" class="btn-gradient px-3 py-2 rounded text-sm">‚ûï Registrar gasto</button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-left table-nice">
              <thead>
                <tr>
                  <th class="p-2">Fecha</th>
                  <th class="p-2">Tipo</th>
                  <th class="p-2">Descripci√≥n</th>
                  <th class="p-2 text-right">Monto</th>
                  <th class="p-2">Acciones</th>
                </tr>
              </thead>
              <tbody id="fin-gastos-body"></tbody>
              <tfoot>
                <tr class="bg-amber-50">
                  <td colspan="3" class="p-2 text-right font-bold">Total gastos (periodo):</td>
                  <td class="p-2 text-right font-bold" id="fin-gastos-total">$0.00</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
        
        <div class="panel">
          <h3 class="font-bold mb-2">Utilidad neta por semana</h3>
          <canvas id="fin-weekly-chart" height="200"></canvas>
          <div id="fin-weekly-empty" class="text-sm opacity-60 mt-2 hidden">Sin datos en el periodo</div>
        </div>

        <!-- Asignaciones por departamento -->
        <div class="panel mt-4">
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-2 mb-2">
            <h3 class="font-bold">Asignaciones por departamento</h3>
            <div class="flex flex-wrap items-center gap-2">
              <label class="text-sm font-bold">Base</label>
              <select id="fin-alloc-base" class="input-modern p-2 rounded">
                <option value="revenue">Ingresos</option>
                <option value="gp">Margen Bruto</option>
                <option value="net">Utilidad Neta</option>
              </select>
              <div class="text-sm opacity-70">Base actual: <span id="fin-alloc-base-value" class="font-bold">$0.00</span></div>
              <button id="fin-alloc-export" class="btn-outline px-3 py-2 rounded text-sm ml-auto">Exportar CSV</button>
              <button id="fin-add-alloc" class="btn-gradient px-3 py-2 rounded text-sm">‚ûï A√±adir</button>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-left table-nice">
              <thead><tr><th class="p-2">Departamento</th><th class="p-2 text-right">% Asignado</th><th class="p-2 text-right">Monto (periodo)</th><th class="p-2">Acciones</th></tr></thead>
              <tbody id="fin-alloc-body"></tbody>
              <tfoot>
                <tr>
                  <th class="p-2 text-right">Totales:</th>
                  <th class="p-2 text-right" id="fin-alloc-total-pct">0%</th>
                  <th class="p-2 text-right" id="fin-alloc-total-amt">$0.00</th>
                  <th></th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </section>

      <!-- POS -->
      <section id="view-vender" class="view">
        <h2 class="text-2xl font-extrabold mb-4 section-title" style="color:var(--burger-dark)">üõí Punto de Venta</h2>
        <div class="flex flex-col xl:flex-row gap-4">
          <!-- √Årea de productos - M√°s ancha -->
          <div class="xl:w-2/3 panel">
            <div class="flex flex-col gap-4 mb-4">
              <!-- Fila superior: B√∫squeda y Tipo de orden -->
              <div class="flex flex-col sm:flex-row gap-3">
                <div class="flex-1">
                  <label class="block text-sm font-bold mb-2">üîç Buscar Producto</label>
                  <input id="pos-search-input" type="text" class="w-full input-modern p-3 rounded-lg text-base" placeholder="Escribe el nombre del producto...">
                </div>
                <div class="sm:w-48">
                  <label class="block text-sm font-bold mb-2">üìã Tipo de orden</label>
                  <select id="pos-order-type" class="w-full input-modern p-3 rounded-lg text-base">
                    <option value="local">üè™ Local</option>
                    <option value="para_llevar">üì¶ Para llevar</option>
                    <option value="envio">üöö Env√≠o</option>
                  </select>
                </div>
              </div>
              
              <!-- Mesa (solo visible para tipo Local) -->
              <div id="pos-table-row" class="hidden">
                <label class="block text-sm font-bold mb-2">ü™ë Mesa</label>
                <div class="flex gap-2">
                  <select id="pos-table-select" class="flex-1 input-modern p-3 rounded-lg text-base"></select>
                  <button id="pos-new-table" class="px-4 py-3 rounded-lg bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold transition-all" title="Nueva mesa">‚ûï Nueva</button>
                </div>
              </div>
            </div>
            
            <!-- Categor√≠as - M√°s grandes y visibles -->
            <div class="mb-4">
              <div id="pos-category-buttons" class="flex flex-wrap gap-2"></div>
            </div>
            
            <!-- Grid de productos - Tarjetas m√°s grandes -->
            <div id="pos-product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4 gap-4"></div>
          </div>
          
          <!-- Panel de orden - M√°s limpio -->
          <div class="xl:w-1/3">
            <div class="panel p-5 sticky top-4">
              <div class="flex items-center mb-5 pb-3 border-b-2">
                <span class="mr-3 text-2xl">üßæ</span>
                <h3 class="font-bold text-xl">Orden Actual</h3>
              </div>
              
              <div id="pos-order-items" class="space-y-3 mb-4 max-h-[45vh] overflow-y-auto pr-2">
                <div class="text-center py-8 text-sm opacity-70">A√±ade productos para empezar</div>
              </div>
              
              <div class="space-y-4 border-t-2 pt-4">
                <div class="flex justify-between text-lg">
                  <span class="font-semibold">Subtotal</span>
                  <span id="pos-subtotal" class="font-bold text-xl">$0.00</span>
                </div>
                
                <div>
                  <div class="flex justify-between items-center mb-2">
                    <label for="pos-discount-input" class="text-sm font-bold">üí∞ Descuento</label>
                    <input type="number" id="pos-discount-input" class="w-28 input-modern p-2 rounded-lg text-right" placeholder="0.00" min="0">
                  </div>
                  <div class="flex gap-2">
                    <button class="flex-1 px-3 py-2 rounded-lg border-2 text-sm font-bold hover:bg-gray-50 transition" data-discount-pct="5">5%</button>
                    <button class="flex-1 px-3 py-2 rounded-lg border-2 text-sm font-bold hover:bg-gray-50 transition" data-discount-pct="10">10%</button>
                    <button class="flex-1 px-3 py-2 rounded-lg border-2 text-sm font-bold hover:bg-gray-50 transition" data-discount-pct="15">15%</button>
                  </div>
                </div>
                
                <div class="flex justify-between items-center">
                  <label class="flex items-center gap-2 text-sm font-bold">
                    <input type="checkbox" id="pos-shipping-checkbox" class="w-4 h-4">
                    <span>üöö Env√≠o</span>
                  </label>
                  <input type="number" id="pos-shipping-cost" class="w-28 input-modern p-2 rounded-lg text-right hidden" placeholder="0.00" min="0">
                </div>
                
                <div class="flex justify-between text-2xl font-extrabold border-t-2 pt-4">
                  <span>Total</span>
                  <span id="pos-total" class="text-green-600">$0.00</span>
                </div>
                
                <div>
                  <label for="pos-customer-select" class="block text-sm font-bold mb-2">üë§ Cliente</label>
                  <div class="flex gap-2">
                    <select id="pos-customer-select" class="flex-1 input-modern p-3 rounded-lg text-base"></select>
                    <button id="pos-add-customer" class="px-4 py-3 rounded-lg bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold transition-all" title="Nuevo cliente">‚ûï</button>
                  </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mt-4">
                  <button id="pos-suspend-btn" class="btn-outline px-4 py-3 rounded-lg font-bold transition">‚è∏Ô∏è Suspender</button>
                  <button id="pos-clear-btn" class="btn-outline px-4 py-3 rounded-lg font-bold transition">üóëÔ∏è Vaciar</button>
                  <button id="pos-suspended-list-btn" class="btn-outline px-4 py-3 rounded-lg font-bold transition">üìÇ Guardados</button>
                  <button id="pos-pay-btn" class="bg-gradient-to-r from-green-500 to-green-600 text-white py-3 rounded-lg font-bold text-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>üí≥ Cobrar</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Pedidos -->
      <section id="view-pedidos-pendientes" class="view">
        <h2 class="text-2xl font-bold mb-4" style="color:var(--burger-dark)">Pedidos Pendientes</h2>
  <div class="panel">
          <div class="flex items-center gap-4 mb-3">
            <div class="text-sm opacity-70">En cola: <span id="pedidos-count">0</span></div>
            <button id="debug-data" class="px-3 py-1 bg-blue-500 text-white rounded text-sm">üîç Debug Data</button>
          </div>
          <div id="pedidos-pendientes-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
          <div id="no-pedidos-message" class="text-center py-8 opacity-70 hidden">No hay pedidos pendientes</div>
        </div>
      </section>

      <!-- Ventas -->
      <section id="view-ventas" class="view">
        <h2 class="text-2xl font-bold mb-4" style="color:var(--burger-dark)">Historial de Ventas</h2>
        <div class="panel overflow-x-auto">
          <table class="w-full text-left table-nice">
            <thead>
              <tr>
                <th class="p-2">ID</th>
                <th class="p-2">Fecha</th>
                <th class="p-2">Cliente</th>
                <th class="p-2">Items</th>
                <th class="p-2 text-right">Total</th>
                <th class="p-2 text-right">Costo Prod.</th>
                <th class="p-2 text-right">Ganancia</th>
                <th class="p-2">Acciones</th>
              </tr>
            </thead>
            <tbody id="ventas-list-body"></tbody>
          </table>
        </div>
      </section>

      <!-- Productos -->
      <section id="view-productos" class="view">
        <div class="flex justify-between items-center mb-4">
          <div>
            <h2 class="text-2xl font-extrabold section-title" style="color:var(--burger-dark)">üçî Gesti√≥n de Productos</h2>
            <p class="text-sm opacity-75 mt-1">Cat√°logo central de productos: precios, costos, categor√≠a y estaci√≥n de preparaci√≥n.</p>
          </div>
          <div class="flex flex-wrap gap-2 justify-end">
            <button id="open-productos-modal" class="btn-gradient px-4 py-2 rounded flex items-center gap-1"><span>‚ûï</span><span class="hidden sm:inline">Nuevo producto</span><span class="sm:hidden">Nuevo</span></button>
            <button id="export-productos-btn" class="px-3 py-2 rounded border btn-outline text-sm flex items-center gap-1" title="Exportar productos a JSON">üíæ <span class="hidden md:inline">Exportar</span></button>
          </div>
        </div>

        <!-- KPIs r√°pidos de cat√°logo -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
          <div class="stat-card flex items-center justify-between">
            <div>
              <div class="productos-kpi-label">Productos activos</div>
              <div id="productos-kpi-total" class="productos-kpi-value">0</div>
            </div>
            <div class="text-2xl">üì¶</div>
          </div>
          <div class="stat-card flex items-center justify-between">
            <div>
              <div class="productos-kpi-label">Combos</div>
              <div id="productos-kpi-combos" class="productos-kpi-value">0</div>
            </div>
            <div class="text-2xl">üçΩÔ∏è</div>
          </div>
          <div class="stat-card flex items-center justify-between">
            <div>
              <div class="productos-kpi-label">Sin categor√≠a</div>
              <div id="productos-kpi-uncat" class="productos-kpi-value">0</div>
            </div>
            <div class="text-2xl">‚ö†Ô∏è</div>
          </div>
        </div>
        
        <!-- Filtros de productos (por categor√≠as definidas) -->
        <div class="mb-4 flex flex-wrap items-center justify-between gap-2">
          <div class="flex flex-col gap-1 flex-1 min-w-[220px]">
            <span class="text-xs font-semibold tracking-wide uppercase opacity-70">Filtros de categor√≠a</span>
            <div id="productos-filter-container" class="flex flex-wrap gap-2"></div>
          </div>
          <button type="button" id="add-categoria-btn" class="px-3 py-2 rounded-lg border-2 border-dashed text-sm bg-white hover:bg-yellow-50 flex items-center gap-1">
            <span>‚ûï</span><span>Nueva categor√≠a</span>
          </button>
        </div>

    <div class="panel overflow-x-auto">
            <table class="w-full text-left table-nice text-sm">
              <thead>
                <tr>
                  <th class="p-2 sticky-col">
                    <div class="flex flex-col">
                      <span class="font-semibold">Producto</span>
                      <span class="text-[11px] opacity-70">Nombre y categor√≠a</span>
                    </div>
                  </th>
                  <th class="p-2">
                    <div class="flex flex-col">
                      <span class="font-semibold">Tipo</span>
                      <span class="text-[11px] opacity-70">Individual / Combo</span>
                    </div>
                  </th>
                  <th class="p-2">
                    <div class="flex flex-col">
                      <span class="font-semibold">Clasificaci√≥n</span>
                      <span class="text-[11px] opacity-70">Uso interno</span>
                    </div>
                  </th>
                  <th class="p-2">
                    <div class="flex flex-col">
                      <span class="font-semibold">Tama√±o</span>
                      <span class="text-[11px] opacity-70">Solo complementos</span>
                    </div>
                  </th>
                  <th class="p-2 text-right">
                    <div class="flex flex-col items-end">
                      <span class="font-semibold">Precio</span>
                      <span class="text-[11px] opacity-70">Venta</span>
                    </div>
                  </th>
                  <th class="p-2 text-right">
                    <div class="flex flex-col items-end">
                      <span class="font-semibold">Costo</span>
                      <span class="text-[11px] opacity-70">Receta</span>
                    </div>
                  </th>
                  <th class="p-2 text-right">
                    <div class="flex flex-col items-end">
                      <span class="font-semibold">Margen</span>
                      <span class="text-[11px] opacity-70">$ y %</span>
                    </div>
                  </th>
                  <th class="p-2">
                    <div class="flex flex-col">
                      <span class="font-semibold">Estaciones</span>
                      <span class="text-[11px] opacity-70">Parrilla / Papera...</span>
                    </div>
                  </th>
                  <th class="p-2">
                    <div class="flex flex-col">
                      <span class="font-semibold">Descripci√≥n</span>
                      <span class="text-[11px] opacity-70">Notas para la carta</span>
                    </div>
                  </th>
                  <th class="p-2 text-right">
                    <div class="flex flex-col items-end">
                      <span class="font-semibold">Acciones</span>
                      <span class="text-[11px] opacity-70">Editar, duplicar‚Ä¶</span>
                    </div>
                  </th>
                </tr>
              </thead>
              <tbody id="productos-list-body"></tbody>
            </table>
        </div>

        <!-- Rentabilidad de Productos -->
        <div class="mt-6">
          <h3 class="text-xl font-extrabold mb-3" style="color:var(--burger-dark)">üìà An√°lisis de Rentabilidad por Producto</h3>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
            <div class="panel">
              <h4 class="font-bold mb-2">Margen vs Ventas</h4>
              <canvas id="profit-margin-scatter"></canvas>
            </div>
            <div class="panel">
              <h4 class="font-bold mb-2">Ingresos vs Costos por Producto</h4>
              <canvas id="revenue-cost-chart"></canvas>
            </div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
            <div class="panel">
              <h4 class="font-bold mb-2">Top 10 - Productos m√°s Rentables</h4>
              <canvas id="top-profit-products"></canvas>
            </div>
            <div class="panel">
              <h4 class="font-bold mb-2">Rentabilidad por Categor√≠a</h4>
              <canvas id="category-profitability"></canvas>
            </div>
          </div>
          <div class="panel">
            <h4 class="font-bold mb-2">Resumen de Rentabilidad</h4>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div class="stat-card">
                <div class="text-xs opacity-70">Margen Promedio</div>
                <div id="avg-profit-margin" class="text-xl font-extrabold text-green-600">0%</div>
              </div>
              <div class="stat-card">
                <div class="text-xs opacity-70">Producto m√°s Rentable</div>
                <div id="most-profitable-product" class="text-sm font-bold">-</div>
              </div>
              <div class="stat-card">
                <div class="text-xs opacity-70">Total Ganancia Bruta</div>
                <div id="total-gross-profit" class="text-xl font-extrabold text-green-600">$0</div>
              </div>
              <div class="stat-card">
                <div class="text-xs opacity-70">ROI Promedio</div>
                <div id="avg-roi" class="text-xl font-extrabold text-blue-600">0%</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Estaciones -->
      <section id="view-estaciones" class="view">
        <div class="flex justify-between items-center mb-4">
          <div>
            <h2 class="text-2xl font-extrabold section-title" style="color:var(--burger-dark)">üî• Gesti√≥n de Estaciones</h2>
            <p class="text-sm opacity-75 mt-1">Define los puntos de preparaci√≥n (parrilla, freidora, plancha‚Ä¶) para organizar tu cocina.</p>
          </div>
          <div class="flex gap-2">
            <button id="add-estacion-btn" class="btn-gradient px-4 py-2 rounded flex items-center gap-1">
              <span>‚ûï</span><span class="hidden sm:inline">Nueva estaci√≥n</span><span class="sm:hidden">Nueva</span>
            </button>
          </div>
        </div>

        <!-- KPIs r√°pidos de estaciones -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
          <div class="stat-card flex items-center justify-between">
            <div>
              <div class="estaciones-kpi-label">Estaciones totales</div>
              <div id="est-kpi-total" class="estaciones-kpi-value">0</div>
            </div>
            <div class="text-2xl">üßë‚Äçüç≥</div>
          </div>
          <div class="stat-card flex items-center justify-between">
            <div>
              <div class="estaciones-kpi-label">Estaciones base</div>
              <div id="est-kpi-fixed" class="estaciones-kpi-value">0</div>
            </div>
            <div class="text-2xl">üèóÔ∏è</div>
          </div>
          <div class="stat-card flex items-center justify-between">
            <div>
              <div class="estaciones-kpi-label">Productos sin estaci√≥n</div>
              <div id="est-kpi-unassigned" class="estaciones-kpi-value">0</div>
            </div>
            <div class="text-2xl">‚ö†Ô∏è</div>
          </div>
        </div>

        <div class="panel overflow-x-auto">
          <table class="w-full text-left table-nice text-sm">
            <thead>
              <tr>
                <th class="p-2">
                  <div class="flex flex-col">
                    <span class="font-semibold">Estaci√≥n</span>
                    <span class="text-[11px] opacity-70">Nombre visible</span>
                  </div>
                </th>
                <th class="p-2">
                  <div class="flex flex-col">
                    <span class="font-semibold">Clave interna</span>
                    <span class="text-[11px] opacity-70">Para vincular productos</span>
                  </div>
                </th>
                <th class="p-2 text-center">
                  <div class="flex flex-col items-center">
                    <span class="font-semibold">Icono</span>
                    <span class="text-[11px] opacity-70">Letra o emoji</span>
                  </div>
                </th>
                <th class="p-2 text-right">
                  <div class="flex flex-col items-end">
                    <span class="font-semibold">Productos</span>
                    <span class="text-[11px] opacity-70">Asignados a la estaci√≥n</span>
                  </div>
                </th>
                <th class="p-2 text-right">
                  <div class="flex flex-col items-end">
                    <span class="font-semibold">Acciones</span>
                    <span class="text-[11px] opacity-70">Editar / Eliminar</span>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody id="estaciones-list-body"></tbody>
          </table>
        </div>
      </section>

      <!-- Ingredientes -->
      <section id="view-ingredientes" class="view">
        <div class="flex justify-between items-center mb-4">
          <div>
            <h2 class="text-2xl font-extrabold section-title" style="color:var(--burger-dark)">ü•¨ Gesti√≥n de Ingredientes</h2>
            <p class="text-sm opacity-75 mt-1">Controla costos unitarios y presentaciones de cada insumo como en una hoja de c√°lculo.</p>
          </div>
          <div class="flex gap-2">
            <button id="open-ingredientes-modal" class="btn-gradient px-4 py-2 rounded flex items-center gap-1">
              <span>‚ûï</span><span class="hidden sm:inline">A√±adir Ingrediente</span><span class="sm:hidden">Nuevo</span>
            </button>
            <button id="import-ingredientes-preset" class="px-3 py-2 rounded border bg-white hover:bg-amber-50 text-sm flex items-center gap-1" title="Importar lista predefinida">
              <span>üì•</span><span class="hidden md:inline">Importar base</span>
            </button>
          </div>
        </div>
	<div class="panel overflow-x-auto">
          <table class="w-full text-left table-nice ingredientes-table text-sm">
            <thead>
              <tr>
                <th class="p-2 sticky-col">
                  <div class="flex flex-col">
                    <span class="font-semibold">Ingrediente</span>
                    <span class="text-[11px] opacity-70">Nombre y unidad</span>
                  </div>
                </th>
                <th class="p-2 text-right">
                  <div class="flex flex-col items-end">
                    <span class="font-semibold">Precio paquete</span>
                    <span class="text-[11px] opacity-70">Costo total</span>
                  </div>
                </th>
                <th class="p-2 text-right">
                  <div class="flex flex-col items-end">
                    <span class="font-semibold">Unidades/paquete</span>
                    <span class="text-[11px] opacity-70">Piezas o gramos</span>
                  </div>
                </th>
                <th class="p-2 text-right">
                  <div class="flex flex-col items-end">
                    <span class="font-semibold">Costo unitario</span>
                    <span class="text-[11px] opacity-70">Para recetas</span>
                  </div>
                </th>
                <th class="p-2 text-right">
                  <div class="flex flex-col items-end">
                    <span class="font-semibold">Acciones</span>
                    <span class="text-[11px] opacity-70">Editar / Eliminar</span>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody id="ingredientes-list-body"></tbody>
          </table>
        </div>
      </section>

      <!-- Insumos Gastados (debajo de Ingredientes) -->
      <section id="view-insumos" class="view">
        <div class="flex flex-col gap-2 mb-4">
          <div class="flex justify-between items-center">
            <h2 class="text-2xl font-extrabold section-title" style="color:var(--burger-dark)">üì¶ Insumos Gastados</h2>
            <div class="flex items-center gap-3">
              <div class="flex items-center gap-2">
                <label class="text-sm font-bold">Periodo</label>
                <select id="ins-period-select" class="input-modern p-2 rounded">
                  <option value="7d">√öltimos 7 d√≠as</option>
                  <option value="today">Hoy</option>
                  <option value="30d" selected>√öltimos 30 d√≠as</option>
                  <option value="month">Este mes</option>
                  <option value="all">Todo</option>
                  <option value="custom">Personalizado</option>
                </select>
              </div>
              <div id="ins-custom-range" class="hidden flex items-center gap-2">
                <input id="ins-date-start" type="date" class="input-modern p-2 rounded" />
                <span class="opacity-60">a</span>
                <input id="ins-date-end" type="date" class="input-modern p-2 rounded" />
              </div>
              <div class="flex gap-2">
                <button id="insumos-recompute" class="btn-outline px-3 py-2 rounded" title="Recalcular desde ventas">‚Üª Recalcular</button>
                <button id="insumos-clear" class="btn-outline px-3 py-2 rounded" title="Limpiar historial">üßπ Limpiar</button>
              </div>
            </div>
          </div>
        </div>
        <div class="insumos-shell">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
          <div class="stat-card"><div class="text-xs opacity-70">Ingredientes</div><div id="ins-stat-ings" class="text-xl font-extrabold">0</div></div>
          <div class="stat-card"><div class="text-xs opacity-70">L√≠neas de historial</div><div id="ins-stat-lines" class="text-xl font-extrabold">0</div></div>
          <div class="stat-card"><div class="text-xs opacity-70">Mermas</div><div id="ins-stat-mermas" class="text-xl font-extrabold">0</div></div>
          <div class="stat-card"><div class="text-xs opacity-70">Ventas registradas</div><div id="ins-stat-ventas" class="text-xl font-extrabold">0</div></div>
        </div>
        <div class="insumos-tabs">
          <button class="insumos-tab-btn" data-target="ins-tab-totales">Totales consumidos</button>
          <button class="insumos-tab-btn" data-target="ins-tab-ventas">Ventas (consumo)</button>
          <button class="insumos-tab-btn" data-target="ins-tab-mermas">Mermas</button>
        </div>
        <div class="grid grid-cols-1 gap-4">
          <div id="ins-tab-totales" class="insumos-panel overflow-x-auto insumos-tab-panel">
            <div class="insumos-panel-header">
              <h3 class="insumos-panel-title">üìä Totales consumidos</h3>
              <span class="insumos-panel-pill">Ingrediente ¬∑ Periodo</span>
            </div>
            <table class="w-full text-left table-nice insumos-table text-sm">
              <thead>
                <tr>
                  <th class="p-2 sticky-col">
                    <div class="flex flex-col">
                      <span class="font-semibold">Ingrediente</span>
                      <span class="text-[11px] opacity-70">Nombre y unidad</span>
                    </div>
                  </th>
                  <th class="p-2 text-right">
                    <div class="flex flex-col items-end">
                      <span class="font-semibold">Unidad</span>
                      <span class="text-[11px] opacity-70">Formato</span>
                    </div>
                  </th>
                  <th class="p-2 text-right">
                    <div class="flex flex-col items-end">
                      <span class="font-semibold">Cantidad</span>
                      <span class="text-[11px] opacity-70">Periodo</span>
                    </div>
                  </th>
                  <th class="p-2 text-right">
                    <div class="flex flex-col items-end">
                      <span class="font-semibold">Prom. diario</span>
                      <span class="text-[11px] opacity-70">Consumo</span>
                    </div>
                  </th>
                  <th class="p-2 text-right">
                    <div class="flex flex-col items-end">
                      <span class="font-semibold">Acciones</span>
                      <span class="text-[11px] opacity-70">Ajustes</span>
                    </div>
                  </th>
                </tr>
              </thead>
              <tbody id="insumos-totales-body"></tbody>
            </table>
          </div>
          <div id="ins-tab-ventas" class="insumos-panel overflow-x-auto insumos-tab-panel">
            <div class="insumos-panel-header">
              <div>
                <h3 class="insumos-panel-title">üßæ Ventas (consumo)</h3>
                <p class="insumos-panel-subtext">Haz clic en la venta para descargar su PDF de insumos.</p>
              </div>
              <button id="insumos-ventas-pdf" class="btn-outline px-3 py-1 rounded text-xs">Descargar PDF</button>
            </div>
            <table class="w-full text-left table-nice insumos-table text-sm">
              <thead>
                <tr>
                  <th class="p-2">
                    <div class="flex flex-col">
                      <span class="font-semibold">Fecha</span>
                      <span class="text-[11px] opacity-70">D√≠a y hora</span>
                    </div>
                  </th>
                  <th class="p-2">
                    <div class="flex flex-col">
                      <span class="font-semibold">Venta</span>
                      <span class="text-[11px] opacity-70">Referencia</span>
                    </div>
                  </th>
                </tr>
              </thead>
              <tbody id="insumos-ventas-body"></tbody>
            </table>
          </div>
          <div id="ins-tab-mermas" class="insumos-panel overflow-x-auto insumos-tab-panel">
            <div class="insumos-panel-header">
              <h3 class="insumos-panel-title">‚ö†Ô∏è Mermas</h3>
              <span class="insumos-panel-pill">Control de desperdicio</span>
            </div>
            <table class="w-full text-left table-nice insumos-table text-sm">
              <thead>
                <tr>
                  <th class="p-2">
                    <div class="flex flex-col">
                      <span class="font-semibold">Fecha</span>
                      <span class="text-[11px] opacity-70">Registro</span>
                    </div>
                  </th>
                  <th class="p-2">
                    <div class="flex flex-col">
                      <span class="font-semibold">Ingrediente</span>
                      <span class="text-[11px] opacity-70">Nombre</span>
                    </div>
                  </th>
                  <th class="p-2 text-right">
                    <div class="flex flex-col items-end">
                      <span class="font-semibold">Cantidad</span>
                      <span class="text-[11px] opacity-70">Merma</span>
                    </div>
                  </th>
                </tr>
              </thead>
        <tbody id="insumos-mermas-body"></tbody>
      </table>
      <div class="flex items-center justify-end mt-3">
        <button id="btn-add-merma" class="btn-outline px-3 py-2 rounded text-sm bg-white hover:bg-amber-50">Agregar merma</button>
      </div>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">
          <div class="insumos-panel overflow-x-auto lg:col-span-3">
            <div class="flex justify-between items-center mb-2">
              <h3 class="insumos-panel-title">üìà Consumo semanal</h3>
              <div class="flex items-center gap-2">
                <label class="text-sm opacity-70">Semanas</label>
                <select id="ins-semanas-select" class="input-modern p-1 rounded text-sm">
                  <option value="4">4</option>
                  <option value="8" selected>8</option>
                  <option value="12">12</option>
                </select>
                <button id="ins-weekly-export" class="btn-outline px-3 py-1 rounded text-sm">Exportar CSV</button>
              </div>
            </div>
            <table class="w-full text-left table-nice insumos-table text-sm">
              <thead>
                <tr>
                  <th class="p-2">
                    <div class="flex flex-col">
                      <span class="font-semibold">Semana</span>
                      <span class="text-[11px] opacity-70">Rango de fechas</span>
                    </div>
                  </th>
                  <th class="p-2">
                    <div class="flex flex-col">
                      <span class="font-semibold">Top ingredientes</span>
                      <span class="text-[11px] opacity-70">M√°s consumidos</span>
                    </div>
                  </th>
                  <th class="p-2 text-right">
                    <div class="flex flex-col items-end">
                      <span class="font-semibold">Total unidades</span>
                      <span class="text-[11px] opacity-70">Suma semanal</span>
                    </div>
                  </th>
                </tr>
              </thead>
              <tbody id="insumos-weekly-body"></tbody>
            </table>
          </div>
        </div>
        </div>
      </section>

      <!-- Inventario (debajo de Insumos) -->
      <section id="view-inventario" class="view">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-extrabold section-title" style="color:var(--burger-dark)">üóÉÔ∏è Stock de Ingredientes</h2>
          <div class="text-sm opacity-70">Registra compras y controla existencias</div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div class="panel overflow-x-auto lg:col-span-2">
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-bold">Stock actual</h3>
              <button id="inv-sync-consumo" class="btn-outline px-3 py-1 rounded text-xs" title="Crear compras de ajuste para igualar compras con consumo">Igualar compras con consumo</button>
            </div>
            <table class="w-full text-left table-nice ingredientes-table text-sm">
              <thead>
                <tr>
                  <th class="p-2 sticky-col">
                    <div class="flex flex-col">
                      <span class="font-semibold">Ingrediente</span>
                      <span class="text-[11px] opacity-70">Nombre</span>
                    </div>
                  </th>
                  <th class="p-2">
                    <div class="flex flex-col">
                      <span class="font-semibold">Unidad</span>
                      <span class="text-[11px] opacity-70">Formato</span>
                    </div>
                  </th>
                  <th class="p-2 text-right">
                    <div class="flex flex-col items-end">
                      <span class="font-semibold">Comprado</span>
                      <span class="text-[11px] opacity-70">Unidades</span>
                    </div>
                  </th>
                  <th class="p-2 text-right">
                    <div class="flex flex-col items-end">
                      <span class="font-semibold">Consumido</span>
                      <span class="text-[11px] opacity-70">+ merma</span>
                    </div>
                  </th>
                  <th class="p-2 text-right">
                    <div class="flex flex-col items-end">
                      <span class="font-semibold">Disponible</span>
                      <span class="text-[11px] opacity-70">Unidades</span>
                    </div>
                  </th>
                  <th class="p-2">
                    <div class="flex flex-col items-start">
                      <span class="font-semibold">Acciones</span>
                      <span class="text-[11px] opacity-70">Compras</span>
                    </div>
                  </th>
                </tr>
              </thead>
              <tbody id="inv-stock-body"></tbody>
            </table>
          </div>
          <div class="panel overflow-x-auto">
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-bold">Historial de compras</h3>
              <button id="compras-export-pdf" class="btn-outline px-3 py-1 rounded text-sm">Descargar PDF</button>
            </div>
            <table class="w-full text-left table-nice ingredientes-table text-sm">
              <thead><tr>
                <th class="p-2">Fecha</th>
                <th class="p-2">Ingrediente</th>
                <th class="p-2 text-right">Unid/Paquete</th>
                <th class="p-2 text-right">Precio/Unidad</th>
                <th class="p-2 text-right">Piezas</th>
                <th class="p-2 text-right">Unidades</th>
                <th class="p-2 text-right">Costo</th>
                <th class="p-2">Acciones</th>
              </tr></thead>
              <tbody id="inv-compras-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Recomendaci√≥n de Compras -->
      <section id="view-recomendaciones" class="view">
        <div class="flex justify-between items-center mb-4">
          <div>
            <h2 class="text-2xl font-extrabold section-title" style="color:var(--burger-dark)">üõí Recomendaci√≥n de Compras</h2>
            <p class="text-xs md:text-sm opacity-70 mt-1">Basado en consumo promedio, horizonte elegido y stock actual.</p>
          </div>
          <div class="hidden md:flex flex-col items-end text-xs md:text-sm opacity-75">
            <span class="font-semibold">Atajos r√°pidos</span>
            <span>1‚Äì3 d√≠as para reposici√≥n diaria, 7+ d√≠as para compras grandes.</span>
          </div>
        </div>
        <div class="panel mb-4">
          <div class="flex flex-col lg:flex-row lg:items-end gap-3">
            <div class="flex items-center gap-2">
              <label class="text-sm font-bold">Periodo</label>
              <select id="rec-period-select" class="input-modern p-2 rounded">
                <option value="7d">√öltimos 7 d√≠as</option>
                <option value="today">Hoy</option>
                <option value="30d" selected>√öltimos 30 d√≠as</option>
                <option value="month">Este mes</option>
                <option value="all">Todo</option>
                <option value="custom">Personalizado</option>
              </select>
            </div>
            <div id="rec-custom-range" class="hidden flex items-center gap-2">
              <input id="rec-date-start" type="date" class="input-modern p-2 rounded" />
              <span class="opacity-60">a</span>
              <input id="rec-date-end" type="date" class="input-modern p-2 rounded" />
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm font-bold">Horizonte</label>
              <input id="rec-horizon-days" type="number" class="input-modern p-2 rounded w-24" min="1" step="1" value="3" />
              <span class="text-sm">d√≠as de cobertura</span>
              <div class="flex items-center gap-1 ml-2">
                <button class="px-2 py-1 rounded border text-xs md:text-sm rec-quick-days" data-days="1">1d</button>
                <button class="px-2 py-1 rounded border text-xs md:text-sm rec-quick-days" data-days="2">2d</button>
                <button class="px-2 py-1 rounded border text-xs md:text-sm rec-quick-days" data-days="3">3d</button>
              </div>
            </div>
            <div class="flex items-center gap-3 ml-auto">
              <label class="text-xs md:text-sm flex items-center gap-2"><input id="rec-select-all" type="checkbox"> Seleccionar todo</label>
              <button id="rec-export-pdf" class="btn-outline px-3 py-2 rounded text-xs md:text-sm">Descargar PDF</button>
            </div>
          </div>
        </div>
        <div class="panel overflow-x-auto">
          <div class="flex justify-between items-center mb-2">
            <div>
              <h3 class="font-bold text-sm md:text-base">Sugerencias por ingrediente</h3>
              <p class="text-xs opacity-60">Ordenadas por d√©ficit m√°s alto primero.</p>
            </div>
            <span class="hidden md:inline-flex text-[0.7rem] px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200">Click en ‚ÄúAgregar compra‚Äù para registrar directo en inventario</span>
          </div>
          <table class="w-full text-left table-nice ingredientes-table text-xs md:text-sm">
            <thead>
              <tr>
                <th class="p-2 text-center text-[0.7rem] w-10">Sel.</th>
                <th class="p-2">Ingrediente</th>
                <th class="p-2 text-[0.7rem]">Unidad</th>
                <th class="p-2 text-right text-[0.7rem]">Disponible</th>
                <th class="p-2 text-right text-[0.7rem]">Prom. diario</th>
                <th class="p-2 text-right text-[0.7rem]">Req. horizonte</th>
                <th class="p-2 text-right text-[0.7rem]">D√©ficit</th>
                <th class="p-2 text-right text-[0.7rem]">Sugerencia</th>
                <th class="p-2 text-right text-[0.7rem]">Costo est.</th>
                <th class="p-2 text-[0.7rem]">Acciones</th>
              </tr>
            </thead>
            <tbody id="rec-body"></tbody>
          </table>
          <div id="rec-empty" class="text-sm opacity-60 mt-2 hidden">No se requieren compras para el horizonte seleccionado.</div>
        </div>
      </section>

      <!-- Clientes -->
      <section id="view-clientes" class="view">
        <div class="flex flex-col gap-3 mb-4">
          <div class="flex justify-between items-center">
            <h2 class="text-2xl font-extrabold section-title" style="color:var(--burger-dark)">üë• Gesti√≥n de Clientes</h2>
            <div class="flex gap-2">
              <button id="open-clientes-modal" class="btn-gradient px-4 py-2 rounded">‚ûï Nuevo Cliente</button>
              <button id="import-clientes-preset" class="btn-outline px-3 py-2 rounded">üì• Importar Clientes</button>
            </div>
          </div>
          <div class="client-toolbar grid grid-cols-1 md:grid-cols-3 gap-2">
            <div>
              <label class="block text-sm font-bold mb-1">Buscar cliente</label>
              <input id="clientes-search" type="text" class="w-full input-modern p-2 rounded" placeholder="Nombre, tel√©fono o direcci√≥n" />
            </div>
            <div>
              <label class="block text-sm font-bold mb-1">Ordenar por</label>
              <select id="clientes-sort" class="w-full input-modern p-2 rounded">
                <option value="nombre">Nombre (A-Z)</option>
                <option value="puntos">Puntos (desc)</option>
                <option value="gasto">Gasto total (desc)</option>
                <option value="reciente">M√°s reciente</option>
              </select>
            </div>
            <div class="flex items-end gap-2">
              <button id="clientes-view-cards" class="px-3 py-2 rounded border bg-white">Tarjetas</button>
              <button id="clientes-view-table" class="px-3 py-2 rounded border">Tabla</button>
            </div>
          </div>
        </div>
  <div class="panel">
          <div id="clientes-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 text-base"></div>
          <div id="clientes-table-wrapper" class="overflow-x-auto hidden mt-4">
            <table class="w-full text-left table-nice ingredientes-table text-sm md:text-base">
              <thead>
                <tr>
                  <th class="p-2">Nombre</th>
                  <th class="p-2">Tel√©fono</th>
                  <th class="p-2">Direcci√≥n</th>
                  <th class="p-2 text-right">Gasto Total</th>
                  <th class="p-2 text-right">Puntos</th>
                  <th class="p-2">Acciones</th>
                </tr>
              </thead>
              <tbody id="clientes-list-body"></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modales b√°sicos -->
  <div id="modal-backdrop" class="fixed inset-0 backdrop-blur-sm hidden z-40" style="background:rgba(0,0,0,.5); pointer-events:none;"></div>
  <div id="modal-container" class="fixed inset-0 hidden z-50 flex items-center justify-center p-6" style="pointer-events:auto;"></div>

  <!-- Modal: Inicio de sesi√≥n / Registro Gestia -->
  <div id="hero-auth-overlay" class="fixed inset-0 hidden z-[60] flex items-center justify-center px-4" style="background:rgba(15,23,42,.70);">
    <div class="bg-white rounded-2xl border border-slate-300 max-w-md w-full p-6 md:p-8 shadow-lg">
      <div class="flex items-center justify-between mb-4">
        <div>
          <p class="text-[11px] uppercase tracking-[0.25em] text-slate-500 mb-1">Acceso a Gestia</p>
          <h3 id="hero-auth-title" class="text-xl md:text-2xl font-extrabold text-slate-900">Inicia sesi√≥n</h3>
        </div>
        <button id="hero-auth-close" class="text-slate-400 hover:text-slate-600 text-xl leading-none" aria-label="Cerrar">√ó</button>
      </div>
      <p id="hero-auth-subtitle" class="text-sm text-slate-600 mb-4">Usa tu correo y contrase√±a para conectar tu punto de venta.</p>
      <div class="space-y-3 mb-4">
        <div>
          <label class="text-xs font-semibold text-slate-600 block mb-1">Correo</label>
          <input id="hero-auth-email" type="email" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="tucorreo@negocio.com" />
        </div>
        <div>
          <label class="text-xs font-semibold text-slate-600 block mb-1">Contrase√±a</label>
          <input id="hero-auth-pass" type="password" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
      </div>
      <div class="flex flex-col gap-2 mb-2">
        <button id="hero-modal-login" class="w-full px-4 py-2.5 rounded-full text-sm font-semibold text-white" style="background:linear-gradient(135deg,var(--burger-accent),var(--burger-tomato))">Iniciar sesi√≥n</button>
        <button id="hero-modal-signup" class="w-full px-4 py-2.5 rounded-full text-sm font-semibold border border-slate-300 text-slate-800 bg-white">Crear cuenta nueva</button>
      </div>
      <p class="text-[11px] text-slate-500">Tus datos se guardan en tu propio proyecto de Firebase. Puedes cambiar de dispositivo sin perder el historial.</p>
    </div>
  </div>

  <script>
    // Estado global
  const initialAppState = { ingredientes: [], productos: [], clientes: [], ventas: [], pedidosPendientes: [], insumosConsumo: { totales:{}, historial:[], merma:[] }, inventario:{ compras:[] }, finanzas:{ empleados:[], servicios:[], asignaciones:[], allocBase:'revenue', gastos:[] }, cajaTransferencias: [], cajaPendientes: [], cajaIngresos: [], mesas: [], mesaOrders: {}, nextSaleNumber: 1, estaciones: [], categorias: [] };
  let appState = JSON.parse(JSON.stringify(initialAppState));
  let currentOrder = { items: [], clienteId: null, subtotal: 0, total: 0, descuento: 0, costoEnvio: 0, tipo:'local', mesaId: null, pago:null };
  let __processingSale = false;
  let posCategoryFilter = 'all';
  let suspendedOrders = [];

    // Utilidades
    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
    const fmt = (n)=>'$'+(Number(n)||0).toFixed(2);
    const hideLoading = ()=>{ const el=$('#loading-overlay'); if(el){ el.style.display='none'; el.style.pointerEvents='none'; } };
    const USER_STATE_PREFIX = 'pointsell:user-state:v1:';
    let __activeUid = null;

    function getActiveUser(){
      const u = window.auth?.currentUser;
      if(!u || u.isAnonymous) return null;
      return u;
    }
    function getActiveUid(){ return getActiveUser()?.uid || null; }
    function getUserStateKey(uid){ return USER_STATE_PREFIX + String(uid||''); }

    let __saveExtrasTimer = null;
    window.__applyingUserExtrasFromFirestore = window.__applyingUserExtrasFromFirestore || false;

    const saveLS = ()=>{
      try{
        const uid = getActiveUid();
        if(!uid) return;
        localStorage.setItem(getUserStateKey(uid), JSON.stringify(appState));
      }catch(e){ console.warn('localStorage', e); }

      // Adem√°s del cache local, persistimos ‚Äúextras‚Äù en Firestore (caja/mesas/estaciones/etc.)
      // usando debounce para no saturar la red.
      try{
        if(window.__applyingUserExtrasFromFirestore) return;
        const uid = getActiveUid();
        if(!uid) return;
        if(typeof isFirestoreReady==='function' && !isFirestoreReady()) return;
        clearTimeout(__saveExtrasTimer);
        __saveExtrasTimer = setTimeout(()=>{ try{ saveUserExtrasToFirestore?.(); }catch(_){ } }, 650);
      }catch(_){ }
    };

    const loadLSForUid = (uid)=>{
      try{
        if(!uid) return;
        const s = localStorage.getItem(getUserStateKey(uid));
        if(!s) return;
        // Siempre partimos de un estado limpio para evitar ‚Äúmezclar‚Äù usuarios
        const parsed = JSON.parse(s);
        appState = { ...JSON.parse(JSON.stringify(initialAppState)), ...(parsed||{}) };
      }catch(e){ console.warn('localStorage', e); }
    };

    function resetAppState(opts){
      const { persist = true } = (opts && typeof opts==='object') ? opts : { persist:true };
      appState = JSON.parse(JSON.stringify(initialAppState));
      currentOrder = { items: [], clienteId: null, subtotal: 0, total: 0, descuento: 0, costoEnvio: 0, tipo:'local', mesaId: null, pago:null };
      suspendedOrders = [];
      if(persist){
        try{ saveLS(); }catch(_){ }
      }
      try{ renderAll(); renderPosProductList(); renderPedidosPendientes(); }catch(_){ }
    }

    function sanitizeState(){
      // Asegurar arrays y quitar entradas inv√°lidas que rompen render/acciones
      if(!Array.isArray(appState.ingredientes)) appState.ingredientes = [];
      if(!Array.isArray(appState.productos)) appState.productos = [];
      if(!Array.isArray(appState.estaciones)) appState.estaciones = [];
      if(!Array.isArray(appState.categorias)) appState.categorias = [];
      if(!Array.isArray(appState.clientes)) appState.clientes = [];
      if(!Array.isArray(appState.ventas)) appState.ventas = [];
  if(!Array.isArray(appState.pedidosPendientes)) appState.pedidosPendientes = [];
  if(!appState.insumosConsumo) appState.insumosConsumo = { totales:{}, historial:[], merma:[] };
  if(!appState.insumosConsumo.merma) appState.insumosConsumo.merma = [];
  if(!appState.inventario) appState.inventario = { compras:[] };
  if(!Array.isArray(appState.inventario.compras)) appState.inventario.compras = [];
  if(!Array.isArray(appState.insumosConsumo.merma)) appState.insumosConsumo.merma = [];
  if(!appState.finanzas) appState.finanzas = { empleados:[], servicios:[], asignaciones:[], allocBase:'revenue', gastos:[] };
  if(!Array.isArray(appState.finanzas.empleados)) appState.finanzas.empleados = [];
  if(!Array.isArray(appState.finanzas.servicios)) appState.finanzas.servicios = [];
  if(!Array.isArray(appState.finanzas.asignaciones)) appState.finanzas.asignaciones = [];
  if(!Array.isArray(appState.finanzas.gastos)) appState.finanzas.gastos = [];
  if(!appState.finanzas.allocBase) appState.finanzas.allocBase = 'revenue';
  if(!Array.isArray(appState.cajaTransferencias)) appState.cajaTransferencias = [];
  if(!Array.isArray(appState.cajaPendientes)) appState.cajaPendientes = [];
  if(!Array.isArray(appState.cajaIngresos)) appState.cajaIngresos = [];
  if(!Array.isArray(appState.mesas)) appState.mesas = [];
  if(!appState.mesaOrders || typeof appState.mesaOrders!=='object') appState.mesaOrders = {};
      ensureDefaultStations();
      ensureDefaultCategorias();
      appState.ingredientes = appState.ingredientes.filter(i=> i && typeof i === 'object' && i.nombre);
      if(typeof appState.nextSaleNumber !== 'number' || appState.nextSaleNumber < 1){ appState.nextSaleNumber = 1; }
    }

    function ensureDefaultStations(){
      if(!Array.isArray(appState.estaciones)) appState.estaciones = [];
      // Ya no creamos estaciones base por defecto.
      // Adem√°s, eliminamos el flag "fixed" de estaciones antiguas para que todas
      // sean editables/eliminables por el usuario.
      appState.estaciones = appState.estaciones.map(st => {
        if(!st || typeof st !== 'object') return st;
        const copy = { ...st };
        if(copy.fixed) delete copy.fixed;
        return copy;
      }).filter(st => st && typeof st === 'object');
    }

    function canonicalCategoriaKey(rawKey, rawName){
      let k = (rawKey||'').toString().trim().toLowerCase();
      if(!k && rawName) k = rawName.toString().trim().toLowerCase();
      const map = {
        'bebidas':'bebida',
        'hamburguesas':'hamburguesa',
        'complementos':'complemento',
        'postres':'postre',
        'hotdogs':'hotdog',
        'combos':'combo'
      };
      if(map[k]) k = map[k];
      return k;
    }

    function ensureDefaultCategorias(){
      if(!Array.isArray(appState.categorias)) appState.categorias = [];
      // Normalizar claves (singular/plural) y quitar duplicados existentes
      if(appState.categorias.length > 1){
        const byKey = new Map();
        for(const c of appState.categorias){
          if(!c) continue;
          const key = canonicalCategoriaKey(c.key, c.nombre);
          if(!key) continue;
          const existing = byKey.get(key);
          if(!existing){
            byKey.set(key, { ...c, key });
          }else{
            const nombrePreferido = (existing.nombre && existing.nombre.length >= (c.nombre||'').length)
              ? existing.nombre
              : (c.nombre || existing.nombre);
            byKey.set(key, { ...existing, nombre: nombrePreferido, key });
          }
        }
        appState.categorias = Array.from(byKey.values());
      }
      // Ya no a√±adimos categor√≠as base por defecto; solo derivamos de productos existentes.
      const ensure = (key, nombre)=>{
        key = canonicalCategoriaKey(key, nombre);
        if(!key) return;
        let cat = appState.categorias.find(c=>c && c.key===key);
        if(!cat){
          cat = { id: generateId('cat'), key, nombre: (nombre||'').trim() || key.charAt(0).toUpperCase()+key.slice(1) };
          appState.categorias.push(cat);
        } else {
          if(!cat.nombre && nombre) cat.nombre = nombre;
        }
      };
      (appState.productos||[]).forEach(p=>{
        const raw = (p.categoria||'').toString().trim();
        if(!raw) return;
        const key = canonicalCategoriaKey(raw, raw);
        ensure(key, raw);
      });
    }

    // --- Inventario ---
    function unitsPerPiece(ing){
      const up = Number(ing?.unidadesPaquete)||0; return up>0? up: 1;
    }
    function computeStock(){
      // Map ingredientId -> { compradoUnidades, comprasPiezas }
      const stock = {};
      (appState.inventario.compras||[]).forEach(c=>{
        if(c?.cancelada) return; // exclude canceled purchases from available stock
        const unid = Number(c.piezas||0) * unitsPerPiece(getIngredientById(c.ingredienteId));
        if(!stock[c.ingredienteId]) stock[c.ingredienteId] = { compradoUnidades:0, comprasPiezas:0 };
        stock[c.ingredienteId].compradoUnidades += unid;
        stock[c.ingredienteId].comprasPiezas += Number(c.piezas||0);
      });
      return stock;
    }
    function syncInventarioComprasConConsumo(){
      try{
        if(!window.confirm('Esto crear√° compras de ajuste para que el total comprado sea al menos igual al consumido+merma de cada ingrediente. ¬øContinuar?')) return;
        if(!appState.inventario) appState.inventario = { compras:[] };
        if(!Array.isArray(appState.inventario.compras)) appState.inventario.compras = [];

        const stockBase = computeStock();
        const totales = appState.insumosConsumo?.totales || {};
        const mermaArr = Array.isArray(appState.insumosConsumo?.merma) ? appState.insumosConsumo.merma : [];
        const mermaByIng = {};
        mermaArr.forEach(m=>{
          if(!m || !m.ingredienteId) return;
          mermaByIng[m.ingredienteId] = (mermaByIng[m.ingredienteId]||0) + Number(m.cantidad||0);
        });

        const nowIso = new Date().toISOString();
        let created = 0;

        (appState.ingredientes||[]).forEach(ing=>{
          if(!ing || !ing.id) return;
          const compradoUnid = stockBase[ing.id]?.compradoUnidades || 0;
          const consumido = Number(totales[ing.id]||0) + Number(mermaByIng[ing.id]||0);
          const deficit = consumido - compradoUnid;
          if(deficit <= 0.0001) return;

          const upp = unitsPerPiece(ing) || 1;
          const unidades = deficit;
          const piezas = unidades / upp;
          const unitCost = getUnitCost(ing) || 0;
          const precioUnidad = unitCost;
          const precioPaquete = unitCost * upp;
          const costo = unitCost>0 ? unidades * unitCost : 0;

          const compra = {
            id: generateId('cmp'),
            ingredienteId: ing.id,
            tipoCompra: 'individual',
            piezas,
            unidades,
            precioPaquete,
            precioUnidad,
            costo,
            nota: 'Ajuste autom√°tico (compra individual) para igualar compras con consumo',
            fecha: nowIso
          };
          appState.inventario.compras.push(compra);
          if(typeof saveCompraToFirestore==='function'){
            try{ saveCompraToFirestore(compra); }catch(_){ }
          }
          created++;
        });

        if(!created){
          alert('No se encontraron diferencias: las compras ya cubren el consumo.');
          return;
        }

        saveLS();
        renderInventario();
        alert(`Se crearon ${created} compras de ajuste para igualar compras con consumo.`);
      }catch(e){
        console.warn('syncInventarioComprasConConsumo', e);
        alert('No se pudo ejecutar el ajuste autom√°tico de inventario.');
      }
    }
    // Construir una descripci√≥n bonita a partir de la receta (para POS)
    function humanJoin(arr){
      if(!Array.isArray(arr) || arr.length===0) return '';
      if(arr.length===1) return arr[0];
      if(arr.length===2) return `${arr[0]} y ${arr[1]}`;
      return `${arr.slice(0,-1).join(', ')} y ${arr[arr.length-1]}`;
    }
    function basePhraseFor(name){
      const n = (name||'').toLowerCase();
      // Usa un conector neutro y corto
      if(n.includes('hamburguesa')||n.includes('hotdog')||n.includes('hot dog')||n.includes('papas')) return 'Con';
      return 'Con';
    }
    function buildProductDescription(p){
      try{
        const txt = (p?.descripcion||'').toString().trim();
        if(txt && txt.length>=6) return txt;
        
        // Handle new combo products with comboConfig
        if(p?.tipo === 'combo' && p?.comboConfig) {
          const comboItems = [];
          const config = p.comboConfig;

          if(Array.isArray(config.categorias) && config.categorias.length>0){
            config.categorias.forEach(c=>{
              const qty = Math.max(1, Number(c?.cantidad)||1);
              const label = (c?.categoria||'').toString().trim();
              if(!label) return;
              const qtyText = qty > 1 ? `${qty}x ` : '';
              comboItems.push(`${qtyText}${label}`);
            });
          }
          
          if(config.hamburguesas) {
            const qty = config.hamburguesas.cantidad || 1;
            const qtyText = qty > 1 ? `${qty}x ` : '';
            comboItems.push(`${qtyText}Hamburguesa${qty > 1 ? 's' : ''}`);
          }
          
          if(config.papas) {
            const size = config.papas.tama√±o || 'M';
            comboItems.push(`Papas ${size}`);
          }
          
          if(config.aros) {
            const size = config.aros.tama√±o || 'M';
            comboItems.push(`Aros ${size}`);
          }
          
          if(config.hotdogs) {
            const qty = config.hotdogs.cantidad || 1;
            const qtyText = qty > 1 ? `${qty}x ` : '';
            comboItems.push(`${qtyText}Hotdog${qty > 1 ? 's' : ''}`);
          }
          
          if(config.complementos && config.complementos.length > 0) {
            const complements = [];
            for(const comp of config.complementos) {
              const product = appState.productos.find(p => p.id === comp.productId);
              if(product) {
                const qty = comp.cantidad > 1 ? `${comp.cantidad}x ` : '';
                complements.push(`${qty}${product.nombre}`);
              }
            }
            if(complements.length > 0) {
              comboItems.push(complements.join(', '));
            }
          }
          
          if(comboItems.length > 0) {
            return `Combo incluye: ${comboItems.join(', ')}.`;
          }
        }
        
        // Handle legacy combo products (for backward compatibility)
        if(p?.tipo === 'combo' && Array.isArray(p?.comboProductos) && p.comboProductos.length > 0) {
          const comboItems = [];
          for(const cp of p.comboProductos) {
            const product = appState.productos.find(prod => prod.id === cp.productId);
            if(product) {
              const qty = cp.cantidad > 1 ? `${cp.cantidad}x ` : '';
              comboItems.push(`${qty}${product.nombre}`);
            }
          }
          if(comboItems.length > 0) {
            return `Combo incluye: ${comboItems.join(', ')}.`;
          }
        }
        
        // Handle regular recipe products
        const receta = Array.isArray(p?.receta)? p.receta : [];
        if(receta.length===0) return '';
        const stop = ['sal','az√∫car','azucar','aceite','agua','hielo','harina','salsa','aderezo','catsup','ketchup','mostaza','mayonesa'];
        const items = [];
        for(const r of receta){
          const ing = getIngredientById(r.ingredienteId);
          const name = (ing?.nombre||'').toString();
          if(!name) continue;
          const ln = name.toLowerCase();
          if(stop.some(s=> ln.includes(s))) continue;
          items.push({ name, qty: Number(r.cantidad)||0 });
        }
        if(items.length===0) return '';
        items.sort((a,b)=> b.qty-a.qty);
        const top = [...new Set(items.slice(0,4).map(i=> i.name))];
        const phrase = basePhraseFor(p?.nombre);
        return `${phrase} ${humanJoin(top)}.`;
      }catch(_){ return (p?.descripcion||'').toString(); }
    }
    function renderInventario(){
      const sb = document.getElementById('inv-stock-body');
      const hb = document.getElementById('inv-compras-body');
      if(!sb || !hb) return;
      sb.innerHTML=''; hb.innerHTML='';
      const stock = computeStock();
      const totales = appState.insumosConsumo?.totales||{};
      const merma = appState.insumosConsumo?.merma||[];
      const mermaByIng = {};
      merma.forEach(m=>{ mermaByIng[m.ingredienteId] = (mermaByIng[m.ingredienteId]||0) + Number(m.cantidad||0); });
      // Consumo promedio diario (√∫ltimos 30 d√≠as) para calcular d√≠as de cobertura
      let startAvg = new Date(); startAvg.setDate(startAvg.getDate()-30);
      let endAvg = new Date();
      let avgMap = new Map();
      try{ avgMap = averageDailyConsumption(startAvg, endAvg); }catch(_){ avgMap = new Map(); }
      (appState.ingredientes||[]).forEach(ing=>{
        const unidPorPza = unitsPerPiece(ing);
        const compradoUnid = stock[ing.id]?.compradoUnidades||0;
        const consumido = Number(totales[ing.id]||0) + Number(mermaByIng[ing.id]||0);
        const disponible = Math.max(0, compradoUnid - consumido);
        const avgDay = avgMap.get(ing.id)?.avg || 0;
        const coverage = avgDay>0 ? (disponible/avgDay) : Infinity;
        let dispClass = 'inv-ok';
        if(Number.isFinite(coverage)){
          if(coverage >= 7) dispClass = 'inv-ok';
          else if(coverage >= 3) dispClass = 'inv-warn';
          else dispClass = 'inv-bad';
        } else {
          dispClass = 'inv-ok'; // sin consumo reciente => suficiente
        }
        const covTxt = Number.isFinite(coverage) ? `${coverage.toFixed(1)} d` : '‚Äî';
        const tr = document.createElement('tr');
        tr.className = 'ingredientes-table-row';
        tr.innerHTML = `
          <td class="p-2 sticky-col ingrediente-name-cell">${ing.nombre}</td>
          <td class="p-2 ingrediente-unit-cell">${(ing.unidad||'').toString()}</td>
          <td class="p-2 text-right num">${(stock[ing.id]?.compradoUnidades||0).toFixed(2)}</td>
          <td class="p-2 text-right num">${consumido.toFixed(2)}</td>
          <td class="p-2 text-right num"><span class="inv-chip ${dispClass}" title="${disponible.toFixed(2)} ${ing.unidad||''} ‚Ä¢ Cobertura ${covTxt}">${disponible.toFixed(2)}</span></td>
          <td class="p-2"><button class="px-2 py-1 rounded border text-sm btn-add-compra" data-id="${ing.id}">Agregar compra</button></td>`;
        sb.appendChild(tr);
      });
      // Historial compras
      const compras = (appState.inventario.compras||[]).slice().sort((a,b)=> new Date(b.fecha)-new Date(a.fecha));
  if(compras.length===0){ hb.innerHTML='<tr><td colspan="6" class="p-3 text-center opacity-60">Sin compras registradas</td></tr>'; }
      else compras.forEach(c=>{
        const ing = getIngredientById(c.ingredienteId);
        const unid = Number(c.piezas||0) * unitsPerPiece(ing);
  const upp = unitsPerPiece(ing);
  const unitLabel = (ing?.unidad||'').toString();
  const unitsInCompra = Number(c.unidades||0);
  const priceUnit = (Number(c.precioUnidad||0)) || (unitsInCompra>0 ? (Number(c.costo||0)/unitsInCompra) : (upp>0? (Number(c.precioPaquete||0)/upp) : 0));
        const tr = document.createElement('tr');
        const canceled = !!c.cancelada;
        const motivo = (c.motivoCancel||'').trim();
        tr.className = canceled ? 'opacity-60' : '';
        tr.innerHTML = `
          <td class="p-2">${new Date(c.fecha).toLocaleString()}${canceled?'<div class="text-xs text-red-700">Cancelado'+(motivo?`: ${motivo}`:'')+'</div>':''}</td>
          <td class="p-2">${ing?ing.nombre:'‚Äî'}</td>
          <td class="p-2 text-right num">${upp} ${unitLabel}</td>
          <td class="p-2 text-right num">${fmt(priceUnit)}</td>
          <td class="p-2 text-right num">${c.piezas||0}</td>
          <td class="p-2 text-right num">${unid}</td>
          <td class="p-2 text-right num">${fmt(c.costo||0)}</td>
          <td class="p-2">${canceled?'<span class="text-xs text-red-600">‚Äî</span>':`<button class="px-2 py-1 rounded border text-sm btn-cancel-compra" data-id="${c.id}">Cancelar</button>`}</td>`;
        hb.appendChild(tr);
      });
    }

    // Wire: bot√≥n Agregar compra (flujo en dos pasos)
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest && e.target.closest('.btn-add-compra');
      if(!btn) return;
      const ingId = btn.getAttribute('data-id');
      const ing = getIngredientById(ingId);
      if(!ing) return;

      const upp = unitsPerPiece(ing);

      const openPaqueteModal = ()=>{
        // Datos para aside
        const unit = ing.unidad||'unid';
        const uppText = `${upp} ${unit}`;
        const pricePkg = Number(ing.precioPaquete||0);
        const priceUnitEst = upp>0? pricePkg/upp : 0;
        const stockMap = computeStock();
        const disponible = Math.max(0, (stockMap[ing.id]?.compradoUnidades||0) - ((appState.insumosConsumo?.totales?.[ing.id]||0) + (appState.insumosConsumo?.merma||[]).reduce((s,m)=> m.ingredienteId===ing.id? s+Number(m.cantidad||0):s,0)));
        let startAvg = new Date(); startAvg.setDate(startAvg.getDate()-30); let endAvg = new Date();
        let avgDay = 0; try{ avgDay = averageDailyConsumption(startAvg,endAvg).get(ing.id)?.avg||0; }catch(_){ }
        const coverage = avgDay>0 ? (disponible/avgDay) : null;
        const covTxt = coverage!=null? `${coverage.toFixed(1)} d` : '‚Äî';
        const asideHtml = `
          <div class="text-sm space-y-2">
            <div class="font-bold">${ing.nombre}</div>
            <div><span class="opacity-70">Unid/Paquete:</span> <span class="font-semibold">${uppText}</span></div>
            <div><span class="opacity-70">Precio paquete(ing):</span> <span class="font-semibold">${fmt(pricePkg)}</span></div>
            <div><span class="opacity-70">Precio por ${unit} (est):</span> <span class="font-semibold">${fmt(priceUnitEst)}</span></div>
            <div><span class="opacity-70">Stock disp.:</span> <span class="font-semibold">${disponible.toFixed(2)} ${unit}</span></div>
            <div><span class="opacity-70">Consumo/d√≠a (30d):</span> <span class="font-semibold">${avgDay.toFixed(2)} ${unit}</span></div>
            <div><span class="opacity-70">Cobertura:</span> <span class="font-semibold">${covTxt}</span></div>
          </div>`;
        openFormModal({
          title:`Compra por paquete: ${ing.nombre}`,
          fields:[
            { type:'html', name:'info', html:`Ingresa el n√∫mero de paquetes y el precio por paquete. Este ingrediente tiene ${upp} ${ing.unidad||'unid'} por paquete.` },
            { name:'piezas', label:`N√∫mero de paquetes`, type:'number', min:1, step:'1', placeholder:`Ej. 10 paquetes` },
            { name:'precioPaquete', label:'Precio por paquete ($)', type:'number', min:0, step:'0.01', placeholder:'Ej. 120.00' },
            { name:'nota', label:'Nota (opcional)', type:'text' }
          ],
          submitText:'Registrar',
          aside: asideHtml,
          onSubmit:(data)=>{
            const piezas = Math.max(0, Number(data.piezas||0));
            const precioPaquete = Math.max(0, Number(data.precioPaquete||0));
            if(piezas<=0){ alert('Ingresa paquetes > 0'); return false; }
            if(precioPaquete<=0){ alert('Ingresa precio por paquete > 0'); return false; }
            const unidades = piezas * upp;
            const precioUnidad = precioPaquete / upp;
            const costo = piezas * precioPaquete;
            const compra = { id: generateId('cmp'), ingredienteId: ingId, tipoCompra:'paquete', piezas, unidades, precioPaquete, precioUnidad, costo, nota:(data.nota||'').trim(), fecha: new Date().toISOString() };
            appState.inventario.compras.push(compra);
            if(typeof saveCompraToFirestore==='function') saveCompraToFirestore(compra);
            saveLS(); renderInventario();
          }
        });
      };

      const openIndividualModal = ()=>{
        // Datos aside (mismos que paquete)
        const unit = ing.unidad||'unid';
        const uppText = `${upp} ${unit}`;
        const pricePkg = Number(ing.precioPaquete||0);
        const priceUnitEst = upp>0? pricePkg/upp : 0;
        const stockMap = computeStock();
        const disponible = Math.max(0, (stockMap[ing.id]?.compradoUnidades||0) - ((appState.insumosConsumo?.totales?.[ing.id]||0) + (appState.insumosConsumo?.merma||[]).reduce((s,m)=> m.ingredienteId===ing.id? s+Number(m.cantidad||0):s,0)));
        let startAvg = new Date(); startAvg.setDate(startAvg.getDate()-30); let endAvg = new Date();
        let avgDay = 0; try{ avgDay = averageDailyConsumption(startAvg,endAvg).get(ing.id)?.avg||0; }catch(_){ }
        const coverage = avgDay>0 ? (disponible/avgDay) : null;
        const covTxt = coverage!=null? `${coverage.toFixed(1)} d` : '‚Äî';
        const asideHtml = `
          <div class="text-sm space-y-2">
            <div class="font-bold">${ing.nombre}</div>
            <div><span class="opacity-70">Unid/Paquete:</span> <span class="font-semibold">${uppText}</span></div>
            <div><span class="opacity-70">Precio paquete(ing):</span> <span class="font-semibold">${fmt(pricePkg)}</span></div>
            <div><span class="opacity-70">Precio por ${unit} (est):</span> <span class="font-semibold">${fmt(priceUnitEst)}</span></div>
            <div><span class="opacity-70">Stock disp.:</span> <span class="font-semibold">${disponible.toFixed(2)} ${unit}</span></div>
            <div><span class="opacity-70">Consumo/d√≠a (30d):</span> <span class="font-semibold">${avgDay.toFixed(2)} ${unit}</span></div>
            <div><span class="opacity-70">Cobertura:</span> <span class="font-semibold">${covTxt}</span></div>
          </div>`;
        openFormModal({
          title:`Compra individual: ${ing.nombre}`,
          fields:[
            { type:'html', name:'info', html:`Ingresa la cantidad total en ${ing.unidad||'unid'} y el precio por ${ing.unidad||'unidad'}.` },
            { name:'unidades', label:`Cantidad (${ing.unidad||'unid'})`, type:'number', min:0, step:'0.01', placeholder:`Ej. ${upp} ${ing.unidad||'unid'}` },
            { name:'precioUnidad', label:`Precio por ${ing.unidad||'unidad'} ($)`, type:'number', min:0, step:'0.0001', placeholder:'Ej. 0.80' },
            { name:'nota', label:'Nota (opcional)', type:'text' }
          ],
          submitText:'Registrar',
          aside: asideHtml,
          onSubmit:(data)=>{
            const unidades = Math.max(0, Number(data.unidades||0));
            const precioUnidad = Math.max(0, Number(data.precioUnidad||0));
            if(unidades<=0){ alert(`Ingresa ${ing.unidad||'unidades'} > 0`); return false; }
            if(precioUnidad<=0){ alert('Ingresa precio por unidad > 0'); return false; }
            const piezas = unidades / upp;
            const precioPaquete = precioUnidad * upp;
            const costo = unidades * precioUnidad;
            const compra = { id: generateId('cmp'), ingredienteId: ingId, tipoCompra:'individual', piezas, unidades, precioPaquete, precioUnidad, costo, nota:(data.nota||'').trim(), fecha: new Date().toISOString() };
            appState.inventario.compras.push(compra);
            if(typeof saveCompraToFirestore==='function') saveCompraToFirestore(compra);
            saveLS(); renderInventario();
          }
        });
      };

      // Paso 1: escoger tipo (dropdown literal)
      openFormModal({
        title:`Agregar compra: ${ing.nombre}`,
        fields:[ { name:'tipo', label:'Tipo', type:'select', value:'paquete', options:[{label:'Paquete', value:'paquete'},{label:'Individual', value:'individual'}] } ],
        submitText:'Continuar',
        onSubmit:(data)=>{
          // Cerrar este modal ANTES de abrir el siguiente para evitar que se cierre inmediatamente
          const t = String(data.tipo||'paquete');
          closeModal();
          setTimeout(()=>{ if(t==='individual') openIndividualModal(); else openPaqueteModal(); }, 0);
          // Evita el auto-close posterior del contenedor
          return false;
        }
      });
      // Avanzar autom√°ticamente al cambiar la opci√≥n del dropdown (sin presionar Continuar)
      setTimeout(()=>{
        try{
          const sel = document.querySelector('#dynamic-form select[name="tipo"]');
          if(sel){
            sel.addEventListener('change', (ev)=>{
              const t = String(ev.target.value||'paquete');
              closeModal();
              setTimeout(()=>{ if(t==='individual') openIndividualModal(); else openPaqueteModal(); }, 0);
            }, { once: true });
          }
        }catch(_){ }
      }, 0);
    });

    // Wire: cancelar compra con motivo
    document.addEventListener('click', async (e)=>{
      const btn = e.target.closest && e.target.closest('.btn-cancel-compra');
      if(!btn) return;
      const id = btn.getAttribute('data-id');
      const compra = (appState.inventario?.compras||[]).find(x=> x.id===id);
      if(!compra) return;
      if(compra.cancelada){ alert('Esta compra ya est√° cancelada.'); return; }
      const ing = getIngredientById(compra.ingredienteId);
      const label = `${ing?ing.nombre:'Ingrediente'} ‚Ä¢ ${new Date(compra.fecha).toLocaleString()} ‚Ä¢ ${compra.piezas||0} pzas`;
      let motivo = prompt(`Motivo de cancelaci√≥n para:\n${label}\n(Obligatorio)`);
      if(motivo===null) return; // user cancelled
      motivo = String(motivo||'').trim();
      if(!motivo){ alert('Debes especificar un motivo.'); return; }
      if(!confirm('¬øCancelar esta compra? No se contar√° en stock ni gastos.')) return;
      compra.cancelada = true;
      compra.motivoCancel = motivo;
      compra.cancelAt = new Date().toISOString();
      saveLS();
      try{ if(typeof saveCompraCancelToFirestore==='function') await saveCompraCancelToFirestore(compra); }catch(_){}
      renderInventario();
      // Recalcular reportes de gastos (se basan en compras)
      try{ updateDashboard?.(); }catch(_){ }
    });
    // Asegurar numeraci√≥n secuencial de ventas (Venta1, Venta2, ...)
    function assignSaleNumbersIfMissing(){
      try{
        const ventas = Array.isArray(appState.ventas) ? appState.ventas : [];
        const missing = ventas.some(v=> typeof v.saleNumber !== 'number' || v.saleNumber < 1);
        if(!missing){
          const maxNum = ventas.reduce((m,v)=> Math.max(m, v.saleNumber||0), 0);
          appState.nextSaleNumber = Math.max(appState.nextSaleNumber||1, maxNum+1);
          return;
        }
        const ordered = ventas.slice().sort((a,b)=> new Date(a.fecha)-new Date(b.fecha));
        let n = 1;
        ordered.forEach(v=>{ v.saleNumber = n++; });
        appState.nextSaleNumber = n;
      }catch(e){ console.warn('assignSaleNumbersIfMissing', e); }
    }

    // --- Modales b√°sicos ---
    function closeModal(){ 
      const b=$('#modal-backdrop'); 
      const c=$('#modal-container'); 
      if(b){ 
        b.classList.add('hidden'); 
        b.style.display = 'none'; 
      } 
      if(c){ 
        c.classList.add('hidden'); 
        c.innerHTML=''; 
      }
      // Asegurar que no queden listeners fantasma
      document.body.style.overflow = '';
      document.documentElement.style.overflow = '';
    }
    function generateId(prefix){ return `${prefix}_${Date.now()}_${Math.random().toString(36).slice(2,6)}`; }
  function openFormModal({ title, fields, onSubmit, submitText='Guardar', aside }){
      let backdrop = $('#modal-backdrop');
      let container = $('#modal-container');
      // Crear si no existen
      if(!backdrop){ backdrop = document.createElement('div'); backdrop.id='modal-backdrop'; backdrop.className='fixed inset-0 backdrop-blur-sm hidden z-40'; backdrop.style.background='rgba(0,0,0,.5)'; backdrop.style.pointerEvents='none'; document.body.appendChild(backdrop); }
      if(!container){ container = document.createElement('div'); container.id='modal-container'; container.className='fixed inset-0 hidden z-50 flex items-center justify-center p-6'; container.style.pointerEvents='auto'; document.body.appendChild(container); }
      const hasAside = !!aside;
      const maxW = hasAside ? 'max-w-2xl' : 'max-w-md';
      const formInner = `
            ${fields.map(f=>{
              if(f.type==='textarea'){
                return `<div><label class="block text-sm font-bold mb-1">${f.label}</label><textarea name="${f.name}" rows="${f.rows||3}" class="w-full input-modern p-2 rounded" placeholder="${f.placeholder||''}">${f.value||''}</textarea></div>`;
              }
              if(f.type==='html'){
                return `<div class="text-sm opacity-70">${f.html||f.value||''}</div>`;
              }
              if(f.type==='combobox'){
                const listId = `dl-${f.name}-${Math.random().toString(36).slice(2,6)}`;
                const opts = (f.options||[]).map(o=>`<option value="${(o.label||o.value||'').toString().replace(/"/g,'&quot;')}"></option>`).join('');
                return `<div><label class="block text-sm font-bold mb-1">${f.label}</label><input type="text" name="${f.name}" class="w-full input-modern p-2 rounded" placeholder="${f.placeholder||''}" value="${f.value||''}" list="${listId}"><datalist id="${listId}">${opts}</datalist></div>`;
              }
              if(f.type==='select'){
                const opts = (f.options||[]).map(o=>{
                  const sel = (String(o.value)===String(f.value)) ? ' selected' : '';
                  return `<option value="${o.value}"${sel}>${o.label||o.value}</option>`;
                }).join('');
                return `<div><label class="block text-sm font-bold mb-1">${f.label}</label><select name="${f.name}" class="w-full input-modern p-2 rounded">${opts}</select></div>`;
              }
              return `<div><label class="block text-sm font-bold mb-1">${f.label}</label><input type="${f.type||'text'}" name="${f.name}" class="w-full input-modern p-2 rounded" placeholder="${f.placeholder||''}" value="${f.value||''}" ${f.min!=null?`min="${f.min}"`:''} ${f.step?`step="${f.step}"`:''}></div>`;
            }).join('')}
            <div class="flex gap-2 pt-2">
              <button type="submit" class="btn-success px-4 py-2 rounded">${submitText}</button>
              <button type="button" class="btn-danger px-4 py-2 rounded" id="cancel-modal-btn">Cancelar</button>
            </div>`;
      const body = `
        <div class="bg-white rounded-2xl shadow-2xl w-full ${maxW} overflow-hidden">
          <div class="modal-header-nice"><h3 class="text-base font-extrabold" style="color:var(--burger-dark)">${title}</h3></div>
          ${hasAside ? `
            <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-4">
              <form id="dynamic-form" class="space-y-3 md:col-span-2">${formInner}</form>
              <aside class="md:col-span-1">
                ${aside}
              </aside>
            </div>
          ` : `
            <form id="dynamic-form" class="space-y-3 p-6">${formInner}</form>
          `}
        </div>`;
      container.innerHTML = body;
      backdrop.classList.remove('hidden');
      backdrop.style.display = '';
      container.classList.remove('hidden');
      // Prevent background scroll on mobile
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';
      $('#cancel-modal-btn')?.addEventListener('click', closeModal);
      $('#dynamic-form')?.addEventListener('submit', (e)=>{
        e.preventDefault();
        const fd = new FormData(e.target);
        const data = Object.fromEntries(fd.entries());
        // Normalize numbers and resolve combobox selections to values
        let invalid = false;
        fields.forEach(f=>{
          if(f.type==='number') data[f.name] = parseFloat(data[f.name]||'0');
          if(f.type==='combobox'){
            const raw = (data[f.name]||'').toString().trim();
            const norm = (s)=> (s||'').toString().trim().toLowerCase();
            const opts = Array.isArray(f.options)? f.options: [];
            let match = opts.find(o=> norm(o.label)===norm(raw)) || opts.find(o=> norm(o.value)===norm(raw));
            if(!match && raw){
              const candidates = opts.filter(o=> norm(o.label).includes(norm(raw)));
              if(candidates.length===1){ match = candidates[0]; }
            }
            if(!match){ alert(`Selecciona un valor v√°lido para "${f.label}"`); invalid = true; return; }
            data[f.name] = match.value;
          }
        });
        if(invalid){ return; }
        try{
          const res = onSubmit?.(data);
          if(res === false){ return; }
        }catch(err){ console.warn('modal submit', err); }
        closeModal();
      });
    }

    // Modal simple de gu√≠a r√°pida (solo contenido informativo)
    function openGuideModal(){
      let backdrop = document.getElementById('modal-backdrop');
      let container = document.getElementById('modal-container');
      if(!backdrop){
        backdrop = document.createElement('div');
        backdrop.id = 'modal-backdrop';
        backdrop.className = 'fixed inset-0 backdrop-blur-sm hidden z-40';
        backdrop.style.background = 'rgba(0,0,0,.5)';
        backdrop.style.pointerEvents = 'none';
        document.body.appendChild(backdrop);
      }
      if(!container){
        container = document.createElement('div');
        container.id = 'modal-container';
        container.className = 'fixed inset-0 hidden z-50 flex items-center justify-center p-6';
        container.style.pointerEvents = 'auto';
        document.body.appendChild(container);
      }

      const body = `
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl overflow-hidden">
          <div class="modal-header-nice flex items-center justify-between">
            <h3 class="text-base md:text-lg font-extrabold" style="color:var(--burger-dark)">Gu√≠a r√°pida de m√≥dulos</h3>
            <button id="guide-close-btn" class="text-slate-400 hover:text-slate-600 text-xl leading-none" aria-label="Cerrar">√ó</button>
          </div>
          <div class="p-5 md:p-6 space-y-4 text-sm md:text-base text-slate-700 max-h-[70vh] overflow-y-auto">
            <p class="text-xs md:text-sm text-slate-500">Resumen corto de qu√© hace cada secci√≥n de Gestia.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <h4 class="font-bold mb-1">üèÅ Inicio</h4>
                <p>Pantalla de bienvenida y acceso a tu cuenta. Desde aqu√≠ puedes iniciar sesi√≥n o crear una nueva.</p>
              </div>
              <div>
                <h4 class="font-bold mb-1">üìä Dashboard</h4>
                <p>Resumen de ventas, tickets y productos m√°s vendidos en el periodo seleccionado.</p>
              </div>
              <div>
                <h4 class="font-bold mb-1">üìà Reportes</h4>
                <p>Gr√°ficas detalladas por tipo de orden, m√©todo de pago, d√≠as y rendimiento por producto.</p>
              </div>
              <div>
                <h4 class="font-bold mb-1">üí∞ Finanzas</h4>
                <p>Calcula margen bruto, sueldos, servicios, gastos diarios y utilidad estimada.</p>
              </div>
              <div>
                <h4 class="font-bold mb-1">üõí Punto de Venta</h4>
                <p>Donde cobras: elige productos, aplica descuentos, agrega env√≠o y registra el pago.</p>
              </div>
              <div>
                <h4 class="font-bold mb-1">üë®‚Äçüç≥ Pedidos</h4>
                <p>Cola de pedidos pendientes para cocina. Muestra lo que est√° en preparaci√≥n.</p>
              </div>
              <div>
                <h4 class="font-bold mb-1">üßæ Ventas</h4>
                <p>Historial completo de tickets con totales, costos, ganancia y opci√≥n de reimprimir.</p>
              </div>
              <div>
                <h4 class="font-bold mb-1">üçî Productos</h4>
                <p>Cat√°logo central. Aqu√≠ configuras precios, categor√≠as, recetas y estaciones de cada producto.</p>
              </div>
              <div>
                <h4 class="font-bold mb-1">üî• Estaciones</h4>
                <p>Define las √°reas de preparaci√≥n (parrilla, plancha, barra, etc.) y vinc√∫lalas a productos.</p>
              </div>
              <div>
                <h4 class="font-bold mb-1">ü•¨ Ingredientes</h4>
                <p>Lista de insumos con su unidad y costo unitario para usar en las recetas.</p>
              </div>
              <div>
                <h4 class="font-bold mb-1">üì¶ Insumos Gastados</h4>
                <p>Resumen de consumo de ingredientes por ventas y mermas, √∫til para controlar costos.</p>
              </div>
              <div>
                <h4 class="font-bold mb-1">üóÉÔ∏è Inventario</h4>
                <p>Registra compras y consulta existencias actuales de cada ingrediente.</p>
              </div>
              <div>
                <h4 class="font-bold mb-1">üõí Recomendaci√≥n de Compras</h4>
                <p>Calcula cu√°nto comprar seg√∫n consumo promedio y d√≠as de cobertura que elijas.</p>
              </div>
              <div>
                <h4 class="font-bold mb-1">üë• Clientes</h4>
                <p>Directorio de clientes con historial de gasto y puntos de lealtad.</p>
              </div>
            </div>
          </div>
        </div>`;

      container.innerHTML = body;
      backdrop.classList.remove('hidden');
      backdrop.style.display = '';
      container.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      document.getElementById('guide-close-btn')?.addEventListener('click', closeModal);
      backdrop.addEventListener('click', (e)=>{
        if(e.target===backdrop) closeModal();
      });
    }

    // --- Helpers de costos/recetas ---
    function getIngredientById(id){ return appState.ingredientes.find(i=>i.id===id); }
    function getUnitCost(ing){ if(!ing) return 0; const up=Number(ing.unidadesPaquete)||0; const pp=Number(ing.precioPaquete)||0; return up>0? pp/up : 0; }
    // Costo total de una receta (array de { ingredienteId, cantidad })
    function computeRecipeCost(receta){
      try{
        if(!Array.isArray(receta)) return 0;
        let total = 0;
        for(const r of receta){
          const ing = getIngredientById(r.ingredienteId);
          const qty = Number(r.cantidad)||0;
          if(ing && qty>0){ total += getUnitCost(ing) * qty; }
        }
        return total;
      }catch(e){ console.warn('computeRecipeCost', e); return 0; }
    }

    function calculateComboEstimatedCost(comboConfig) {
      let totalCost = 0;
      try {
        // Configuraci√≥n por categor√≠as (categor√≠as creadas)
        if (Array.isArray(comboConfig?.categorias) && comboConfig.categorias.length > 0) {
          const catKey = (s)=>{
            try{
              return (typeof canonicalCategoriaKey==='function' ? (canonicalCategoriaKey(s, s) || '') : '') || (s||'').toString().trim().toLowerCase();
            }catch(_){
              return (s||'').toString().trim().toLowerCase();
            }
          };
          const visible = (typeof getVisibleProducts==='function') ? getVisibleProducts() : (appState.productos||[]);
          comboConfig.categorias.forEach(cc=>{
            const categoria = (cc?.categoria||'').toString().trim();
            const qty = Math.max(1, parseInt(cc?.cantidad || '1', 10) || 1);
            if(!categoria) return;
            const key = catKey(categoria);
            const candidates = (visible||[]).filter(p=>{
              if(!p || p.tipo==='combo') return false;
              const pKey = catKey(p.categoria || p.clasificacion || '');
              return pKey === key;
            });
            if(candidates.length===0){ return; }
            const cheapest = candidates.reduce((min, p)=>{
              const c = Number(p?.costo)||0;
              if(!min) return p;
              const mc = Number(min?.costo)||0;
              return c < mc ? p : min;
            }, null);
            totalCost += (Number(cheapest?.costo)||0) * qty;
          });
          return totalCost;
        }

        // Hamburguesas
        if (comboConfig.hamburguesas) {
          const qty = comboConfig.hamburguesas.cantidad || 1;
          const defaultId = comboConfig.hamburguesas.defaultId;
          if (defaultId) {
            const product = appState.productos.find(p => p.id === defaultId);
            if (product) totalCost += (product.costo || 0) * qty;
          } else {
            // Estimate average burger cost
            totalCost += 45 * qty; // Base cost estimate
          }
        }

        // Papas
        if (comboConfig.papas) {
          const size = comboConfig.papas.tama√±o || 'M';
          const baseCost = size === 'XL' ? 25 : size === 'L' ? 20 : 15;
          totalCost += baseCost;
        }

        // Aros
        if (comboConfig.aros) {
          const size = comboConfig.aros.tama√±o || 'M';
          const baseCost = size === 'XL' ? 30 : size === 'L' ? 25 : 20;
          totalCost += baseCost;
        }

        // Hotdogs
        if (comboConfig.hotdogs) {
          const qty = comboConfig.hotdogs.cantidad || 1;
          const defaultId = comboConfig.hotdogs.defaultId;
          if (defaultId) {
            const product = appState.productos.find(p => p.id === defaultId);
            if (product) totalCost += (product.costo || 0) * qty;
          } else {
            // Estimate average hotdog cost
            totalCost += 35 * qty; // Base cost estimate
          }
        }

        return totalCost;
      } catch (e) {
        console.warn('calculateComboEstimatedCost', e);
        return 0;
      }
    }

    // --- Firestore: sincronizaci√≥n de productos ---
    let unsubscribeProducts = null;
    // Marca si ya recibimos al menos una sincronizaci√≥n desde Firestore para evitar crear duplicados antes de tiempo
    window.__productsSynced = window.__productsSynced || false;

    // Normaliza nombres para comparaciones (evita duplicados por may√∫sculas/espacios)
    function normalizeName(s){ return (s||'').toString().trim().toLowerCase(); }
    // Elige un √∫nico producto por nombre normalizado; prioriza no archivado y con receta/costos definidos
    function uniqueByProductName(list){
      try{
        const pickScore = (p)=>{
          let s = 0;
          if(p?.archivado) s -= 1000;
          if(Array.isArray(p?.receta) && p.receta.length>0) s += 10;
          if(Number(p?.costo)>0) s += 5;
          if(Number(p?.precio)>0) s += 1;
          return s;
        };
        const best = new Map();
        (Array.isArray(list)?list:[]).forEach(p=>{
          const key = normalizeName(p?.nombre);
          if(!key){ return; }
          const curr = best.get(key);
          if(!curr || pickScore(p) > pickScore(curr)) best.set(key, p);
        });
        return Array.from(best.values());
      }catch(_){ return Array.isArray(list)?list:[]; }
    }
    // Lista visible sin duplicados (por nombre) y no archivados
    let currentProductosFilter = 'all';
    function productMatchesFilter(p, filter){
      if(!filter || filter === 'all') return true;
      const key = filter.toString().toLowerCase();
      if(p.clasificacion && p.clasificacion.toLowerCase() === key) return true;
      if(p.categoria && p.categoria.toString().toLowerCase() === key) return true;
      if(key === 'combo' && p.tipo === 'combo') return true;
      return false;
    }
    function getVisibleProducts(){ 
      const all = uniqueByProductName(appState.productos||[]).filter(p=> !p.archivado);
      if (currentProductosFilter === 'all') return all;
      return all.filter(p => productMatchesFilter(p, currentProductosFilter));
    }
  let unsubscribeIngredientes = null;
  let unsubscribeClientes = null;
  let unsubscribeVentas = null;
  let unsubscribeCompras = null;
  let unsubscribeInsumos = null; // one doc per user
  let unsubscribePedidos = null;
  let unsubscribeMeta = null;
  let unsubscribeEmpleados = null;
  let unsubscribeServicios = null;
  let unsubscribeUserExtras = null; // caja/mesas/estaciones/categor√≠as/finanzas extras
    function isFirestoreReady(){ return !!(window.db && window.fs); }

    // --- Firestore: Extras de usuario (doc √∫nico por usuario) ---
    async function saveUserExtrasToFirestore(){
      try{
        if(!isFirestoreReady()) return;
        const uid = getActiveUid();
        if(!uid) return;
        const { doc, setDoc } = window.fs;
        const payload = {
          userId: uid,
          cajaTransferencias: Array.isArray(appState.cajaTransferencias) ? appState.cajaTransferencias : [],
          cajaPendientes: Array.isArray(appState.cajaPendientes) ? appState.cajaPendientes : [],
          cajaIngresos: Array.isArray(appState.cajaIngresos) ? appState.cajaIngresos : [],
          mesas: Array.isArray(appState.mesas) ? appState.mesas : [],
          mesaOrders: (appState.mesaOrders && typeof appState.mesaOrders==='object') ? appState.mesaOrders : {},
          estaciones: Array.isArray(appState.estaciones) ? appState.estaciones : [],
          categorias: Array.isArray(appState.categorias) ? appState.categorias : [],
          finanzas: {
            asignaciones: Array.isArray(appState.finanzas?.asignaciones) ? appState.finanzas.asignaciones : [],
            allocBase: (appState.finanzas?.allocBase || 'revenue'),
            gastos: Array.isArray(appState.finanzas?.gastos) ? appState.finanzas.gastos : []
          }
        };
        await setDoc(doc(window.db, 'userExtras', uid), payload, { merge:true });
      }catch(e){ console.warn('[FS] saveUserExtrasToFirestore', e); }
    }

    function subscribeUserExtras(){
      try{
        if(!isFirestoreReady()) return;
        if(unsubscribeUserExtras) return;
        const uid = getActiveUid();
        if(!uid) return;
        const { doc, onSnapshot } = window.fs;
        const ref = doc(window.db, 'userExtras', uid);
        unsubscribeUserExtras = onSnapshot(ref, (snap)=>{
          if(!snap.exists()) return;
          const data = snap.data();
          if(!data) return;
          window.__applyingUserExtrasFromFirestore = true;
          try{
            appState.cajaTransferencias = Array.isArray(data.cajaTransferencias) ? data.cajaTransferencias : [];
            appState.cajaPendientes = Array.isArray(data.cajaPendientes) ? data.cajaPendientes : [];
            appState.cajaIngresos = Array.isArray(data.cajaIngresos) ? data.cajaIngresos : [];
            appState.mesas = Array.isArray(data.mesas) ? data.mesas : [];
            appState.mesaOrders = (data.mesaOrders && typeof data.mesaOrders==='object') ? data.mesaOrders : {};
            appState.estaciones = Array.isArray(data.estaciones) ? data.estaciones : [];
            appState.categorias = Array.isArray(data.categorias) ? data.categorias : [];
            appState.finanzas = {
              ...(appState.finanzas||{ empleados:[], servicios:[], asignaciones:[], allocBase:'revenue', gastos:[] }),
              asignaciones: Array.isArray(data.finanzas?.asignaciones) ? data.finanzas.asignaciones : (appState.finanzas?.asignaciones||[]),
              allocBase: (data.finanzas?.allocBase || appState.finanzas?.allocBase || 'revenue'),
              gastos: Array.isArray(data.finanzas?.gastos) ? data.finanzas.gastos : (appState.finanzas?.gastos||[])
            };
            try{ sanitizeState(); }catch(_){ }
            // Guardar cache local sin re-enviar a Firestore
            try{ localStorage.setItem(getUserStateKey(uid), JSON.stringify(appState)); }catch(_){ }
            try{ renderCaja(); }catch(_){ }
            try{ renderFinanzas(); }catch(_){ }
            try{ renderEstacionesTabla(); }catch(_){ }
            try{ renderMesaSelector(); }catch(_){ }
          } finally {
            window.__applyingUserExtrasFromFirestore = false;
          }
        }, (err)=>console.warn('[FS] subscribeUserExtras', err));
      }catch(e){ console.warn('[FS] subscribeUserExtras(outside)', e); }
    }

    async function maybeBootstrapUserExtrasToFirestore(){
      try{
        if(!isFirestoreReady()) return;
        const uid = getActiveUid();
        if(!uid) return;
        const { doc, getDoc, setDoc } = window.fs;
        const ref = doc(window.db, 'userExtras', uid);
        const s = await getDoc(ref);
        if(s.exists()) return;
        const hasAny =
          (appState.cajaTransferencias||[]).length ||
          (appState.cajaPendientes||[]).length ||
          (appState.cajaIngresos||[]).length ||
          (appState.mesas||[]).length ||
          (appState.estaciones||[]).length ||
          (appState.categorias||[]).length ||
          (appState.finanzas?.asignaciones||[]).length ||
          (appState.finanzas?.gastos||[]).length ||
          (appState.mesaOrders && Object.keys(appState.mesaOrders||{}).length);
        if(!hasAny) return;
        await setDoc(ref, { userId:uid }, { merge:true });
        await saveUserExtrasToFirestore();
      }catch(e){ console.warn('[FS] maybeBootstrapUserExtrasToFirestore', e); }
    }
  async function saveProductToFirestore(prod){
      try{
    if(!isFirestoreReady() || !prod?.id) return;
    const uid = window.auth?.currentUser?.uid;
    if(!uid) return;
    const { doc, setDoc } = window.fs;
    await setDoc(doc(window.db, 'productos', prod.id), { ...prod, userId: uid }, { merge:true });
      }catch(e){ console.warn('[FS] saveProductToFirestore', e); }
    }
    async function deleteProductFromFirestore(id){
      // Soft-archive instead of hard delete to avoid re-seeding and rule issues
      try{
        if(!isFirestoreReady() || !id) return;
        const uid = window.auth?.currentUser?.uid; if(!uid) return;
        const { doc, setDoc } = window.fs;
        await setDoc(doc(window.db, 'productos', id), { archivado:true, archivedAt:new Date().toISOString(), userId: uid }, { merge:true });
      }catch(e){ console.warn('[FS] deleteProductFromFirestore(archive)', e); }
    }
  function subscribeProducts(){
      try{
    if(!isFirestoreReady()) return;
        if(unsubscribeProducts){ return; }
    const uid = window.auth?.currentUser?.uid;
    if(!uid) return;
    const { collection, onSnapshot, query, where } = window.fs;
    const colRef = collection(window.db, 'productos');
    const q = query(colRef, where('userId','==', uid));
  unsubscribeProducts = onSnapshot(q, (snap)=>{
          if(snap.empty){
            console.info('[FS] productos vac√≠os en Firestore; conservando locales y haciendo bootstrap‚Ä¶');
            // Empujar locales a Firestore si corresponde
            try{ maybeBootstrapProductsToFirestore(); }catch(_){ }
            // No sobrescribir appState.productos aqu√≠ para no perder locales
            return;
          }
      const arr = [];
      snap.forEach(d=>{ const data=d.data(); if(data && data.id) arr.push(data); });
      const deduped = uniqueByProductName(arr);
      appState.productos = deduped;
      // Marcamos que ya tenemos una primera sync para permitir seeding seguro sin crear duplicados
      window.__productsSynced = true;
          saveLS();
          renderAll();
          renderPosProductList();
        }, (err)=> console.warn('[FS] subscribeProducts', err));
      }catch(e){ console.warn('[FS] subscribeProducts(outside)', e); }
    }
  async function maybeBootstrapProductsToFirestore(){
      try{
    if(!isFirestoreReady()) return;
    const uid = window.auth?.currentUser?.uid;
    if(!uid) return;
    const { collection, getDocs, doc, setDoc, query, where } = window.fs;
    const colRef = collection(window.db, 'productos');
    const snap = await getDocs(query(colRef, where('userId','==', uid)));
        if(snap.empty && Array.isArray(appState.productos) && appState.productos.length>0){
          for(const p of appState.productos){
      await setDoc(doc(window.db, 'productos', p.id), { ...p, userId: uid }, { merge:true });
          }
        }
      }catch(e){ console.warn('[FS] maybeBootstrapProductsToFirestore', e); }
    }
    function startFirestoreProductSync(){
      subscribeProducts();
      // bootstrapping en segundo plano
      maybeBootstrapProductsToFirestore();
    }

    // --- Firestore: Ingredientes ---
    async function saveIngredientToFirestore(ing){
      try{
        if(!isFirestoreReady() || !ing?.id) return;
        const uid = window.auth?.currentUser?.uid; if(!uid) return;
        const { doc, setDoc } = window.fs;
        await setDoc(doc(window.db, 'ingredientes', ing.id), { ...ing, userId: uid }, { merge:true });
      }catch(e){ console.warn('[FS] saveIngredientToFirestore', e); }
    }
    async function deleteIngredientFromFirestore(id){
      try{
        if(!isFirestoreReady() || !id) return;
        const { doc, deleteDoc } = window.fs;
        await deleteDoc(doc(window.db, 'ingredientes', id));
      }catch(e){ console.warn('[FS] deleteIngredientFromFirestore', e); }
    }
    function subscribeIngredientes(){
      try{
        if(!isFirestoreReady()) return;
        if(unsubscribeIngredientes){ return; }
        const uid = window.auth?.currentUser?.uid; if(!uid) return;
        const { collection, onSnapshot, query, where } = window.fs;
        const q = query(collection(window.db, 'ingredientes'), where('userId','==', uid));
        unsubscribeIngredientes = onSnapshot(q, (snap)=>{
          if(snap.empty){ try{ maybeBootstrapIngredientesToFirestore(); }catch(_){} return; }
          const arr = []; snap.forEach(d=>{ const data=d.data(); if(data && data.id) arr.push(data); });
          appState.ingredientes = arr; saveLS(); renderAll();
        }, (err)=> console.warn('[FS] subscribeIngredientes', err));
      }catch(e){ console.warn('[FS] subscribeIngredientes(outside)', e); }
    }
    async function maybeBootstrapIngredientesToFirestore(){
      try{
        if(!isFirestoreReady()) return;
        const uid = window.auth?.currentUser?.uid; if(!uid) return;
        const { collection, getDocs, doc, setDoc, query, where } = window.fs;
        const colRef = collection(window.db, 'ingredientes');
        const snap = await getDocs(query(colRef, where('userId','==', uid)));
        if(snap.empty && Array.isArray(appState.ingredientes) && appState.ingredientes.length>0){
          for(const i of appState.ingredientes){ await setDoc(doc(window.db, 'ingredientes', i.id), { ...i, userId: uid }, { merge:true }); }
        }
      }catch(e){ console.warn('[FS] maybeBootstrapIngredientesToFirestore', e); }
    }

    // --- Firestore: Clientes ---
    async function saveClienteToFirestore(cli){
      try{
        if(!isFirestoreReady() || !cli?.id) return;
        const uid = window.auth?.currentUser?.uid; if(!uid) return;
        const { doc, setDoc } = window.fs;
        await setDoc(doc(window.db, 'clientes', cli.id), { ...cli, userId: uid }, { merge:true });
      }catch(e){ console.warn('[FS] saveClienteToFirestore', e); }
    }
    async function deleteClienteFromFirestore(id){
      try{
        if(!isFirestoreReady() || !id) return;
        const { doc, deleteDoc } = window.fs;
        await deleteDoc(doc(window.db, 'clientes', id));
      }catch(e){ console.warn('[FS] deleteClienteFromFirestore', e); }
    }
    function subscribeClientes(){
      try{
        if(!isFirestoreReady()) return;
        if(unsubscribeClientes){ return; }
        const uid = window.auth?.currentUser?.uid; if(!uid) return;
        const { collection, onSnapshot, query, where } = window.fs;
        const q = query(collection(window.db, 'clientes'), where('userId','==', uid));
        unsubscribeClientes = onSnapshot(q, (snap)=>{
          if(snap.empty){ try{ maybeBootstrapClientesToFirestore(); }catch(_){} return; }
          const arr = []; snap.forEach(d=>{ const data=d.data(); if(data && data.id) arr.push(data); });
          appState.clientes = arr; saveLS(); renderAll();
        }, (err)=> console.warn('[FS] subscribeClientes', err));
      }catch(e){ console.warn('[FS] subscribeClientes(outside)', e); }
    }
    async function maybeBootstrapClientesToFirestore(){
      try{
        if(!isFirestoreReady()) return;
        const uid = window.auth?.currentUser?.uid; if(!uid) return;
        const { collection, getDocs, doc, setDoc, query, where } = window.fs;
        const colRef = collection(window.db, 'clientes');
        const snap = await getDocs(query(colRef, where('userId','==', uid)));
        if(snap.empty && Array.isArray(appState.clientes) && appState.clientes.length>0){
          for(const c of appState.clientes){ await setDoc(doc(window.db, 'clientes', c.id), { ...c, userId: uid }, { merge:true }); }
        }
      }catch(e){ console.warn('[FS] maybeBootstrapClientesToFirestore', e); }
    }

    // --- Firestore: Ventas ---
    async function saveVentaToFirestore(v){
      try{
        if(!isFirestoreReady() || !v?.id) return;
        const uid = window.auth?.currentUser?.uid; if(!uid) return;
        const { doc, setDoc } = window.fs;
        await setDoc(doc(window.db, 'ventas', v.id), { ...v, userId: uid }, { merge:true });
      }catch(e){ console.warn('[FS] saveVentaToFirestore', e); }
    }
    function subscribeVentas(){
      try{
        if(!isFirestoreReady()) return;
        if(unsubscribeVentas){ return; }
        const uid = window.auth?.currentUser?.uid; if(!uid) return;
        const { collection, onSnapshot, query, where } = window.fs;
        const q = query(collection(window.db, 'ventas'), where('userId','==', uid));
        unsubscribeVentas = onSnapshot(q, (snap)=>{
          // Si est√° vac√≠o, no forzamos reemplazo local; dejamos bootstrap manual si se desea
          const arr = []; snap.forEach(d=>{ const data=d.data(); if(data && data.id) arr.push(data); });
          if(arr.length===0) return;
          appState.ventas = arr;
          try{ assignSaleNumbersIfMissing(); }catch(_){ }
          try{ recomputeInsumosFromVentas(); }catch(_){ }
          saveLS(); renderAll();
        }, (err)=> console.warn('[FS] subscribeVentas', err));
      }catch(e){ console.warn('[FS] subscribeVentas(outside)', e); }
    }
    async function maybeBootstrapVentasToFirestore(){
      try{
        if(!isFirestoreReady()) return;
        const uid = window.auth?.currentUser?.uid; if(!uid) return;
        const { collection, getDocs, doc, setDoc, query, where } = window.fs;
        const colRef = collection(window.db, 'ventas');
        const snap = await getDocs(query(colRef, where('userId','==', uid)));
        if(snap.empty && Array.isArray(appState.ventas) && appState.ventas.length>0){
          for(const v of appState.ventas){ await setDoc(doc(window.db, 'ventas', v.id), { ...v, userId: uid }, { merge:true }); }
        }
      }catch(e){ console.warn('[FS] maybeBootstrapVentasToFirestore', e); }
    }

    function startFirestoreAllSync(){
      subscribeProducts();
      subscribeIngredientes();
      subscribeClientes();
      subscribeVentas();
      subscribeCompras();
      subscribeInsumos();
      subscribePedidos();
      subscribeMeta();
  subscribeEmpleados();
  subscribeServicios();
      subscribeUserExtras();
      // bootstraps
      maybeBootstrapProductsToFirestore();
      maybeBootstrapIngredientesToFirestore();
      maybeBootstrapClientesToFirestore();
      maybeBootstrapVentasToFirestore();
      maybeBootstrapComprasToFirestore();
      maybeBootstrapInsumosToFirestore();
      maybeBootstrapPedidosToFirestore();
      maybeBootstrapMetaToFirestore();
  maybeBootstrapEmpleadosToFirestore();
  maybeBootstrapServiciosToFirestore();
      maybeBootstrapUserExtrasToFirestore();
    }

    // Utilidad de mantenimiento: borrar cat√°logo del usuario actual (productos, ingredientes, categor√≠as, estaciones)
    async function debugClearCatalogForCurrentUser(){
      try{
        if(!isFirestoreReady()){ alert('Firestore no est√° listo. Abre la app normalmente e int√©ntalo de nuevo.'); return; }
        const uid = window.auth?.currentUser?.uid;
        if(!uid){ alert('Inicia sesi√≥n con el correo que quieres limpiar antes de ejecutar esta acci√≥n.'); return; }
        const { collection, getDocs, query, where, doc, deleteDoc } = window.fs || {};
        if(!collection || !getDocs){ alert('Firestore no est√° disponible en esta vista.'); return; }
        const colNames = ['productos','ingredientes','categorias','estaciones'];
        for(const colName of colNames){
          try{
            const colRef = collection(window.db, colName);
            const snap = await getDocs(query(colRef, where('userId','==', uid)));
            const ops = [];
            snap.forEach(d=>{ ops.push(deleteDoc(doc(window.db, colName, d.id))); });
            if(ops.length){ await Promise.all(ops); }
          }catch(e){ console.warn('[DEBUG CLEAR]', colName, e); }
        }
        // Limpiar estado local (solo de este usuario) y refrescar UI
        try{ localStorage.removeItem(getUserStateKey(uid)); }catch(_){ }
        if(typeof resetAppState==='function'){ try{ resetAppState({ persist:false }); }catch(_){ } }
        alert('Cat√°logo borrado para este usuario. Recarga la p√°gina y ver√°s el POS vac√≠o.');
      }catch(e){ console.warn('[debugClearCatalogForCurrentUser]', e); alert('No se pudo borrar el cat√°logo: '+(e?.message||'')); }
    }

    // --- Firestore: Inventario Compras ---
    async function saveCompraToFirestore(compra){
      try{ if(!isFirestoreReady()||!compra?.id) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {doc,setDoc}=window.fs; await setDoc(doc(window.db,'compras',compra.id),{...compra,userId:uid},{merge:true}); }catch(e){ console.warn('[FS] saveCompra',e); }
    }
    async function saveCompraCancelToFirestore(compra){
      try{ if(!isFirestoreReady()||!compra?.id) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {doc,setDoc}=window.fs; const payload={ cancelada:true, motivoCancel: compra.motivoCancel||'', cancelAt: compra.cancelAt||new Date().toISOString(), userId: uid }; await setDoc(doc(window.db,'compras',compra.id), payload, { merge:true }); }catch(e){ console.warn('[FS] cancelCompra',e); }
    }
    async function subscribeCompras(){
      try{ if(!isFirestoreReady()) return; if(unsubscribeCompras) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {collection,onSnapshot,query,where}=window.fs; const q=query(collection(window.db,'compras'),where('userId','==',uid)); unsubscribeCompras=onSnapshot(q,(snap)=>{ const arr=[]; snap.forEach(d=>{const x=d.data(); if(x&&x.id) arr.push(x);}); appState.inventario=computedMergeInventario(appState.inventario,{compras:arr}); saveLS(); renderInventario(); },(err)=>console.warn('[FS] subscribeCompras',err)); }catch(e){ console.warn('[FS] subscribeCompras(outside)',e); }
    }
    async function maybeBootstrapComprasToFirestore(){ try{ if(!isFirestoreReady()) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {collection,getDocs,doc,setDoc,query,where}=window.fs; const colRef=collection(window.db,'compras'); const snap=await getDocs(query(colRef,where('userId','==',uid))); if(snap.empty && Array.isArray(appState.inventario?.compras) && appState.inventario.compras.length>0){ for(const c of appState.inventario.compras){ await setDoc(doc(window.db,'compras',c.id),{...c,userId:uid},{merge:true}); } } }catch(e){ console.warn('[FS] maybeBootstrapCompras',e); } }
    function computedMergeInventario(curr, next){ return { compras: Array.isArray(next?.compras)? next.compras : (curr?.compras||[]) }; }

    // --- Firestore: Insumos (doc √∫nico por usuario) ---
    async function saveInsumosToFirestore(){
      try{ if(!isFirestoreReady()) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {doc,setDoc}=window.fs; const payload={ totales: appState.insumosConsumo?.totales||{}, historial: appState.insumosConsumo?.historial||[], merma: appState.insumosConsumo?.merma||[] }; await setDoc(doc(window.db,'insumos',uid),{ userId: uid, ...payload },{merge:true}); }catch(e){ console.warn('[FS] saveInsumos',e); }
    }
    function subscribeInsumos(){
      try{ if(!isFirestoreReady()) return; if(unsubscribeInsumos) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {doc,onSnapshot}=window.fs; const ref=doc(window.db,'insumos',uid); unsubscribeInsumos=onSnapshot(ref,(snap)=>{ if(!snap.exists()) return; const data=snap.data(); if(!data) return; appState.insumosConsumo = { totales: data.totales||{}, historial: data.historial||[], merma: data.merma||[] }; saveLS(); renderInsumosView(); renderInventario(); },(err)=>console.warn('[FS] subscribeInsumos',err)); }catch(e){ console.warn('[FS] subscribeInsumos(outside)',e); }
    }
  async function maybeBootstrapInsumosToFirestore(){ try{ if(!isFirestoreReady()) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {doc,getDoc,setDoc}=window.fs; const ref=doc(window.db,'insumos',uid); const s=await getDoc(ref); if(!s.exists() && appState.insumosConsumo){ await setDoc(ref,{ userId:uid, ...appState.insumosConsumo },{merge:true}); } }catch(e){ console.warn('[FS] maybeBootstrapInsumos',e); }
  }

    // --- Firestore: Pedidos pendientes ---
    async function savePedidoToFirestore(p){ try{ if(!isFirestoreReady()||!p?.id) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {doc,setDoc}=window.fs; await setDoc(doc(window.db,'pedidos',p.id),{...p,userId:uid},{merge:true}); }catch(e){ console.warn('[FS] savePedido',e); }
    }
    async function deletePedidoFromFirestore(id){ try{ if(!isFirestoreReady()||!id) return; const {doc,deleteDoc}=window.fs; await deleteDoc(doc(window.db,'pedidos',id)); }catch(e){ console.warn('[FS] deletePedido',e); } }
    function subscribePedidos(){ try{ if(!isFirestoreReady()) return; if(unsubscribePedidos) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {collection,onSnapshot,query,where}=window.fs; const q=query(collection(window.db,'pedidos'),where('userId','==',uid)); unsubscribePedidos=onSnapshot(q,(snap)=>{ const arr=[]; snap.forEach(d=>{ const x=d.data(); if(x&&x.id) arr.push(x); }); appState.pedidosPendientes=arr; saveLS(); renderPedidosPendientes(); },(err)=>console.warn('[FS] subscribePedidos',err)); }catch(e){ console.warn('[FS] subscribePedidos(outside)',e); }
    }
  async function maybeBootstrapPedidosToFirestore(){ try{ if(!isFirestoreReady()) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {collection,getDocs,doc,setDoc,query,where}=window.fs; const colRef=collection(window.db,'pedidos'); const snap=await getDocs(query(colRef,where('userId','==',uid))); if(snap.empty && Array.isArray(appState.pedidosPendientes) && appState.pedidosPendientes.length>0){ for(const p of appState.pedidosPendientes){ await setDoc(doc(window.db,'pedidos',p.id),{...p,userId:uid},{merge:true}); } } }catch(e){ console.warn('[FS] maybeBootstrapPedidos',e); }
  }

    // --- Firestore: Meta (nextSaleNumber) ---
    async function saveMetaToFirestore(){ try{ if(!isFirestoreReady()) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {doc,setDoc}=window.fs; await setDoc(doc(window.db,'meta',uid),{ userId:uid, nextSaleNumber: Number(appState.nextSaleNumber)||1 },{merge:true}); }catch(e){ console.warn('[FS] saveMeta',e); }
    }
    function subscribeMeta(){ try{ if(!isFirestoreReady()) return; if(unsubscribeMeta) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {doc,onSnapshot}=window.fs; const ref=doc(window.db,'meta',uid); unsubscribeMeta=onSnapshot(ref,(snap)=>{ if(!snap.exists()) return; const data=snap.data(); if(typeof data?.nextSaleNumber==='number'){ appState.nextSaleNumber = Math.max(appState.nextSaleNumber||1, data.nextSaleNumber); } },(err)=>console.warn('[FS] subscribeMeta',err)); }catch(e){ console.warn('[FS] subscribeMeta(outside)',e); }
    }
  async function maybeBootstrapMetaToFirestore(){ try{ if(!isFirestoreReady()) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {doc,getDoc,setDoc}=window.fs; const ref=doc(window.db,'meta',uid); const s=await getDoc(ref); if(!s.exists()){ await setDoc(ref,{ userId:uid, nextSaleNumber: Number(appState.nextSaleNumber)||1 },{merge:true}); } }catch(e){ console.warn('[FS] maybeBootstrapMeta',e); } }

  // --- Firestore: Finanzas (empleados y servicios) ---
  async function saveEmpleadoToFirestore(emp){ try{ if(!isFirestoreReady()||!emp?.id) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {doc,setDoc}=window.fs; await setDoc(doc(window.db,'empleados',emp.id),{...emp,userId:uid},{merge:true}); }catch(e){ console.warn('[FS] saveEmpleado',e); } }
  async function deleteEmpleadoFromFirestore(id){ try{ if(!isFirestoreReady()||!id) return; const {doc,deleteDoc}=window.fs; await deleteDoc(doc(window.db,'empleados',id)); }catch(e){ console.warn('[FS] deleteEmpleado',e); } }
  function subscribeEmpleados(){ try{ if(!isFirestoreReady()) return; if(unsubscribeEmpleados) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {collection,onSnapshot,query,where}=window.fs; const q=query(collection(window.db,'empleados'),where('userId','==',uid)); unsubscribeEmpleados=onSnapshot(q,(snap)=>{ const arr=[]; snap.forEach(d=>{ const x=d.data(); if(x&&x.id) arr.push(x); }); appState.finanzas = { ...appState.finanzas, empleados: arr }; saveLS(); renderFinanzas(); },(err)=>console.warn('[FS] subscribeEmpleados',err)); }catch(e){ console.warn('[FS] subscribeEmpleados(outside)',e); }
  }
  async function maybeBootstrapEmpleadosToFirestore(){ try{ if(!isFirestoreReady()) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {collection,getDocs,doc,setDoc,query,where}=window.fs; const colRef=collection(window.db,'empleados'); const snap=await getDocs(query(colRef,where('userId','==',uid))); const list=appState.finanzas?.empleados||[]; if(snap.empty && list.length>0){ for(const e of list){ await setDoc(doc(window.db,'empleados',e.id),{...e,userId:uid},{merge:true}); } } }catch(e){ console.warn('[FS] maybeBootstrapEmpleados',e); }
  }

  async function saveServicioToFirestore(srv){ try{ if(!isFirestoreReady()||!srv?.id) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {doc,setDoc}=window.fs; await setDoc(doc(window.db,'servicios',srv.id),{...srv,userId:uid},{merge:true}); }catch(e){ console.warn('[FS] saveServicio',e); } }
  async function deleteServicioFromFirestore(id){ try{ if(!isFirestoreReady()||!id) return; const {doc,deleteDoc}=window.fs; await deleteDoc(doc(window.db,'servicios',id)); }catch(e){ console.warn('[FS] deleteServicio',e); } }
  function subscribeServicios(){ try{ if(!isFirestoreReady()) return; if(unsubscribeServicios) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {collection,onSnapshot,query,where}=window.fs; const q=query(collection(window.db,'servicios'),where('userId','==',uid)); unsubscribeServicios=onSnapshot(q,(snap)=>{ const arr=[]; snap.forEach(d=>{ const x=d.data(); if(x&&x.id) arr.push(x); }); appState.finanzas = { ...appState.finanzas, servicios: arr }; saveLS(); renderFinanzas(); },(err)=>console.warn('[FS] subscribeServicios',err)); }catch(e){ console.warn('[FS] subscribeServicios(outside)',e); }
  }
  async function maybeBootstrapServiciosToFirestore(){ try{ if(!isFirestoreReady()) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {collection,getDocs,doc,setDoc,query,where}=window.fs; const colRef=collection(window.db,'servicios'); const snap=await getDocs(query(colRef,where('userId','==',uid))); const list=appState.finanzas?.servicios||[]; if(snap.empty && list.length>0){ for(const s of list){ await setDoc(doc(window.db,'servicios',s.id),{...s,userId:uid},{merge:true}); } } }catch(e){ console.warn('[FS] maybeBootstrapServicios',e); }
  }

    // Dataset de ingredientes predefinidos (semilla)
    const PRESET_INGREDIENTS = [
      { nombre:'BOTECITO', precioPaquete:100.00, unidadesPaquete:100, unidad:'unidad' },
      { nombre:'Mantequilla Gloria', precioPaquete:269.10, unidadesPaquete:1170, unidad:'g' },
      { nombre:'Galletas Marbu', precioPaquete:20.00, unidadesPaquete:1, unidad:'unidad' },
      { nombre:'Cocoa', precioPaquete:90.00, unidadesPaquete:250, unidad:'g' },
      { nombre:'QUESO NACHOS', precioPaquete:200.00, unidadesPaquete:4000, unidad:'g' },
      { nombre:'Cocacola 1.75', precioPaquete:39.00, unidadesPaquete:1, unidad:'unidad' },
      { nombre:'Queso Bola', precioPaquete:494.00, unidadesPaquete:1900, unidad:'g' },
      { nombre:'SALCHICHAS JUMBO', precioPaquete:147.00, unidadesPaquete:20, unidad:'unidad' },
      { nombre:'PAN HAMBURGUESA PEQUE√ëO', precioPaquete:75.00, unidadesPaquete:12, unidad:'unidad' },
      { nombre:'Vegetales Hotdog', precioPaquete:4.00, unidadesPaquete:1, unidad:'unidad' },
      { nombre:'Queso Fiorelo', precioPaquete:31.00, unidadesPaquete:1, unidad:'unidad' },
      { nombre:'Cocacola 600Ml', precioPaquete:18.00, unidadesPaquete:1, unidad:'unidad' },
      { nombre:'CHAROLA PEQUE√ëA', precioPaquete:50.00, unidadesPaquete:25, unidad:'unidad' },
      { nombre:'Pepinillos', precioPaquete:140.00, unidadesPaquete:2000, unidad:'g' },
      { nombre:'CHAROLA UNISEL', precioPaquete:170.00, unidadesPaquete:50, unidad:'unidad' },
      { nombre:'PAPAS GAJO', precioPaquete:160.00, unidadesPaquete:2000, unidad:'g' },
      { nombre:'Maicena', precioPaquete:30.00, unidadesPaquete:300, unidad:'g' },
      { nombre:'TOCINO', precioPaquete:75.00, unidadesPaquete:16, unidad:'unidad' },
      { nombre:'QUESO AMERICANO', precioPaquete:162.90, unidadesPaquete:90, unidad:'unidad' },
      { nombre:'PAPEL GRADO ALIMENTICIO', precioPaquete:300.00, unidadesPaquete:1000, unidad:'unidad' },
      { nombre:'PAPAS FRANCESAS', precioPaquete:160.00, unidadesPaquete:2000, unidad:'g' },
      { nombre:'Ranch', precioPaquete:75.00, unidadesPaquete:750, unidad:'mL' },
      { nombre:'AROS DE CEBOLLA', precioPaquete:272.00, unidadesPaquete:100, unidad:'unidad' },
      { nombre:'MAYONESA', precioPaquete:306.00, unidadesPaquete:3400, unidad:'g' },
      { nombre:'Royal', precioPaquete:30.00, unidadesPaquete:500, unidad:'g' },
      { nombre:'Crema Avellana', precioPaquete:220.00, unidadesPaquete:2000, unidad:'g' },
      { nombre:'Costillas', precioPaquete:150.00, unidadesPaquete:1000, unidad:'g' },
      { nombre:'CARNE HAMBURGUESA SIRLON', precioPaquete:90.00, unidadesPaquete:12, unidad:'unidad' },
      { nombre:'Vegetales', precioPaquete:8.00, unidadesPaquete:1, unidad:'unidad' },
      { nombre:'Harina', precioPaquete:20.00, unidadesPaquete:1000, unidad:'g' },
      { nombre:'SALSA BBQ', precioPaquete:42.00, unidadesPaquete:600, unidad:'g' },
      { nombre:'Crema lala 4L', precioPaquete:274.40, unidadesPaquete:3920, unidad:'g' },
      { nombre:'PAN HOTDOG', precioPaquete:69.96, unidadesPaquete:12, unidad:'unidad' },
      { nombre:'Chispas de Chocolate', precioPaquete:200.00, unidadesPaquete:1000, unidad:'g' },
      { nombre:'CHILES', precioPaquete:2.00, unidadesPaquete:2, unidad:'unidad' },
      { nombre:'QUESO MANCHEGO', precioPaquete:150.00, unidadesPaquete:1000, unidad:'g' },
      { nombre:'Catsup', precioPaquete:144.00, unidadesPaquete:200, unidad:'unidad' },
      { nombre:'CARNE DE HAMBURGUESA', precioPaquete:125.00, unidadesPaquete:10, unidad:'unidad' },
      { nombre:'Azucar Mascabada', precioPaquete:80.00, unidadesPaquete:2000, unidad:'g' },
      { nombre:'AGUAS', precioPaquete:86.00, unidadesPaquete:18, unidad:'unidad' },
      { nombre:'BIMBOLLO', precioPaquete:90.96, unidadesPaquete:12, unidad:'unidad' },
      { nombre:'SALCHICHA BAFAR JALAPE√ëO', precioPaquete:38.00, unidadesPaquete:4, unidad:'PZ' },
      { nombre:'PAN HOTDOG MEDIA NOCHE', precioPaquete:42.00, unidadesPaquete:8, unidad:'PZ' }
    ];

    // Clientes predefinidos del usuario
    const PRESET_CLIENTES_USER = [
      { nombre:'JAIME', telefono:'9221579492', direccion:'Talcualoya', gastoTotal:200, puntos:20 },
      { nombre:'Viridiana Maciel', telefono:'9221569521', direccion:'Desconocida', gastoTotal:0, puntos:0 },
      { nombre:'pollero', telefono:'9221657362', direccion:'desconocido', gastoTotal:140, puntos:14 },
      { nombre:'Didi', telefono:'9222831642', direccion:'Desconocida', gastoTotal:160, puntos:16 },
      { nombre:'Miguel Pimentel', telefono:'5638430441', direccion:'Desconocido', gastoTotal:0, puntos:0 },
      { nombre:'paul', telefono:'9221745327', direccion:'centro', gastoTotal:200, puntos:20 },
      { nombre:'Pablo Verazas', telefono:'9221140524', direccion:'Desconocida', gastoTotal:780, puntos:78 },
      { nombre:'Jeronimo', telefono:'9221585606', direccion:'Desconocida', gastoTotal:510, puntos:51 },
      { nombre:'Hermano mimi', telefono:'desconocido', direccion:'desconocido', gastoTotal:340, puntos:34 },
      { nombre:'Fany', telefono:'9221306105', direccion:'Desconocida', gastoTotal:440, puntos:98 },
      { nombre:'CENDI', telefono:'desconocido', direccion:'desconocido', gastoTotal:0, puntos:0 },
      { nombre:'TONY DIVA', telefono:'9613612532', direccion:'nueva tacoteno', gastoTotal:340, puntos:34 },
      { nombre:'Karim', telefono:'9221928934', direccion:'Petrolera', gastoTotal:0, puntos:0 },
      { nombre:'Claudia', telefono:'9222053732', direccion:'Calle quintanarro colonia emiliano zapata', gastoTotal:0, puntos:0 },
      { nombre:'uriel', telefono:'9222108294', direccion:'coahuila 36', gastoTotal:440, puntos:224 },
      { nombre:'YOSHUA', telefono:'desconocido', direccion:'desconocido', gastoTotal:60, puntos:6 },
      { nombre:'ISRAEL UNI', telefono:'DESCONOCIDO', direccion:'DESCONOCIDO', gastoTotal:60, puntos:6 },
      { nombre:'Gladys Casa Rosa', telefono:'9222271093', direccion:'desconocida', gastoTotal:0, puntos:0 },
      { nombre:'Denise', telefono:'9222822876', direccion:'Calle tecnologico casa madera', gastoTotal:0, puntos:0 },
      { nombre:'Maribel Vecina', telefono:'9221281283', direccion:'Coahuila 31', gastoTotal:0, puntos:0 },
      { nombre:'denis vazques', telefono:'9222822876', direccion:'casa madera', gastoTotal:110, puntos:11 },
      { nombre:'SY', telefono:'9221135326', direccion:'CONGRESO', gastoTotal:120, puntos:12 },
      { nombre:'Mimi', telefono:'9221637737', direccion:'Coahuila 34', gastoTotal:320, puntos:320 },
      { nombre:'Tienda Esquina', telefono:'9221751654', direccion:'Tienda esquina Colonia 10 de mayo', gastoTotal:0, puntos:0 },
      { nombre:'Hernesto Martinez', telefono:'9221633150', direccion:'Desconocida', gastoTotal:200, puntos:20 },
      { nombre:'Yuri', telefono:'9221253602', direccion:'desconocido', gastoTotal:600, puntos:60 },
      { nombre:'Cristy Vinales', telefono:'228 288 9858', direccion:'Sor Juana In√©s de la Cruz n√∫mero 8 col obrera por el chilape√±o casa de dos pisos color blanco con portones de aluminio color champagne.', gastoTotal:480, puntos:480 },
      { nombre:'Simon', telefono:'922 121 1457', direccion:'Bixiweb', gastoTotal:110, puntos:110 },
      { nombre:'Colonia Calle california', telefono:'9221286098', direccion:'Colonia calle california', gastoTotal:0, puntos:0 }
    ];

    function importUserClientsPreset(){
      try{
        if(!Array.isArray(PRESET_CLIENTES_USER) || PRESET_CLIENTES_USER.length===0){ alert('No hay clientes para importar.'); return; }
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        const existing = new Set((appState.clientes||[]).map(c=> byName(c.nombre)));
        const toAdd = PRESET_CLIENTES_USER.filter(c=> !existing.has(byName(c.nombre)));
        if(toAdd.length===0){ alert('Todos los clientes ya existen.'); return; }
        appState.clientes.push(...toAdd.map(c=>({ id: generateId('cli'), nombre:c.nombre, telefono:c.telefono||'', direccion:c.direccion||'', puntos:Number(c.puntos)||0, gastoTotal:Number(c.gastoTotal)||0 })));
        saveLS(); renderAll();
        alert(`Importados ${toAdd.length} clientes.`);
      }catch(e){ console.warn('importUserClientsPreset', e); alert('Error importando clientes'); }
    }
    function importUserClientsPresetSilently(){
      try{
        if(!Array.isArray(PRESET_CLIENTES_USER) || PRESET_CLIENTES_USER.length===0) return;
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        // Asegurar cliente general por nombre antes de importar el resto
        appState.clientes = Array.isArray(appState.clientes) ? appState.clientes : [];
        let general = appState.clientes.find(c=> byName(c.nombre)==='cliente general');
        if(!general){
          general = { id: generateId('cli'), nombre:'Cliente general', telefono:'', direccion:'', gastoTotal:0, puntos:0 };
          appState.clientes.push(general);
        }

        const existing = new Set((appState.clientes||[]).map(c=> byName(c.nombre)));
        const toAdd = PRESET_CLIENTES_USER.filter(c=> !existing.has(byName(c.nombre)));
        if(toAdd.length){
          appState.clientes.push(...toAdd.map(c=>({ id: generateId('cli'), nombre:c.nombre, telefono:c.telefono||'', direccion:c.direccion||'', puntos:Number(c.puntos)||0, gastoTotal:Number(c.gastoTotal)||0 })));
        }
        saveLS();
      }catch(e){ console.warn('importUserClientsPresetSilently', e); }
    }

    // Modal de Producto con Receta
    function openProductModal(){
      console.log('[UI] Abrir modal Producto');
      const backdrop = $('#modal-backdrop');
      const container = $('#modal-container');
      if(!backdrop||!container){ console.warn('[UI] modal elements missing'); }
      const ingOptions = appState.ingredientes.map(i=>`<option value="${i.id}">${i.nombre} (${i.unidad||''})</option>`).join('');
      const disabledRecipe = appState.ingredientes.length===0;
      // Opciones de categor√≠a basadas en appState.categorias
      ensureDefaultCategorias();
      let categoriaOptions = '';
      let clasifExtraOptions = '';
      if(Array.isArray(appState.categorias) && appState.categorias.length){
        const cats = [...appState.categorias].sort((a,b)=>{
          const la = (a.nombre||a.key||'').toString();
          const lb = (b.nombre||b.key||'').toString();
          return la.localeCompare(lb);
        });
        const baseKeys = new Set(['hamburguesa','hotdog','postre','complemento','bebida','combo']);
        categoriaOptions = cats.map(c=>{
          const label = (c.nombre||c.key||'').toString();
          const value = label; // guardamos el nombre visible en el producto
          return `<option value="${value}">${label}</option>`;
        }).join('');
        clasifExtraOptions = cats.map(c=>{
          const key = (c.key||'').toString().toLowerCase();
          if(!key || baseKeys.has(key)) return '';
          const label = (c.nombre||c.key||'').toString();
          return `<option value="${key}">${label}</option>`;
        }).join('');
      }

      const html = `
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6">
          <h3 class="text-lg font-bold mb-4" style="color:var(--burger-dark)">Nuevo Producto</h3>
          <form id="product-form" class="space-y-4">
            <div>
              <label class="block text-sm font-bold mb-1">Tipo de Producto</label>
              <select name="tipo" id="product-type-select" class="w-full input-modern p-2 rounded">
                <option value="individual">Producto Individual</option>
                <option value="combo">Combo</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-bold mb-1">Nombre</label>
              <input type="text" name="nombre" class="w-full input-modern p-2 rounded" placeholder="Ej. Hamburguesa Doble" required>
            </div>
            <div>
              <label class="block text-sm font-bold mb-1">Precio (venta)</label>
              <input type="number" name="precio" class="w-full input-modern p-2 rounded" placeholder="0.00" min="0" step="0.01" required>
            </div>
            <div>
              <label class="block text-sm font-bold mb-1">Descripci√≥n</label>
              <textarea name="descripcion" rows="3" class="w-full input-modern p-2 rounded" placeholder="Descripci√≥n para el men√∫"></textarea>
            </div>
            <div>
              <label class="block text-sm font-bold mb-1">Categor√≠a</label>
              <select name="categoria" class="w-full input-modern p-2 rounded">
                <option value="">Sin categor√≠a</option>
                ${categoriaOptions}
              </select>
            </div>
            <div id="tamano-section" class="hidden">
              <label class="block text-sm font-bold mb-1">Tama√±o del Complemento</label>
              <select name="tamano" class="w-full input-modern p-2 rounded">
                <option value="">Sin especificar</option>
                <option value="chico">üîπ Chico</option>
                <option value="mediano">üî∏ Mediano</option>
                <option value="grande">üî∂ Grande</option>
              </select>
            </div>
            <div class="border-t pt-3" id="recipe-section">
              <div class="recipe-title-bar mb-2">
                <label class="block text-sm font-bold">Receta (ingredientes)</label>
                <button type="button" id="add-ingredient-row" class="btn-success btn-compact rounded" ${disabledRecipe?'disabled':''}>+ Agregar</button>
              </div>
              ${disabledRecipe? '<div class="p-3 text-sm rounded bg-yellow-100 text-yellow-800">Primero agrega ingredientes en la secci√≥n Ingredientes.</div>' : ''}
              <div id="recipe-rows" class="recipe-list space-y-2"></div>
              <div id="cost-estimate" class="text-xs opacity-70 mt-2"></div>
            </div>
            <div class="border-t pt-3 hidden" id="combo-section">
              <div class="combo-title-bar mb-2">
                <label class="block text-sm font-bold">Configuraci√≥n del Combo</label>
                <div class="text-xs text-gray-600 mb-3">Selecciona las categor√≠as que incluye este combo y la cantidad de cada una. Al tomar la orden, podr√°s elegir los productos de cada categor√≠a.</div>
              </div>
              <div id="combo-dyn-categories" class="space-y-2"></div>
              <div id="combo-cost-estimate" class="text-xs opacity-70 mt-2"></div>
            </div>
            <div class="flex gap-2 pt-2">
              <button type="submit" class="btn-success px-4 py-2 rounded">Guardar</button>
              <button type="button" id="cancel-product-modal" class="btn-danger px-4 py-2 rounded">Cancelar</button>
            </div>
          </form>
        </div>`;

      container.innerHTML = html;
      backdrop.classList.remove('hidden');
      backdrop.style.display = '';
      container.classList.remove('hidden');
      // Prevent background scroll on mobile
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';

      function addRow(defaultId='', defaultQty=''){
        const rows = $('#recipe-rows');
        if(!rows) return;
        const row = document.createElement('div');
        row.className = 'recipe-row';
        row.innerHTML = `
          <select class="select-compact input-modern rounded ing-select">
            <option value="">Seleccione ingrediente</option>
            ${ingOptions}
          </select>
          <input type="number" class="input-compact input-modern rounded qty-input" placeholder="Cant." min="0" step="any">
          <button type="button" class="btn-danger btn-compact rounded remove-row">√ó</button>
        `;
        rows.appendChild(row);
        if(defaultId){ row.querySelector('.ing-select').value = defaultId; }
        if(defaultQty!==''){ row.querySelector('.qty-input').value = defaultQty; }
        row.querySelector('.remove-row').addEventListener('click', ()=>{ row.remove(); recalcCost(); });
        row.querySelector('.ing-select').addEventListener('change', recalcCost);
        row.querySelector('.qty-input').addEventListener('input', recalcCost);
      }

      function recalcCost(){
        let cost = 0;
        const qtys = $$('#recipe-rows .qty-input');
        $$('#recipe-rows .ing-select').forEach((sel, idx)=>{
          const id = sel.value;
          const qty = parseFloat(qtys[idx]?.value||'0');
          if(!id || !qty) return;
          const ing = getIngredientById(id);
          cost += getUnitCost(ing) * qty;
        });
        const price = parseFloat(document.querySelector('#product-form [name="precio"]')?.value||'0')||0;
        const margin = price - cost;
        const pct = price>0 ? (margin/price*100) : 0;
        const el = $('#cost-estimate');
        if(el) el.textContent = `Costo: ${fmt(cost)} ‚Ä¢ Margen: ${fmt(margin)} (${pct.toFixed(1)}%)`;
      }

      $('#add-ingredient-row')?.addEventListener('click', ()=> addRow());
      if(!disabledRecipe) addRow();
      recalcCost();

      // Combo functionality
      function toggleProductType() {
        const productType = document.getElementById('product-type-select')?.value;
        const recipeSection = document.getElementById('recipe-section');
        const comboSection = document.getElementById('combo-section');
        
        if (productType === 'combo') {
          recipeSection?.classList.add('hidden');
          comboSection?.classList.remove('hidden');
          renderComboCategorias();
          setupComboListeners();
          recalcComboCost();
        } else {
          recipeSection?.classList.remove('hidden');
          comboSection?.classList.add('hidden');
          recalcCost();
        }
      }

      function renderComboCategorias(){
        const cont = document.getElementById('combo-dyn-categories');
        if(!cont) return;

        ensureDefaultCategorias();
        const cats = Array.isArray(appState.categorias) ? [...appState.categorias] : [];
        const labelFor = (c)=> (c?.nombre || c?.key || '').toString().trim();
        const keyFor = (s)=> (typeof canonicalCategoriaKey==='function' ? (canonicalCategoriaKey(s, s) || '') : '') || (s||'').toString().trim().toLowerCase();
        const isCombo = (c)=> keyFor(c?.key||c?.nombre||'') === 'combo' || labelFor(c).toLowerCase()==='combo';

        const list = cats
          .filter(c=> labelFor(c))
          .filter(c=> !isCombo(c))
          .sort((a,b)=> labelFor(a).localeCompare(labelFor(b)));

        if(list.length===0){
          cont.innerHTML = '<div class="p-3 text-sm rounded bg-yellow-100 text-yellow-800">Primero crea categor√≠as en la secci√≥n Categor√≠as.</div>';
          return;
        }

        cont.innerHTML = list.map(c=>{
          const label = labelFor(c);
          const id = `combo-cat-${keyFor(label).replace(/[^a-z0-9_\-]/g,'_')}`;
          return `
            <div class="border rounded-lg p-3 flex items-center gap-3">
              <input type="checkbox" id="${id}" class="combo-dyn-cat-check" data-categoria="${label}">
              <label for="${id}" class="font-bold flex-1">${label}</label>
              <div class="flex items-center gap-2">
                <span class="text-xs font-bold opacity-70">Cant.</span>
                <input type="number" class="w-20 input-modern p-2 rounded text-sm combo-dyn-cat-qty" min="1" step="1" value="1" disabled>
              </div>
            </div>`;
        }).join('');
      }

      function readComboConfigFromUI(){
        const cont = document.getElementById('combo-dyn-categories');
        if(!cont) return { categorias: [] };
        const selected = [];
        cont.querySelectorAll('.combo-dyn-cat-check').forEach(chk=>{
          if(!chk.checked) return;
          const categoria = chk.getAttribute('data-categoria') || '';
          const qtyEl = chk.closest('div')?.querySelector('.combo-dyn-cat-qty');
          const cantidad = Math.max(1, parseInt(qtyEl?.value || '1', 10) || 1);
          if(categoria){ selected.push({ categoria, cantidad }); }
        });
        return { categorias: selected };
      }

      function setupComboListeners() {
        // Dynamic category checkbox -> enable qty
        const cont = document.getElementById('combo-dyn-categories');
        if(cont){
          cont.querySelectorAll('.combo-dyn-cat-check').forEach(chk=>{
            chk.addEventListener('change', ()=>{
              const qty = chk.closest('div')?.querySelector('.combo-dyn-cat-qty');
              if(qty){ qty.disabled = !chk.checked; }
              recalcComboCost();
            });
          });
          cont.querySelectorAll('.combo-dyn-cat-qty').forEach(inp=>{
            inp.addEventListener('input', recalcComboCost);
            inp.addEventListener('change', recalcComboCost);
          });
        }

        // Mostrar/ocultar selector de tama√±o cuando se selecciona complemento
        const clasificacionSelect = document.getElementById('product-clasificacion-select');
        const tamanoSection = document.getElementById('tamano-section');
        if (clasificacionSelect && tamanoSection) {
          clasificacionSelect.addEventListener('change', (e) => {
            if (e.target.value === 'complemento') {
              tamanoSection.classList.remove('hidden');
            } else {
              tamanoSection.classList.add('hidden');
            }
          });
        }

        // (Los inputs din√°micos ya se conectan arriba)
      }

      function recalcComboCost() {
        const comboConfig = readComboConfigFromUI();
        const totalCost = calculateComboEstimatedCost(comboConfig);
        const description = (comboConfig.categorias||[]).map(c=>{
          const qty = Math.max(1, Number(c.cantidad)||1);
          const qtyText = qty>1 ? `${qty}x ` : '';
          return `${qtyText}${c.categoria}`;
        });

        const price = parseFloat(document.querySelector('#product-form [name="precio"]')?.value||'0')||0;
        const margin = price - (Number(totalCost)||0);
        const pct = price > 0 ? (margin/price*100) : 0;
        const el = $('#combo-cost-estimate');
        if(el) {
          el.textContent = `Incluye: ${description.join(', ')} ‚Ä¢ Costo estimado: ${fmt(totalCost)} ‚Ä¢ Margen: ${fmt(margin)} (${pct.toFixed(1)}%)`;
        }
      }

      // Event listeners
      document.getElementById('product-type-select')?.addEventListener('change', toggleProductType);
      
      // Initialize
      toggleProductType();

    $('#cancel-product-modal')?.addEventListener('click', closeModal);
    document.querySelector('#product-form [name="precio"]')?.addEventListener('input', ()=>{
      const productType = document.getElementById('product-type-select')?.value;
      if(productType === 'combo') {
        recalcComboCost();
      } else {
        recalcCost();
      }
    });
      $('#product-form')?.addEventListener('submit', (e)=>{
        e.preventDefault();
        console.log('[UI] Guardar Producto');
        try{
          const fd = new FormData(e.target);
          const data = Object.fromEntries(fd.entries());
          const productType = data.tipo || 'individual';
          
          let costo = 0;
          let receta = [];
          let comboProductos = [];
          let prod = null;
          
          if(productType === 'combo') {
            console.log('[COMBO] Creando combo...');
            // Configuraci√≥n por categor√≠as + cantidad
            const comboConfig = readComboConfigFromUI();
            if(!Array.isArray(comboConfig.categorias) || comboConfig.categorias.length===0){
              alert('Selecciona al menos una categor√≠a para el combo.');
              return;
            }

            // Calculate estimated cost
            costo = calculateComboEstimatedCost(comboConfig);
            console.log('[COMBO] Costo calculado:', costo);
            console.log('[COMBO] Configuraci√≥n final:', comboConfig);
            
            const catLabelCombo = (data.categoria||'').trim();
            const clasifCombo = productType === 'combo' ? 'combo' : canonicalCategoriaKey(catLabelCombo, catLabelCombo) || '';
            prod = { 
              id: generateId('p'), 
              nombre:(data.nombre||'').trim()||'Sin nombre', 
              precio:Number(data.precio)||0, 
              descripcion:(data.descripcion||'').trim(), 
              tipo: productType,
              clasificacion:clasifCombo,
              categoria:catLabelCombo,
              comboConfig,
              costo 
            };
            
            console.log('[COMBO] Producto final creado:', prod);
          } else {
            // Handle regular recipe
            const sels = $$('#recipe-rows .ing-select');
            const qtys = $$('#recipe-rows .qty-input');
            for(let i=0;i<sels.length;i++){
              const ingredienteId = sels[i].value;
              const cantidad = parseFloat(qtys[i].value||'0');
              if(ingredienteId && cantidad>0){ receta.push({ ingredienteId, cantidad }); }
            }
            costo = computeRecipeCost(receta);
            
            const catLabel = (data.categoria||'').trim();
            const clasif = canonicalCategoriaKey(catLabel, catLabel) || '';
            prod = { 
              id: generateId('p'), 
              nombre:(data.nombre||'').trim()||'Sin nombre', 
              precio:Number(data.precio)||0, 
              descripcion:(data.descripcion||'').trim(), 
              tipo: productType,
              clasificacion:clasif,
              tamano:(data.tamano||'').trim(),
              categoria:catLabel,
              receta, 
              costo 
            };
          }

          // Add the product to the state
          // Add the product to the state
          if (prod) {
            console.log('[UI] Guardando producto:', prod);
            appState.productos.push(prod);
            if(typeof saveProductToFirestore === 'function') saveProductToFirestore(prod);
            saveLS(); renderAll(); renderPosProductList();
          }
        }catch(err){ console.error('[UI] Error guardando producto', err); }
        closeModal();
      });
    }

    // Modal espec√≠fico: crear ingrediente
    function openIngredientModal(){
      console.log('[UI] Abrir modal Ingrediente');
      openFormModal({
        title:'Nuevo Ingrediente',
        fields:[
          {name:'nombre', label:'Nombre', placeholder:'Queso, Tomate...', type:'text'},
          {name:'unidad', label:'Unidad', placeholder:'g, kg, L, unidad', type:'text'},
          {name:'precioPaquete', label:'Precio por Paquete', placeholder:'0.00', type:'number', min:0, step:'0.01'},
          {name:'unidadesPaquete', label:'Unidades por Paquete', placeholder:'1', type:'number', min:1, step:'1'}
        ],
        onSubmit:(data)=>{
          try{
            const ing = { id: generateId('ing'), nombre:(data.nombre||'').trim(), unidad:(data.unidad||'').trim(), precioPaquete:Number(data.precioPaquete)||0, unidadesPaquete:Number(data.unidadesPaquete)||1 };
            appState.ingredientes.push(ing);
            if(typeof saveIngredientToFirestore==='function') saveIngredientToFirestore(ing);
            saveLS(); renderAll();
          }catch(err){ console.error('[UI] Error guardando ingrediente', err); }
        }
      });
    }

    // Importar preset manualmente
    function importPresetIngredients(){
      if(!Array.isArray(PRESET_INGREDIENTS) || PRESET_INGREDIENTS.length===0){ alert('No hay listado predefinido.'); return; }
      if(!confirm('¬øImportar listado de ingredientes predefinido?\nSi ya tienes algunos, se a√±adir√°n sin borrar.')) return;
      const existingNames = new Set(appState.ingredientes.map(i=>i.nombre.toLowerCase()));
      const toAdd = PRESET_INGREDIENTS.filter(i=> !existingNames.has((i.nombre||'').toLowerCase()));
      appState.ingredientes.push(...toAdd.map(i=>({ id: generateId('ing'), ...i })));
      saveLS(); renderAll(); renderIngredientesTabla();
      alert(`Importados ${toAdd.length} ingredientes nuevos.`);
    }

    // Importaci√≥n silenciosa (sin confirm/alert), merge por nombre (case-insensitive)
    function importPresetIngredientsSilently(){
      if(!Array.isArray(PRESET_INGREDIENTS) || PRESET_INGREDIENTS.length===0) return;
      const existingNames = new Set((appState.ingredientes||[]).map(i=> (i.nombre||'').toLowerCase()));
      const toAdd = PRESET_INGREDIENTS.filter(i=> !existingNames.has((i.nombre||'').toLowerCase()));
      if(toAdd.length===0) return;
      appState.ingredientes.push(...toAdd.map(i=>({ id: generateId('ing'), ...i })));
      saveLS();
    }

    // --- Exportar productos completos a JSON ---
    function exportProductosToJSON(){
      try{
        const productos = (appState.productos||[]).filter(p=> !p.archivado);
        const data = {
          productos: productos,
          ingredientes: appState.ingredientes||[],
          exportDate: new Date().toISOString(),
          version: '1.0'
        };
        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `productos_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
        alert(`Exportados ${productos.length} productos con sus ingredientes.`);
      }catch(err){
        console.error('Error exportando productos', err);
        alert('Error al exportar productos.');
      }
    }

    // Sidebar m√≥vil (reintroducido)
    function setupSidebar(){
      const btn = $('#mobile-menu-btn');
      const sidebar = document.querySelector('.sidebar');
      const backdrop = document.getElementById('sidebar-backdrop');
      const icon = btn?.querySelector('span');

      const isMobile = ()=> window.innerWidth <= 1024;
      let isOpenState = true;

      const updateBtn = (open)=>{
        if(!btn) return;
        btn.setAttribute('aria-label', open ? 'Ocultar men√∫' : 'Mostrar men√∫');
        if(icon) icon.textContent = open ? '‚úï' : '‚ò∞';
      };

      const setOpen = (open)=>{
        if(!sidebar) return;
        isOpenState = !!open;
        if(isMobile()){
          sidebar.classList.toggle('collapsed', false);
          sidebar.classList.toggle('open', !!open);
          if(backdrop){ backdrop.classList.toggle('hidden', !open); }
        } else {
          sidebar.classList.remove('open');
          sidebar.classList.toggle('collapsed', !open);
          if(backdrop){ backdrop.classList.add('hidden'); }
        }
        updateBtn(!!open);
      };

      const toggle = (open)=>{
        if(open===undefined){
          const currentlyOpen = isMobile() ? sidebar?.classList.contains('open') : !sidebar?.classList.contains('collapsed');
          open = !currentlyOpen;
        }
        setOpen(open);
      };
      // expose for other modules (navigation close)
      window.__toggleSidebar = toggle;

      btn?.addEventListener('click', ()=> toggle());
      backdrop?.addEventListener('click', ()=> toggle(false));
      document.addEventListener('click', (e)=>{
        if(window.innerWidth<=1024 && sidebar?.classList.contains('open')){
          const inside = sidebar.contains(e.target) || btn?.contains(e.target);
          if(!inside) toggle(false);
        }
      });

      // keep state consistent when resizing between mobile/desktop
      window.addEventListener('resize', ()=>{
        try{ setOpen(isOpenState); }catch(_){ }
      });

      // initial state
      const initiallyOpen = isMobile() ? sidebar?.classList.contains('open') : !sidebar?.classList.contains('collapsed');
      isOpenState = !!initiallyOpen;
      updateBtn(isOpenState);
    }

    // Navegaci√≥n
    function setupNavigation(){
      const sidebar = document.querySelector('.sidebar');
      // Listeners directos (por si el DOM es est√°tico)
      $$('.nav-link').forEach(a=> a.addEventListener('click', (e)=>{
        e.preventDefault();
        const link = e.currentTarget;
        const id = (link.getAttribute('href')||'').replace('#','');
        if(id) showView(id);
        if(window.innerWidth <= 1024){
          try{ window.__toggleSidebar?.(false); }catch(_){ if(sidebar?.classList.contains('open')) sidebar.classList.remove('open'); }
        }
      }));
      // Delegaci√≥n global (respaldo si los directos no se adjuntan por timing)
      document.addEventListener('click', (e)=>{
        const link = e.target.closest('a.nav-link');
        if(!link) return;
        e.preventDefault();
        const id = (link.getAttribute('href')||'').replace('#','');
        if(id) showView(id);
        if(window.innerWidth <= 1024){
          try{ window.__toggleSidebar?.(false); }catch(_){ if(sidebar?.classList.contains('open')) sidebar.classList.remove('open'); }
        }
      });
      // Navegar con el hash de la URL
      function navigateToHash(){
  const id = (location.hash||'').replace('#','') || 'inicio';
  const exists = document.getElementById('view-'+id);
  showView(exists ? id : 'inicio');
      }
      window.addEventListener('hashchange', navigateToHash);
      // Sincronizar al inicio
      navigateToHash();
    }
    function showView(id){
      try{
        console.log('[NAV] showView ->', id);
        try{ document.body.setAttribute('data-view', id); }catch(_){ }
        const targetId = 'view-' + id; // fix: incluir gui√≥n
        const views = $$('.view');
        let found = false;
        views.forEach(v=>{
          if(v.id===targetId){ v.classList.add('active'); v.style.display='block'; found = true; }
          else { v.classList.remove('active'); v.style.display='none'; }
        });
        if(!found){ console.warn('[NAV] Vista no encontrada:', targetId); }
        $$('.nav-link').forEach(a=> a.classList.toggle('active', a.getAttribute('href')==='#'+id));
        if(id==='dashboard') updateDashboard();
        if(id==='vender'){
          try{ document.getElementById('pos-search-input').value=''; }catch(_){ }
          posCategoryFilter = 'all';
          renderPosProductList();
        }
  if(id==='reportes') renderCharts();
  if(id==='inventario') renderInventario();
  if(id==='recomendaciones') renderRecomendaciones();
  if(id==='pedidos-pendientes') renderPedidosPendientes();
  if(id==='finanzas') renderFinanzas();
        if(id==='productos') { 
          renderProductosFilterButtons();
          renderProductosTabla(); 
          renderProfitabilityCharts();
        }
        if(id==='estaciones') renderEstacionesTabla();
        if(id==='ingredientes') renderIngredientesTabla();
  if(id==='insumos') renderInsumosView();
  if(id==='clientes') renderClientesTabla();
  if(id==='finanzas') renderFinanzas();
        if(id==='ventas') renderVentasTabla();
      }catch(e){ console.error('[NAV] showView error', e); }
    }

    // ===== Finanzas: helpers =====
    function getFinancePeriod(){
      const sel = document.getElementById('fin-period-select');
      let now = new Date();
      let start = new Date(now);
      const v = sel?.value || '30d';
      if(v==='today') start.setHours(0,0,0,0);
      else if(v==='30d') start.setDate(start.getDate()-30);
      else if(v==='month') start = new Date(now.getFullYear(), now.getMonth(), 1);
      else if(v==='all') start = new Date(0);
      else if(v==='custom'){
        const s = document.getElementById('fin-date-start')?.value;
        const e = document.getElementById('fin-date-end')?.value;
        start = s ? new Date(s+'T00:00:00') : new Date(0);
        now = e ? new Date(e+'T23:59:59') : new Date();
      } else { start.setDate(start.getDate()-7); }
      return { start, end: now };
    }

    function weeklyBuckets(start, end){
      const weeks = [];
      let d = new Date(start);
      d.setHours(0,0,0,0);
      while(d <= end){
        const wkStart = new Date(d);
        const wkEnd = new Date(wkStart); wkEnd.setDate(wkEnd.getDate()+6); wkEnd.setHours(23,59,59,999);
        weeks.push({ start: wkStart, end: wkEnd, rev:0, cogs:0, payroll:0, services:0, net:0 });
        d.setDate(d.getDate()+7);
      }
      return weeks;
    }

    // ====== PDF Logo & Watermark helpers ======
    async function getCompanyLogo(){
      if(window.__companyLogoCache) return window.__companyLogoCache;
      try{
        const src = 'company.png';
        const data = await new Promise((resolve)=>{
          const img = new Image();
          img.crossOrigin = 'anonymous';
          img.onload = ()=>{
            try{
              const canvas = document.createElement('canvas');
              canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0);
              const dataUrl = canvas.toDataURL('image/png');
              resolve({ dataUrl, w: img.naturalWidth, h: img.naturalHeight });
            }catch(_){ resolve(null); }
          };
          img.onerror = ()=> resolve(null);
          img.src = src;
        });
        window.__companyLogoCache = data;
        return data;
      }catch(_){ return null; }
    }
    function drawWatermark(doc, logo){
      if(!logo) return;
      try{
        const pageW = doc.internal.pageSize.getWidth();
        const pageH = doc.internal.pageSize.getHeight();
        // Make watermark larger for visibility
        const maxW = pageW * 0.70;
        const maxH = pageH * 0.70;
        const ratio = (logo.w||1)/(logo.h||1);
        let w = maxW; let h = w/ratio;
        if(h>maxH){ h=maxH; w=h*ratio; }
        const x = (pageW - w)/2; const y = (pageH - h)/2;
        if(doc.GState && doc.setGState){
          // Slightly higher opacity to be noticeable but not obstructive
          const gs = new doc.GState({ opacity: 0.14 });
          doc.setGState(gs);
          doc.addImage(logo.dataUrl, 'PNG', x, y, w, h, undefined, 'FAST');
          const gs1 = new doc.GState({ opacity: 1 });
          doc.setGState(gs1);
        } else {
          // Fallback (no opacity control): draw smaller to avoid overpowering text
          doc.addImage(logo.dataUrl, 'PNG', x, y, w*0.6, h*0.6, undefined, 'FAST');
        }
      }catch(_){ /* ignore */ }
    }
    function drawHeaderLogo(doc, logo){
      if(!logo) return;
      try{
        const pageW = doc.internal.pageSize.getWidth();
        const margin = 40;
        const targetH = 26;
        const ratio = (logo.w||1)/(logo.h||1);
        const targetW = targetH * ratio;
        const x = pageW - margin - targetW;
        const y = 12;
        doc.addImage(logo.dataUrl, 'PNG', x, y, targetW, targetH, undefined, 'FAST');
      }catch(_){ }
    }

    // ====== PDF Theme helpers (UI parity) ======
    function getCssVar(name, fallback=''){
      try{
        const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        return v || fallback;
      }catch(_){ return fallback; }
    }
    function hexToRgb(hex){
      try{
        const h0 = String(hex||'').trim();
        if(!h0.startsWith('#')) return null;
        const h = h0.slice(1);
        const full = (h.length===3) ? h.split('').map(c=>c+c).join('') : h.slice(0,6);
        if(!/^[0-9a-fA-F]{6}$/.test(full)) return null;
        const int = parseInt(full, 16);
        return { r:(int>>16)&255, g:(int>>8)&255, b:int&255 };
      }catch(_){ return null; }
    }
    function cssColorToRgb(color, fallback){
      const c = String(color||'').trim();
      if(!c) return fallback;
      if(c.startsWith('#')) return hexToRgb(c) || fallback;
      const m = c.match(/^rgba?\((\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);
      if(m) return { r: Number(m[1])||0, g: Number(m[2])||0, b: Number(m[3])||0 };
      return fallback;
    }
    function getPdfTheme(){
      const accent = cssColorToRgb(getCssVar('--burger-accent', '#2563EB'), { r:37, g:99, b:235 });
      const surface2 = cssColorToRgb(getCssVar('--app-surface-2', '#F9FAFB'), { r:249, g:250, b:251 });
      const border = cssColorToRgb(getCssVar('--app-border', '#E2E8F0'), { r:226, g:232, b:240 });
      const muted = cssColorToRgb(getCssVar('--app-muted', '#64748B'), { r:100, g:116, b:139 });
      return { accent, surface2, border, muted };
    }
    function pdfDrawBrandBand(doc, logo, title, subtitle, opts={}){
      const theme = getPdfTheme();
      const pageW = doc.internal.pageSize.getWidth();
      const margin = opts.margin ?? 40;
      const bandH = opts.bandH ?? 64;
      const titleSize = opts.titleSize ?? 18;
      const subSize = opts.subSize ?? 11;
      doc.setFillColor(theme.accent.r, theme.accent.g, theme.accent.b);
      doc.rect(0, 0, pageW, bandH, 'F');
      doc.setTextColor(255);
      doc.setFont('helvetica','bold');
      doc.setFontSize(titleSize);
      doc.text(String(title||'Gestia'), margin, 28);
      doc.setFont('helvetica','normal');
      doc.setFontSize(subSize);
      if(subtitle) doc.text(String(subtitle), margin, 46);
      doc.setTextColor(0);
      drawHeaderLogo(doc, logo);
      if(opts.watermark !== false) drawWatermark(doc, logo);
      return bandH + 10;
    }
    function pdfApplyTableHeaderStyle(doc){
      const theme = getPdfTheme();
      doc.setFillColor(theme.surface2.r, theme.surface2.g, theme.surface2.b);
      doc.setDrawColor(theme.border.r, theme.border.g, theme.border.b);
    }

    function pdfPad2(n){ return String(Number(n)||0).padStart(2,'0'); }
    function pdfIsoDate(d){
      try{
        const dd = (d instanceof Date) ? d : new Date(d);
        if(Number.isNaN(dd.getTime())) return '';
        return `${dd.getFullYear()}-${pdfPad2(dd.getMonth()+1)}-${pdfPad2(dd.getDate())}`;
      }catch(_){ return ''; }
    }
    function pdfDateTimeStamp(d){
      try{
        const dd = (d instanceof Date) ? d : new Date(d);
        if(Number.isNaN(dd.getTime())) return '';
        return `${pdfIsoDate(dd)} ${pdfPad2(dd.getHours())}:${pdfPad2(dd.getMinutes())}`;
      }catch(_){ return ''; }
    }
    function pdfSafeFilenamePart(s){
      try{
        const raw = String(s??'').trim();
        if(!raw) return '';
        let out = raw;
        try{ out = out.normalize('NFD').replace(/[\u0300-\u036f]/g,''); }catch(_){ }
        out = out.replace(/\s+/g,'_');
        out = out.replace(/[^a-zA-Z0-9._-]/g,'');
        out = out.replace(/_+/g,'_');
        return out.replace(/^[_\.\-]+|[_\.\-]+$/g,'');
      }catch(_){ return ''; }
    }
    function pdfBuildFilename(opts={}){
      const brand = pdfSafeFilenamePart(opts.brand || 'Gestia') || 'Gestia';
      const report = pdfSafeFilenamePart(opts.report || 'reporte') || 'reporte';
      const extra = pdfSafeFilenamePart(opts.extra || '');
      const start = opts.start ? pdfIsoDate(opts.start) : '';
      const end = opts.end ? pdfIsoDate(opts.end) : '';
      let period = '';
      if(start && end) period = `${start}_a_${end}`;
      else if(start) period = start;
      else period = pdfIsoDate(new Date());
      const parts = [brand, report, period];
      if(extra) parts.push(extra);
      return `${parts.filter(Boolean).join('_')}.pdf`;
    }
    function pdfDrawPageFrame(doc, opts={}){
      try{
        const theme = getPdfTheme();
        const pageW = doc.internal.pageSize.getWidth();
        const pageH = doc.internal.pageSize.getHeight();
        const frameM = opts.frameMargin ?? 18;
        doc.setDrawColor(theme.border.r, theme.border.g, theme.border.b);
        doc.setLineWidth(0.8);
        doc.rect(frameM, frameM, pageW - frameM*2, pageH - frameM*2, 'S');
      }catch(_){ }
    }
    function pdfDrawStandardFooter(doc, pageNo, totalPages, opts={}){
      try{
        const theme = getPdfTheme();
        const pageW = doc.internal.pageSize.getWidth();
        const pageH = doc.internal.pageSize.getHeight();
        const frameM = opts.frameMargin ?? 18;
        const margin = opts.margin ?? 40;
        const footerH = opts.footerH ?? (margin - frameM);
        const footerTop = pageH - frameM - footerH;
        const leftPad = 10;
        const rightPad = 10;

        doc.setFillColor(theme.surface2.r, theme.surface2.g, theme.surface2.b);
        doc.rect(frameM, footerTop, pageW - frameM*2, footerH, 'F');
        doc.setDrawColor(theme.border.r, theme.border.g, theme.border.b);
        doc.line(frameM, footerTop, pageW - frameM, footerTop);

        const brand = String(opts.brand || 'Gestia');
        const reportName = String(opts.reportName || '').trim();
        const periodText = String(opts.periodText || '').trim();
        const generatedAt = opts.generatedAt || new Date();
        const gen = pdfDateTimeStamp(generatedAt);

        const left = [brand, reportName, periodText].filter(Boolean).join(' ‚Ä¢ ');
        const right = `Generado: ${gen} ‚Ä¢ P√°gina ${pageNo}/${totalPages}`;

        doc.setFont('helvetica','normal');
        doc.setFontSize(8.5);
        doc.setTextColor(theme.muted.r, theme.muted.g, theme.muted.b);
        const y = footerTop + footerH - 10;
        doc.text(left, frameM + leftPad, y);
        doc.text(right, pageW - frameM - rightPad, y, { align:'right' });
        doc.setTextColor(0);
      }catch(_){ }
    }
    function pdfFinalizeDocument(doc, opts={}){
      try{
        const total = doc.getNumberOfPages();
        for(let p=1; p<=total; p++){
          doc.setPage(p);
          pdfDrawPageFrame(doc, opts);
          pdfDrawStandardFooter(doc, p, total, opts);
        }
      }catch(_){ }
    }
    // Estimar COGS por ingrediente a partir de ventas y recetas
    function estimateCOGSByIngredientFromVentas(ventas){
      const byIng = new Map();
      const sum = (arr,f)=> arr.reduce((s,x)=> s + (f?f(x):x), 0);
      (ventas||[]).forEach(v=>{
        (v.items||[]).forEach(it=>{
          const p = appState.productos.find(pp=>pp.id===it.productoId);
          const qty = Number(it.cantidad)||0;
          const receta = Array.isArray(p?.receta)? p.receta : [];
          receta.forEach(r=>{
            const ing = getIngredientById(r.ingredienteId);
            if(!ing) return;
            const unitCost = getUnitCost(ing);
            const used = (Number(r.cantidad)||0) * qty;
            const cost = used * unitCost;
            const curr = byIng.get(ing.id) || { ingredienteId: ing.id, nombre: ing.nombre, unidad: ing.unidad||'', cantidad:0, costo:0 };
            curr.cantidad += used; curr.costo += cost; byIng.set(ing.id, curr);
          });
        });
      });
      const arr = Array.from(byIng.values());
      const total = sum(arr, x=> x.costo||0);
      arr.sort((a,b)=> (b.costo||0) - (a.costo||0));
      return { total, list: arr };
    }

    // Exportar PDF: Resumen Finanzas con KPIs, Top, COGS e √≠ndice por fecha
  async function exportVentasPDFForFinanzas(){
      try{
        const { jsPDF } = window.jspdf || {};
        if(!jsPDF){ alert('No se pudo cargar jsPDF'); return; }
        const generatedAt = new Date();
        const { start, end } = getFinancePeriod();
        const ventas = (appState.ventas||[])
          .filter(v=> !v.cancelada)
          .filter(v=>{ const d=new Date(v.fecha); return d>=start && d<=end; })
          .sort((a,b)=> new Date(a.fecha)-new Date(b.fecha));

    const doc = new jsPDF({ unit:'pt', format:'a4' });
    const logo = await getCompanyLogo();
      const margin = 40;
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
        const money = (n)=> '$'+(Number(n)||0).toFixed(2);
        const sum = (arr,f)=> (arr||[]).reduce((s,x)=> s + (f?f(x):x), 0);
      let y = pdfDrawBrandBand(doc, logo, 'Gestia', 'Resumen de ventas', { margin });
    const ensureSpace = (need)=>{ if(y + need > pageH - margin){ doc.addPage(); y = margin; drawWatermark(doc, logo); drawHeaderLogo(doc, logo); } };
        const writeLine = (text, opts={})=>{ const size=opts.size||10; doc.setFontSize(size); if(opts.bold){ doc.setFont('helvetica','bold'); } else { doc.setFont('helvetica','normal'); } doc.text(String(text), margin, y); y += opts.leading || 16; };
      doc.setFont('helvetica','normal');
      writeLine(`Periodo: ${start.toLocaleDateString()} a ${end.toLocaleDateString()}`, { size:10, leading:18 });
      writeLine(`Generado: ${generatedAt.toLocaleString()}`, { size:9, leading:16 });
      y += 6;

        // ===== KPIs =====
  const ingresos = sum(ventas, v=> v.total||0);
  const descuento = sum(ventas, v=> v.descuento||0);
  const envio = sum(ventas, v=> v.costoEnvio||0);
  const productRevenue = sum(ventas, v=> (v.subtotal||0) - (v.descuento||0)); // sin env√≠o
  const cogsAgg = estimateCOGSByIngredientFromVentas(ventas);
  const cogs = cogsAgg.total||0;
  const gp = productRevenue - cogs;
  const payroll = payrollForRange(start, end);
  const services = servicesForRange(start, end);
  const net = gp - payroll - services;
  const orders = ventas.length;
  const aov = orders>0? productRevenue/orders : 0;

        writeLine('Resumen KPIs', { size:12, leading:18, bold:true });
        ensureSpace(90);
        const kpiRows = [
          ['Ingresos (total)', money(ingresos)],
          ['Descuento aplicado', money(descuento)],
          ['Env√≠o cobrado', money(envio)],
          ['COGS estimado', money(cogs)],
          ['Margen bruto (prod. - COGS)', money(gp)],
          ['Sueldos (periodo)', money(payroll)],
          ['Servicios (periodo)', money(services)],
          ['Utilidad neta (est.)', money(net)],
          ['√ìrdenes', String(orders)],
          ['Ticket promedio (sin env√≠o)', money(aov)]
        ];
        kpiRows.forEach(r=>{ writeLine(`‚Ä¢ ${r[0]}: ${r[1]}`, { size:10, leading:14 }); });
        y += 6;

        // ===== Top productos =====
        writeLine('Top 10 productos', { size:12, leading:18, bold:true });
        // Recuento por cantidad y estimaci√≥n de ingresos por l√≠nea (proporcional al descuento por venta)
        const counts = new Map();
        const revs = new Map();
        ventas.forEach(v=>{
          const d = Number(v.descuento||0);
          const sub = Number(v.subtotal|| sum(v.items||[], it=> (Number(it.precio)||0)*(Number(it.cantidad)||0)));
          (v.items||[]).forEach(it=>{
            const name = it.nombre || (appState.productos.find(p=>p.id===it.productoId)?.nombre) || 'Producto';
            const qty = Number(it.cantidad)||0;
            const lineRev = (Number(it.precio)||0) * qty;
            const adjRev = sub>0 ? (lineRev - d*(lineRev/sub)) : lineRev; // prorratea descuento
            counts.set(name, (counts.get(name)||0)+qty);
            revs.set(name, (revs.get(name)||0)+adjRev);
          });
        });
        const top = Array.from(counts.entries()).sort((a,b)=> (b[1]-a[1])).slice(0,10);
        const tpHeaders = ['Producto','Cant.','Ingresos'];
        const tpW = [260, 60, 120];
        const drawHeader = (headers, widths)=>{
          doc.setFont('helvetica','bold');
          let x = margin; y += 4; doc.setDrawColor(220); doc.line(margin, y, pageW - margin, y); y += 14;
          headers.forEach((h,i)=>{ doc.text(h, x, y); x += widths[i]; }); y += 8; doc.setDrawColor(220); doc.line(margin, y, pageW - margin, y); y += 8; doc.setFont('helvetica','normal');
        };
        ensureSpace(60);
        drawHeader(tpHeaders, tpW);
        if(top.length===0){ ensureSpace(18); doc.text('Sin datos en el periodo', margin, y); y += 16; }
        else {
          top.forEach(([name, qty])=>{
            ensureSpace(18);
            let x = margin;
            const row = [name, String(qty), money(revs.get(name)||0)];
            row.forEach((cell,i)=>{ doc.text(String(cell), x, y); x += tpW[i]; });
            y += 16;
          });
        }
        y += 6;

        // ===== COGS por ingrediente =====
        writeLine('COGS estimado por ingrediente (Top 10)', { size:12, leading:18, bold:true });
        const ingHeaders = ['Ingrediente','Cant.','Unidad','Costo'];
        const ingW = [220, 70, 60, 120];
        ensureSpace(60);
        drawHeader(ingHeaders, ingW);
        const cogsTop = (cogsAgg.list||[]).slice(0,10);
        if(cogsTop.length===0){ ensureSpace(18); doc.text('Sin datos en el periodo', margin, y); y += 16; }
        else {
          cogsTop.forEach(r=>{
            ensureSpace(18);
            let x = margin;
            const row = [r.nombre||'‚Äî', (Number(r.cantidad)||0).toFixed(2), r.unidad||'', money(r.costo||0)];
            row.forEach((cell,i)=>{ doc.text(String(cell), x, y); x += ingW[i]; });
            y += 16;
          });
        }
        ensureSpace(24);
        doc.setFont('helvetica','bold');
        doc.text(`Total COGS estimado: ${money(cogs)}`, margin, y); y += 18; doc.setFont('helvetica','normal');

        // ===== Detalle: Ventas por fecha =====
        ensureSpace(40);
        writeLine('Ventas por fecha', { size:12, leading:18, bold:true });
        const vhHeaders = ['Fecha','ID','Cliente','Items','Total'];
        const vhW = [120, 80, 200, 60, 80];
        const drawSalesHeader = ()=>{ drawHeader(vhHeaders, vhW); };
        ensureSpace(40);
        drawSalesHeader();
        let totalVentas = 0;
        if(ventas.length===0){ ensureSpace(18); doc.text('Sin ventas en el periodo', margin, y); y += 16; }
        else {
          for(const v of ventas){
            const itemsCount = sum(v.items||[], it=> it.cantidad||0);
            const label = (typeof v.saleNumber==='number' && v.saleNumber>0) ? `Venta${v.saleNumber}` : `#${String(v.id).slice(0,6)}`;
            const cliente = v.clienteId ? (appState.clientes.find(c=>c.id===v.clienteId)?.nombre || '‚Äî') : 'General';
            const row = [ new Date(v.fecha).toLocaleString(), label, cliente, String(itemsCount), money(v.total||0) ];
            ensureSpace(18);
            let x = margin; row.forEach((cell,i)=>{ doc.text(String(cell), x, y); x += vhW[i]; }); y += 16;
            totalVentas += (v.total||0);
          }
          ensureSpace(30);
          doc.setDrawColor(220); doc.line(margin, y, pageW - margin, y); y += 18;
          doc.setFont('helvetica','bold');
          writeLine(`Total de ventas: ${money(totalVentas)}`, { size:12 });
        }

        pdfFinalizeDocument(doc, { brand:'Gestia', reportName:'Resumen de ventas', periodText:`${pdfIsoDate(start)} a ${pdfIsoDate(end)}`, generatedAt, margin });
        doc.save(pdfBuildFilename({ brand:'Gestia', report:'Ventas_Finanzas', start, end }));
      }catch(e){ console.warn('exportVentasPDFForFinanzas', e); alert('No se pudo generar el PDF.'); }
    }

    function payrollForRange(start, end){
      const emps = appState.finanzas?.empleados||[];
      // sueldoSemanal se prorratea por n√∫mero de semanas completas o parciales
      const msPerDay = 86400000;
      const days = Math.max(1, Math.ceil((end - start + 1) / msPerDay));
      const weeks = days/7;
      const totalWeekly = emps.filter(e=> e.activo!==false).reduce((s,e)=> s + (Number(e.sueldoSemanal)||0), 0);
      return totalWeekly * weeks;
    }

    function servicesForRange(start, end){
      // servicios: { nombre, monto, frecuencia: 'semanal'|'mensual'|'fijo' }
      const svcs = appState.finanzas?.servicios||[];
      const days = Math.max(1, Math.ceil((end - start + 1)/86400000));
      const weeks = days/7;
      const months = days/30.4375;
      let total = 0;
      svcs.forEach(s=>{
        const amt = Number(s.monto)||0; const f = (s.frecuencia||'mensual');
        if(f==='semanal') total += amt * weeks;
        else if(f==='mensual') total += amt * months;
        else total += amt; // fijo por periodo
      });
      return total;
    }

    function renderCaja(){
      try{
        const setTxt = (id, txt) => { const el = document.getElementById(id); if(el) el.textContent = txt; };
        const sum = (arr, f)=> arr.reduce((s,x)=> s + (f?f(x):x), 0);
        const norm = (m)=> (String(m||'').toLowerCase().includes('efect') ? 'efectivo' : 'tarjeta');

        // Caja es balance hist√≥rico (todo el tiempo)
        const start = new Date(0);
        const end = new Date();

        const ventas = (appState.ventas||[])
          .filter(v=> !v?.cancelada)
          .filter(v=> { const d = new Date(v.fecha); return d>=start && d<=end; });
        const ingVentasEf = sum(ventas.filter(v=> norm(v?.pago?.metodo)==='efectivo'), v=> Number(v.total)||0);
        const ingVentasTar = sum(ventas.filter(v=> norm(v?.pago?.metodo)!=='efectivo'), v=> Number(v.total)||0);

        const otrosIngresos = (appState.cajaIngresos||[])
          .filter(i=> !i?.cancelado)
          .filter(i=> { const d = new Date(i.fecha); return d>=start && d<=end; });
        const ingOtrosEf = sum(otrosIngresos.filter(i=> norm(i?.metodo||'Efectivo')==='efectivo'), i=> Number(i.monto)||0);
        const ingOtrosTar = sum(otrosIngresos.filter(i=> norm(i?.metodo||'Efectivo')!=='efectivo'), i=> Number(i.monto)||0);

        const ingEf = ingVentasEf + ingOtrosEf;
        const ingTar = ingVentasTar + ingOtrosTar;

        const gastosAll = (appState.finanzas?.gastos||[]);
        const gastos = gastosAll.filter(g=>{ const d = new Date(g.fecha); return d>=start && d<=end; });

        // Compras de insumos (Inventario) tambi√©n cuentan como gasto en Caja
        const compras = (appState.inventario?.compras||[])
          .filter(c=> !c?.cancelada)
          .filter(c=>{ const d = new Date(c.fecha); return d>=start && d<=end; })
          .map(c=>{
            let ingName = 'Insumo';
            try{ const ing = (typeof getIngredientById==='function') ? getIngredientById(c.ingredienteId) : null; if(ing?.nombre) ingName = ing.nombre; }catch(_){ }
            const nota = (c.nota||'').toString().trim();
            return {
              id: `compra:${c.id}`,
              fecha: c.fecha,
              tipo: 'compra_insumo',
              metodo: (c.metodo||'Efectivo'),
              monto: Number(c.costo)||0,
              descripcion: `Compra insumo: ${ingName}${nota?` ‚Äî ${nota}`:''}`,
              __source: 'compra'
            };
          });

        const gastosCombined = gastos.concat(compras);
        const gasEf = sum(gastosCombined.filter(g=> norm(g?.metodo||'Efectivo')==='efectivo'), g=> Number(g.monto)||0);
        const gasTar = sum(gastosCombined.filter(g=> norm(g?.metodo||'Efectivo')!=='efectivo'), g=> Number(g.monto)||0);

        // Traspasos ajustan saldos por m√©todo sin cambiar el total
        const traspasos = (appState.cajaTransferencias||[])
          .filter(t=> !t?.cancelada)
          .filter(t=>{ const d = new Date(t.fecha); return d>=start && d<=end; });
        const traspEfATar = sum(traspasos.filter(t=> norm(t?.de)==='efectivo' && norm(t?.a)!=='efectivo'), t=> Number(t.monto)||0);
        const traspTarAEf = sum(traspasos.filter(t=> norm(t?.de)!=='efectivo' && norm(t?.a)==='efectivo'), t=> Number(t.monto)||0);

        const totalEf = (ingEf - gasEf) - traspEfATar + traspTarAEf;
        const totalTar = (ingTar - gasTar) + traspEfATar - traspTarAEf;
        const totalCaja = totalEf + totalTar;

        // Pendientes (no disponible): se descuentan del disponible, pero siguen contando dentro del total
        const pendientes = (appState.cajaPendientes||[])
          .filter(p=> !p?.resuelta)
          .filter(p=>{ const d = new Date(p.fecha); return d>=start && d<=end; });
        const noDispEf = sum(pendientes.filter(p=> norm(p?.metodo||'Efectivo')==='efectivo'), p=> Number(p.monto)||0);
        const noDispTar = sum(pendientes.filter(p=> norm(p?.metodo||'Efectivo')!=='efectivo'), p=> Number(p.monto)||0);
        const noDispTotal = noDispEf + noDispTar;

        const dispEf = totalEf - noDispEf;
        const dispTar = totalTar - noDispTar;
        const dispTotal = dispEf + dispTar;

        setTxt('caja-ing-ef', fmt(ingEf));
        setTxt('caja-ing-tar', fmt(ingTar));
        setTxt('caja-gas-ef', fmt(gasEf));
        setTxt('caja-gas-tar', fmt(gasTar));
        setTxt('caja-sal-ef', fmt(dispEf));
        setTxt('caja-sal-tar', fmt(dispTar));
        setTxt('caja-sal-total', fmt(dispTotal));

        setTxt('caja-nodisp-ef', fmt(noDispEf));
        setTxt('caja-nodisp-tar', fmt(noDispTar));
        setTxt('caja-nodisp-total', fmt(noDispTotal));
        setTxt('caja-total-ef', fmt(totalEf));
        setTxt('caja-total-tar', fmt(totalTar));
        setTxt('caja-total-total', fmt(totalCaja));

        // Tabla detalle de ingresos (manuales)
        const ib = document.getElementById('caja-ingresos-body');
        if(ib){
          ib.innerHTML = '';
          const list = otrosIngresos.slice().sort((a,b)=> new Date(b.fecha) - new Date(a.fecha));
          list.forEach(i=>{
            const tr = document.createElement('tr');
            const metodoDisplay = (String(i.metodo||'Efectivo').toLowerCase().includes('efect') ? 'Efectivo' : 'Tarjeta');
            tr.innerHTML = `<td class="p-2">${new Date(i.fecha).toLocaleDateString()}</td>`+
              `<td class="p-2">${metodoDisplay}</td>`+
              `<td class="p-2">${i.descripcion||'‚Äî'}</td>`+
              `<td class="p-2 text-right num">${fmt(Number(i.monto)||0)}</td>`+
              `<td class="p-2">`+
                `<button class="px-2 py-1 rounded border text-sm caja-edit-ing" data-id="${i.id}">Editar</button> `+
                `<button class="px-2 py-1 rounded border text-sm caja-del-ing" data-id="${i.id}">Eliminar</button>`+
              `</td>`;
            ib.appendChild(tr);
          });
          setTxt('caja-ingresos-total', fmt(sum(otrosIngresos, ii=> Number(ii.monto)||0)));
        }

        // Tabla detalle de gastos
        const gb = document.getElementById('caja-gastos-body');
        if(gb){
          gb.innerHTML = '';
          const gastosList = gastosCombined.slice().sort((a,b)=> new Date(b.fecha) - new Date(a.fecha));
          const tipoMap = { 'sueldo': 'üíµ Sueldo', 'gas': 'üî• Gas', 'gasolina': '‚õΩ Gasolina', 'insumos': 'üì¶ Insumos', 'compra_insumo': 'üì¶ Compra de insumos', 'otro': 'üìå Otro' };
          gastosList.forEach(g=>{
            const tr = document.createElement('tr');
            const tipoDisplay = tipoMap[g.tipo] || g.tipo || 'üìå Otro';
            const metodoDisplay = (String(g.metodo||'Efectivo').toLowerCase().includes('efect') ? 'Efectivo' : 'Tarjeta');
            const actions = (g.__source==='compra')
              ? '<span class="text-xs opacity-60">‚Äî</span>'
              : `<button class="px-2 py-1 rounded border text-sm fin-edit-gasto" data-id="${g.id}">Editar</button> `+
                `<button class="px-2 py-1 rounded border text-sm fin-del-gasto" data-id="${g.id}">Eliminar</button>`;
            tr.innerHTML = `<td class="p-2">${new Date(g.fecha).toLocaleDateString()}</td>`+
              `<td class="p-2">${tipoDisplay}</td>`+
              `<td class="p-2">${metodoDisplay}</td>`+
              `<td class="p-2">${g.descripcion||'‚Äî'}</td>`+
              `<td class="p-2 text-right num">${fmt(Number(g.monto)||0)}</td>`+
              `<td class="p-2">${actions}</td>`;
            gb.appendChild(tr);
          });
          setTxt('caja-gastos-total', fmt(sum(gastosCombined, gg=> Number(gg.monto)||0)));
        }

        // Tabla pendientes (no disponible)
        const pb = document.getElementById('caja-pendientes-body');
        if(pb){
          pb.innerHTML = '';
          const tipoMap = { 'prestamo': 'ü§ù Pr√©stamo', 'cobro': 'üßæ Cobro pendiente', 'otro': 'üìå Otro' };
          const list = pendientes.slice().sort((a,b)=> new Date(b.fecha) - new Date(a.fecha));
          list.forEach(p=>{
            const tr = document.createElement('tr');
            const tipoDisplay = tipoMap[p.tipo] || p.tipo || 'üìå Otro';
            const metodoDisplay = (String(p.metodo||'Efectivo').toLowerCase().includes('efect') ? 'Efectivo' : 'Tarjeta');
            tr.innerHTML = `<td class="p-2">${new Date(p.fecha).toLocaleDateString()}</td>`+
              `<td class="p-2">${tipoDisplay}</td>`+
              `<td class="p-2">${metodoDisplay}</td>`+
              `<td class="p-2">${p.descripcion||'‚Äî'}</td>`+
              `<td class="p-2 text-right num">${fmt(Number(p.monto)||0)}</td>`+
              `<td class="p-2">`+
                `<button class="px-2 py-1 rounded border text-sm caja-resolve-pend" data-id="${p.id}">Resolver</button> `+
                `<button class="px-2 py-1 rounded border text-sm caja-del-pend" data-id="${p.id}">Eliminar</button>`+
              `</td>`;
            pb.appendChild(tr);
          });
          setTxt('caja-pendientes-total', fmt(sum(pendientes, pp=> Number(pp.monto)||0)));
        }
      }catch(e){ console.warn('renderCaja', e); }
    }

    function renderFinanzas(){
      try{
        const { start, end } = getFinancePeriod();
        // Ventas filtradas
        const ventas = (appState.ventas||[]).filter(v=> !v.cancelada && new Date(v.fecha)>=start && new Date(v.fecha)<=end);
        const sum = (arr,f)=> arr.reduce((s,x)=> s + (f?f(x):x), 0);
  const revenue = sum(ventas, v=> v.total||0); // incluye env√≠o
  const productRevenue = sum(ventas, v=> (v.subtotal||0) - (v.descuento||0)); // excluye env√≠o
  const cogs = sum(ventas, v=> sum(v.items||[], it=>{
          const p = appState.productos.find(pp=>pp.id===it.productoId);
          const cost = (p && typeof p.costo==='number') ? p.costo : computeRecipeCost(p?.receta||[]);
          return (cost||0) * (it.cantidad||0);
        }));
  const gp = productRevenue - cogs;
        const payroll = payrollForRange(start, end);
        const services = servicesForRange(start, end);
        
        // Gastos diarios en el periodo
        const gastos = (appState.finanzas?.gastos||[]).filter(g=> {
          const d = new Date(g.fecha);
          return d >= start && d <= end;
        });
        const gastosTotal = sum(gastos, g=> Number(g.monto)||0);
        
        const net = gp - payroll - services - gastosTotal;
        const setTxt=(id,txt)=>{ const el=document.getElementById(id); if(el) el.textContent=txt; };
        setTxt('fin-kpi-rev', fmt(revenue));
        setTxt('fin-kpi-cogs', fmt(cogs));
  setTxt('fin-kpi-gp', fmt(gp));
  setTxt('fin-kpi-payroll', fmt(payroll));
  setTxt('fin-kpi-services', fmt(services));
  setTxt('fin-kpi-gastos', fmt(gastosTotal));
  setTxt('fin-kpi-net', fmt(net));
  // Asignaciones por departamento
        // Asignaciones por departamento
        const baseSel = document.getElementById('fin-alloc-base');
        if(baseSel){ baseSel.value = appState.finanzas?.allocBase || 'revenue'; }
        const baseKey = (appState.finanzas?.allocBase)||'revenue';
        const baseVal = baseKey==='gp' ? gp : (baseKey==='net' ? net : revenue);
        const baseValEl = document.getElementById('fin-alloc-base-value');
        if(baseValEl){ baseValEl.textContent = fmt(baseVal); }
        const ab = document.getElementById('fin-alloc-body');
        if(ab){
          ab.innerHTML = '';
          const list = (appState.finanzas?.asignaciones)||[];
          let totalPct = 0, totalAmt = 0;
          list.forEach(a=>{
            const pct = Math.max(0, Number(a.porcentaje)||0);
            const amt = baseVal * (pct/100);
            totalPct += pct; totalAmt += amt;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="p-2">${a.nombre||'‚Äî'}</td>`+
              `<td class="p-2 text-right">${pct.toFixed(1)}%</td>`+
              `<td class="p-2 text-right">${fmt(amt)}</td>`+
              `<td class="p-2">`+
              `<button class="px-2 py-1 rounded border text-sm fin-edit-alloc" data-id="${a.id}">Editar</button> `+
              `<button class="px-2 py-1 rounded border text-sm fin-del-alloc" data-id="${a.id}">Eliminar</button>`+
              `</td>`;
            ab.appendChild(tr);
          });
          const totPctEl = document.getElementById('fin-alloc-total-pct');
          const totAmtEl = document.getElementById('fin-alloc-total-amt');
          if(totPctEl){ totPctEl.textContent = `${totalPct.toFixed(1)}%`; totPctEl.style.color = totalPct>100 ? '#b91c1c' : ''; }
          if(totAmtEl){ totAmtEl.textContent = fmt(totalAmt); }
        }
        // Tablas
        const eb = document.getElementById('fin-emp-body'); if(eb){ eb.innerHTML=''; (appState.finanzas?.empleados||[]).forEach(e=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="p-2">${e.nombre||'‚Äî'}</td><td class="p-2 text-right">${fmt(Number(e.sueldoSemanal)||0)}</td><td class="p-2">${e.activo===false? 'No':'S√≠'}</td><td class="p-2">`+
            `<button class="px-2 py-1 rounded border text-sm fin-edit-emp" data-id="${e.id}">Editar</button> `+
            `<button class="px-2 py-1 rounded border text-sm fin-del-emp" data-id="${e.id}">Eliminar</button>`+
            `</td>`;
          eb.appendChild(tr);
        }); }
        const sb = document.getElementById('fin-srv-body'); if(sb){ sb.innerHTML=''; (appState.finanzas?.servicios||[]).forEach(s=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="p-2">${s.nombre||'‚Äî'}</td><td class="p-2 text-right">${fmt(Number(s.monto)||0)}</td><td class="p-2">${s.frecuencia||'mensual'}</td><td class="p-2">`+
            `<button class="px-2 py-1 rounded border text-sm fin-edit-srv" data-id="${s.id}">Editar</button> `+
            `<button class="px-2 py-1 rounded border text-sm fin-del-srv" data-id="${s.id}">Eliminar</button>`+
            `</td>`;
          sb.appendChild(tr);
        }); }
        
        // Tabla de gastos diarios
        const gb = document.getElementById('fin-gastos-body');
        if(gb){
          gb.innerHTML='';
          const gastosList = gastos.slice().sort((a,b)=> new Date(b.fecha) - new Date(a.fecha));
          gastosList.forEach(g=>{
            const tr = document.createElement('tr');
            const tipoMap = { 'sueldo': 'üíµ Sueldo', 'gas': 'üî• Gas', 'gasolina': '‚õΩ Gasolina', 'insumos': 'üì¶ Insumos', 'otro': 'üìå Otro' };
            const tipoDisplay = tipoMap[g.tipo] || g.tipo || 'üìå Otro';
            tr.innerHTML = `<td class="p-2">${new Date(g.fecha).toLocaleDateString()}</td>`+
              `<td class="p-2">${tipoDisplay}</td>`+
              `<td class="p-2">${g.descripcion||'‚Äî'}</td>`+
              `<td class="p-2 text-right num">${fmt(Number(g.monto)||0)}</td>`+
              `<td class="p-2">`+
              `<button class="px-2 py-1 rounded border text-sm fin-edit-gasto" data-id="${g.id}">Editar</button> `+
              `<button class="px-2 py-1 rounded border text-sm fin-del-gasto" data-id="${g.id}">Eliminar</button>`+
              `</td>`;
            gb.appendChild(tr);
          });
          setTxt('fin-gastos-total', fmt(gastosTotal));
        }
        
        // Semanal chart
        const canvas = document.getElementById('fin-weekly-chart');
        const empty = document.getElementById('fin-weekly-empty');
        if(canvas){
          const weeks = weeklyBuckets(start, end);
          // rellenar por semana
          ventas.forEach(v=>{
            weeks.forEach(w=>{ const d=new Date(v.fecha); if(d>=w.start && d<=w.end){
              w.rev += v.total||0; // total con env√≠o
              // revenue de productos sin env√≠o (para margen)
              w.prodRev = (w.prodRev||0) + ((v.subtotal||0) - (v.descuento||0));
              w.cogs += sum(v.items||[], it=>{ const p=appState.productos.find(pp=>pp.id===it.productoId); const c=(p&&typeof p.costo==='number')?p.costo:computeRecipeCost(p?.receta||[]); return (c||0)*(it.cantidad||0); });
            } });
          });
          weeks.forEach(w=>{ 
            w.payroll = payrollForRange(w.start, w.end); 
            w.services = servicesForRange(w.start, w.end);
            // Gastos de esa semana
            w.gastos = sum((appState.finanzas?.gastos||[]).filter(g=> {
              const d = new Date(g.fecha);
              return d >= w.start && d <= w.end;
            }), g=> Number(g.monto)||0);
            const gpW = (w.prodRev||0) - (w.cogs||0); 
            w.net = gpW - w.payroll - w.services - w.gastos; 
          });
          const labels = weeks.map(w=> w.start.toLocaleDateString());
          const netData = weeks.map(w=> Math.round(w.net*100)/100);
          if(window.__finWeekly){ window.__finWeekly.destroy(); window.__finWeekly = undefined; }
          const has = netData.some(x=> x!==0);
          if(!has){ empty?.classList.remove('hidden'); }
          else { empty?.classList.add('hidden'); }
          const ctx = canvas.getContext('2d');
          window.__finWeekly = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ label:'Utilidad neta (est.)', data: netData, backgroundColor: '#FF6B35' }] }, options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ ticks:{ callback:(v)=>'$'+v } } } } });
        }
      }catch(e){ console.warn('renderFinanzas', e); }
    }

    // Finanzas: UI wiring
    (function setupFinanzas(){
      document.addEventListener('change', (e)=>{
        if(e.target?.id==='fin-period-select'){
          const sel = e.target; const box = document.getElementById('fin-custom-range');
          if(sel.value==='custom'){ box?.classList.remove('hidden'); }
          else { box?.classList.add('hidden'); }
          renderFinanzas();
        }
        if(e.target?.id==='fin-date-start' || e.target?.id==='fin-date-end'){ renderFinanzas(); }
        if(e.target?.id==='fin-alloc-base'){
          const v = e.target.value;
          if(!appState.finanzas) appState.finanzas = { empleados:[], servicios:[], asignaciones:[], allocBase:'revenue' };
          appState.finanzas.allocBase = v;
          saveLS();
          renderFinanzas();
        }
      });
      document.addEventListener('click', (e)=>{
  const exportPDF = e.target.closest && e.target.closest('#fin-export-ventas-pdf');
  if(exportPDF){ exportVentasPDFForFinanzas(); return; }

        // Caja: traspaso efectivo -> tarjeta
        const trBtn = e.target.closest && e.target.closest('#caja-transfer-ef-a-tar, #caja-transfer-tar-a-ef');
        if(trBtn){
          const isEfToTar = trBtn.id === 'caja-transfer-ef-a-tar';
          const hoy = new Date().toISOString().slice(0,10);
          openFormModal({ title: isEfToTar ? 'Traspasar Efectivo ‚Üí Tarjeta' : 'Traspasar Tarjeta ‚Üí Efectivo', fields:[
            { name:'fecha', label:'Fecha', type:'date', value:hoy },
            { name:'monto', label:'Monto ($)', type:'number', min:0, step:'0.01' },
            { name:'nota', label:'Nota (opcional)', type:'text' }
          ], submitText:'Registrar traspaso', onSubmit:(data)=>{
            const monto = Number(data.monto)||0;
            if(monto<=0){ alert('Ingresa un monto > 0'); return false; }
            if(!Array.isArray(appState.cajaTransferencias)) appState.cajaTransferencias = [];
            const t = {
              id: generateId('trx'),
              fecha: (data.fecha||hoy),
              de: isEfToTar ? 'Efectivo' : 'Tarjeta',
              a: isEfToTar ? 'Tarjeta' : 'Efectivo',
              monto,
              nota: (data.nota||'').trim()
            };
            appState.cajaTransferencias.push(t);
            saveLS();
            renderCaja();
          }});
          return;
        }

        // Caja: pendientes (no disponible)
        const addPend = e.target.closest && e.target.closest('#caja-add-pendiente, #caja-add-pendiente-quick');
        if(addPend){
          const hoy = new Date().toISOString().slice(0,10);
          openFormModal({ title:'Agregar pendiente (no disponible)', fields:[
            { name:'fecha', label:'Fecha', type:'date', value:hoy },
            { name:'tipo', label:'Tipo', type:'select', value:'prestamo', options:[
              { value:'cobro', label:'Pago pendiente (venta a cr√©dito)' },
              { value:'prestamo', label:'Pr√©stamo de dinero' },
              { value:'otro', label:'Otro' }
            ]},
            { name:'metodo', label:'M√©todo', type:'select', value:'Efectivo', options:[
              { value:'Efectivo', label:'Efectivo' },
              { value:'Tarjeta', label:'Tarjeta' }
            ]},
            { name:'monto', label:'Monto ($)', type:'number', min:0, step:'0.01' },
            { name:'descripcion', label:'Descripci√≥n', type:'text', placeholder:'Ej: Venta a cr√©dito (cliente X) / Pr√©stamo a Juan' }
          ], submitText:'Guardar', onSubmit:(data)=>{
            const monto = Number(data.monto)||0;
            if(monto<=0){ alert('Ingresa un monto > 0'); return false; }
            if(!Array.isArray(appState.cajaPendientes)) appState.cajaPendientes = [];
            appState.cajaPendientes.push({
              id: generateId('pend'),
              fecha: (data.fecha||hoy),
              tipo: data.tipo||'prestamo',
              metodo: data.metodo||'Efectivo',
              monto,
              descripcion: (data.descripcion||'').trim(),
              resuelta: false
            });
            saveLS();
            renderCaja();
          }});
          return;
        }

        // Caja: otros ingresos (manuales)
        const addIng = e.target.closest && e.target.closest('#caja-add-ingreso');
        if(addIng){
          const hoy = new Date().toISOString().slice(0,10);
          openFormModal({ title:'Registrar ingreso (manual)', fields:[
            { name:'fecha', label:'Fecha', type:'date', value:hoy },
            { name:'metodo', label:'M√©todo', type:'select', value:'Efectivo', options:[
              {value:'Efectivo', label:'Efectivo'},
              {value:'Tarjeta', label:'Tarjeta'}
            ]},
            { name:'monto', label:'Monto ($)', type:'number', min:0, step:'0.01' },
            { name:'descripcion', label:'Descripci√≥n', type:'text', placeholder:'Ej: Dep√≥sito, ajuste, otros cobros' }
          ], submitText:'Guardar', onSubmit:(data)=>{
            const monto = Number(data.monto)||0;
            if(monto<=0){ alert('Ingresa un monto > 0'); return false; }
            if(!Array.isArray(appState.cajaIngresos)) appState.cajaIngresos = [];
            appState.cajaIngresos.push({
              id: generateId('ing'),
              fecha: (data.fecha||hoy),
              metodo: data.metodo||'Efectivo',
              monto,
              descripcion: (data.descripcion||'').trim()
            });
            saveLS();
            renderCaja();
          }});
          return;
        }

        const editIng = e.target.closest && e.target.closest('.caja-edit-ing');
        if(editIng){
          const id = editIng.getAttribute('data-id');
          const ing = (appState.cajaIngresos||[]).find(x=> x.id===id);
          if(!ing) return;
          openFormModal({ title:'Editar ingreso', fields:[
            { name:'fecha', label:'Fecha', type:'date', value:(ing.fecha||'').slice(0,10) },
            { name:'metodo', label:'M√©todo', type:'select', value:(ing.metodo||'Efectivo'), options:[
              {value:'Efectivo', label:'Efectivo'},
              {value:'Tarjeta', label:'Tarjeta'}
            ]},
            { name:'monto', label:'Monto ($)', type:'number', min:0, step:'0.01', value:Number(ing.monto)||0 },
            { name:'descripcion', label:'Descripci√≥n', type:'text', value:ing.descripcion||'' }
          ], submitText:'Actualizar', onSubmit:(data)=>{
            const monto = Number(data.monto)||0;
            if(monto<=0){ alert('Ingresa un monto > 0'); return false; }
            ing.fecha = data.fecha || ing.fecha;
            ing.metodo = (data.metodo||ing.metodo||'Efectivo').trim()||'Efectivo';
            ing.monto = monto;
            ing.descripcion = (data.descripcion||'').trim();
            saveLS();
            renderCaja();
          }});
          return;
        }

        const delIng = e.target.closest && e.target.closest('.caja-del-ing');
        if(delIng){
          const id = delIng.getAttribute('data-id');
          if(confirm('¬øEliminar ingreso?')){
            appState.cajaIngresos = (appState.cajaIngresos||[]).filter(x=> x.id!==id);
            saveLS();
            renderCaja();
          }
          return;
        }

        const resolvePend = e.target.closest && e.target.closest('.caja-resolve-pend');
        if(resolvePend){
          const id = resolvePend.getAttribute('data-id');
          const p = (appState.cajaPendientes||[]).find(x=> x.id===id);
          if(!p) return;
          if(confirm('¬øMarcar como resuelto? Esto lo quita de "no disponible".')){
            p.resuelta = true;
            p.fechaResuelta = new Date().toISOString();
            saveLS();
            renderCaja();
          }
          return;
        }

        const delPend = e.target.closest && e.target.closest('.caja-del-pend');
        if(delPend){
          const id = delPend.getAttribute('data-id');
          if(confirm('¬øEliminar pendiente?')){
            appState.cajaPendientes = (appState.cajaPendientes||[]).filter(x=> x.id!==id);
            saveLS();
            renderCaja();
          }
          return;
        }
        const addAlloc = e.target.closest && e.target.closest('#fin-add-alloc');
        if(addAlloc){
          openFormModal({ title:'A√±adir Asignaci√≥n', fields:[
            { name:'nombre', label:'Departamento', type:'text' },
            { name:'porcentaje', label:'% del base', type:'number', min:0, step:'0.1' }
          ], onSubmit:(data)=>{
            const a = { id: generateId('alloc'), nombre:(data.nombre||'').trim()||'Departamento', porcentaje: Math.max(0, Number(data.porcentaje)||0) };
            if(!appState.finanzas) appState.finanzas = { empleados:[], servicios:[], asignaciones:[], allocBase:'revenue' };
            if(!Array.isArray(appState.finanzas.asignaciones)) appState.finanzas.asignaciones = [];
            appState.finanzas.asignaciones.push(a);
            saveLS(); renderFinanzas();
          }});
        }
        const editAllocBtn = e.target.closest && e.target.closest('.fin-edit-alloc');
        if(editAllocBtn){
          const id = editAllocBtn.getAttribute('data-id');
          const a = (appState.finanzas?.asignaciones||[]).find(x=>x.id===id); if(!a) return;
          openFormModal({ title:'Editar Asignaci√≥n', fields:[
            { name:'nombre', label:'Departamento', type:'text', value:a.nombre||'' },
            { name:'porcentaje', label:'% del base', type:'number', min:0, step:'0.1', value:a.porcentaje||0 }
          ], submitText:'Actualizar', onSubmit:(data)=>{
            a.nombre = (data.nombre||'').trim()||a.nombre;
            a.porcentaje = Math.max(0, Number(data.porcentaje)||0);
            saveLS(); renderFinanzas();
          }});
        }
        const delAllocBtn = e.target.closest && e.target.closest('.fin-del-alloc');
        if(delAllocBtn){ const id = delAllocBtn.getAttribute('data-id'); if(confirm('¬øEliminar asignaci√≥n?')){ appState.finanzas.asignaciones = (appState.finanzas?.asignaciones||[]).filter(x=>x.id!==id); saveLS(); renderFinanzas(); } }
        const exportAlloc = e.target.closest && e.target.closest('#fin-alloc-export');
        if(exportAlloc){
          try{
            const baseKey = appState.finanzas?.allocBase || 'revenue';
            const { start, end } = getFinancePeriod();
            const baseVal = (baseKey==='gp')? (document.getElementById('fin-kpi-gp')? Number((document.getElementById('fin-kpi-gp').textContent||'').replace(/[^\d.-]/g,'')) : 0)
                           : (baseKey==='net')? (document.getElementById('fin-kpi-net')? Number((document.getElementById('fin-kpi-net').textContent||'').replace(/[^\d.-]/g,'')) : 0)
                           : (document.getElementById('fin-kpi-rev')? Number((document.getElementById('fin-kpi-rev').textContent||'').replace(/[^\d.-]/g,'')) : 0);
            const rows = [['Departamento','Porcentaje','Base','Monto','PeriodoInicio','PeriodoFin']];
            (appState.finanzas?.asignaciones||[]).forEach(a=>{
              const pct = Math.max(0, Number(a.porcentaje)||0);
              const amt = baseVal * (pct/100);
              rows.push([a.nombre||'', pct.toFixed(1)+'%', baseKey, amt.toFixed(2), start.toISOString(), end.toISOString()]);
            });
            const csv = rows.map(r=> r.map(x=> '"'+String(x).replaceAll('"','""')+'"').join(',')).join('\n');
            const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'asignaciones.csv';
            document.body.appendChild(a); a.click(); a.remove();
          }catch(err){ console.warn('alloc export', err); alert('No se pudo exportar.'); }
        }
        const addEmp = e.target.closest && e.target.closest('#fin-add-emp');
        if(addEmp){
          openFormModal({ title:'A√±adir Empleado', fields:[
            { name:'nombre', label:'Nombre', type:'text' },
            { name:'sueldoSemanal', label:'Sueldo semanal ($)', type:'number', min:0, step:'0.01' },
            { name:'activo', label:'Activo (s√≠/no)', type:'text', placeholder:'s√≠' }
          ], onSubmit:(data)=>{
            const emp = { id: generateId('emp'), nombre:(data.nombre||'').trim()||'Empleado', sueldoSemanal: Number(data.sueldoSemanal)||0, activo: ((data.activo||'s√≠').toLowerCase().startsWith('s')) };
            if(!appState.finanzas) appState.finanzas = { empleados:[], servicios:[], asignaciones:[], allocBase:'revenue' };
            appState.finanzas.empleados.push(emp);
            saveLS(); if(typeof saveEmpleadoToFirestore==='function') saveEmpleadoToFirestore(emp); renderFinanzas();
          }});
        }
        const addSrv = e.target.closest && e.target.closest('#fin-add-srv');
        if(addSrv){
          openFormModal({ title:'A√±adir Servicio', fields:[
            { name:'nombre', label:'Servicio', type:'text' },
            { name:'monto', label:'Monto ($)', type:'number', min:0, step:'0.01' },
            { name:'frecuencia', label:'Frecuencia (semanal/mensual/fijo)', type:'text', placeholder:'mensual' }
          ], onSubmit:(data)=>{
            const srv = { id: generateId('srv'), nombre:(data.nombre||'').trim()||'Servicio', monto: Number(data.monto)||0, frecuencia: (data.frecuencia||'mensual').toLowerCase() };
            if(!appState.finanzas) appState.finanzas = { empleados:[], servicios:[], asignaciones:[], allocBase:'revenue' };
            appState.finanzas.servicios.push(srv);
            saveLS(); if(typeof saveServicioToFirestore==='function') saveServicioToFirestore(srv); renderFinanzas();
          }});
        }
        const editEmp = e.target.closest && e.target.closest('.fin-edit-emp');
        if(editEmp){
          const id = editEmp.getAttribute('data-id'); const emp = (appState.finanzas?.empleados||[]).find(x=>x.id===id); if(!emp) return;
          openFormModal({ title:'Editar Empleado', fields:[
            { name:'nombre', label:'Nombre', type:'text', value:emp.nombre||'' },
            { name:'sueldoSemanal', label:'Sueldo semanal ($)', type:'number', min:0, step:'0.01', value:emp.sueldoSemanal||0 },
            { name:'activo', label:'Activo (s√≠/no)', type:'text', value: (emp.activo===false? 'no':'s√≠') }
          ], submitText:'Actualizar', onSubmit:(data)=>{
            emp.nombre = (data.nombre||'').trim()||emp.nombre;
            emp.sueldoSemanal = Number(data.sueldoSemanal)||0;
            emp.activo = ((data.activo||'s√≠').toLowerCase().startsWith('s'));
            saveLS(); if(typeof saveEmpleadoToFirestore==='function') saveEmpleadoToFirestore(emp); renderFinanzas();
          }});
        }
        const delEmp = e.target.closest && e.target.closest('.fin-del-emp');
        if(delEmp){ const id = delEmp.getAttribute('data-id'); if(confirm('¬øEliminar empleado?')){ appState.finanzas.empleados = (appState.finanzas?.empleados||[]).filter(x=>x.id!==id); saveLS(); if(typeof deleteEmpleadoFromFirestore==='function') deleteEmpleadoFromFirestore(id); renderFinanzas(); } }
        const editSrv = e.target.closest && e.target.closest('.fin-edit-srv');
        if(editSrv){
          const id = editSrv.getAttribute('data-id'); const srv = (appState.finanzas?.servicios||[]).find(x=>x.id===id); if(!srv) return;
          openFormModal({ title:'Editar Servicio', fields:[
            { name:'nombre', label:'Servicio', type:'text', value:srv.nombre||'' },
            { name:'monto', label:'Monto ($)', type:'number', min:0, step:'0.01', value:srv.monto||0 },
            { name:'frecuencia', label:'Frecuencia (semanal/mensual/fijo)', type:'text', value: srv.frecuencia||'mensual' }
          ], submitText:'Actualizar', onSubmit:(data)=>{
            srv.nombre = (data.nombre||'').trim()||srv.nombre;
            srv.monto = Number(data.monto)||0;
            srv.frecuencia = (data.frecuencia||'mensual').toLowerCase();
            saveLS(); if(typeof saveServicioToFirestore==='function') saveServicioToFirestore(srv); renderFinanzas();
          }});
        }
        const delSrv = e.target.closest && e.target.closest('.fin-del-srv');
        if(delSrv){ const id = delSrv.getAttribute('data-id'); if(confirm('¬øEliminar servicio?')){ appState.finanzas.servicios = (appState.finanzas?.servicios||[]).filter(x=>x.id!==id); saveLS(); if(typeof deleteServicioFromFirestore==='function') deleteServicioFromFirestore(id); renderFinanzas(); } }
        
        // Gastos diarios
        const addGasto = e.target.closest && e.target.closest('#fin-add-gasto, #caja-add-gasto');
        if(addGasto){
          const hoy = new Date().toISOString().slice(0,10);
          openFormModal({ title:'Registrar Gasto Diario', fields:[
            { name:'fecha', label:'Fecha', type:'date', value:hoy },
            { name:'tipo', label:'Tipo', type:'select', options:[
              {value:'sueldo', label:'üíµ Sueldo'},
              {value:'gas', label:'üî• Gas'},
              {value:'gasolina', label:'‚õΩ Gasolina'},
              {value:'insumos', label:'üì¶ Insumos extras'},
              {value:'otro', label:'üìå Otro'}
            ]},
            { name:'metodo', label:'M√©todo', type:'select', value:'Efectivo', options:[
              {value:'Efectivo', label:'Efectivo'},
              {value:'Tarjeta', label:'Tarjeta'}
            ]},
            { name:'monto', label:'Monto ($)', type:'number', min:0, step:'0.01' },
            { name:'descripcion', label:'Descripci√≥n', type:'text', placeholder:'Opcional' }
          ], onSubmit:(data)=>{
            const gasto = { 
              id: generateId('gasto'), 
              fecha: data.fecha || hoy,
              tipo: data.tipo || 'otro',
              metodo: (data.metodo||'Efectivo').trim()||'Efectivo',
              monto: Number(data.monto)||0, 
              descripcion: (data.descripcion||'').trim()
            };
            if(!appState.finanzas) appState.finanzas = { empleados:[], servicios:[], asignaciones:[], allocBase:'revenue', gastos:[] };
            if(!Array.isArray(appState.finanzas.gastos)) appState.finanzas.gastos = [];
            appState.finanzas.gastos.push(gasto);
            saveLS(); renderFinanzas(); renderCaja();
          }});
        }
        const editGasto = e.target.closest && e.target.closest('.fin-edit-gasto');
        if(editGasto){
          const id = editGasto.getAttribute('data-id'); 
          const gasto = (appState.finanzas?.gastos||[]).find(x=>x.id===id); 
          if(!gasto) return;
          openFormModal({ title:'Editar Gasto', fields:[
            { name:'fecha', label:'Fecha', type:'date', value:gasto.fecha?.slice(0,10)||'' },
            { name:'tipo', label:'Tipo', type:'select', value:gasto.tipo||'otro', options:[
              {value:'sueldo', label:'üíµ Sueldo'},
              {value:'gas', label:'üî• Gas'},
              {value:'gasolina', label:'‚õΩ Gasolina'},
              {value:'insumos', label:'üì¶ Insumos extras'},
              {value:'otro', label:'üìå Otro'}
            ]},
            { name:'metodo', label:'M√©todo', type:'select', value:(gasto.metodo||'Efectivo'), options:[
              {value:'Efectivo', label:'Efectivo'},
              {value:'Tarjeta', label:'Tarjeta'}
            ]},
            { name:'monto', label:'Monto ($)', type:'number', min:0, step:'0.01', value:gasto.monto||0 },
            { name:'descripcion', label:'Descripci√≥n', type:'text', value:gasto.descripcion||'' }
          ], submitText:'Actualizar', onSubmit:(data)=>{
            gasto.fecha = data.fecha || gasto.fecha;
            gasto.tipo = data.tipo || gasto.tipo;
            gasto.metodo = (data.metodo||gasto.metodo||'Efectivo').trim()||'Efectivo';
            gasto.monto = Number(data.monto)||0;
            gasto.descripcion = (data.descripcion||'').trim();
            saveLS(); renderFinanzas(); renderCaja();
          }});
        }
        const delGasto = e.target.closest && e.target.closest('.fin-del-gasto');
        if(delGasto){ 
          const id = delGasto.getAttribute('data-id'); 
          if(confirm('¬øEliminar gasto?')){ 
            appState.finanzas.gastos = (appState.finanzas?.gastos||[]).filter(x=>x.id!==id); 
            saveLS(); renderFinanzas(); renderCaja(); 
          } 
        }
      });
    })();

    // Render
    function updateDashboard(){
      const period = document.getElementById('db-period-select')?.value || '7d';
      const now = new Date();
      const start = (()=>{
        const d = new Date(now);
        if(period==='today'){ d.setHours(0,0,0,0); return d; }
        if(period==='30d'){ d.setDate(d.getDate()-30); return d; }
        if(period==='month'){ const x = new Date(d.getFullYear(), d.getMonth(), 1); return x; }
        if(period==='all'){ return new Date(0); }
        d.setDate(d.getDate()-7); return d; // 7d
      })();
      const ventas = (appState.ventas||[])
        .filter(v=> !v?.cancelada)
        .filter(v=> new Date(v.fecha)>=start && new Date(v.fecha)<=now);
      const prevStart = (()=>{
        if(period==='today'){ const x = new Date(start); x.setDate(x.getDate()-1); return x; }
        if(period==='30d'){ const x = new Date(start); x.setDate(x.getDate()-30); return x; }
        if(period==='month'){ const lastMonth = new Date(start); lastMonth.setMonth(lastMonth.getMonth()-1); return lastMonth; }
        if(period==='all'){ return new Date(0); }
        const x = new Date(start); x.setDate(x.getDate()-7); return x;
      })();
      const prevVentas = (appState.ventas||[])
        .filter(v=> !v?.cancelada)
        .filter(v=> new Date(v.fecha)>=prevStart && new Date(v.fecha)<start);

      const sum = (arr, f)=> arr.reduce((s,x)=> s + (f?f(x):x), 0);
      const total = sum(ventas, v=> v.total||0);
      const orders = ventas.length;
      const items = sum(ventas, v=> sum(v.items||[], it=> it.cantidad||0));
      const discount = sum(ventas, v=> v.descuento||0);
      const shipping = sum(ventas, v=> v.costoEnvio||0);
      const aov = orders>0 ? total/orders : 0;
      // Prev period for trend
      const prevTotal = sum(prevVentas, v=> v.total||0);
      const prevOrders = prevVentas.length;
      const prevItems = sum(prevVentas, v=> sum(v.items||[], it=> it.cantidad||0));
      const prevAov = prevOrders>0 ? (sum(prevVentas, v=> v.total||0)/prevOrders) : 0;
      const trendPct = (curr, prev)=>{
        if(prev<=0) return 100; // base
        return Math.round(((curr - prev)/prev)*100);
      };

      // KPIs
      const setText = (id, txt)=>{ const el = document.getElementById(id); if(el) el.textContent = txt; };
      const setTrend = (id, curr, prev)=>{
        const el = document.getElementById(id);
        if(!el) return;
        const pct = trendPct(curr, prev);
        el.className = 'kpi-trend ' + (pct>=0? 'kpi-up':'kpi-down');
        el.textContent = (pct>=0? '‚ñ≤ ':'‚ñº ') + Math.abs(pct) + '%';
      };
      setText('kpi-revenue', fmt(total)); setTrend('kpi-revenue-trend', total, prevTotal);
      setText('kpi-orders', String(orders)); setTrend('kpi-orders-trend', orders, prevOrders);
      setText('kpi-aov', fmt(aov)); setTrend('kpi-aov-trend', aov, prevAov);
      setText('kpi-items', String(items)); setTrend('kpi-items-trend', items, prevItems);
      setText('kpi-discount', fmt(discount));
      setText('kpi-shipping', fmt(shipping));
      // Top product
      const productCounts = {};
      ventas.forEach(v=> (v.items||[]).forEach(it=>{ productCounts[it.nombre] = (productCounts[it.nombre]||0) + (it.cantidad||0); }));
      const topProd = Object.keys(productCounts).sort((a,b)=> productCounts[b]-productCounts[a])[0];
      setText('kpi-top-product', topProd || '‚Äî');
      // Top client
      const clientTotals = {};
      ventas.forEach(v=>{ if(v.clienteId){ clientTotals[v.clienteId] = (clientTotals[v.clienteId]||0) + (v.total||0); } });
      const topClientId = Object.keys(clientTotals).sort((a,b)=> clientTotals[b]-clientTotals[a])[0];
      const topClientName = topClientId ? (appState.clientes.find(c=>c.id===topClientId)?.nombre || '‚Äî') : '‚Äî';
      setText('kpi-top-client', topClientName);

      // Ventas recientes
      const tbody = document.getElementById('db-ventas-recientes-body');
      if(tbody){
        tbody.innerHTML='';
        const rec = ventas.slice().sort((a,b)=>new Date(b.fecha)-new Date(a.fecha)).slice(0,10);
        if(rec.length===0){ tbody.innerHTML='<tr><td colspan="4" class="p-3 text-center opacity-60">Sin ventas</td></tr>'; }
        else {
          rec.forEach(v=>{ const c = appState.clientes.find(x=>x.id===v.clienteId); const label = (typeof v.saleNumber==='number' && v.saleNumber>0) ? `Venta${v.saleNumber}` : `#${String(v.id).slice(0,6)}`; const tr = document.createElement('tr'); tr.innerHTML = `<td class=\"p-2\">${label}</td><td class=\"p-2\">${c?c.nombre:'General'}</td><td class=\"p-2\">${new Date(v.fecha).toLocaleString()}</td><td class=\"p-2 text-right font-bold\">${fmt(v.total)}</td>`; tbody.appendChild(tr); });
        }
      }

      // Ventas por hora (hoy)
      const hourlyCanvas = document.getElementById('sales-hourly-chart');
      const emptyMsg = document.getElementById('sales-hourly-empty');
      if(hourlyCanvas){
        const d = new Date(); d.setHours(0,0,0,0);
        const todaySales = (appState.ventas||[])
          .filter(v=> !v?.cancelada)
          .filter(v=> new Date(v.fecha)>=d);
        const byHour = new Array(24).fill(0);
        todaySales.forEach(v=>{ const h = new Date(v.fecha).getHours(); byHour[h] += (v.total||0); });
        const hasData = todaySales.length>0 && byHour.some(x=> x>0);
        if(!hasData){ emptyMsg?.classList.remove('hidden'); }
        else { emptyMsg?.classList.add('hidden'); }
        const ctx = hourlyCanvas.getContext('2d');
        if(window.__hourlyChart){ window.__hourlyChart.destroy(); window.__hourlyChart = undefined; }
        const hourLabels = Array.from({ length: 24 }, (_, i) => (i<10?('0'+i):String(i)) + ':00');
        window.__hourlyChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: hourLabels,
            datasets: [ { label: 'Ingresos', data: byHour, backgroundColor: '#FF6B35' } ]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { ticks: { callback: (v)=> '$'+v } } }
          }
        });
      }
    }
    function renderProductosTabla(){
      const tb=$('#productos-list-body');
      if(!tb) return;
      tb.innerHTML='';
  // Usa lista visible deduplicada si existe el helper; fallback a filtro simple
  const visibles = (typeof getVisibleProducts==='function') ? getVisibleProducts() : (appState.productos||[]).filter(p=> !p.archivado);
  if(visibles.length===0){
        tb.innerHTML='<tr><td colspan="9" class="p-3 text-center opacity-60">Sin productos</td></tr>';
        return;
      }
  // Actualizar KPIs r√°pidos de cat√°logo
  try{
    const total = visibles.length;
    const combos = visibles.filter(p=>p.tipo==='combo').length;
    const uncat = visibles.filter(p=>!p.categoria || !p.categoria.toString().trim()).length;
    const elTotal = document.getElementById('productos-kpi-total');
    const elCombos = document.getElementById('productos-kpi-combos');
    const elUncat = document.getElementById('productos-kpi-uncat');
    if(elTotal) elTotal.textContent = String(total);
    if(elCombos) elCombos.textContent = String(combos);
    if(elUncat) elUncat.textContent = String(uncat);
  }catch(_){ }
  visibles.forEach(p=>{
        const tr=document.createElement('tr');
        tr.className = 'productos-table-row';
        const costo = (typeof p.costo==='number') ? p.costo : computeRecipeCost(p.receta||[]);
        const margen = (Number(p.precio)||0) - costo;
        const pct = (Number(p.precio)||0)>0 ? (margen/Number(p.precio)*100) : 0;
        const tipoDisplay = p.tipo === 'combo'
          ? '<span class="combo-badge">üçΩÔ∏è COMBO</span>'
          : '<span class="prod-type-pill">Individual</span>';
        
        // Clasificaci√≥n display
        const clasificacionMap = {
          'hamburguesa': 'üçî Hamburguesa',
          'hotdog': 'üå≠ Hotdog',
          'postre': 'üç∞ Postre',
          'complemento': 'üçü Complemento',
          'bebida': 'ü•§ Bebida',
          'combo': 'üçΩÔ∏è Combo'
        };
        const clasifBase = p.clasificacion ? (clasificacionMap[p.clasificacion] || p.clasificacion) : '';
        const clasificacionDisplay = clasifBase
          ? `<span class="prod-class-pill">${clasifBase}</span>`
          : '<span class="text-[11px] opacity-60">Sin clasif.</span>';
        
        // Tama√±o display
        const tamanoMap = {
          'chico': 'üîπ Chico',
          'mediano': 'üî∏ Mediano',
          'grande': 'üî∂ Grande'
        };
        const tamanoDisplay = p.tamano ? (tamanoMap[p.tamano] || p.tamano) : '-';
        
        // Estaciones (multi, din√°micas desde appState.estaciones)
        const prodStations = Array.isArray(p.estaciones)
          ? p.estaciones
          : (p.estacion && p.estacion !== 'ninguna' ? [p.estacion] : []);
        const estacionesConfig = (appState.estaciones || []).filter(s => s && s.key);
        const noneActive = prodStations.length === 0;
        const buttonsHtml = estacionesConfig.map(st => {
          const active = prodStations.includes(st.key);
          const label = (st.icon || st.nombre || st.key).toString().trim().charAt(0).toUpperCase();
          const title = st.nombre || st.key;
          return `<button class="estacion-btn ${active ? 'active' : ''}" data-id="${p.id}" data-estacion="${st.key}" title="${title}">${label}</button>`;
        }).join('');
        const estacionHTML = `
          <div class="prod-station-wrapper">
            ${buttonsHtml}
            <button class="estacion-btn ${noneActive?'active':''}" data-id="${p.id}" data-estacion="ninguna" title="Sin estaci√≥n">-</button>
          </div>
        `;
        
        const categoriaLabel = (p.categoria || '').toString().trim();
        const categoriaChip = categoriaLabel
          ? `<span class="inline-flex items-center gap-1 px-2 py-[2px] rounded-full text-[11px] font-semibold bg-amber-50 border border-amber-200 text-amber-900 mt-0.5"><span class="text-[10px]">üè∑Ô∏è</span><span>${categoriaLabel}</span></span>`
          : '<span class="text-[11px] opacity-60">Sin categor√≠a</span>';

        tr.innerHTML=`
            <td class="p-2 align-top sticky-col">
              <div class="flex flex-col gap-0.5">
                <span class="font-semibold">${p.nombre}</span>
                ${categoriaChip}
              </div>
            </td>
            <td class="p-2 align-top">${tipoDisplay}</td>
            <td class="p-2 align-top">${clasificacionDisplay}</td>
            <td class="p-2 align-top">${tamanoDisplay}</td>
            <td class="p-2 align-top text-right num">${fmt(p.precio)}</td>
            <td class="p-2 align-top text-right num">${fmt(costo)}</td>
            <td class="p-2 align-top text-right num">
              <div class="flex flex-col items-end leading-tight">
                <span>${fmt(margen)}</span>
                <span class="opacity-60 text-[11px]">${pct.toFixed(1)}%</span>
              </div>
            </td>
            <td class="p-2 align-top">${estacionHTML}</td>
            <td class="p-2 align-top text-xs opacity-80 max-w-xs">${p.descripcion||''}</td>
            <td class="p-2 align-top whitespace-nowrap">
              <div class="flex flex-wrap gap-1 justify-end">
                <button class="btn-gradient px-3 py-1 rounded text-xs btn-edit-prod" data-id="${p.id}">Editar</button>
                <button class="px-3 py-1 rounded text-xs border btn-derive-slice" title="Derivar subproducto (1/8)" data-id="${p.id}">Derivar 1/8</button>
                <button class="px-3 py-1 rounded text-xs border btn-dup-prod" data-id="${p.id}">Duplicar</button>
                <button class="btn-danger px-3 py-1 rounded text-xs btn-del-prod" data-id="${p.id}">Eliminar</button>
              </div>
            </td>`;
        tb.appendChild(tr);
      });
    }

    // Render Profitability Charts
    function renderProfitabilityCharts(){
      if(!appState.productos || !appState.ventas) return;
      
      // Calculate profitability data for each product
      const profitData = [];
      const visibles = (typeof getVisibleProducts==='function') ? getVisibleProducts() : (appState.productos||[]).filter(p=> !p.archivado);
      
      visibles.forEach(p => {
        const costo = (typeof p.costo==='number') ? p.costo : computeRecipeCost(p.receta||[]);
        const precio = Number(p.precio) || 0;
        const margen = precio - costo;
        const margenPct = precio > 0 ? (margen / precio * 100) : 0;
        
        // Calculate total sales for this product
        const ventas = (appState.ventas||[]).filter(v => !v.cancelada);
        let totalVendido = 0;
        let totalIngresos = 0;
        
        ventas.forEach(v => {
          (v.items||[]).forEach(item => {
            if(item.productoId === p.id) {
              totalVendido += item.cantidad || 0;
              totalIngresos += (item.precio || 0) * (item.cantidad || 0);
            }
          });
        });
        
        const totalCostos = totalVendido * costo;
        const gananciaTotal = totalIngresos - totalCostos;
        const roi = costo > 0 ? ((margen / costo) * 100) : 0;
        
        profitData.push({
          nombre: p.nombre,
          categoria: p.categoria || 'Sin categor√≠a',
          precio,
          costo,
          margen,
          margenPct,
          totalVendido,
          totalIngresos,
          totalCostos,
          gananciaTotal,
          roi
        });
      });

      // Update summary stats
      const avgMargen = profitData.length > 0 ? profitData.reduce((s,p) => s + p.margenPct, 0) / profitData.length : 0;
      const mostProfitable = profitData.sort((a,b) => b.gananciaTotal - a.gananciaTotal)[0];
      const totalGrossProfit = profitData.reduce((s,p) => s + p.gananciaTotal, 0);
      const avgROI = profitData.length > 0 ? profitData.reduce((s,p) => s + p.roi, 0) / profitData.length : 0;

      const setTxt = (id, txt) => { const el=document.getElementById(id); if(el) el.textContent = txt; };
      setTxt('avg-profit-margin', avgMargen.toFixed(1) + '%');
      setTxt('most-profitable-product', mostProfitable ? mostProfitable.nombre : '-');
      setTxt('total-gross-profit', fmt(totalGrossProfit));
      setTxt('avg-roi', avgROI.toFixed(1) + '%');

      // Chart 1: Profit Margin vs Sales Scatter
      const scatterCtx = document.getElementById('profit-margin-scatter')?.getContext('2d');
      if(scatterCtx && window.Chart) {
        window.__profitScatterChart?.destroy();
        window.__profitScatterChart = new Chart(scatterCtx, {
          type: 'scatter',
          data: {
            datasets: [{
              label: 'Productos',
              data: profitData.map(p => ({
                x: p.totalVendido,
                y: p.margenPct,
                label: p.nombre
              })),
              backgroundColor: 'rgba(16, 185, 129, 0.6)',
              borderColor: '#10B981',
              pointRadius: 6
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (ctx) => `${ctx.raw.label}: ${ctx.raw.y.toFixed(1)}% margen, ${ctx.raw.x} vendidos`
                }
              }
            },
            scales: {
              x: { title: { display: true, text: 'Unidades Vendidas' } },
              y: { title: { display: true, text: 'Margen %' } }
            }
          }
        });
      }

      // Chart 2: Revenue vs Cost
      const revenueCtx = document.getElementById('revenue-cost-chart')?.getContext('2d');
      if(revenueCtx && window.Chart) {
        window.__revenueCostChart?.destroy();
        const topProducts = profitData.sort((a,b) => b.totalIngresos - a.totalIngresos).slice(0, 10);
        window.__revenueCostChart = new Chart(revenueCtx, {
          type: 'bar',
          data: {
            labels: topProducts.map(p => p.nombre),
            datasets: [
              {
                label: 'Ingresos',
                data: topProducts.map(p => p.totalIngresos),
                backgroundColor: '#3B82F6'
              },
              {
                label: 'Costos',
                data: topProducts.map(p => p.totalCostos),
                backgroundColor: '#EF4444'
              }
            ]
          },
          options: {
            responsive: true,
            plugins: { legend: { position: 'top' } },
            scales: { y: { ticks: { callback: (v) => '$' + v } } }
          }
        });
      }

      // Chart 3: Top Profitable Products
      const topProfitCtx = document.getElementById('top-profit-products')?.getContext('2d');
      if(topProfitCtx && window.Chart) {
        window.__topProfitChart?.destroy();
        const topProfit = profitData.sort((a,b) => b.gananciaTotal - a.gananciaTotal).slice(0, 10);
        window.__topProfitChart = new Chart(topProfitCtx, {
          type: 'bar',
          data: {
            labels: topProfit.map(p => p.nombre),
            datasets: [{
              label: 'Ganancia Total',
              data: topProfit.map(p => p.gananciaTotal),
              backgroundColor: '#10B981'
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { x: { ticks: { callback: (v) => '$' + v } } }
          }
        });
      }

      // Chart 4: Category Profitability
      const categoryCtx = document.getElementById('category-profitability')?.getContext('2d');
      if(categoryCtx && window.Chart) {
        window.__categoryProfitChart?.destroy();
        const byCategory = {};
        profitData.forEach(p => {
          if(!byCategory[p.categoria]) byCategory[p.categoria] = { ingresos: 0, costos: 0, ganancia: 0 };
          byCategory[p.categoria].ingresos += p.totalIngresos;
          byCategory[p.categoria].costos += p.totalCostos;
          byCategory[p.categoria].ganancia += p.gananciaTotal;
        });
        
        const categories = Object.keys(byCategory);
        window.__categoryProfitChart = new Chart(categoryCtx, {
          type: 'doughnut',
          data: {
            labels: categories,
            datasets: [{
              data: categories.map(cat => byCategory[cat].ganancia),
              backgroundColor: [
                '#FF6B35', '#3B82F6', '#10B981', '#F59E0B', 
                '#8B5CF6', '#EF4444', '#06B6D4', '#84CC16'
              ]
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: (ctx) => `${ctx.label}: ${fmt(ctx.raw)} ganancia`
                }
              }
            }
          }
        });
      }
    }

    function renderIngredientesTabla(){
      const tb=$('#ingredientes-list-body'); if(!tb) return;
      tb.innerHTML='';
      if(!Array.isArray(appState.ingredientes) || appState.ingredientes.length===0){
        tb.innerHTML='<tr><td colspan="5" class="p-3 text-center opacity-60">Sin ingredientes</td></tr>';
        return;
      }
      appState.ingredientes.forEach(i=>{
        const unitCost = getUnitCost(i);
        const tr=document.createElement('tr');
        tr.className = 'ingredientes-table-row';
        tr.innerHTML=`
          <td class="p-2 align-top sticky-col">
            <div class="flex flex-col gap-0.5">
              <span class="ingrediente-name-cell">${i.nombre}</span>
              <span class="ingrediente-unit-cell">${i.unidad||''}</span>
            </div>
          </td>
          <td class="p-2 align-top text-right num">${fmt(i.precioPaquete||0)}</td>
          <td class="p-2 align-top text-right num">${i.unidadesPaquete||0}</td>
          <td class="p-2 align-top text-right num">${fmt(unitCost||0)}</td>
          <td class="p-2 align-top text-right">
            <div class="flex flex-wrap gap-1 justify-end">
              <button class="btn-gradient px-3 py-1 rounded text-xs btn-edit-ing" data-id="${i.id}">Editar</button>
              <button class="btn-danger px-3 py-1 rounded text-xs btn-del-ing" data-id="${i.id}">Eliminar</button>
            </div>
          </td>`;
        tb.appendChild(tr);
      });
    }

    function renderProductosFilterButtons(){
      const container = document.getElementById('productos-filter-container');
      if(!container) return;
      container.innerHTML = '';

      const btnBaseClasses = 'productos-filter-btn px-4 py-2 rounded-lg border-2 font-bold text-sm transition';

      const deleteCategory = (key, label)=>{
        if(!Array.isArray(appState.categorias)) return;
        if(!confirm(`¬øEliminar la categor√≠a "${label}"?`)) return;
        appState.categorias = appState.categorias.filter(c=> c && c.key !== key);
        if(currentProductosFilter === key) currentProductosFilter = 'all';
        saveLS();
        renderProductosFilterButtons();
        renderProductosTabla();
      };

      const makeBtn = (label, filter, opts={})=>{
        const btn = document.createElement('button');
        btn.className = btnBaseClasses;
        btn.setAttribute('data-filter', filter);
        const textSpan = document.createElement('span');
        textSpan.textContent = label;
        btn.appendChild(textSpan);
        if(opts.deletable){
          const close = document.createElement('span');
          close.textContent = '√ó';
          close.className = 'ml-2 text-xs opacity-60 hover:opacity-100';
          close.style.cursor = 'pointer';
          close.addEventListener('click', (ev)=>{
            ev.stopPropagation();
            deleteCategory(filter, label);
          });
          btn.appendChild(close);
        }
        if(filter === currentProductosFilter || (filter==='all' && currentProductosFilter==='all')){
          btn.classList.add('active','border-blue-500','bg-blue-50','text-blue-700');
        }
        btn.addEventListener('click', ()=>{
          currentProductosFilter = filter;
          renderProductosFilterButtons();
          renderProductosTabla();
        });
        return btn;
      };

      // Bot√≥n "Todos"
      container.appendChild(makeBtn('üîç Todos', 'all'));

      // Asegurar categor√≠as base y derivadas
      ensureDefaultCategorias();
      let categorias = Array.isArray(appState.categorias) ? [...appState.categorias] : [];

      // Seguridad extra: quitar duplicados por clave antes de pintar
      if(categorias.length > 1){
        const seen = new Map();
        for(const c of categorias){
          if(!c || !c.key) continue;
          const key = c.key.toString().toLowerCase();
          if(!seen.has(key)) seen.set(key, { ...c, key });
        }
        categorias = Array.from(seen.values());
      }

      if(categorias.length===0) return;

      // Ordenar alfab√©ticamente por nombre visible
      categorias.sort((a,b)=>{
        const la = (a.nombre||a.key||'').toString();
        const lb = (b.nombre||b.key||'').toString();
        return la.localeCompare(lb);
      });

      categorias.forEach(cat=>{
        if(!cat || !cat.key) return;
        const key = cat.key.toString().toLowerCase();
        const label = (cat.nombre||'').toString().trim() || key.charAt(0).toUpperCase()+key.slice(1);
        container.appendChild(makeBtn(label, key, { deletable:true }));
      });
    }

    function renderEstacionesTabla(){
      const tb = document.getElementById('estaciones-list-body');
      if(!tb) return;
      ensureDefaultStations();
      tb.innerHTML = '';
      const estaciones = (appState.estaciones||[]).filter(e=> e && e.key);
      const productosAll = (appState.productos||[]).filter(p=> !p.archivado);

      if(estaciones.length === 0){
        tb.innerHTML = '<tr><td colspan="5" class="p-3 text-center opacity-60">Sin estaciones</td></tr>';
      } else {
        estaciones.forEach(st => {
        const productos = (appState.productos||[]).filter(p => {
          const es = Array.isArray(p.estaciones)
            ? p.estaciones
            : (p.estacion && p.estacion !== 'ninguna' ? [p.estacion] : []);
          return es.includes(st.key);
        });
        const count = productos.length;
        const tr = document.createElement('tr');
        tr.className = 'estaciones-table-row';
        const keyPill = `<span class="estacion-key-pill">${st.key}</span>`;
        const fixedChip = st.fixed ? '<span class="estacion-chip-fixed">Base</span>' : '';
        tr.innerHTML = `
          <td class="p-2 align-top">
            <div class="flex flex-col gap-0.5">
              <span class="font-semibold">${st.nombre || ''}</span>
              <div class="flex items-center gap-1">${fixedChip}</div>
            </div>
          </td>
          <td class="p-2 align-top">${keyPill}</td>
          <td class="p-2 align-top text-center text-xl">${st.icon || ''}</td>
          <td class="p-2 align-top text-right num">${count}</td>
          <td class="p-2 align-top text-right whitespace-nowrap">
            <div class="flex flex-wrap gap-1 justify-end">
              <button class="btn-gradient px-3 py-1 rounded text-xs btn-edit-est" data-id="${st.id}">Editar</button>
              <button class="btn-danger px-3 py-1 rounded text-xs btn-del-est" data-id="${st.id}" ${st.fixed ? 'disabled title="Estaci√≥n base no se puede eliminar"' : ''}>Eliminar</button>
            </div>
          </td>`;
        tb.appendChild(tr);
        });
      }

      // Actualizar KPIs r√°pidos de estaciones
      try{
        const total = estaciones.length;
        const fixed = estaciones.filter(s=>s.fixed).length;
        const sinEstacion = productosAll.filter(p=>{
          const es = Array.isArray(p.estaciones)
            ? p.estaciones
            : (p.estacion && p.estacion !== 'ninguna' ? [p.estacion] : []);
          return !es || es.length === 0;
        }).length;
        const elTotal = document.getElementById('est-kpi-total');
        const elFixed = document.getElementById('est-kpi-fixed');
        const elUnassigned = document.getElementById('est-kpi-unassigned');
        if(elTotal) elTotal.textContent = String(total);
        if(elFixed) elFixed.textContent = String(fixed);
        if(elUnassigned) elUnassigned.textContent = String(sinEstacion);
      }catch(_){ }
    }

    // Acciones de edici√≥n/eliminaci√≥n en Ingredientes
    function setupIngredientesActions(){
      const tb = $('#ingredientes-list-body');
      if(!tb) return;
      tb.addEventListener('click', (e)=>{
        const btn = e.target.closest('button');
        if(!btn) return;
        const id = btn.getAttribute('data-id');
        const ing = appState.ingredientes.find(x=>x.id===id);
        if(btn.classList.contains('btn-edit-ing')){
          if(!ing) return;
          openFormModal({
            title:'Editar Ingrediente',
            fields:[
              {name:'nombre', label:'Nombre', type:'text', value:ing.nombre},
              {name:'unidad', label:'Unidad', type:'text', value:ing.unidad},
              {name:'precioPaquete', label:'Precio por Paquete', type:'number', min:0, step:'0.01', value:ing.precioPaquete},
              {name:'unidadesPaquete', label:'Unidades por Paquete', type:'number', min:1, step:'1', value:ing.unidadesPaquete}
            ],
            submitText:'Actualizar',
            onSubmit:(data)=>{
              ing.nombre=(data.nombre||'').trim();
              ing.unidad=(data.unidad||'').trim();
              ing.unidadesPaquete=Number(data.unidadesPaquete)||1;
              if(typeof saveIngredientToFirestore==='function') saveIngredientToFirestore(ing);
              saveLS(); renderAll();
            }
          });
        } else if(btn.classList.contains('btn-del-ing')){
          if(!ing) return;
          if(confirm(`¬øEliminar ingrediente "${ing.nombre}"?`)){
            appState.ingredientes = appState.ingredientes.filter(x=>x.id!==id);
            if(typeof deleteIngredientFromFirestore==='function') deleteIngredientFromFirestore(id);
            saveLS(); renderAll();
          }
        }
      });
    }

    function setupEstacionesActions(){
      const tb = document.getElementById('estaciones-list-body');
      const addBtn = document.getElementById('add-estacion-btn');
      if(addBtn){
        addBtn.addEventListener('click', ()=>{
          openFormModal({
            title:'Nueva Estaci√≥n',
            fields:[
              {name:'nombre', label:'Nombre visible', type:'text', placeholder:'Ej. Plancha', value:''},
              {name:'key', label:'Clave interna (sin espacios)', type:'text', placeholder:'ej. plancha', value:''},
              {name:'icon', label:'Inicial (1 letra)', type:'text', placeholder:'P', value:''},
              {type:'html', html:'La clave interna se usar√° para vincular productos y pantallas. Para Parrilla y Papera ya existen las claves <strong>parrilla</strong> y <strong>freidora</strong>.'}
            ],
            submitText:'Crear',
            onSubmit:(data)=>{
              const nombre = (data.nombre||'').trim();
              const key = (data.key||'').trim().toLowerCase();
              const icon = (data.icon||'').trim() || 'üçΩÔ∏è';
              if(!nombre || !key){ alert('Nombre y clave son obligatorios'); return; }
              if(appState.estaciones.some(e=>e.key===key)){ alert('Ya existe una estaci√≥n con esa clave'); return; }
              appState.estaciones.push({ id: generateId('st'), nombre, key, icon, fixed:false });
              saveLS(); renderEstacionesTabla();
            }
          });
        });
      }
      if(!tb) return;
      tb.addEventListener('click', (e)=>{
        const btn = e.target.closest('button');
        if(!btn) return;
        const id = btn.getAttribute('data-id');
        const st = (appState.estaciones||[]).find(s=>s.id===id);
        if(!st) return;
        if(btn.classList.contains('btn-edit-est')){
          openFormModal({
            title:'Editar Estaci√≥n',
            fields:[
              {name:'nombre', label:'Nombre visible', type:'text', value:st.nombre},
              {name:'key', label:'Clave interna', type:'text', value:st.key, disabled: !!st.fixed},
              {name:'icon', label:'Icono', type:'text', value:st.icon}
            ],
            submitText:'Actualizar',
            onSubmit:(data)=>{
              st.nombre = (data.nombre||'').trim();
              if(!st.fixed){
                const newKey = (data.key||'').trim().toLowerCase();
                if(!newKey){ alert('La clave no puede quedar vac√≠a'); return; }
                if(newKey !== st.key && appState.estaciones.some(e=>e.key===newKey)){ alert('Ya existe una estaci√≥n con esa clave'); return; }
                // Actualizar referencia en productos
                (appState.productos||[]).forEach(p=>{
                  if(Array.isArray(p.estaciones)){
                    p.estaciones = p.estaciones.map(k=> k===st.key ? newKey : k);
                  }else if(p.estacion === st.key){
                    p.estacion = newKey;
                  }
                });
                st.key = newKey;
              }
              st.icon = (data.icon||'').trim() || st.icon;
              saveLS(); renderEstacionesTabla(); renderProductosTabla();
            }
          });
        } else if(btn.classList.contains('btn-del-est')){
          if(st.fixed){ return; }
          if(!confirm(`¬øEliminar estaci√≥n "${st.nombre}"? Los productos dejar√°n de usarla.`)) return;
          appState.estaciones = (appState.estaciones||[]).filter(s=>s.id!==id);
          (appState.productos||[]).forEach(p=>{
            if(Array.isArray(p.estaciones)){
              p.estaciones = p.estaciones.filter(k=>k!==st.key);
              if(p.estaciones.length===0) p.estacion = 'ninguna';
            }else if(p.estacion === st.key){
              p.estacion = 'ninguna';
            }
          });
          saveLS(); renderEstacionesTabla(); renderProductosTabla();
        }
      });
    }

    function setupCategoriasActions(){
      const addBtn = document.getElementById('add-categoria-btn');
      if(!addBtn) return;
      addBtn.addEventListener('click', ()=>{
        openFormModal({
          title:'Nueva Categor√≠a',
          fields:[
            {name:'nombre', label:'Nombre visible', type:'text', placeholder:'Ej. Tacos', value:''},
            {name:'key', label:'Clave interna (sin espacios)', type:'text', placeholder:'ej. tacos', value:''}
          ],
          submitText:'Crear',
          onSubmit:(data)=>{
            let nombre = (data.nombre||'').trim();
            let key = (data.key||'').trim().toLowerCase();
            if(!nombre && !key){ alert('Debes indicar al menos el nombre'); return; }
            if(!key){
              key = nombre.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
                .replace(/[^a-z0-9]+/g,'-')
                .replace(/^-+|-+$/g,'');
            }
            if(!nombre) nombre = key.charAt(0).toUpperCase()+key.slice(1);
            if(!Array.isArray(appState.categorias)) appState.categorias = [];
            if(appState.categorias.some(c=>c && c.key===key)){
              alert('Ya existe una categor√≠a con esa clave');
              return;
            }
            appState.categorias.push({ id: generateId('cat'), key, nombre });
            saveLS();
            renderProductosFilterButtons();
          }
        });
      });
    }

    // Botones de crear (productos, ingredientes, clientes) e importar
    function setupCreateButtons(){
      document.getElementById('open-ingredientes-modal')?.addEventListener('click', openIngredientModal);
      document.getElementById('open-productos-modal')?.addEventListener('click', openProductModal);
      document.getElementById('export-productos-btn')?.addEventListener('click', exportProductosToJSON);
      document.getElementById('open-clientes-modal')?.addEventListener('click', openClienteModal);
      document.getElementById('import-ingredientes-preset')?.addEventListener('click', importPresetIngredients);
  document.getElementById('import-clientes-preset')?.addEventListener('click', importUserClientsPreset);
    }

    // Botones Insumos
    (function setupInsumosButtons(){
  document.getElementById('insumos-recompute')?.addEventListener('click', ()=>{ recomputeInsumosFromVentas(); saveLS(); renderInsumosView(); renderInventario(); alert('Insumos recomputados desde ventas'); });
  document.addEventListener('change', (e)=>{
    const sel = e.target && e.target.closest && e.target.closest('#ins-semanas-select');
    if(!sel) return;
    renderInsumosView();
  });
  document.getElementById('insumos-clear')?.addEventListener('click', ()=>{ if(confirm('¬øLimpiar historial de insumos gastados?')){ appState.insumosConsumo = { totales:{}, historial:[], merma:[] }; saveLS(); if(typeof saveInsumosToFirestore==='function') saveInsumosToFirestore(); renderInsumosView(); } });
    })();

    // Modal de Cliente
    function openClienteModal(){
      openFormModal({
        title:'Nuevo Cliente',
        fields:[
          {name:'nombre', label:'Nombre', type:'text', placeholder:'Nombre y apellido'},
          {name:'telefono', label:'Tel√©fono', type:'text', placeholder:'Opcional'},
          {name:'direccion', label:'Direcci√≥n', type:'text', placeholder:'Opcional'}
        ],
        onSubmit:(data)=>{
          const cli = { id: generateId('cli'), nombre:(data.nombre||'').trim()||'Sin Nombre', telefono:(data.telefono||'').trim(), direccion:(data.direccion||'').trim(), puntos:0, gastoTotal:0 };
          appState.clientes.push(cli);
          if(typeof saveClienteToFirestore==='function') saveClienteToFirestore(cli);
          saveLS(); renderAll();
        }
      });
    }

    // Render tablas faltantes
      function recomputeClientesFromVentas(){
        try{
          const byId = new Map();
          (appState.clientes||[]).forEach(c=>{
            c.gastoTotal = 0;
            c.puntos = 0;
            byId.set(c.id, c);
          });
          (appState.ventas||[]).forEach(v=>{
            if(v?.cancelada) return;
            if(!v.clienteId) return;
            const c = byId.get(v.clienteId);
            if(!c) return;
            const total = Number(v.total||0);
            c.gastoTotal = (c.gastoTotal||0) + total;
            c.puntos = Math.floor((c.gastoTotal||0) / 10);
          });
        }catch(e){ console.warn('recomputeClientesFromVentas', e); }
      }

      function renderClientesTabla(){
        const tb = document.getElementById('clientes-list-body');
        if(!tb) return;
        tb.innerHTML = '';
        // Recalcular gasto total y puntos desde las ventas registradas
        recomputeClientesFromVentas();
        const term = (document.getElementById('clientes-search')?.value||'').toLowerCase().trim();
        const sort = document.getElementById('clientes-sort')?.value||'nombre';
        let list = Array.isArray(appState.clientes) ? [...appState.clientes] : [];
        if(term){ list = list.filter(c=> (c.nombre||'').toLowerCase().includes(term) || (c.telefono||'').toLowerCase().includes(term) || (c.direccion||'').toLowerCase().includes(term)); }
        if(sort==='nombre') list.sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||''));
        if(sort==='puntos') list.sort((a,b)=> (b.puntos||0)-(a.puntos||0));
        if(sort==='gasto') list.sort((a,b)=> (b.gastoTotal||0)-(a.gastoTotal||0));
        if(sort==='reciente') list = list.slice().reverse();
      if(list.length===0){ tb.innerHTML = '<tr><td colspan="6" class="p-3 text-center opacity-60">Sin clientes</td></tr>'; return; }
        list.forEach(c=>{
          const tr = document.createElement('tr');
          tr.className = 'ingredientes-table-row';
          tr.innerHTML = `
            <td class="p-3 font-bold text-base">${c.nombre}</td>
            <td class="p-3 text-sm md:text-base">${c.telefono||''}</td>
            <td class="p-3 text-sm md:text-base">${c.direccion||''}</td>
          <td class="p-3 text-right text-sm md:text-base">${fmt(c.gastoTotal||0)}</td>
          <td class="p-3 text-right font-semibold text-sm md:text-base">${c.puntos||0}</td>
            <td class="p-2">
              <div class="flex gap-2">
          <button class="px-2 py-1 rounded border text-xs md:text-sm btn-hist-cli" data-id="${c.id}">Historial</button>
                <button class="px-2 py-1 rounded border text-xs md:text-sm btn-edit-cli" data-id="${c.id}">Editar</button>
                <button class="px-2 py-1 rounded border text-xs md:text-sm btn-del-cli" data-id="${c.id}">Eliminar</button>
                <button class="icon-btn text-xs md:text-sm btn-view-cli" title="Ver" data-id="${c.id}">üëÅÔ∏è</button>
              </div>
            </td>`;
          tb.appendChild(tr);
        });
      }

      function renderClientesCards(){
        const grid = document.getElementById('clientes-grid');
        if(!grid) return;
        grid.innerHTML='';
        // Asegurar que los puntos/gasto est√©n sincronizados con las ventas
        recomputeClientesFromVentas();
        const term = (document.getElementById('clientes-search')?.value||'').toLowerCase().trim();
        const sort = document.getElementById('clientes-sort')?.value||'nombre';
        let list = Array.isArray(appState.clientes) ? [...appState.clientes] : [];
        if(term){ list = list.filter(c=> (c.nombre||'').toLowerCase().includes(term) || (c.telefono||'').toLowerCase().includes(term) || (c.direccion||'').toLowerCase().includes(term)); }
        if(sort==='nombre') list.sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||''));
        if(sort==='puntos') list.sort((a,b)=> (b.puntos||0)-(a.puntos||0));
        if(sort==='gasto') list.sort((a,b)=> (b.gastoTotal||0)-(a.gastoTotal||0));
        if(sort==='reciente') list = list.slice().reverse();
        if(list.length===0){ grid.innerHTML = '<div class="text-center py-8 opacity-60">Sin clientes</div>'; return; }
        list.forEach(c=>{
          const card = document.createElement('div');
          card.className = 'client-card';
          card.innerHTML = `
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-extrabold text-xl" style="color:var(--burger-dark)">${c.nombre}</div>
                <div class="text-sm md:text-base opacity-80">${c.telefono||'‚Äî'}</div>
                <div class="text-sm md:text-base opacity-80">${c.direccion||'‚Äî'}</div>
              </div>
              <div class="space-x-1 whitespace-nowrap">
                <button class="icon-btn btn-view-cli" title="Ver" data-id="${c.id}">üëÅÔ∏è</button>
                <button class="icon-btn btn-edit-cli" title="Editar" data-id="${c.id}">‚úèÔ∏è</button>
                <button class="icon-btn btn-del-cli" title="Eliminar" data-id="${c.id}">üóëÔ∏è</button>
              </div>
            </div>
            <div class="mt-3 flex items-center gap-2">
              <span class="pill pill-points">‚≠ê ${c.puntos||0} pts</span>
              <span class="pill pill-spend">üí∞ ${fmt(c.gastoTotal||0)}</span>
            </div>
          `;
          grid.appendChild(card);
        });
      }

      function showClientesView(mode){
        const grid = document.getElementById('clientes-grid');
        const table = document.getElementById('clientes-table-wrapper');
        if(!grid || !table){
          try{ localStorage.setItem('clientes-view-mode', mode); }catch(_){ }
          return;
        }
        if(mode==='table'){
          grid.classList.add('hidden');
          table.classList.remove('hidden');
          renderClientesTabla();
        } else {
          table.classList.add('hidden');
          grid.classList.remove('hidden');
          renderClientesCards();
        }
        localStorage.setItem('clientes-view-mode', mode);
      }

    // Acciones de edici√≥n/eliminaci√≥n en Clientes
    (function setupClientesActions(){
      document.addEventListener('click', (e)=>{
        const btn = e.target.closest && e.target.closest('button');
        if(!btn) return;
        if(btn.classList.contains('btn-edit-cli')){
          const id = btn.getAttribute('data-id');
          const c = appState.clientes.find(x=>x.id===id); if(!c) return;
          openFormModal({
            title:'Editar Cliente',
            fields:[
              {name:'nombre', label:'Nombre', type:'text', value:c.nombre},
              {name:'telefono', label:'Tel√©fono', type:'text', value:c.telefono||''},
              {name:'direccion', label:'Direcci√≥n', type:'text', value:c.direccion||''}
            ],
            submitText:'Actualizar',
            onSubmit:(data)=>{
              c.nombre = (data.nombre||'').trim()||c.nombre;
              c.telefono = (data.telefono||'').trim();
              c.direccion = (data.direccion||'').trim();
              if(typeof saveClienteToFirestore==='function') saveClienteToFirestore(c);
              saveLS(); renderAll();
            }
          });
        } else if(btn.classList.contains('btn-del-cli')){
          const id = btn.getAttribute('data-id');
          const c = appState.clientes.find(x=>x.id===id); if(!c) return;
          if(confirm(`¬øEliminar cliente "${c.nombre}"?`)){
            appState.clientes = appState.clientes.filter(x=>x.id!==id);
            if(typeof deleteClienteFromFirestore==='function') deleteClienteFromFirestore(id);
            saveLS(); renderAll();
          }
        } else if(btn.classList.contains('btn-hist-cli')){
          const id = btn.getAttribute('data-id');
          const c = appState.clientes.find(x=>x.id===id); if(!c) return;
          const ventasCli = (appState.ventas||[]).filter(v=> v.clienteId===id).sort((a,b)=> new Date(b.fecha)-new Date(a.fecha));
          const total = ventasCli.reduce((s,v)=> s+(v.total||0), 0);
          const body = ventasCli.length===0 ? 'Sin ventas de este cliente' : ventasCli.map(v=> `${new Date(v.fecha).toLocaleString()}  ‚Ä¢  ${fmt(v.total)}`).join('\n');
          openFormModal({
            title: `Historial de ${c.nombre} ‚Ä¢ Total: ${fmt(total)}`,
            fields:[ { name:'hist', label:'', type:'textarea', rows:10, value: body } ],
            submitText:'Cerrar',
            onSubmit:()=>{}
          });
        } else if(btn.classList.contains('btn-view-cli')){
          const id = btn.getAttribute('data-id');
          const c = appState.clientes.find(x=>x.id===id); if(!c) return;
          openFormModal({
            title: `Cliente: ${c.nombre}`,
            fields: [
              { name:'telefono', label:'Tel√©fono', type:'text', value:c.telefono||'', placeholder:'', readonly:true },
              { name:'direccion', label:'Direcci√≥n', type:'text', value:c.direccion||'', placeholder:'', readonly:true },
            ],
            submitText:'Cerrar',
            onSubmit:()=>{}
          });
        }
      });
    })();

    // Wire toolbar Clientes
    (function setupClientesToolbar(){
      const search = document.getElementById('clientes-search');
      const sort = document.getElementById('clientes-sort');
      const btnCards = document.getElementById('clientes-view-cards');
      const btnTable = document.getElementById('clientes-view-table');
      const mode = localStorage.getItem('clientes-view-mode')||'cards';
      if(mode==='table') showClientesView('table'); else showClientesView('cards');
      search?.addEventListener('input', ()=>{ renderClientesCards(); renderClientesTabla(); });
      sort?.addEventListener('change', ()=>{ renderClientesCards(); renderClientesTabla(); });
      btnCards?.addEventListener('click', ()=> showClientesView('cards'));
      btnTable?.addEventListener('click', ()=> showClientesView('table'));
    })();

    function renderVentasTabla(){
      const tb = document.getElementById('ventas-list-body');
      if(!tb) return;
      tb.innerHTML='';
      if(!Array.isArray(appState.ventas) || appState.ventas.length===0){
        tb.innerHTML = '<tr><td colspan="8" class="p-3 text-center opacity-60">Sin ventas</td></tr>';
        return;
      }
      const rows = (appState.ventas||[])
        .filter(v=> !v?.cancelada)
        .slice()
        .sort((a,b)=>new Date(b.fecha)-new Date(a.fecha));
      rows.forEach(v=>{
        const cli = appState.clientes.find(c=>c.id===v.clienteId);
        const tr = document.createElement('tr');
        const label = (typeof v.saleNumber==='number' && v.saleNumber>0) ? `Venta${v.saleNumber}` : `#${String(v.id).slice(0,6)}`;
        
        // Calcular costo total de producci√≥n de esta venta
        let costoTotal = 0;
        (v.items || []).forEach(item => {
          const producto = (appState.productos || []).find(p => p.id === item.productoId);
          const costoItem = item.costo || producto?.costo || 0;
          costoTotal += costoItem * (item.cantidad || 1);
        });
        
        const ganancia = (v.total || 0) - costoTotal;
        const margenPct = v.total > 0 ? ((ganancia / v.total) * 100).toFixed(1) : 0;
        
        tr.innerHTML = `
          <td class="p-2">${label}</td>
          <td class="p-2">${new Date(v.fecha).toLocaleString()}</td>
          <td class="p-2">${cli?cli.nombre:'General'}</td>
          <td class="p-2">${v.items?.length||0}</td>
          <td class="p-2 text-right font-bold">${fmt(v.total)}</td>
          <td class="p-2 text-right text-red-600 font-semibold">${fmt(costoTotal)}</td>
          <td class="p-2 text-right font-bold" style="color: ${ganancia >= 0 ? '#16a34a' : '#dc2626'}">
            ${fmt(ganancia)} <span class="text-xs opacity-70">(${margenPct}%)</span>
          </td>
          <td class="p-2 flex items-center gap-2">
            <button class="px-2 py-1 rounded border text-sm btn-view-sale" data-id="${v.id}">Ver</button>
            <button class="px-2 py-1 rounded border border-red-300 text-red-700 hover:bg-red-50 text-sm btn-delete-sale" title="Cancelar venta" aria-label="Cancelar venta" data-id="${v.id}">‚úï</button>
          </td>
        `;
        tb.appendChild(tr);
      });
    }
    // Ver detalle de venta
    (function setupVentasActions(){
      document.addEventListener('click', (e)=>{
        const btn = e.target.closest && e.target.closest('button.btn-view-sale');
        if(!btn) return;
        const id = btn.getAttribute('data-id');
        const v = (appState.ventas||[]).find(x=>x.id===id);
        if(!v) return;
        const label = (typeof v.saleNumber==='number' && v.saleNumber>0) ? `Venta${v.saleNumber}` : `#${String(v.id).slice(0,6)}`;
        const lines = [];
        (v.items||[]).forEach(it=>{
          const unit = (Number(it.precio)||0) + ((it.modifiers||[]).reduce((a,m)=> a + (Number(m.price)||0), 0));
          const mods = (it.modifiers&&it.modifiers.length) ? ' ['+it.modifiers.map(m=> m.name + (m.price?` (+${fmt(m.price)})`:'' )).join(', ')+']' : '';
          
          // Check if it's a combo with customization
          if (it.customization && it.customization.type === 'combo') {
            lines.push(`${it.cantidad} √ó üçΩÔ∏è ${it.nombre} (COMBO)  ‚Ä¢  ${fmt(unit)} c/u  =  ${fmt(unit*it.cantidad)}`);
            lines.push(''); // Add space before combo breakdown
            
            // Add combo breakdown
            const breakdown = generateComboBreakdown(it.customization, 'text');
            breakdown.forEach(line => {
              if (line.trim() !== '') {
                lines.push(`    ${line}`); // Indent the breakdown
              }
            });
            lines.push(''); // Add space after combo breakdown
          } else {
            lines.push(`${it.cantidad} √ó ${it.nombre}${mods}  ‚Ä¢  ${fmt(unit)} c/u  =  ${fmt(unit*it.cantidad)}`);
          }
        });
        lines.push('');
        lines.push(`Subtotal: ${fmt(v.subtotal||0)}`);
        if(v.descuento){ lines.push(`Descuento: -${fmt(v.descuento)}`); }
        if(v.costoEnvio){ lines.push(`Env√≠o: ${fmt(v.costoEnvio)}`); }
        lines.push(`Total: ${fmt(v.total||0)}`);
        openFormModal({ title: `${label} ‚Ä¢ ${new Date(v.fecha).toLocaleString()}`, fields:[{ name:'detalle', label:'', type:'textarea', rows: Math.min(14, Math.max(8, lines.length+2)), value: lines.join('\n') }], submitText:'Cerrar', onSubmit:()=>{} });
      });
    })();

    // Debug button functionality
    document.addEventListener('DOMContentLoaded', function() {
      document.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'debug-data') {
          console.clear();
          console.log('üö® [DEBUG DATA DUMP] =========================');
          console.log('üìä appState.ventas:', appState.ventas);
          console.log('üìã appState.pedidosPendientes:', appState.pedidosPendientes);
          console.log('üõí currentOrder:', currentOrder);
          
          if (appState.ventas && appState.ventas.length > 0) {
            console.log('üîç √öltima venta completa:');
            const lastSale = appState.ventas[appState.ventas.length - 1];
            console.log(lastSale);
            if (lastSale.items && lastSale.items.length > 0) {
              console.log('üõí Items de la √∫ltima venta:');
              lastSale.items.forEach((item, index) => {
                console.log(`   Item ${index + 1}:`, item);
                if (item.customization) {
                  console.log(`   Customization:`, item.customization);
                }
              });
            }
          }
          console.log('============================================');
          
          alert('Debug data printed to console. Press F12 to view.');
        }
      });
    });

    // Helper: cancelar (soft-delete) venta en Firestore si est√° disponible
    async function deleteVentaFromFirestore(id){
      try{
        if(!window.db || !window.fs) return;
        const uid = window.auth?.currentUser?.uid;
        if(!uid) return;
        const { doc, setDoc } = window.fs;
        await setDoc(doc(window.db, 'ventas', id), { cancelada: true, cancelAt: new Date().toISOString(), userId: uid }, { merge: true });
      }catch(e){ console.warn('cancelVentaInFirestore', e); }
    }

    // Cancelar venta con confirmaci√≥n (X)
    (function setupVentasDelete(){
      document.addEventListener('click', async (e)=>{
        const btn = e.target.closest && e.target.closest('button.btn-delete-sale');
        if(!btn) return;
        const id = btn.getAttribute('data-id');
        const venta = (appState.ventas||[]).find(v=> v.id===id);
        if(!venta) return;
        const label = (typeof venta.saleNumber==='number' && venta.saleNumber>0) ? `Venta${venta.saleNumber}` : `#${String(venta.id).slice(0,6)}`;
        if(venta.cancelada){ alert('Esta venta ya est√° cancelada.'); return; }
        if(!confirm(`¬øCancelar ${label}? No contar√° en reportes ni insumos.`)) return;
        // Local: marcar como cancelada
        venta.cancelada = true;
        venta.cancelAt = new Date().toISOString();
        // Si hubiera pedidos relacionados, removerlos
        try{
          const rels = (appState.pedidosPendientes||[]).filter(p=> p.ventaId===venta.id);
          if(rels.length){
            appState.pedidosPendientes = (appState.pedidosPendientes||[]).filter(p=> p.ventaId!==venta.id);
            if(typeof deletePedidoFromFirestore==='function'){
              rels.forEach(p=>{ try{ deletePedidoFromFirestore(p.id); }catch(_){} });
            }
          }
        }catch(_){}
        try{ recomputeInsumosFromVentas(); }catch(_){ }
        saveLS();
        renderVentasTabla();
        updateDashboard?.();
  // Refrescar vistas dependientes del consumo de insumos e inventario
  renderInsumosView?.();
  renderInventario?.();
        // Cloud: persistir cancelaci√≥n
        deleteVentaFromFirestore(id);
      });
    })();

    // ===================== INSUMOS GASTADOS =====================
    // Mapeo de modificadores (extras) -> consumo adicional de ingredientes
    // Nota: asumimos cantidades razonables para extras:
    //  - carneExtra: +1 CARNE DE HAMBURGUESA
    //  - tocinoExtra: +1 TOCINO
    //  - americanoExtra: +1 QUESO AMERICANO
    //  - manchegoExtra: +20 g QUESO MANCHEGO
    //  - botecitoQueso: +1 BOTECITO y +15 g QUESO NACHOS
    //  - chilesExtra: +1 BOTECITO y +1 CHILES
    const MODIFIER_CONSUMPTION_MAP = {
      carneExtra: [ { nombre:'CARNE DE HAMBURGUESA', cantidad: 1 } ],
      tocinoExtra: [ { nombre:'TOCINO', cantidad: 1 } ],
      americanoExtra: [ { nombre:'QUESO AMERICANO', cantidad: 1 } ],
      manchegoExtra: [ { nombre:'QUESO MANCHEGO', cantidad: 20 } ], // gramos
      botecitoQueso: [ { nombre:'BOTECITO', cantidad: 1 }, { nombre:'QUESO NACHOS', cantidad: 15 } ],
      chilesExtra: [ { nombre:'BOTECITO', cantidad: 1 }, { nombre:'CHILES', cantidad: 1 } ]
    };
    function findIngredientByNameInsensitive(nombre){
      const by = (s)=> (s||'').toString().trim().toLowerCase();
      const target = by(nombre);
      return (appState.ingredientes||[]).find(i=> by(i.nombre)===target);
    }
    // Estructura: appState.insumosConsumo = { totales: { [ingId]: cantidad }, historial: [ { ventaId, fecha, items:[{ ingredienteId, nombre, unidad, cantidad }] } ] }
    function accumulateInsumosFromVenta(venta){
      try{
        if(!venta || !Array.isArray(venta.items)) return;
        const histItems = [];
        const applyRecipeForProduct = (productId, factor)=>{
          const comboProduct = appState.productos.find(p => p.id === productId);
          if(!comboProduct) return;
          const receta = Array.isArray(comboProduct.receta)? comboProduct.receta : [];
          if(receta.length===0) return;
          const mult = Number(factor)||0;
          if(mult<=0) return;
          for(const r of receta){
            const ing = appState.ingredientes.find(i=>i.id===r.ingredienteId);
            if(!ing) continue;
            const used = (Number(r.cantidad)||0) * mult;
            if(used<=0) continue;
            appState.insumosConsumo.totales[ing.id] = (appState.insumosConsumo.totales[ing.id]||0) + used;
            histItems.push({ ingredienteId: ing.id, nombre: ing.nombre, unidad: ing.unidad||'', cantidad: used });
          }
        };

        for(const it of (venta.items||[])){
          const qty = Number(it.cantidad)||0;
          if(qty<=0) continue;

          // 1) Combos nuevos con customization detallada
          if(it.customization && it.customization.type === 'combo'){
            const c = it.customization;
            const baseMult = qty || 1;

            if(Array.isArray(c.hamburguesas)){
              c.hamburguesas.forEach(b=>{
                if(b.productId) applyRecipeForProduct(b.productId, baseMult);
              });
            }
            if(Array.isArray(c.hotdogs)){
              c.hotdogs.forEach(h=>{
                if(h.productId) applyRecipeForProduct(h.productId, baseMult);
              });
            }
            if(Array.isArray(c.complementos)){
              c.complementos.forEach(comp=>{
                if(comp.productId) applyRecipeForProduct(comp.productId, baseMult);
              });
            }
            if(Array.isArray(c.bebidas)){
              c.bebidas.forEach(beb=>{
                if(beb.productId) applyRecipeForProduct(beb.productId, baseMult);
              });
            }
          } else {
            // 2) Productos normales y combos legacy con comboProductos
            const prod = appState.productos.find(p=>p.id===it.productoId);
            if(!prod) continue;

            if(prod.tipo === 'combo' && Array.isArray(prod.comboProductos)) {
              for(const cp of prod.comboProductos) {
                const comboQty = (Number(cp.cantidad)||1) * qty;
                if(cp.productId) applyRecipeForProduct(cp.productId, comboQty);
              }
            } else {
              applyRecipeForProduct(prod.id, qty);
            }
          }

          // 3) Aplicar consumo por modificadores (extras) seleccionados
          const mods = Array.isArray(it.modifiers)? it.modifiers : [];
          for(const m of mods){
            // Usar clave cuando exista; si no, inferir por el nombre
            let key = m.key;
            if(!key && m.name){
              const n = (m.name||'').toString().toLowerCase();
              if(n.includes('carne')) key = 'carneExtra';
              else if(n.includes('manchego')) key = 'manchegoExtra';
              else if(n.includes('americano')) key = 'americanoExtra';
              else if(n.includes('tocino')) key = 'tocinoExtra';
              else if(n.includes('chile')) key = 'chilesExtra';
              else if(n.includes('botecito') || n.includes('queso extra')) key = 'botecitoQueso';
            }
            const additions = key ? MODIFIER_CONSUMPTION_MAP[key] : null;
            if(!additions) continue;
            additions.forEach(add=>{
              // Buscar ingrediente por nombre y sumar
              const ingObj = findIngredientByNameInsensitive(add.nombre);
              if(!ingObj) return;
              const used = (Number(add.cantidad)||0) * qty;
              if(used<=0) return;
              appState.insumosConsumo.totales[ingObj.id] = (appState.insumosConsumo.totales[ingObj.id]||0) + used;
              histItems.push({ ingredienteId: ingObj.id, nombre: ingObj.nombre, unidad: ingObj.unidad||'', cantidad: used });
            });
          }
        }
        if(histItems.length>0){
          appState.insumosConsumo.historial.push({ ventaId: venta.id, fecha: venta.fecha, items: histItems });
        }
      }catch(e){ console.warn('accumulateInsumosFromVenta', e); }
    }

    function recomputeInsumosFromVentas(){
      appState.insumosConsumo = { totales:{}, historial:[] };
      for(const v of (appState.ventas||[])){
        if(v && !v.cancelada) accumulateInsumosFromVenta(v);
      }
  if(typeof saveInsumosToFirestore==='function') saveInsumosToFirestore();
    }

    function renderInsumosView(){
      const tb = document.getElementById('insumos-totales-body');
      const vb = document.getElementById('insumos-ventas-body');
      const mb = document.getElementById('insumos-mermas-body');
  const wb = document.getElementById('insumos-weekly-body');
      if(!tb||!vb||!mb) return;
  tb.innerHTML=''; vb.innerHTML=''; mb.innerHTML=''; if(wb) wb.innerHTML='';
  // Determinar periodo seleccionado para filtrar historial y mermas
  const getInsumosPeriod = ()=>{
    const sel = document.getElementById('ins-period-select');
    let now = new Date();
    let start = new Date(now);
    const v = sel?.value || '30d';
    if(v==='today') start.setHours(0,0,0,0);
    else if(v==='30d') start.setDate(start.getDate()-30);
    else if(v==='month') start = new Date(now.getFullYear(), now.getMonth(), 1);
    else if(v==='all') start = new Date(0);
    else if(v==='custom'){
      const s = document.getElementById('ins-date-start')?.value;
      const e = document.getElementById('ins-date-end')?.value;
      start = s ? new Date(s+'T00:00:00') : new Date(0);
      now = e ? new Date(e+'T23:59:59') : new Date();
    } else { start.setDate(start.getDate()-7); }
    return { start, end: now };
  };
  const { start: insStart, end: insEnd } = getInsumosPeriod();
  const msPerDay = 86400000;
  const totalDays = Math.max(1, Math.ceil((insEnd - insStart + 1) / msPerDay));
  // Construir totales desde historial filtrado y sumar mermas del periodo
  const totMap = new Map(); // ingId -> {cantidad, nombre, unidad}
  const histArr = (appState.insumosConsumo.historial||[]).filter(h=>{ const d=new Date(h.fecha); return d>=insStart && d<=insEnd; });
  const mermArr = (appState.insumosConsumo.merma||[]).filter(m=>{ const d=new Date(m.fecha); return d>=insStart && d<=insEnd; });
  histArr.forEach(h=>{
    (h.items||[]).forEach(i=>{
      const curr = totMap.get(i.ingredienteId) || { cantidad:0, nombre:i.nombre, unidad:i.unidad };
      curr.cantidad += Number(i.cantidad)||0;
      curr.nombre = curr.nombre || i.nombre;
      curr.unidad = curr.unidad || i.unidad;
      totMap.set(i.ingredienteId, curr);
    });
  });
  mermArr.forEach(m=>{
    const ing = appState.ingredientes.find(x=> x.id===m.ingredienteId);
    const curr = totMap.get(m.ingredienteId) || { cantidad:0, nombre: ing?.nombre || m.ingredienteId, unidad: ing?.unidad||'' };
    curr.cantidad += Number(m.cantidad)||0;
    totMap.set(m.ingredienteId, curr);
  });
  const totEntries = Array.from(totMap.entries()).map(([ingId, info])=> [ingId, info.cantidad, info]);
  const sIngs = document.getElementById('ins-stat-ings'); if(sIngs) sIngs.textContent = String(totEntries.length);
  const sLines = document.getElementById('ins-stat-lines'); if(sLines) sLines.textContent = String(histArr.length + mermArr.length);
  const sMerm = document.getElementById('ins-stat-mermas'); if(sMerm) sMerm.textContent = String(mermArr.length);
  const sVend = document.getElementById('ins-stat-ventas'); if(sVend) sVend.textContent = String(histArr.length);
      // Totales
  const entries = totEntries;
      if(entries.length===0){ tb.innerHTML = '<tr><td colspan="5" class="p-3 text-center opacity-60">Sin consumo en el periodo</td></tr>'; }
      else{
        const rows = entries.map(([ingId,cant,info])=>{
          const ing = appState.ingredientes.find(i=>i.id===ingId);
          const unidad = info?.unidad || ing?.unidad || '';
          const nombre = info?.nombre || ing?.nombre || ingId;
          const daily = (Number(cant)||0) / totalDays;
          return `<tr>
            <td class="p-2">${nombre}</td>
            <td class="p-2">${unidad}</td>
            <td class="p-2 text-right">${(Number(cant)||0).toLocaleString()}</td>
            <td class="p-2 text-right">${daily.toFixed(2)}</td>
            <td class="p-2"><button class="btn-danger px-2 py-1 rounded text-sm btn-add-merma" data-id="${ingId}">Merma</button></td>
          </tr>`;
        }).join('');
        tb.innerHTML = rows;
      }
      // Delegaci√≥n para Merma (re-attach cada render)
      tb.querySelectorAll('.btn-add-merma').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const ingId = btn.getAttribute('data-id');
          const ing = appState.ingredientes.find(i=>i.id===ingId);
          openFormModal({
            title:`Registrar Merma: ${ing?.nombre||ingId}`,
            fields:[ { name:'cantidad', label:'Cantidad', type:'number', min:0, step:'0.01', value:'' } ],
            submitText:'Agregar',
            onSubmit:(data)=>{
              const qty = Number(data.cantidad)||0;
              if(qty<=0){ alert('Ingresa una cantidad mayor a 0'); return false; }
              if(!appState.insumosConsumo) appState.insumosConsumo = { totales:{}, historial:[], merma:[] };
              if(!appState.insumosConsumo.totales) appState.insumosConsumo.totales = {};
              if(!Array.isArray(appState.insumosConsumo.merma)) appState.insumosConsumo.merma = [];
              appState.insumosConsumo.totales[ingId] = (appState.insumosConsumo.totales[ingId]||0) + qty;
              appState.insumosConsumo.merma.push({ id: generateId('merma'), ingredienteId: ingId, cantidad: qty, fecha: new Date().toISOString() });
              saveLS(); renderInsumosView(); renderInventario();
                  if(typeof saveInsumosToFirestore==='function') saveInsumosToFirestore();
            }
          });
        });
      });
      // Ventas (consumo detallado)
      const hist = (histArr||[]).slice().sort((a,b)=> new Date(b.fecha)-new Date(a.fecha));
      if(hist.length===0){ vb.innerHTML = '<tr><td colspan="2" class="p-3 text-center opacity-60">Sin ventas registradas</td></tr>'; }
      else{
        hist.forEach(h=>{
          const tr = document.createElement('tr');
    const venta = (appState.ventas||[]).find(v=> v.id===h.ventaId);
    const label = venta && venta.saleNumber ? `Venta${venta.saleNumber}` : `#${String(h.ventaId).slice(0,6)}`;
	  tr.innerHTML = `<td class="p-2">${new Date(h.fecha).toLocaleString()}</td><td class="p-2"><span class="insumo-badge insumo-badge-venta" data-venta-id="${h.ventaId}" title="Descargar PDF de insumos de esta venta">${label}</span></td>`;
          vb.appendChild(tr);
        });
  // Click en badge de venta para PDF individual de insumos
  vb.querySelectorAll('.insumo-badge-venta').forEach(badge=>{
    const ventaId = badge.getAttribute('data-venta-id');
    if(!ventaId) return;
    badge.style.cursor = 'pointer';
    badge.addEventListener('click', ()=>{
      exportInsumosVentaDetallePDF(ventaId);
    });
  });
      }
      // Mermas
  const mlist = (mermArr||[]).slice().sort((a,b)=> new Date(b.fecha)-new Date(a.fecha));
      if(mlist.length===0){ mb.innerHTML = '<tr><td colspan="3" class="p-3 text-center opacity-60">Sin mermas</td></tr>'; }
      else{
        mlist.forEach(m=>{
          const tr = document.createElement('tr');
          const ing = appState.ingredientes.find(i=>i.id===m.ingredienteId);
          const nombre = ing?.nombre || m.ingredienteId; const unidad = ing?.unidad || '';
          tr.innerHTML = `<td class="p-2">${new Date(m.fecha).toLocaleString()}</td><td class="p-2">${nombre}</td><td class="p-2">${m.cantidad}${unidad}</td>`;
          mb.appendChild(tr);
        });
      }

      // Wire bot√≥n "Agregar merma" (general)
      const mermaBtn = document.getElementById('btn-add-merma');
      if(mermaBtn){
        mermaBtn.onclick = ()=>{
          const opts = (appState.ingredientes||[]).map(i=> ({ label: i.nombre, value: i.id }));
          openFormModal({
            title: 'Registrar merma',
            fields: [
              { name:'ingredienteId', label:'Ingrediente', type:'combobox', options:opts, placeholder:'Buscar o escribir nombre...' },
              { name:'cantidad', label:'Cantidad', type:'number', min:0.01, step:'0.01', placeholder:'Ej. 1.5' },
              { name:'motivo', label:'Motivo (opcional)', type:'text' }
            ],
            submitText:'Guardar',
            onSubmit: (data)=>{
              const ingId = data.ingredienteId;
              const qty = Math.max(0.01, Number(data.cantidad||0));
              if(!ingId || qty<=0){ alert('Selecciona ingrediente y cantidad > 0'); return false; }
              appState.insumosConsumo.merma = appState.insumosConsumo.merma || [];
              appState.insumosConsumo.merma.push({ id: generateId('merma'), ingredienteId: ingId, cantidad: qty, motivo: (data.motivo||'').trim(), fecha: new Date().toISOString() });
              appState.insumosConsumo.totales[ingId] = (appState.insumosConsumo.totales[ingId]||0) + qty;
              saveLS();
              if(typeof saveInsumosToFirestore==='function') saveInsumosToFirestore();
              renderInsumosView();
              renderInventario?.();
            }
          });
        };
      }

      // Consumo semanal (agrupado por inicio de semana)
      try{
        if(wb){
          const weeksCount = Math.max(1, Number(document.getElementById('ins-semanas-select')?.value||8));
          // calcular semanas hacia atr√°s desde hoy (lunes-domingo)
          const end = new Date(); end.setHours(23,59,59,999);
          const start = new Date(end); start.setDate(start.getDate() - (7*weeksCount-1)); start.setHours(0,0,0,0);
          // normalizar a lunes
          const day = start.getDay(); // 0-dom,1-lun
          const offsetToMonday = (day===0? 6 : day-1);
          start.setDate(start.getDate()-offsetToMonday);
          const byWeek = new Map(); // key=YYYY-Www -> {start,end,totByIng:{}, total}
          const hist = Array.isArray(appState.insumosConsumo?.historial)? appState.insumosConsumo.historial:[];
          hist.forEach(h=>{
            const d = new Date(h.fecha);
            if(d<start || d>end) return;
            // lunes de esa semana
            const wStart = new Date(d); const g = wStart.getDay(); const off = (g===0? 6 : g-1); wStart.setDate(wStart.getDate()-off); wStart.setHours(0,0,0,0);
            const wEnd = new Date(wStart); wEnd.setDate(wEnd.getDate()+6); wEnd.setHours(23,59,59,999);
            const key = `${wStart.getFullYear()}-W${String(Math.ceil(((wStart - new Date(wStart.getFullYear(),0,1)) / 86400000 + wStart.getDay()+1)/7)).padStart(2,'0')}`;
            const bucket = byWeek.get(key) || { start:wStart, end:wEnd, totByIng:{}, total:0 };
            (h.items||[]).forEach(it=>{
              bucket.totByIng[it.nombre] = (bucket.totByIng[it.nombre]||0) + (Number(it.cantidad)||0);
              bucket.total += Number(it.cantidad)||0;
            });
            byWeek.set(key, bucket);
          });
          const rows = Array.from(byWeek.entries()).sort((a,b)=> a[1].start - b[1].start);
          if(rows.length===0){ wb.innerHTML = '<tr><td colspan="3" class="p-3 text-center opacity-60">Sin consumo en el periodo</td></tr>'; }
          else{
            wb.innerHTML = rows.map(([key,b])=>{
              const tops = Object.entries(b.totByIng).sort((a,b)=> b[1]-a[1]).slice(0,5).map(([n,c])=> `${n}: ${c.toFixed(0)}`).join(', ');
              return `<tr><td class="p-2">${b.start.toLocaleDateString()} ‚Äì ${b.end.toLocaleDateString()}</td><td class="p-2">${tops||'‚Äî'}</td><td class="p-2 text-right">${b.total.toFixed(0)}</td></tr>`;
            }).join('');
            // attach export button
            const btn = document.getElementById('ins-weekly-export');
            if(btn){
              btn.onclick = ()=>{
                const csv = [['Semana','Ingrediente','Cantidad']];
                rows.forEach(([_,b])=>{
                  Object.entries(b.totByIng).forEach(([n,c])=> csv.push([`${b.start.toLocaleDateString()} - ${b.end.toLocaleDateString()}`, n, String(c)]));
                });
                downloadCSV('consumo_semanal.csv', csv);
              };
            }
          }
        }
      }catch(e){ console.warn('renderInsumosView weekly', e); }
    }

    // Debug function to check combos
    window.debugCombos = function() {
      console.log('=== DIAGN√ìSTICO DE COMBOS ===');
      console.log('Total productos en appState:', appState.productos?.length || 0);
      
      const allProducts = appState.productos || [];
      const combos = allProducts.filter(p => p.tipo === 'combo');
      const visibleCombos = combos.filter(p => !p.archivado);
      
      console.log('Combos totales:', combos.length);
      console.log('Combos visibles (no archivados):', visibleCombos.length);
      
      if (combos.length > 0) {
        console.log('Lista de combos:');
        combos.forEach((combo, i) => {
          console.log(`${i + 1}. ${combo.nombre} - Precio: $${combo.precio} - Archivado: ${combo.archivado ? 'S√ç' : 'NO'}`);
          console.log('   Config:', combo.comboConfig);
        });
      } else {
        console.log('‚ùå NO HAY COMBOS CREADOS');
        console.log('üí° Ve a la secci√≥n "Productos" y crea un combo nuevo');
      }
      
      console.log('Filtro actual de categor√≠a:', posCategoryFilter);
      console.log('=== FIN DIAGN√ìSTICO ===');
    };

    function renderPosCategoryButtons(source){
      const wrap = document.getElementById('pos-category-buttons');
      if(!wrap) return;

      const byKey = new Map();
      (Array.isArray(appState.categorias) ? appState.categorias : []).forEach(c=>{
        if(!c) return;
        const key = canonicalCategoriaKey(c.key, c.nombre);
        if(!key || key==='all') return;
        const nombre = (c.nombre||'').toString().trim() || (key.charAt(0).toUpperCase()+key.slice(1));
        if(!byKey.has(key)) byKey.set(key, nombre);
      });

      (source||[]).forEach(p=>{
        const raw = (p?.clasificacion || p?.categoria || '').toString().trim();
        if(raw){
          const key = canonicalCategoriaKey(raw, raw) || raw.toLowerCase();
          if(key && !byKey.has(key)) byKey.set(key, raw);
        }
        if(p?.tipo==='combo'){
          if(!byKey.has('combo')) byKey.set('combo', 'Combos');
        }
      });

      const entries = Array.from(byKey.entries()).sort((a,b)=> (a[1]||'').localeCompare((b[1]||''), 'es', { sensitivity:'base' }));
      const validKeys = new Set(entries.map(([k])=>k));
      const currentRaw = (posCategoryFilter||'all').toString().trim();
      const currentKey = currentRaw==='all' ? 'all' : (canonicalCategoriaKey(currentRaw, currentRaw) || currentRaw.toLowerCase());
      if(currentKey !== 'all' && !validKeys.has(currentKey)) posCategoryFilter = 'all';

      const btnBase = 'pos-cat-btn px-5 py-3 rounded-lg border-2 font-bold text-base transition-all';
      wrap.innerHTML = '';
      const mkBtn = (value, label)=>{
        const btn = document.createElement('button');
        const activeKey = ((posCategoryFilter||'all')==='all') ? 'all' : (canonicalCategoriaKey(posCategoryFilter, posCategoryFilter) || (posCategoryFilter||'').toString().toLowerCase());
        btn.className = btnBase + (activeKey==='all' && value==='all' ? ' bg-white' : (activeKey!=='all' && value!=='all' && activeKey===value ? ' bg-white' : ''));
        btn.setAttribute('data-pos-cat', value);
        btn.textContent = label;
        wrap.appendChild(btn);
      };
      mkBtn('all', 'üìã Todo');
      entries.forEach(([key, nombre])=> mkBtn(key, nombre));
    }

    // POS: render de productos y manejo de orden
    function renderPosProductList(){
      const grid = document.getElementById('pos-product-list');
      if(!grid) return;
  const q = (document.getElementById('pos-search-input')?.value||'').trim().toLowerCase();
  grid.innerHTML='';
  const source = (typeof getVisibleProducts==='function')
    ? getVisibleProducts()
    : (Array.isArray(appState.productos) ? appState.productos.filter(p=> !p.archivado) : []);

  renderPosCategoryButtons(source);
    
  // Filtro mejorado (normaliza singular/plural y permite claves)
  const wantRaw = (posCategoryFilter||'all').toString().trim();
  const wantKey = wantRaw==='all' ? 'all' : (canonicalCategoriaKey(wantRaw, wantRaw) || wantRaw.toLowerCase());
  const inCat = (p)=> {
    if(wantKey==='all') return true;
    if(wantKey==='combo') return p.tipo === 'combo';
    const c1 = (p.clasificacion||'').toString().trim();
    const c2 = (p.categoria||'').toString().trim();
    const k1 = c1 ? (canonicalCategoriaKey(c1, c1) || c1.toLowerCase()) : '';
    const k2 = c2 ? (canonicalCategoriaKey(c2, c2) || c2.toLowerCase()) : '';
    return (k1 && k1===wantKey) || (k2 && k2===wantKey);
  };
  
  let list = source.filter(p=> inCat(p) && (!q || (p.nombre||'').toLowerCase().includes(q)));
  
  // Ordenar complementos por tama√±o: chico -> mediano -> grande -> sin tama√±o
  if(wantKey === 'complemento'){
    const sizeOrder = { 'chico': 1, 'mediano': 2, 'grande': 3 };
    list.sort((a, b) => {
      const aSize = sizeOrder[a.tamano] || 99;
      const bSize = sizeOrder[b.tamano] || 99;
      if(aSize !== bSize) return aSize - bSize;
      return (a.nombre || '').localeCompare(b.nombre || '');
    });
  }
  
  if(list.length===0){
        grid.innerHTML = '<div class="col-span-full text-center py-12 opacity-60 text-lg">No hay productos en esta categor√≠a</div>';
        return;
      }
  list.forEach(p=>{
    const card = document.createElement('div');
    card.className = 'product-card p-5 flex flex-col cursor-pointer transition-all duration-200';
        let desc = buildProductDescription(p);
        // Evitar duplicar t√≠tulo al inicio de la descripci√≥n
        try{
          const nameLc = (p.nombre||'').toString().trim().toLowerCase();
          const descLc = (desc||'').toString().trim().toLowerCase();
          if(descLc.startsWith(nameLc)){
            desc = desc.substring(p.nombre.length).trim();
            if(desc.startsWith('-')||desc.startsWith(':')) desc = desc.substring(1).trim();
          }
        }catch(_){ }
  
  // Add combo indicator
  const isCombo = p.tipo === 'combo';
  const comboIndicator = isCombo ? '<span class="inline-block ml-2 px-2 py-1 bg-gradient-to-r from-amber-400 to-orange-500 text-white rounded-full text-xs font-bold">üçΩÔ∏è COMBO</span>' : '';
  
  card.innerHTML = `
          <div class="prod-name font-bold text-lg mb-2 line-clamp-2 min-h-[3.5rem]" title="${p.nombre}">${p.nombre} ${comboIndicator}</div>
          <div class="prod-desc text-sm opacity-70 mb-auto line-clamp-2 min-h-[2.5rem]">${desc||'&nbsp;'}</div>
          <div class="bottom mt-4 pt-3 border-t">
            <div class="text-2xl font-extrabold text-green-600">${fmt(p.precio)}</div>
          </div>
        `;
  // Handler: tocar/clicar tarjeta para abrir personalizaci√≥n y agregar
  card.setAttribute('role','button');
  card.setAttribute('tabindex','0');
  card.addEventListener('click', ()=> openCustomizeProductModal(p.id));
  card.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter' || ev.key===' '){ ev.preventDefault(); openCustomizeProductModal(p.id); } });
        grid.appendChild(card);
      });
      // Nota: listeners de cada tarjeta se eliminan autom√°ticamente al limpiar el grid en pr√≥ximas renderizaciones
    }

    // Delegaci√≥n de acciones de productos
    function setupProductosActions(){
      const tb = document.getElementById('productos-list-body');
      if(!tb) return;
      tb.addEventListener('click', (e)=>{
        const btn = e.target.closest('button');
        if(!btn) return;
        const id = btn.getAttribute('data-id');
        
        // Handle estaci√≥n buttons
        if(btn.classList.contains('estacion-btn')){
          const estacion = btn.getAttribute('data-estacion');
          const prod = appState.productos.find(p=>p.id===id);
          if(prod){
            if(!Array.isArray(prod.estaciones)){
              // Migrar desde modelo antiguo de una sola estaci√≥n
              if(prod.estacion && prod.estacion !== 'ninguna') prod.estaciones = [prod.estacion];
              else prod.estaciones = [];
            }

            if(estacion === 'ninguna'){
              prod.estaciones = [];
              prod.estacion = 'ninguna';
            }else{
              const list = Array.from(new Set(prod.estaciones));
              const idx = list.indexOf(estacion);
              if(idx === -1) list.push(estacion); else list.splice(idx, 1);

              prod.estaciones = list;
              if(list.length === 0) prod.estacion = 'ninguna';
              else if(list.length === 1) prod.estacion = list[0];
              else prod.estacion = 'multi';
            }

            if(typeof saveProductToFirestore === 'function') saveProductToFirestore(prod);
            saveLS(); renderProductosTabla();
          }
          return;
        }
        
        if(btn.classList.contains('btn-del-prod')){
          const prod = appState.productos.find(p=>p.id===id);
          if(prod){ prod.archivado = true; prod.archivedAt = new Date().toISOString(); }
          currentOrder.items = currentOrder.items.filter(i=>i.productoId!==id);
          if(typeof deleteProductFromFirestore === 'function') deleteProductFromFirestore(id);
          saveLS(); renderAll(); renderPosProductList(); updateOrderUI();
        } else if(btn.classList.contains('btn-dup-prod')){
          const p = appState.productos.find(x=>x.id===id); if(!p) return;
          const copy = JSON.parse(JSON.stringify(p));
          copy.id = generateId('p');
          copy.nombre = (p.nombre||'Producto') + ' (Copia)';
          appState.productos.push(copy);
          if(typeof saveProductToFirestore === 'function') saveProductToFirestore(copy);
          saveLS(); renderAll(); renderPosProductList();
        } else if(btn.classList.contains('btn-edit-prod')){
          openProductEditModal(id);
        } else if(btn.classList.contains('btn-derive-slice')){
          // Derivar subproducto con divisor configurable (default 8)
          const parent = appState.productos.find(x=>x.id===id);
          if(!parent){ alert('Producto no encontrado'); return; }
          const name = prompt('Nombre del subproducto:', `Rebanada de ${parent.nombre}`);
          if(name===null) return;
          const divStr = prompt('Dividir cantidades y precio entre (ej. 8, 10, 12):', '8');
          const div = Math.max(1, Number(divStr)||8);
          deriveSubProductFrom(id, { childName: name, divisor: div, priceStrategy: 'divide' });
        }
      });
    }

    // Modal de edici√≥n de producto (con receta)
    function openProductEditModal(productId){
      const prod = appState.productos.find(p=>p.id===productId);
      if(!prod) return;
      const backdrop = $('#modal-backdrop');
      const container = $('#modal-container');
      const ingOptions = appState.ingredientes.map(i=>`<option value="${i.id}">${i.nombre} (${i.unidad||''})</option>`).join('');
      // Opciones de categor√≠a basadas en appState.categorias
      ensureDefaultCategorias();
      let categoriaOptionsEdit = '';
      const currentCat = (prod.categoria||'').toString();
      if(Array.isArray(appState.categorias) && appState.categorias.length){
        const cats = [...appState.categorias].sort((a,b)=>{
          const la = (a.nombre||a.key||'').toString();
          const lb = (b.nombre||b.key||'').toString();
          return la.localeCompare(lb);
        });
        categoriaOptionsEdit = cats.map(c=>{
          const label = (c.nombre||c.key||'').toString();
          const value = label;
          const sel = value === currentCat ? ' selected' : '';
          return `<option value="${value}"${sel}>${label}</option>`;
        }).join('');
      }
      const html = `
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6">
          <h3 class="text-lg font-bold mb-4" style="color:var(--burger-dark)">Editar Producto</h3>
          <form id="product-edit-form" class="space-y-4">
            <div>
              <label class="block text-sm font-bold mb-1">Nombre</label>
              <input type="text" name="nombre" class="w-full input-modern p-2 rounded" value="${prod.nombre||''}" required>
            </div>
            <div>
              <label class="block text-sm font-bold mb-1">Precio (venta)</label>
              <input type="number" name="precio" class="w-full input-modern p-2 rounded" value="${Number(prod.precio)||0}" min="0" step="0.01" required>
            </div>
            <div>
              <label class="block text-sm font-bold mb-1">Descripci√≥n</label>
              <textarea name="descripcion" rows="3" class="w-full input-modern p-2 rounded">${prod.descripcion||''}</textarea>
            </div>
            <div>
              <label class="block text-sm font-bold mb-1">Categor√≠a</label>
              <select name="categoria" class="w-full input-modern p-2 rounded">
                <option value="">Sin categor√≠a</option>
                ${categoriaOptionsEdit}
              </select>
            </div>
            <div id="edit-tamano-section" class="${prod.clasificacion==='complemento'?'':'hidden'}">
              <label class="block text-sm font-bold mb-1">Tama√±o del Complemento</label>
              <select name="tamano" class="w-full input-modern p-2 rounded">
                <option value="" ${!prod.tamano?'selected':''}>Sin especificar</option>
                <option value="chico" ${prod.tamano==='chico'?'selected':''}>üîπ Chico</option>
                <option value="mediano" ${prod.tamano==='mediano'?'selected':''}>üî∏ Mediano</option>
                <option value="grande" ${prod.tamano==='grande'?'selected':''}>üî∂ Grande</option>
              </select>
            </div>
            <div class="border-t pt-3">
              <div class="recipe-title-bar mb-2">
                <label class="block text-sm font-bold">Receta (ingredientes)</label>
                <button type="button" id="edit-add-ingredient-row" class="btn-success btn-compact rounded">+ Agregar</button>
              </div>
              <div id="edit-recipe-rows" class="recipe-list space-y-2"></div>
              <div id="edit-cost-estimate" class="text-xs opacity-70 mt-2"></div>
            </div>
            <div class="flex gap-2 pt-2">
              <button type="submit" class="btn-success px-4 py-2 rounded">Actualizar</button>
              <button type="button" id="cancel-product-edit" class="btn-danger px-4 py-2 rounded">Cancelar</button>
            </div>
          </form>
        </div>`;
      container.innerHTML = html;
      backdrop.classList.remove('hidden');
      backdrop.style.display = '';
      container.classList.remove('hidden');
      // Prevent background scroll on mobile
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';

      function addRow(defaultIngId='', defaultQty=''){
        const rows = document.getElementById('edit-recipe-rows');
        const row = document.createElement('div');
        row.className = 'recipe-row';
        row.innerHTML = `
          <select class=\"select-compact input-modern rounded ing-select\">${ingOptions}</select>
          <input type=\"number\" class=\"input-compact input-modern rounded qty-input\" placeholder=\"Cant.\" min=\"0\" step=\"any\">
          <button type=\"button\" class=\"btn-danger btn-compact rounded remove-row\">√ó</button>
        `;
        rows.appendChild(row);
        if(defaultIngId){ row.querySelector('.ing-select').value = defaultIngId; }
        if(defaultQty!==undefined && defaultQty!==''){ row.querySelector('.qty-input').value = String(defaultQty); }
        row.querySelector('.remove-row').addEventListener('click', ()=> { row.remove(); recalcEditCost(); });
        row.querySelector('.ing-select').addEventListener('change', recalcEditCost);
        row.querySelector('.qty-input').addEventListener('input', recalcEditCost);
      }
      // Prefill receta
      (prod.receta||[]).forEach(r=> addRow(r.ingredienteId, r.cantidad));
      if(!prod.receta || prod.receta.length===0) addRow();
      document.getElementById('edit-add-ingredient-row')?.addEventListener('click', ()=> addRow());
      document.getElementById('cancel-product-edit')?.addEventListener('click', closeModal);
      function recalcEditCost(){
        let cost = 0;
        const rows = Array.from(document.querySelectorAll('#edit-recipe-rows .recipe-row'));
        rows.forEach(r=>{
          const sel = r.querySelector('.ing-select');
          const qty = parseFloat(r.querySelector('.qty-input')?.value||'0');
          const ing = getIngredientById(sel?.value);
          if(ing && qty>0) cost += getUnitCost(ing) * qty;
        });
        const price = parseFloat(document.querySelector('#product-edit-form [name=\"precio\"]')?.value||'0')||0;
        const margin = price - cost;
        const pct = price>0 ? (margin/price*100) : 0;
        const el = document.getElementById('edit-cost-estimate');
        if(el) el.textContent = `Costo: ${fmt(cost)} ‚Ä¢ Margen: ${fmt(margin)} (${pct.toFixed(1)}%)`;
      }
      recalcEditCost();
      document.querySelector('#product-edit-form [name="precio"]')?.addEventListener('input', recalcEditCost);
      
      // Mostrar/ocultar selector de tama√±o seg√∫n la categor√≠a (complemento)
      const editCategoriaSelect = document.querySelector('#product-edit-form [name="categoria"]');
      const editTamanoSection = document.getElementById('edit-tamano-section');
      if (editCategoriaSelect && editTamanoSection) {
        const syncTamanoVisibility = () => {
          const label = (editCategoriaSelect.value || '').toString();
          const key = canonicalCategoriaKey(label, label) || '';
          if (key === 'complemento') editTamanoSection.classList.remove('hidden');
          else editTamanoSection.classList.add('hidden');
        };
        editCategoriaSelect.addEventListener('change', syncTamanoVisibility);
        syncTamanoVisibility();
      }
      
      document.getElementById('product-edit-form')?.addEventListener('submit', (e)=>{
        e.preventDefault();
        const fd = new FormData(e.target);
        prod.nombre = (fd.get('nombre')||'').toString().trim()||prod.nombre;
        prod.precio = parseFloat(fd.get('precio'))||0;
        prod.descripcion = (fd.get('descripcion')||'').toString();
        const nuevaCat = (fd.get('categoria')||'').toString().trim();
        prod.categoria = nuevaCat || '';
        const clasifEdit = prod.tipo === 'combo' ? 'combo' : canonicalCategoriaKey(nuevaCat, nuevaCat) || '';
        prod.clasificacion = clasifEdit;
        prod.tamano = (fd.get('tamano')||'').toString();
        const sels = Array.from(document.querySelectorAll('#edit-recipe-rows .ing-select'));
        const qtys = Array.from(document.querySelectorAll('#edit-recipe-rows .qty-input'));
        const nuevaReceta = [];
        for(let i=0;i<sels.length;i++){
          const ingredienteId = sels[i].value;
          const cantidad = parseFloat(qtys[i].value||'0');
          if(ingredienteId && cantidad>0) nuevaReceta.push({ ingredienteId, cantidad });
        }
  prod.receta = nuevaReceta;
  prod.costo = computeRecipeCost(nuevaReceta);
  if(typeof saveProductToFirestore === 'function') saveProductToFirestore(prod);
  // Recalcular subproductos derivados si existen
  try{ recomputeDerivedChildren(prod.id, 8); }catch(_){ }
  saveLS(); renderAll(); renderPosProductList(); closeModal();
      });
    }

    function addToOrder(productoId, skipPapasPrompt = false){
      if(currentOrder.tipo==='local' && !currentOrder.mesaId){
        alert('Selecciona o crea una mesa antes de tomar la orden.');
        try{ document.getElementById('pos-table-select')?.focus(); }catch(_){ }
        return;
      }
      const p = appState.productos.find(x=>x.id===productoId);
      if(!p) return;
      
      // Buscar item sin modificadores para merge r√°pido
      const existing = currentOrder.items.find(i=>i.productoId===productoId && (!i.modifiers || i.modifiers.length===0));
      if(existing){ existing.cantidad += 1; }
      else { currentOrder.items.push({ lineId: generateId('it'), productoId:p.id, nombre:p.nombre, precio:Number(p.precio)||0, cantidad:1, modifiers: [] }); }
      
      // Si es hamburguesa y no se debe saltar el prompt, preguntar por papas
      if(!skipPapasPrompt && (p.clasificacion === 'hamburguesa' || p.nombre.toLowerCase().includes('hamburguesa') || p.nombre.toLowerCase().includes('burger'))){
        showPapasPrompt();
      } else {
        updateOrderUI();
      }
    }
    
    function showPapasPrompt(){
      const backdrop = $('#modal-backdrop');
      const container = $('#modal-container');
      if(!backdrop || !container) { 
        updateOrderUI(); 
        return; 
      }
      
      container.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
          <div class="modal-header-nice">
            <h3 class="text-lg font-extrabold">üçü ¬øAgregar Papas?</h3>
          </div>
          <div class="p-6 space-y-4">
            <p class="text-center text-lg font-semibold">¬øDeseas agregar papas chicas con tu hamburguesa?</p>
            
            <div class="space-y-3">
              <button id="papas-francesas-btn" class="w-full btn-gradient px-4 py-3 rounded-lg text-lg font-bold">
                üçü Papas Francesas Chicas
              </button>
              <button id="papas-gajo-btn" class="w-full btn-gradient px-4 py-3 rounded-lg text-lg font-bold">
                ü•î Papas Gajo Chicas
              </button>
              <button id="no-papas-btn" class="w-full btn-outline px-4 py-3 rounded-lg text-lg font-bold">
                No, gracias
              </button>
            </div>
          </div>
        </div>
      `;
      
      backdrop.classList.remove('hidden');
      backdrop.classList.add('flex');
      
      // Event listeners
      $('#papas-francesas-btn')?.addEventListener('click', () => {
        addPapasToOrder('francesas');
        closeModal();
        updateOrderUI();
      });
      
      $('#papas-gajo-btn')?.addEventListener('click', () => {
        addPapasToOrder('gajo');
        closeModal();
        updateOrderUI();
      });
      
      $('#no-papas-btn')?.addEventListener('click', () => {
        closeModal();
        updateOrderUI();
      });
      
      backdrop.addEventListener('click', (e) => {
        if(e.target === backdrop){
          closeModal();
          updateOrderUI();
        }
      });
    }
    
    function addPapasToOrder(tipo){
      // Buscar el producto de papas seg√∫n el tipo
      const nombrePapas = tipo === 'francesas' ? 'PAPAS FRANCESAS complemento' : 'PAPAS GAJO complemento';
      const papasProducto = appState.productos.find(prod => {
        const normNombre = (prod.nombre || '').toUpperCase().trim();
        return normNombre === nombrePapas;
      });
      
      if(!papasProducto){
        console.warn(`No se encontr√≥ el producto: ${nombrePapas}`);
        return;
      }
      
      // Verificar que sea tama√±o chico
      if(papasProducto.tamano !== 'chico'){
        console.warn(`El producto ${nombrePapas} no es tama√±o chico`);
        // Buscar versi√≥n chica
        const papasChicas = appState.productos.find(prod => {
          const normNombre = (prod.nombre || '').toUpperCase().trim();
          const esPapas = tipo === 'francesas' 
            ? normNombre.includes('FRANCESAS') && normNombre.includes('COMPLEMENTO')
            : normNombre.includes('GAJO') && normNombre.includes('COMPLEMENTO');
          return esPapas && prod.tamano === 'chico';
        });
        
        if(papasChicas){
          agregarPapasItem(papasChicas);
        } else {
          // Si no hay versi√≥n chica, agregar la que encontramos
          agregarPapasItem(papasProducto);
        }
      } else {
        agregarPapasItem(papasProducto);
      }
    }
    
    function agregarPapasItem(papasProducto){
      // Buscar si ya existe este producto en la orden
      const existingPapas = currentOrder.items.find(i => i.productoId === papasProducto.id);
      if(existingPapas){
        existingPapas.cantidad += 1;
      } else {
        currentOrder.items.push({
          lineId: generateId('it'),
          productoId: papasProducto.id,
          nombre: papasProducto.nombre,
          precio: Number(papasProducto.precio) || 0,
          costo: Number(papasProducto.costo) || 0,
          cantidad: 1,
          modifiers: []
        });
      }
    }

    // Personalizaci√≥n de producto (extras)
    function openCustomizeProductModal(productoId){
      if(currentOrder.tipo==='local' && !currentOrder.mesaId){
        alert('Selecciona o crea una mesa antes de tomar la orden.');
        try{ document.getElementById('pos-table-select')?.focus(); }catch(_){ }
        return;
      }
      const p = appState.productos.find(x=>x.id===productoId);
      if(!p){ alert('Producto no encontrado'); return; }
      
      const backdrop = $('#modal-backdrop');
      const container = $('#modal-container');
      if(!backdrop || !container){ alert('Modal no disponible'); return; }

      // Check if it's a combo product
      if (p.tipo === 'combo' && p.comboConfig) {
        openComboCustomizeModal(p);
      } else {
        openRegularProductModal(p);
      }
    }

    function openComboCustomizeModal(p) {
      const backdrop = $('#modal-backdrop');
      const container = $('#modal-container');
      
      let html = `
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden max-h-[90vh] overflow-y-auto">
          <div class="modal-header-nice">
            <h3 class="text-lg font-extrabold">üçΩÔ∏è Personalizar Combo: ${p.nombre}</h3>
          </div>
          <div class="p-5 space-y-4">
            <div class="summary-row">
              <div class="font-bold">Precio base del combo</div>
              <div class="price-chip">${fmt(p.precio)}</div>
            </div>
            <div class="summary-row">
              <div class="font-bold">Diferencias por cambios</div>
              <div id="combo-price-diff" class="price-chip">$0.00</div>
            </div>
            <div class="summary-row border-t pt-2">
              <div class="text-xl font-extrabold">Total del Combo</div>
              <div id="combo-total" class="text-xl font-extrabold">${fmt(p.precio)}</div>
            </div>
            
            <div id="combo-customization" class="space-y-4">`;

      const config = p.comboConfig;
      let customization = {};

      const isCategoriasCombo = Array.isArray(config?.categorias) && config.categorias.length > 0;
      const catKey = (s)=>{
        try{
          return (typeof canonicalCategoriaKey==='function' ? (canonicalCategoriaKey(s, s) || '') : '') || (s||'').toString().trim().toLowerCase();
        }catch(_){
          return (s||'').toString().trim().toLowerCase();
        }
      };

      // Categor√≠as din√°micas (creadas por el usuario)
      if (isCategoriasCombo) {
        const visible = getVisibleProducts().filter(prod => prod.tipo !== 'combo');
        config.categorias.forEach(cc => {
          const categoria = (cc?.categoria || '').toString().trim();
          const qty = Math.max(1, Number(cc?.cantidad) || 1);
          if(!categoria) return;

          const candidates = visible
            .filter(prod => catKey(prod.categoria || prod.clasificacion || '') === catKey(categoria))
            .slice()
            .sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||''));

          html += `
            <div class="combo-category-section border rounded-lg p-4">
              <h4 class="font-bold text-lg mb-3">üì¶ ${categoria} (${qty})</h4>
              ${candidates.length===0 ? `<div class="text-sm text-red-600">No hay productos en la categor√≠a "${categoria}". Crea productos con esa categor√≠a para poder elegirlos.</div>` : `<div class="grid grid-cols-1 gap-2">`}
          `;

          if (candidates.length > 0) {
            for (let i = 0; i < qty; i++) {
              html += `
                <div class="flex items-center gap-2">
                  <span class="text-sm font-medium w-20">${categoria} ${i + 1}:</span>
                  <select class="flex-1 input-modern p-2 rounded text-sm combo-generic-select" data-categoria="${categoria}" data-index="${i}" required>
                    <option value="">Selecciona</option>
                    ${candidates.map(pr => `<option value="${pr.id}">${pr.nombre}</option>`).join('')}
                  </select>
                </div>`;
            }
            html += `</div>`;
          }

          html += `</div>`;
        });
      }

      // Hamburguesas
      if (config.hamburguesas) {
        const qty = config.hamburguesas.cantidad || 1;
        const burgers = getVisibleProducts().filter(prod => 
          prod.tipo !== 'combo' && 
          (prod.clasificacion === 'hamburguesa' || 
           prod.nombre.toLowerCase().includes('hamburguesa') || 
           prod.nombre.toLowerCase().includes('burger'))
        );

        // Elegir hamburguesa base para el combo:
        // 1) Preferir una que tenga "premium" en el nombre
        // 2) Si no hay, buscar una "cl√°sica"
        // 3) Si tampoco hay, usar la m√°s cara como base (la "premium" del men√∫)
        let baseBurger = burgers.find(burger => 
          burger.nombre.toLowerCase().includes('premium')
        );

        if (!baseBurger) {
          baseBurger = burgers.find(burger => 
            burger.nombre.toLowerCase().includes('clasic') || 
            burger.nombre.toLowerCase().includes('classic')
          );
        }

        if (!baseBurger && burgers.length > 0) {
          baseBurger = burgers.reduce((max, burger) => 
            (burger.precio > max.precio) ? burger : max, burgers[0]);
        }

        const basePrice = baseBurger ? baseBurger.precio : 100;

        console.log('[COMBO SETUP] Hamburguesa base:', baseBurger?.nombre, 'Precio base:', basePrice);
        
        html += `
          <div class="combo-category-section border rounded-lg p-4">
            <h4 class="font-bold text-lg mb-3">üçî Hamburguesas (${qty})</h4>
            <div class="text-xs text-gray-600 mb-2">La hamburguesa base (${baseBurger?.nombre || 'Hamburguesa Cl√°sica'}) viene incluida. Solo se cobra diferencia por cambios.</div>
            <div class="grid grid-cols-1 gap-2">`;
        
        for (let i = 0; i < qty; i++) {
          html += `
            <div class="flex items-center gap-2">
              <span class="text-sm font-medium w-16">Burger ${i + 1}:</span>
              <select class="flex-1 input-modern p-2 rounded text-sm combo-burger-select" data-index="${i}" data-base-price="${basePrice}">
                <option value="${baseBurger?.id || ''}" data-price="${basePrice}">${baseBurger?.nombre || 'Hamburguesa Cl√°sica'} (incluida)</option>`;
          
          burgers.forEach(burger => {
            if (burger.id !== baseBurger?.id) {
              const priceDiff = burger.precio - basePrice;
              const diffText = priceDiff > 0 ? ` (+${fmt(priceDiff)})` : priceDiff < 0 ? ` (${fmt(priceDiff)})` : '';
              html += `<option value="${burger.id}" data-price="${burger.precio}">${burger.nombre}${diffText}</option>`;
            }
          });
          
          html += `</select></div>`;
        }
        html += `</div></div>`;
      }

      // Papas
      if (config.papas) {
        const size = config.papas.tama√±o || 'M';
        
        html += `
          <div class="combo-category-section border rounded-lg p-4">
            <h4 class="font-bold text-lg mb-3">üçü Papas ${size}</h4>
            <div class="space-y-2">
              <div>
                <label class="block text-sm font-medium mb-1">Tipo de papas:</label>
                <select id="combo-fries-type" class="w-full input-modern p-2 rounded" required>
                  <option value="">Selecciona el tipo de papas</option>
                  <option value="francesas">Papas Francesas</option>
                  <option value="gajo">Papas Gajo</option>
                </select>
              </div>
            </div>
          </div>`;
      }

      // Aros
      if (config.aros) {
        const size = config.aros.tama√±o || 'M';
        html += `
          <div class="combo-category-section border rounded-lg p-4">
            <h4 class="font-bold text-lg mb-3">üç∞ Aros de Cebolla ${size}</h4>
            <div class="text-sm text-gray-600">Incluidos en el combo</div>
          </div>`;
      }

      // Hotdogs
      if (config.hotdogs) {
        const qty = config.hotdogs.cantidad || 1;
        const hotdogs = getVisibleProducts().filter(prod => 
          prod.tipo !== 'combo' && 
          (prod.clasificacion === 'hotdog' || 
           prod.nombre.toLowerCase().includes('hotdog') || 
           prod.nombre.toLowerCase().includes('hot dog'))
        );
        
        // Find the classic hotdog (cheapest one or one with "clasic" in name) to use as base price
        let classicHotdog = hotdogs.find(hotdog => 
          hotdog.nombre.toLowerCase().includes('clasic') || 
          hotdog.nombre.toLowerCase().includes('classic')
        );
        
        // If no "classic" found, use the cheapest one
        if (!classicHotdog) {
          classicHotdog = hotdogs.reduce((min, hotdog) => 
            (hotdog.precio < min.precio) ? hotdog : min, hotdogs[0]);
        }
        
        const basePrice = classicHotdog ? classicHotdog.precio : 60;
        
        console.log('[COMBO SETUP] Hotdog base:', classicHotdog?.nombre, 'Precio base:', basePrice);
        
        html += `
          <div class="combo-category-section border rounded-lg p-4">
            <h4 class="font-bold text-lg mb-3">üå≠ Hotdogs (${qty})</h4>
            <div class="text-xs text-gray-600 mb-2">El hotdog cl√°sico viene incluido. Solo se cobra diferencia por cambios.</div>
            <div class="grid grid-cols-1 gap-2">`;
        
        for (let i = 0; i < qty; i++) {
          html += `
            <div class="flex items-center gap-2">
              <span class="text-sm font-medium w-16">Hotdog ${i + 1}:</span>
              <select class="flex-1 input-modern p-2 rounded text-sm combo-hotdog-select" data-index="${i}" data-base-price="${basePrice}">
                <option value="${classicHotdog?.id || ''}" data-price="${basePrice}">Hotdog Cl√°sico (incluido)</option>`;
          
          hotdogs.forEach(hotdog => {
            if (hotdog.id !== classicHotdog?.id) {
              const priceDiff = hotdog.precio - basePrice;
              const diffText = priceDiff > 0 ? ` (+${fmt(priceDiff)})` : priceDiff < 0 ? ` (${fmt(priceDiff)})` : '';
              html += `<option value="${hotdog.id}" data-price="${hotdog.precio}">${hotdog.nombre}${diffText}</option>`;
            }
          });
          
          html += `</select></div>`;
        }
        html += `</div></div>`;
      }

      // Complementos
      if (config.complementos) {
        const qty = config.complementos.cantidad || 1;
        let complements = getVisibleProducts().filter(prod => 
          prod.tipo !== 'combo' && 
          (prod.clasificacion === 'complemento' ||
           (prod.categoria && prod.categoria.toLowerCase() === 'complementos'))
        );
        
        // Ordenar por tama√±o: chico -> mediano -> grande -> sin tama√±o
        const sizeOrder = { 'chico': 1, 'mediano': 2, 'grande': 3 };
        complements.sort((a, b) => {
          const aSize = sizeOrder[a.tamano] || 99;
          const bSize = sizeOrder[b.tamano] || 99;
          if (aSize !== bSize) return aSize - bSize;
          return (a.nombre || '').localeCompare(b.nombre || '');
        });
        
        html += `
          <div class="combo-category-section border rounded-lg p-4">
            <h4 class="font-bold text-lg mb-3">ü•§ Complementos (${qty})</h4>
            <div class="text-xs text-gray-600 mb-2">Selecciona los complementos que deseas.</div>
            <div class="grid grid-cols-1 gap-2">`;
        
        for (let i = 0; i < qty; i++) {
          html += `
            <div class="flex items-center gap-2">
              <span class="text-sm font-medium w-20">Compl. ${i + 1}:</span>
              <select class="flex-1 input-modern p-2 rounded text-sm combo-complement-select" data-index="${i}" required>
                <option value="">Selecciona un complemento</option>`;
          
          complements.forEach(comp => {
            html += `<option value="${comp.id}" data-price="${comp.precio}">${comp.nombre} (${fmt(comp.precio)})</option>`;
          });
          
          html += `</select></div>`;
        }
        html += `</div></div>`;
      }

      // Bebidas
      if (config.bebidas) {
        const qty = config.bebidas.cantidad || 1;
        let drinks = getVisibleProducts().filter(prod => 
          prod.tipo !== 'combo' && 
          (prod.clasificacion === 'bebida' ||
           (prod.categoria && prod.categoria.toLowerCase() === 'bebidas'))
        );
        
        // Ordenar por tama√±o: chico -> mediano -> grande -> sin tama√±o
        const sizeOrder = { 'chico': 1, 'mediano': 2, 'grande': 3 };
        drinks.sort((a, b) => {
          const aSize = sizeOrder[a.tamano] || 99;
          const bSize = sizeOrder[b.tamano] || 99;
          if (aSize !== bSize) return aSize - bSize;
          return (a.nombre || '').localeCompare(b.nombre || '');
        });
        
        html += `
          <div class="combo-category-section border rounded-lg p-4">
            <h4 class="font-bold text-lg mb-3">ü•§ Bebidas (${qty})</h4>
            <div class="text-xs text-gray-600 mb-2">Selecciona las bebidas que deseas.</div>
            <div class="grid grid-cols-1 gap-2">`;
        
        for (let i = 0; i < qty; i++) {
          html += `
            <div class="flex items-center gap-2">
              <span class="text-sm font-medium w-20">Bebida ${i + 1}:</span>
              <select class="flex-1 input-modern p-2 rounded text-sm combo-drink-select" data-index="${i}" required>
                <option value="">Selecciona una bebida</option>`;
          
          drinks.forEach(drink => {
            html += `<option value="${drink.id}" data-price="${drink.precio}">${drink.nombre} (${fmt(drink.precio)})</option>`;
          });
          
          html += `</select></div>`;
        }
        html += `</div></div>`;
      }

      html += `
            </div>
            
            <div class="flex gap-2 pt-4">
              <button id="combo-add" class="btn-success px-4 py-2 rounded flex-1">Agregar combo a la orden</button>
              <button id="combo-cancel" class="btn-danger px-4 py-2 rounded">Cancelar</button>
            </div>
          </div>
        </div>`;

      container.innerHTML = html;
      backdrop.classList.remove('hidden');
      backdrop.style.display = '';
      container.classList.remove('hidden');
      // Prevent background scroll on mobile
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';

      // Initialize difference display to $0.00
      setTimeout(() => {
        document.getElementById('combo-price-diff').textContent = '$0.00';
        document.getElementById('combo-total').textContent = fmt(p.precio);
      }, 50);

      function updateComboTotals() {
        if (isCategoriasCombo) {
          document.getElementById('combo-price-diff').textContent = '$0.00';
          document.getElementById('combo-total').textContent = fmt(p.precio);
          return;
        }
        let priceDifference = 0;
        let burgerDifference = 0;
        let hotdogDifference = 0;
        let complementDifference = 0;
        
        console.log('[COMBO] =========================');
        console.log('[COMBO] Calculando diferencias...');
        
        // Calculate price differences for burgers (only charge difference from classic)
        document.querySelectorAll('.combo-burger-select').forEach((select, index) => {
          if (select.value) {
            const option = select.querySelector(`option[value="${select.value}"]`);
            const price = parseFloat(option?.getAttribute('data-price') || '0');
            const basePrice = parseFloat(select.getAttribute('data-base-price') || '0');
            
            // Check if the selected option text contains "incluida" (meaning it's the classic)
            const optionText = option?.textContent || '';
            const isClassicOption = optionText.includes('(incluida)') || optionText.includes('Cl√°sica');
            const diff = isClassicOption ? 0 : Math.max(0, price - basePrice);
            
            console.log(`[COMBO] Burger ${index + 1}: "${optionText}"`);
            console.log(`[COMBO]   precio=${price}, base=${basePrice}, isClassic=${isClassicOption}, diff=${diff}`);
            burgerDifference += diff;
          }
        });

        // Calculate price differences for hotdogs (only charge difference from classic)
        document.querySelectorAll('.combo-hotdog-select').forEach((select, index) => {
          if (select.value) {
            const option = select.querySelector(`option[value="${select.value}"]`);
            const price = parseFloat(option?.getAttribute('data-price') || '0');
            const basePrice = parseFloat(select.getAttribute('data-base-price') || '0');
            
            // Check if the selected option text contains "incluido" (meaning it's the classic)
            const optionText = option?.textContent || '';
            const isClassicOption = optionText.includes('(incluido)') || optionText.includes('Cl√°sico');
            const diff = isClassicOption ? 0 : Math.max(0, price - basePrice);
            
            console.log(`[COMBO] Hotdog ${index + 1}: "${optionText}"`);
            console.log(`[COMBO]   precio=${price}, base=${basePrice}, isClassic=${isClassicOption}, diff=${diff}`);
            hotdogDifference += diff;
          }
        });

        // Add complementos costs (these are always extra)
        // NOTE: Only count complementos that are actually selected in the UI, not from config
        if (config.complementos && config.complementos.length > 0) {
          console.log('[COMBO] Complementos configurados en el combo:', config.complementos);
          console.log('[COMBO] PERO NO se suman autom√°ticamente - solo si el usuario los selecciona');
          
          // Check if there are actual complement selections in the UI
          const complementRows = document.querySelectorAll('.complement-row');
          if (complementRows.length > 0) {
            complementRows.forEach((row, index) => {
              const select = row.querySelector('.complement-select');
              const qtyInput = row.querySelector('.complement-qty');
              if (select && select.value && qtyInput) {
                const productId = select.value;
                const quantity = parseInt(qtyInput.value) || 1;
                const product = appState.productos.find(p => p.id === productId);
                if (product && quantity > 0) {
                  const compCost = (product.precio || 0) * quantity;
                  console.log(`[COMBO] Complemento seleccionado: ${product.nombre}, precio=${product.precio}, qty=${quantity}, costo=${compCost}`);
                  complementDifference += compCost;
                }
              }
            });
          } else {
            console.log('[COMBO] No hay complementos seleccionados en la UI');
          }
        } else {
          console.log('[COMBO] No hay complementos configurados');
        }

        priceDifference = burgerDifference + hotdogDifference + complementDifference;
        
        console.log(`[COMBO] RESUMEN:`);
        console.log(`[COMBO]   Diferencia Burgers: ${burgerDifference}`);
        console.log(`[COMBO]   Diferencia Hotdogs: ${hotdogDifference}`);
        console.log(`[COMBO]   Diferencia Complementos: ${complementDifference}`);
        console.log(`[COMBO]   TOTAL DIFERENCIAS: ${priceDifference}`);
        console.log('[COMBO] =========================');
        
        // Final price = base combo price + differences
        const finalPrice = p.precio + priceDifference;
        document.getElementById('combo-price-diff').textContent = fmt(priceDifference);
        document.getElementById('combo-total').textContent = fmt(finalPrice);
      }

      // Add event listeners
      if (!isCategoriasCombo) {
        document.querySelectorAll('.combo-burger-select, .combo-hotdog-select, #combo-fries-type').forEach(element => {
          element.addEventListener('change', updateComboTotals);
        });
      }

      // Don't call updateComboTotals automatically - let it stay at $0 until user makes changes

      document.getElementById('combo-cancel')?.addEventListener('click', closeModal);
      document.getElementById('combo-add')?.addEventListener('click', () => {
        // Collect customization data
        const customization = {
          type: 'combo',
          comboConfig: p.comboConfig
        };

        if (isCategoriasCombo) {
          customization.categorias = [];
          let allSelected = true;

          const byCat = new Map();
          document.querySelectorAll('.combo-generic-select').forEach(sel => {
            const categoria = sel.getAttribute('data-categoria') || '';
            const productId = sel.value;
            if (!productId) { allSelected = false; return; }
            const productName = sel.querySelector(`option[value="${productId}"]`)?.textContent || '';
            if(!byCat.has(categoria)) byCat.set(categoria, []);
            byCat.get(categoria).push({ productId, productName });
          });

          if (!allSelected) {
            alert('Por favor selecciona todos los productos del combo.');
            return;
          }

          byCat.forEach((items, categoria)=>{
            customization.categorias.push({ categoria, items });
          });
        }

        // Burgers
        if (config.hamburguesas) {
          customization.hamburguesas = [];
          const burgerSelects = document.querySelectorAll('.combo-burger-select');
          let allBurgersSelected = true;
          
          burgerSelects.forEach(select => {
            const productId = select.value;
            if (!productId) {
              allBurgersSelected = false;
              return;
            }
            const productName = select.querySelector(`option[value="${select.value}"]`).textContent.split(' (')[0];
            customization.hamburguesas.push({ productId, productName });
          });
          
          if (!allBurgersSelected) {
            alert('Por favor selecciona todas las hamburguesas del combo');
            return;
          }
        }

        // Fries
        if (config.papas) {
          const friesType = document.getElementById('combo-fries-type')?.value;
          if (!friesType) {
            alert('Por favor selecciona el tipo de papas');
            return;
          }
          customization.papas = { tipo: friesType, tama√±o: config.papas.tama√±o };
        }

        // Rings
        if (config.aros) {
          customization.aros = { tama√±o: config.aros.tama√±o };
        }

        // Hotdogs
        if (config.hotdogs) {
          customization.hotdogs = [];
          const hotdogSelects = document.querySelectorAll('.combo-hotdog-select');
          let allHotdogsSelected = true;
          
          hotdogSelects.forEach(select => {
            const productId = select.value;
            if (!productId) {
              allHotdogsSelected = false;
              return;
            }
            const productName = select.querySelector(`option[value="${select.value}"]`).textContent.split(' (')[0];
            customization.hotdogs.push({ productId, productName });
          });
          
          if (!allHotdogsSelected) {
            alert('Por favor selecciona todos los hotdogs del combo');
            return;
          }
        }

        // Complementos
        if (config.complementos) {
          customization.complementos = [];
          const complementSelects = document.querySelectorAll('.combo-complement-select');
          let allComplementsSelected = true;
          
          complementSelects.forEach(select => {
            const productId = select.value;
            if (!productId) {
              allComplementsSelected = false;
              return;
            }
            const productName = select.querySelector(`option[value="${select.value}"]`)?.textContent.split(' (')[0];
            customization.complementos.push({ productId, productName });
          });
          
          if (!allComplementsSelected) {
            alert('Por favor selecciona todos los complementos del combo');
            return;
          }
        }

        // Bebidas
        if (config.bebidas) {
          customization.bebidas = [];
          const drinkSelects = document.querySelectorAll('.combo-drink-select');
          let allDrinksSelected = true;
          
          drinkSelects.forEach(select => {
            const productId = select.value;
            if (!productId) {
              allDrinksSelected = false;
              return;
            }
            const productName = select.querySelector(`option[value="${select.value}"]`)?.textContent.split(' (')[0];
            customization.bebidas.push({ productId, productName });
          });
          
          if (!allDrinksSelected) {
            alert('Por favor selecciona todas las bebidas del combo');
            return;
          }
        }

        const totalPrice = parseFloat(document.getElementById('combo-total').textContent.replace(/[$,]/g, ''));

        // Calcular costo de producci√≥n del combo
        let costoproduccion = 0;
        
        // Sumar costos de hamburguesas
        if (customization.hamburguesas) {
          customization.hamburguesas.forEach(burger => {
            const prod = getVisibleProducts().find(pr => pr.id === burger.productId);
            costoproduccion += (prod?.costo || 0);
          });
        }
        
        // Sumar costos de hotdogs
        if (customization.hotdogs) {
          customization.hotdogs.forEach(hotdog => {
            const prod = getVisibleProducts().find(pr => pr.id === hotdog.productId);
            costoproduccion += (prod?.costo || 0);
          });
        }
        
        // Sumar costos de complementos
        if (customization.complementos) {
          customization.complementos.forEach(comp => {
            const prod = getVisibleProducts().find(pr => pr.id === comp.productId);
            costoproduccion += (prod?.costo || 0);
          });
        }
        
        // Sumar costos de bebidas
        if (customization.bebidas) {
          customization.bebidas.forEach(beb => {
            const prod = getVisibleProducts().find(pr => pr.id === beb.productId);
            costoproduccion += (prod?.costo || 0);
          });
        }

        // Sumar costos de categor√≠as din√°micas
        if (customization.categorias && customization.categorias.length > 0) {
          customization.categorias.forEach(cat => {
            (cat.items || []).forEach(it => {
              const prod = getVisibleProducts().find(pr => pr.id === it.productId);
              costoproduccion += (prod?.costo || 0);
            });
          });
        }

        console.log('üçΩÔ∏è [COMBO DEBUG] Combo customization:', customization);
        console.log('üçΩÔ∏è [COMBO DEBUG] Total price:', totalPrice);
        console.log('üçΩÔ∏è [COMBO DEBUG] Costo producci√≥n:', costoproduccion);

        // Add to order
        const existingIndex = currentOrder.items.findIndex(item => 
          item.productoId === p.id && 
          JSON.stringify(item.customization) === JSON.stringify(customization)
        );

        if (existingIndex >= 0) {
          currentOrder.items[existingIndex].cantidad += 1;
        } else {
          const newItem = {
            lineId: generateId('it'),
            productoId: p.id,
            nombre: p.nombre,
            precio: totalPrice,
            costo: costoproduccion,
            cantidad: 1,
            customization,
            modifiers: [] // Combos use customization instead of modifiers
          };
          console.log('üçΩÔ∏è [COMBO DEBUG] Adding item to order:', newItem);
          currentOrder.items.push(newItem);
        }

        closeModal();
        updateOrderUI();
      });

      updateComboTotals();
    }

    function openRegularProductModal(p) {
      const backdrop = $('#modal-backdrop');
      const container = $('#modal-container');
      
      const html = `
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl overflow-hidden">
          <div class="modal-header-nice">
            <h3 class="text-lg font-extrabold">Personalizar: ${p.nombre}</h3>
          </div>
          <div class="p-6 space-y-5">
            <div class="summary-row">
              <div class="font-bold text-lg">Precio base</div>
              <div class="price-chip text-xl">${fmt(p.precio)}</div>
            </div>
            <div class="summary-row">
              <div class="font-bold text-lg">Extras</div>
              <div id="mod-extra-sum" class="price-chip text-xl">$0.00</div>
            </div>
            <div class="summary-row border-t-2 pt-3">
              <div class="text-2xl font-extrabold">Total</div>
              <div id="mod-total" class="text-2xl font-extrabold text-green-600">${fmt(p.precio)}</div>
            </div>
            
            <!-- Opci√≥n de Papas -->
            <div class="border-2 rounded-xl p-4 bg-gray-50">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                  <input type="checkbox" id="papas-checkbox" class="w-5 h-5 cursor-pointer">
                  <label for="papas-checkbox" class="font-bold text-lg cursor-pointer">üçü Agregar Papas Complemento</label>
                </div>
                <div class="price-chip text-lg font-bold">+$20.00</div>
              </div>
              
              <!-- Selector de tipo de papas (oculto por defecto) -->
              <div id="papas-tipo-selector" class="hidden mt-3 space-y-2">
                <label class="block text-sm font-bold mb-2">Selecciona el tipo:</label>
                <div class="grid grid-cols-2 gap-3">
                  <button type="button" class="papas-tipo-btn border-2 rounded-lg p-3 font-bold hover:bg-blue-50 transition" data-tipo="francesas">
                    üçü Francesas
                  </button>
                  <button type="button" class="papas-tipo-btn border-2 rounded-lg p-3 font-bold hover:bg-blue-50 transition" data-tipo="gajo">
                    ü•î Gajo
                  </button>
                </div>
                <div id="papas-tipo-selected" class="text-sm text-green-600 font-bold mt-2 hidden"></div>
              </div>
            </div>
            
            <div class="flex gap-3 pt-3">
              <button id="mod-add" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-lg flex-1 font-bold text-lg transition">Agregar a la orden</button>
              <button id="mod-cancel" class="bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-3 rounded-lg font-bold transition">Cancelar</button>
            </div>
          </div>
        </div>`;
      container.innerHTML = html;
      backdrop.classList.remove('hidden');
      backdrop.style.display = '';
      container.classList.remove('hidden');
      // Prevent background scroll on mobile
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';

      let papasSelected = false;
      let papasTipo = '';
      
      const papasCheckbox = $('#papas-checkbox');
      const papasTipoSelector = $('#papas-tipo-selector');
      const papasTipoButtons = document.querySelectorAll('.papas-tipo-btn');
      const papasTipoSelectedText = $('#papas-tipo-selected');
      
      // Toggle selector de tipo cuando se marca/desmarca el checkbox
      papasCheckbox?.addEventListener('change', (e) => {
        papasSelected = e.target.checked;
        if (papasSelected) {
          papasTipoSelector.classList.remove('hidden');
        } else {
          papasTipoSelector.classList.add('hidden');
          papasTipo = '';
          papasTipoButtons.forEach(btn => btn.classList.remove('bg-blue-500', 'text-white', 'border-blue-500'));
          papasTipoSelectedText.classList.add('hidden');
        }
        updateTotals();
      });
      
      // Seleccionar tipo de papas
      papasTipoButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const tipo = btn.getAttribute('data-tipo');
          papasTipo = tipo;
          
          // Actualizar estilos de botones
          papasTipoButtons.forEach(b => {
            b.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
          });
          btn.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
          
          // Mostrar selecci√≥n
          papasTipoSelectedText.textContent = `‚úì Seleccionado: ${tipo === 'francesas' ? 'Papas Francesas' : 'Papas Gajo'}`;
          papasTipoSelectedText.classList.remove('hidden');
        });
      });

      function updateTotals(){
        const extraCost = papasSelected ? 20 : 0;
        $('#mod-extra-sum').textContent = fmt(extraCost);
        $('#mod-total').textContent = fmt((Number(p.precio)||0) + extraCost);
      }
      
      updateTotals();

      $('#mod-cancel')?.addEventListener('click', closeModal);
      $('#mod-add')?.addEventListener('click', ()=>{
        // Validar que si hay papas seleccionadas, tambi√©n haya tipo
        if (papasSelected && !papasTipo) {
          alert('Por favor selecciona el tipo de papas (Francesas o Gajo)');
          return;
        }
        
        // 1. Agregar el producto principal (hamburguesa/hotdog)
        const existing = currentOrder.items.find(i=> i.productoId===p.id && !i.modifiers?.length);
        if(existing){ 
          existing.cantidad += 1; 
        } else {
          currentOrder.items.push({ 
            lineId: generateId('it'), 
            productoId: p.id, 
            nombre: p.nombre, 
            precio: Number(p.precio)||0, 
            costo: Number(p.costo)||0,
            cantidad: 1, 
            modifiers: []
          });
        }
        
        // 2. Si hay papas seleccionadas, agregar el producto complemento correspondiente
        if (papasSelected && papasTipo) {
          const papasNombre = papasTipo === 'francesas' ? 'PAPAS FRANCESAS complemento' : 'PAPAS GAJO complemento';
          
          // Buscar el producto de papas complemento en la lista
          const papasProducto = appState.productos.find(prod => {
            const normNombre = (prod.nombre || '').toUpperCase().trim();
            return normNombre === papasNombre.toUpperCase();
          });
          
          if (papasProducto) {
            // Verificar si ya existe en la orden
            const existingPapas = currentOrder.items.find(i => i.productoId === papasProducto.id);
            if (existingPapas) {
              existingPapas.cantidad += 1;
            } else {
              currentOrder.items.push({
                lineId: generateId('it'),
                productoId: papasProducto.id,
                nombre: papasProducto.nombre,
                precio: Number(papasProducto.precio) || 20,
                costo: Number(papasProducto.costo) || 0,
                cantidad: 1,
                modifiers: []
              });
            }
          } else {
            console.warn(`No se encontr√≥ el producto: ${papasNombre}`);
          }
        }
        
        closeModal();
        updateOrderUI();
      });
    }

    function changeQty(lineId, delta){
      const it = currentOrder.items.find(i=>i.lineId===lineId);
      if(!it) return;
      it.cantidad += delta;
      if(it.cantidad<=0){ currentOrder.items = currentOrder.items.filter(i=>i.lineId!==lineId); }
      updateOrderUI();
    }
    function removeFromOrder(lineId){
      currentOrder.items = currentOrder.items.filter(i=>i.lineId!==lineId);
      updateOrderUI();
    }

    function updateOrderUI(){
      const box = document.getElementById('pos-order-items');
      const btn = document.getElementById('pos-pay-btn') || document.getElementById('process-sale-btn');
      if(!box) return;
      box.innerHTML='';
      if(currentOrder.items.length===0){
        box.innerHTML = '<div class="text-center py-6 text-sm opacity-70">A√±ade productos para empezar</div>';
        if(btn) btn.disabled = true;
      } else {
        currentOrder.items.forEach(it=>{
          const row = document.createElement('div');
          // Wrap when narrow so controls never get cut off
          row.className = 'flex flex-wrap items-start justify-between gap-2 border-b py-1.5';
          const unit = getItemUnitPrice(it);
          
          let detailsText = '';
          
          // Handle combo customization details
          if (it.customization && it.customization.type === 'combo') {
            const details = [];
            const custom = it.customization;
            
            if (custom.hamburguesas) {
              const burgerNames = custom.hamburguesas.map(b => b.productName).join(', ');
              details.push(`üçî ${burgerNames}`);
            }
            
            if (custom.papas) {
              details.push(`üçü Papas ${custom.papas.tipo} ${custom.papas.tama√±o}`);
            }
            
            if (custom.aros) {
              details.push(`üç∞ Aros ${custom.aros.tama√±o}`);
            }
            
            if (custom.hotdogs) {
              const hotdogNames = custom.hotdogs.map(h => h.productName).join(', ');
              details.push(`üå≠ ${hotdogNames}`);
            }
            
            if (custom.complementos && custom.complementos.length > 0) {
              const complementNames = custom.complementos.map(c => {
                const qtyText = c.cantidad > 1 ? `${c.cantidad}x ` : '';
                return `${qtyText}${c.productName}`;
              }).join(', ');
              details.push(`‚ûï ${complementNames}`);
            }
            
            detailsText = details.join(' ‚Ä¢ ');
          } else {
            // Handle regular product modifiers
            const modsText = (it.modifiers && it.modifiers.length>0) ? it.modifiers.map(m=> `${m.name}${m.price?` (+${fmt(m.price)})`:''}`).join(', ') : '';
            detailsText = modsText;
          }
          
          row.innerHTML = `
            <div class="min-w-0 flex-1">
              <div class="font-bold">${it.nombre} ${it.customization?.type === 'combo' ? '<span class="combo-badge text-xs">üçΩÔ∏è COMBO</span>' : ''}</div>
              ${detailsText? `<div class="text-xs opacity-70">${detailsText}</div>`:''}
              <div class="text-xs opacity-70">${fmt(unit)} c/u</div>
            </div>
            <div class="flex items-center gap-1 shrink-0">
              <button class="icon-btn btn-minus" title="Menos">‚àí</button>
              <span class="w-8 text-center font-bold">${it.cantidad}</span>
              <button class="icon-btn btn-plus" title="M√°s">+</button>
              <button class="icon-btn btn-remove" title="Quitar">√ó</button>
            </div>
          `;
          const btnMinus = row.querySelector('.btn-minus');
          const btnPlus = row.querySelector('.btn-plus');
          const btnRemove = row.querySelector('.btn-remove');
          if(btnMinus) btnMinus.addEventListener('click', ()=> changeQty(it.lineId,-1));
          if(btnPlus) btnPlus.addEventListener('click', ()=> changeQty(it.lineId, 1));
          if(btnRemove) btnRemove.addEventListener('click', ()=> removeFromOrder(it.lineId));
          box.appendChild(row);
        });
  if(btn) btn.disabled = false;
      }
      updateOrderTotals();
    }

    function getItemUnitPrice(it){
      const base = Number(it.precio)||0;
      const mods = Array.isArray(it.modifiers)? it.modifiers.reduce((a,m)=> a + (Number(m.price)||0), 0) : 0;
      return base + mods;
    }
    function updateOrderTotals(){
      const subtotal = currentOrder.items.reduce((s,i)=> s + getItemUnitPrice(i)*i.cantidad, 0);
      const discount = parseFloat(document.getElementById('pos-discount-input')?.value||'0')||0;
      const shippingEnabled = document.getElementById('pos-shipping-checkbox')?.checked;
      const shipping = shippingEnabled ? (parseFloat(document.getElementById('pos-shipping-cost')?.value||'0')||0) : 0;
      currentOrder.subtotal = subtotal;
      currentOrder.descuento = discount;
      currentOrder.costoEnvio = shipping;
      currentOrder.total = Math.max(0, subtotal - discount + shipping);
      const subtotalEl = document.getElementById('pos-subtotal');
      const totalEl = document.getElementById('pos-total');
      if(subtotalEl) subtotalEl.textContent = fmt(subtotal);
  if(totalEl) totalEl.textContent = fmt(currentOrder.total);
  // Persistir orden de mesa si aplica
  try{ saveCurrentOrderToMesa(); }catch(_){ }
    }

    // --- Mesas (POS local) ---
    function getMesaById(id){ return (appState.mesas||[]).find(m=>m.id===id); }
    function nextMesaName(){
      const base = 'Mesa ';
      const nums = (appState.mesas||[]).map(m=>{
        const n = (m.nombre||'').toLowerCase().startsWith('mesa ')? Number((m.nombre||'').slice(5)) : NaN;
        return isNaN(n)? 0 : n;
      });
      const max = nums.length? Math.max(...nums) : 0;
      return base + (max+1);
    }
    function renderMesaSelector(){
      const sel = document.getElementById('pos-table-select');
      if(!sel) return;
      const mesas = (appState.mesas||[]);
      const options = ['<option value="">‚Äî Selecciona mesa ‚Äî</option>']
        .concat(mesas.map(m=>{
          const ord = appState.mesaOrders?.[m.id];
          const cnt = ord && Array.isArray(ord.items)? ord.items.reduce((a,i)=>a+Number(i.cantidad||0),0) : 0;
          const label = cnt>0? `${m.nombre} (${cnt})` : m.nombre;
          return `<option value="${m.id}">${label}</option>`;
        }));
      sel.innerHTML = options.join('');
      if(currentOrder.mesaId){ sel.value = currentOrder.mesaId; }
    }
    function toggleMesaUIByType(){
      const row = document.getElementById('pos-table-row');
      if(!row) return;
      if(currentOrder.tipo==='local') row.classList.remove('hidden'); else row.classList.add('hidden');
    }
    function saveCurrentOrderToMesa(){
      if(currentOrder.tipo!=='local' || !currentOrder.mesaId) return;
      // Guardar una copia ligera sin ciclos
      const snap = {
        mesaId: currentOrder.mesaId,
        items: JSON.parse(JSON.stringify(currentOrder.items||[])),
        subtotal: currentOrder.subtotal||0,
        descuento: currentOrder.descuento||0,
        costoEnvio: currentOrder.costoEnvio||0,
        total: currentOrder.total||0,
        tipo: 'local',
        updatedAt: new Date().toISOString()
      };
      appState.mesaOrders[currentOrder.mesaId] = snap;
      saveLS();
      renderMesaSelector();
    }
    function loadOrderFromMesa(mesaId){
      currentOrder.tipo = 'local';
      currentOrder.mesaId = mesaId||null;
  try{ const typeSel = document.getElementById('pos-order-type'); if(typeSel) typeSel.value='local'; }catch(_){ }
      const stored = mesaId? appState.mesaOrders?.[mesaId] : null;
      if(stored){
        currentOrder.items = JSON.parse(JSON.stringify(stored.items||[]));
        currentOrder.subtotal = Number(stored.subtotal)||0;
        currentOrder.descuento = Number(stored.descuento)||0;
        currentOrder.costoEnvio = Number(stored.costoEnvio)||0;
        currentOrder.total = Number(stored.total)||0;
      } else {
        currentOrder.items = [];
        currentOrder.subtotal = 0;
        currentOrder.descuento = 0;
        currentOrder.costoEnvio = 0;
        currentOrder.total = 0;
      }
      updateOrderUI();
    }

    function wirePosInputs(){
      document.getElementById('pos-discount-input')?.addEventListener('input', updateOrderTotals);
      document.getElementById('pos-search-input')?.addEventListener('input', renderPosProductList);
      // Categor√≠as
      document.getElementById('pos-category-buttons')?.addEventListener('click', (e)=>{
        const btn = e.target.closest('.pos-cat-btn');
        if(!btn) return;
        posCategoryFilter = btn.getAttribute('data-pos-cat')||'all';
        renderPosProductList();
      });
      document.getElementById('pos-order-type')?.addEventListener('change', (e)=>{
        currentOrder.tipo = e.target.value;
        const shipChk = document.getElementById('pos-shipping-checkbox');
        const shipCost = document.getElementById('pos-shipping-cost');
        if(currentOrder.tipo==='envio'){
          shipChk?.removeAttribute('disabled');
        } else {
          if(shipChk){ shipChk.checked=false; }
          shipCost?.classList.add('hidden');
          shipCost && (shipCost.value='');
          updateOrderTotals();
        }
        toggleMesaUIByType();
        // Al salir de 'local' guarda el estado de la mesa y desconecta la selecci√≥n
        if(currentOrder.tipo!=='local'){
          if(currentOrder.mesaId) saveCurrentOrderToMesa();
          currentOrder.mesaId = null;
        }
      });
      // Mesas: crear y seleccionar
      document.getElementById('pos-new-table')?.addEventListener('click', ()=>{
        const defName = nextMesaName();
        let nombre = prompt('Nombre de la mesa:', defName);
        if(nombre===null) return;
        nombre = (nombre||'').toString().trim();
        if(!nombre) nombre = defName;
        const mesa = { id: generateId('mesa'), nombre };
        appState.mesas.push(mesa);
        saveLS();
        renderMesaSelector();
        const sel = document.getElementById('pos-table-select');
        if(sel){ sel.value = mesa.id; }
        loadOrderFromMesa(mesa.id);
      });
      document.getElementById('pos-table-select')?.addEventListener('change', (e)=>{
        const nextId = e.target.value || null;
        // Guardar la mesa actual antes de cambiar
        if(currentOrder.mesaId) saveCurrentOrderToMesa();
        if(nextId){ loadOrderFromMesa(nextId); } else { currentOrder.mesaId=null; updateOrderUI(); }
      });
      document.querySelectorAll('[data-discount-pct]')?.forEach(btn=> btn.addEventListener('click', ()=>{
        const pct = Number(btn.getAttribute('data-discount-pct'))||0;
        const calc = Math.round((currentOrder.subtotal * pct)/100*100)/100;
        const input = document.getElementById('pos-discount-input'); if(input){ input.value = String(calc); }
        updateOrderTotals();
      }));
      const shipChk = document.getElementById('pos-shipping-checkbox');
      const shipCost = document.getElementById('pos-shipping-cost');
      shipChk?.addEventListener('change', ()=>{
        if(shipChk.checked){ shipCost.classList.remove('hidden'); }
        else { shipCost.classList.add('hidden'); shipCost.value=''; }
        updateOrderTotals();
      });
      shipCost?.addEventListener('input', updateOrderTotals);
      document.getElementById('process-sale-btn')?.addEventListener('click', openPayModal);
      document.getElementById('pos-pay-btn')?.addEventListener('click', openPayModal);
      document.getElementById('pos-clear-btn')?.addEventListener('click', ()=>{ currentOrder.items=[]; updateOrderUI(); saveCurrentOrderToMesa(); });
      document.getElementById('pos-suspend-btn')?.addEventListener('click', ()=>{
        if(currentOrder.items.length===0){ alert('No hay productos en la orden'); return; }
        const copy = JSON.parse(JSON.stringify(currentOrder));
        copy.id = generateId('susp');
        suspendedOrders.push(copy);
  if(typeof savePedidoToFirestore==='function') savePedidoToFirestore({ id: copy.id, ventaId: null, clienteId: copy.clienteId||null, estado:'pendiente', fecha: new Date().toISOString() });
        currentOrder = { items: [], clienteId: null, subtotal: 0, total: 0, descuento: 0, costoEnvio: 0, tipo:'local', mesaId: null, pago:null };
        updateOrderUI();
        alert('Orden suspendida');
      });
      document.getElementById('pos-suspended-list-btn')?.addEventListener('click', ()=>{
        if(suspendedOrders.length===0){ alert('No hay √≥rdenes guardadas'); return; }
        const options = suspendedOrders.map((o,idx)=> `${idx+1}. ${o.items.length} items - ${fmt(o.total)}`).join('\n');
        const pick = prompt(`√ìrdenes guardadas:\n${options}\nIngresa n√∫mero para reanudar:`);
        const i = (Number(pick)||0)-1; if(i<0 || i>=suspendedOrders.length) return;
        currentOrder = suspendedOrders.splice(i,1)[0];
        updateOrderUI();
      });
      document.getElementById('pos-add-customer')?.addEventListener('click', openClienteModal);
      // Inicializar UI de mesas
      renderMesaSelector();
      toggleMesaUIByType();
    }

    function openPayModal(){
      if(currentOrder.items.length===0){ alert('No hay productos en la orden'); return; }
      openFormModal({
        title:'Cobrar',
        fields:[
          {name:'metodo', label:'M√©todo de pago', type:'select', value:'Efectivo', options:[
            { label:'Efectivo', value:'Efectivo' },
            { label:'Transferencia', value:'Transferencia' },
            { label:'Tarjeta', value:'Tarjeta' }
          ]},
          {name:'referencia', label:'Referencia (opcional)', type:'text', placeholder:'Folio/√∫ltimos 4/etc'}
        ],
        submitText:'Confirmar cobro',
        onSubmit:(data)=>{
          currentOrder.pago = { metodo: (data.metodo||'').trim()||'Efectivo', referencia: (data.referencia||'').trim() };
          processSale();
        }
      });
    }

    function processSale(){
      if(__processingSale) return;
      __processingSale = true;
      try{
        if(currentOrder.items.length===0){ alert('No hay productos en la orden'); return; }
        // Deshabilitar bot√≥n de cobro para evitar doble env√≠o
        try{ const btn = document.getElementById('pos-pay-btn'); if(btn) btn.disabled = true; }catch(_){ }
        const sel = document.getElementById('pos-customer-select');
        const clienteId = sel && sel.value ? sel.value : null;
      // Asignar n√∫mero de venta secuencial
      if(typeof appState.nextSaleNumber !== 'number' || appState.nextSaleNumber < 1){ appState.nextSaleNumber = 1; }
      const saleNumber = appState.nextSaleNumber++;
    const mesaId = currentOrder.mesaId || null;
    const mesaName = mesaId ? (getMesaById(mesaId)?.nombre || '') : '';
      const venta = {
        id: generateId('sale'),
        fecha: new Date().toISOString(),
        clienteId,
  tipo: currentOrder.tipo,
  pago: currentOrder.pago,
  mesaId,
  mesaName,
        saleNumber,
        items: JSON.parse(JSON.stringify(currentOrder.items)),
        subtotal: currentOrder.subtotal,
        descuento: currentOrder.descuento,
        costoEnvio: currentOrder.costoEnvio,
        total: currentOrder.total
      };
      appState.ventas.push(venta);
  if(typeof saveVentaToFirestore==='function') try{ saveVentaToFirestore(venta); }catch(_){ }
  // insumos consumidos por esta venta
  accumulateInsumosFromVenta(venta);
  renderInventario();
      // puntos del cliente
      if(clienteId){
        const c = appState.clientes.find(x=>x.id===clienteId);
        if(c){
          c.gastoTotal = (c.gastoTotal||0) + currentOrder.total;
          // 1 punto por cada $10 gastados
          c.puntos = (c.puntos||0) + Math.floor(currentOrder.total / 10);
        }
      }
      // A√±adir a pendientes (cola simple)
  const pedido = { id: generateId('ord'), ventaId: venta.id, clienteId, estado:'pendiente', fecha: venta.fecha, mesaId, mesaName };
  appState.pedidosPendientes.push(pedido);
  if(typeof savePedidoToFirestore==='function') savePedidoToFirestore(pedido);
  // limpiar orden y restablecer valores por defecto
  // Si es mesa local, limpiar esa cuenta y mantener mesa seleccionada
  if(mesaId){ delete appState.mesaOrders[mesaId]; saveLS(); }
  currentOrder = { items: [], clienteId: null, subtotal: 0, total: 0, descuento: 0, costoEnvio: 0, tipo:'local', mesaId: mesaId||null, pago:null };
      document.getElementById('pos-discount-input').value = '';
      const scb = document.getElementById('pos-shipping-checkbox');
      const sc = document.getElementById('pos-shipping-cost');
      if(scb){ scb.checked = false; }
      if(sc){ sc.value=''; sc.classList.add('hidden'); }
  const typeSel = document.getElementById('pos-order-type');
  if(typeSel){ typeSel.value = 'local'; }
  // refrescar panel de orden
  try{ updateOrderUI(); }catch(_){ }
      if(sel) sel.value = '';
  if(typeof saveInsumosToFirestore==='function') saveInsumosToFirestore();
  if(typeof saveMetaToFirestore==='function') saveMetaToFirestore();
  saveLS(); renderAll(); renderPosProductList(); renderPedidosPendientes();
        alert('Venta procesada correctamente');
      } finally {
        __processingSale = false;
        try{ const btn = document.getElementById('pos-pay-btn'); if(btn) btn.disabled = false; }catch(_){ }
      }
    }

    // Helper function to generate combo breakdown for display
    function generateComboBreakdown(customization, format = 'html') {
      if (!customization || customization.type !== 'combo') {
        return format === 'html' ? '' : [];
      }

      let breakdown = [];
      
      // Show hamburgers breakdown
      if (customization.hamburguesas && customization.hamburguesas.length > 0) {
        breakdown.push(format === 'html' ? 'üçî HAMBURGUESAS:' : 'üçî Hamburguesas:');
        customization.hamburguesas.forEach((burger, index) => {
          const producto = (appState.productos || []).find(p => p.id === burger.productId);
          const precio = producto?.precio || 0;
          const costo = producto?.costo || 0;
          const ganancia = precio - costo;
          
          if (format === 'html') {
            const item = `‚Ä¢ ${burger.productName || 'Hamburguesa'} - <span style="color: #16a34a; font-weight: 700;">Venta: $${precio.toFixed(2)}</span> | <span style="color: #dc2626; font-weight: 700;">Costo: $${costo.toFixed(2)}</span> | <span style="color: #2563eb; font-weight: 700;">Ganancia: $${ganancia.toFixed(2)}</span>`;
            breakdown.push(item);
          } else {
            breakdown.push(`  ‚Ä¢ ${burger.productName || 'Hamburguesa'} (Venta: $${precio.toFixed(2)} | Costo: $${costo.toFixed(2)} | Ganancia: $${ganancia.toFixed(2)})`);
          }
        });
        if (format === 'html') breakdown.push('');
      }
      
      // Show fries breakdown
      if (customization.papas) {
        breakdown.push(format === 'html' ? 'üçü PAPAS:' : 'üçü Papas:');
        const friesType = customization.papas.tipo || 'Papas';
        const friesSize = customization.papas.tama√±o || '';
        const item = `‚Ä¢ ${friesType} ${friesSize}`;
        breakdown.push(format === 'html' ? item : `  ${item}`);
        if (format === 'html') breakdown.push('');
      }
      
      // Show rings breakdown
      if (customization.aros) {
        breakdown.push(format === 'html' ? 'üî∫ AROS:' : 'üî∫ Aros:');
        const ringsSize = customization.aros.tama√±o || '';
        const item = `‚Ä¢ Aros de cebolla ${ringsSize}`;
        breakdown.push(format === 'html' ? item : `  ${item}`);
        if (format === 'html') breakdown.push('');
      }
      
      // Show hotdogs breakdown
      if (customization.hotdogs && customization.hotdogs.length > 0) {
        breakdown.push(format === 'html' ? 'üå≠ HOTDOGS:' : 'üå≠ Hotdogs:');
        customization.hotdogs.forEach((hotdog, index) => {
          const producto = (appState.productos || []).find(p => p.id === hotdog.productId);
          const precio = producto?.precio || 0;
          const costo = producto?.costo || 0;
          const ganancia = precio - costo;
          
          if (format === 'html') {
            const item = `‚Ä¢ ${hotdog.productName || 'Hotdog'} - <span style="color: #16a34a; font-weight: 700;">Venta: $${precio.toFixed(2)}</span> | <span style="color: #dc2626; font-weight: 700;">Costo: $${costo.toFixed(2)}</span> | <span style="color: #2563eb; font-weight: 700;">Ganancia: $${ganancia.toFixed(2)}</span>`;
            breakdown.push(item);
          } else {
            breakdown.push(`  ‚Ä¢ ${hotdog.productName || 'Hotdog'} (Venta: $${precio.toFixed(2)} | Costo: $${costo.toFixed(2)} | Ganancia: $${ganancia.toFixed(2)})`);
          }
        });
        if (format === 'html') breakdown.push('');
      }
      
      // Show complements breakdown
      if (customization.complementos && customization.complementos.length > 0) {
        breakdown.push(format === 'html' ? 'ü•§ COMPLEMENTOS:' : 'ü•§ Complementos:');
        customization.complementos.forEach((comp) => {
          const producto = (appState.productos || []).find(p => p.id === comp.productId);
          const precio = producto?.precio || 0;
          const costo = producto?.costo || 0;
          const ganancia = precio - costo;
          const cantidad = comp.cantidad > 1 ? `${comp.cantidad}√ó ` : '';
          
          if (format === 'html') {
            const item = `‚Ä¢ ${cantidad}${comp.productName || 'Complemento'} - <span style="color: #16a34a; font-weight: 700;">Venta: $${precio.toFixed(2)}</span> | <span style="color: #dc2626; font-weight: 700;">Costo: $${costo.toFixed(2)}</span> | <span style="color: #2563eb; font-weight: 700;">Ganancia: $${ganancia.toFixed(2)}</span>`;
            breakdown.push(item);
          } else {
            breakdown.push(`  ‚Ä¢ ${cantidad}${comp.productName || 'Complemento'} (Venta: $${precio.toFixed(2)} | Costo: $${costo.toFixed(2)} | Ganancia: $${ganancia.toFixed(2)})`);
          }
        });
        if (format === 'html') breakdown.push('');
      }
      
      // Show drinks breakdown
      if (customization.bebidas && customization.bebidas.length > 0) {
        breakdown.push(format === 'html' ? 'ü•§ BEBIDAS:' : 'ü•§ Bebidas:');
        customization.bebidas.forEach((beb) => {
          const producto = (appState.productos || []).find(p => p.id === beb.productId);
          const precio = producto?.precio || 0;
          const costo = producto?.costo || 0;
          const ganancia = precio - costo;
          
          if (format === 'html') {
            const item = `‚Ä¢ ${beb.productName || 'Bebida'} - <span style="color: #16a34a; font-weight: 700;">Venta: $${precio.toFixed(2)}</span> | <span style="color: #dc2626; font-weight: 700;">Costo: $${costo.toFixed(2)}</span> | <span style="color: #2563eb; font-weight: 700;">Ganancia: $${ganancia.toFixed(2)}</span>`;
            breakdown.push(item);
          } else {
            breakdown.push(`  ‚Ä¢ ${beb.productName || 'Bebida'} (Venta: $${precio.toFixed(2)} | Costo: $${costo.toFixed(2)} | Ganancia: $${ganancia.toFixed(2)})`);
          }
        });
        if (format === 'html') breakdown.push('');
      }

      // Show dynamic categories breakdown
      if (customization.categorias && customization.categorias.length > 0) {
        breakdown.push(format === 'html' ? 'üì¶ CATEGOR√çAS:' : 'üì¶ Categor√≠as:');
        customization.categorias.forEach(cat => {
          const categoria = (cat.categoria || 'Categor√≠a').toString();
          const items = Array.isArray(cat.items) ? cat.items : [];
          if (items.length === 0) {
            const item = `‚Ä¢ ${categoria}: (sin selecci√≥n)`;
            breakdown.push(format === 'html' ? item : `  ${item}`);
            return;
          }
          items.forEach(it => {
            const producto = (appState.productos || []).find(p => p.id === it.productId);
            const precio = producto?.precio || 0;
            const costo = producto?.costo || 0;
            const ganancia = precio - costo;
            const name = it.productName || producto?.nombre || 'Producto';
            if (format === 'html') {
              const line = `‚Ä¢ ${categoria}: ${name} - <span style="color: #16a34a; font-weight: 700;">Venta: $${precio.toFixed(2)}</span> | <span style="color: #dc2626; font-weight: 700;">Costo: $${costo.toFixed(2)}</span> | <span style="color: #2563eb; font-weight: 700;">Ganancia: $${ganancia.toFixed(2)}</span>`;
              breakdown.push(line);
            } else {
              breakdown.push(`  ‚Ä¢ ${categoria}: ${name} (Venta: $${precio.toFixed(2)} | Costo: $${costo.toFixed(2)} | Ganancia: $${ganancia.toFixed(2)})`);
            }
          });
        });
        if (format === 'html') breakdown.push('');
      }
      
      return format === 'html' ? breakdown.join('\n') : breakdown;
    }

    function renderPedidosPendientes(){
      console.log('üöÄ [DEBUG] Iniciando renderPedidosPendientes...');
      const cont = document.getElementById('pedidos-pendientes-container');
      const countEl = document.getElementById('pedidos-count');
      const noMsg = document.getElementById('no-pedidos-message');
      if(!cont) return;
      cont.innerHTML='';
      const list = (appState.pedidosPendientes||[]).slice().sort((a,b)=> new Date(a.fecha) - new Date(b.fecha));
      console.log('üìã [DEBUG] Pedidos pendientes:', list.length);
      countEl && (countEl.textContent = String(list.length));
      if(list.length===0){ noMsg?.classList.remove('hidden'); return; }
      noMsg?.classList.add('hidden');
      list.forEach(p=>{
        console.log('üéØ [DEBUG] Procesando pedido:', p);
        const cli = (appState.clientes||[]).find(c=>c.id===p.clienteId);
        const venta = (appState.ventas||[]).find(v=> v.id===p.ventaId);
        console.log('üí∞ [DEBUG] Venta encontrada:', venta);
        const saleNum = typeof venta?.saleNumber==='number' ? `#${venta.saleNumber}` : `#${String(venta?.id||p.id).slice(0,6)}`;
        const when = new Date(p.fecha).toLocaleString();
        const tipo = (venta?.tipo||'local');
        const pagoStr = (venta?.pago?.metodo||'Efectivo');
        const items = Array.isArray(venta?.items) ? venta.items : [];
        console.log('üõí [DEBUG] Items de la venta:', items);
        // Build items markup
        const itemsHtml = items.map(it=>{
          const qty = Number(it.cantidad)||0;
          const name = (it.nombre||'Producto');
          
          console.log('üîç [KITCHEN CARD DEBUG] Item:', it.nombre);
          console.log('üîç [KITCHEN CARD DEBUG] Customization:', it.customization);
          
          // Check if it's a combo with customization
          if (it.customization && it.customization.type === 'combo') {
            console.log('‚úÖ [KITCHEN CARD] Es un combo, generando desglose...');
            const comboDetailsHtml = generateComboBreakdown(it.customization, 'html')
              .split('\n')
              .map(line => {
                if (line.includes('üçî') || line.includes('üçü') || line.includes('üî∫') || line.includes('üå≠') || line.includes('ü•§')) {
                  return `<div class="combo-breakdown-title">${line}</div>`;
                } else if (line.startsWith('‚Ä¢')) {
                  return `<div class="combo-breakdown-item">${line}</div>`;
                } else if (line.trim() === '') {
                  return '<div class="combo-breakdown-spacer"></div>';
                }
                return '';
              })
              .filter(line => line !== '')
              .join('');
            
            console.log('üé® [KITCHEN CARD] HTML generado:', comboDetailsHtml);
            
            return `<div class="kitchen-line combo-kitchen-line">
              <div class="top">
                <span class="qty-chip">${qty}√ó</span>
                <span class="font-extrabold combo-title" style="letter-spacing:.2px">üçΩÔ∏è ${name}</span>
              </div>
              <div class="combo-breakdown">${comboDetailsHtml}</div>
            </div>`;
          } else {
            console.log('‚ùå [KITCHEN CARD] No es un combo o no tiene customization');
            // Regular product or product with simple modifiers
            const mods = Array.isArray(it.modifiers) ? it.modifiers : [];
            const modsHtml = mods.length>0 ? `<div class="mods">${mods.map(m=> `<span class=\"mod-chip\">${(m.name||m.key||'Extra')}</span>`).join('')}</div>` : '';
            return `<div class=\"kitchen-line\"><div class=\"top\"><span class=\"qty-chip\">${qty}√ó</span><span class=\"font-extrabold\" style=\"letter-spacing:.2px\">${name}</span></div>${modsHtml}</div>`;
          }
        }).join('');

        const card = document.createElement('div');
        card.className = 'kitchen-card';
        card.innerHTML = `
          <h4>Pedido ${saleNum}</h4>
          <div class="text-xs opacity-70">${when}</div>
          <div class="kitchen-meta">
            <span class="badge badge-type">${tipo==='envio'?'Env√≠o': (tipo==='para_llevar'?'Para llevar':'Local')}</span>
            ${ (tipo==='local' && (venta?.mesaName || (appState.mesas||[]).some(m=>m.id===venta?.mesaId))) ? `<span class="badge">Mesa: ${venta?.mesaName || ((appState.mesas||[]).find(m=>m.id===venta?.mesaId)?.nombre||'')}</span>` : '' }
            <span class="badge badge-pay">Pago: ${pagoStr}</span>
            <span class="badge badge-customer">${cli? (cli.nombre || 'Cliente') : 'Cliente General'}</span>
          </div>
          <div class="kitchen-items">${itemsHtml || '<div class="text-sm opacity-70">Sin items</div>'}</div>
          <div class="card-actions">
            <button class="btn-success px-3 py-2 rounded text-sm flex-1">Listo</button>
            <button class="btn-danger px-3 py-2 rounded text-sm">Cancelar</button>
          </div>
        `;
        const [btnOk, btnCancel] = card.querySelectorAll('button');
        btnOk.addEventListener('click', ()=>{ appState.pedidosPendientes = appState.pedidosPendientes.filter(x=>x.id!==p.id); if(typeof deletePedidoFromFirestore==='function') deletePedidoFromFirestore(p.id); saveLS(); renderPedidosPendientes(); });
        btnCancel.addEventListener('click', ()=>{ appState.pedidosPendientes = appState.pedidosPendientes.filter(x=>x.id!==p.id); if(typeof deletePedidoFromFirestore==='function') deletePedidoFromFirestore(p.id); saveLS(); renderPedidosPendientes(); });
        cont.appendChild(card);
      });
    }

    // --- Helper: Crear/actualizar producto con receta por nombres de ingredientes ---
  function addOrUpdateProductWithRecipe({ nombre, precio, descripcion, receta }){
      try{
        if(!nombre || !Array.isArray(receta)) return;
    const byName = (n)=> (n||'').toString().trim().toLowerCase();
        // Mapear nombres de ingredientes a IDs
        const mappedReceta = [];
        for(const item of receta){
          const ing = (appState.ingredientes||[]).find(i=> byName(i.nombre) === byName(item.nombre));
          if(!ing){ console.warn('[RECIPE] Ingrediente no encontrado:', item.nombre); continue; }
          const cantidad = Number(item.cantidad)||0;
          if(cantidad<=0) continue;
          mappedReceta.push({ ingredienteId: ing.id, cantidad });
        }
        // Buscar producto existente por nombre
        // Preferir existente no archivado; si s√≥lo hay archivado, reutilizar y desarchivar
        const sameName = (appState.productos||[]).filter(p=> byName(p.nombre) === byName(nombre));
        const existing = sameName.find(p=> !p.archivado) || sameName[0];
        if(existing){
          if(existing.archivado){ existing.archivado=false; existing.archivedAt=undefined; }
          if(typeof precio === 'number' && !Number.isNaN(precio)) existing.precio = precio;
          if(descripcion!=null) existing.descripcion = descripcion;
          if(mappedReceta.length>0) existing.receta = mappedReceta;
          existing.costo = computeRecipeCost(existing.receta||[]);
          if(typeof saveProductToFirestore === 'function') saveProductToFirestore(existing);
        } else {
          const costo = computeRecipeCost(mappedReceta);
          const nuevo = { id: generateId('p'), nombre, precio: Number(precio)||0, descripcion: descripcion||'', receta: mappedReceta, costo };
          appState.productos.push(nuevo);
          if(typeof saveProductToFirestore === 'function') saveProductToFirestore(nuevo);
        }
        saveLS();
        renderAll();
        renderPosProductList();
      }catch(e){ console.error('addOrUpdateProductWithRecipe error', e); }
    }

    // Actualizar receta por nombre exacto (√∫til cuando hay productos con el mismo nombre en distinto case)
    function updateProductRecipeExact({ nombre, precio, descripcion, receta }){
      try{
        const exact = (appState.productos||[]).find(p=> (p.nombre||'') === nombre);
        const byName = (n)=> (n||'').toString().trim().toLowerCase();
        const mapReceta = (arr)=>{
          const out = [];
          (arr||[]).forEach(item=>{
            const ing = (appState.ingredientes||[]).find(i=> byName(i.nombre)===byName(item.nombre));
            if(!ing) return;
            const cantidad = Number(item.cantidad)||0; if(cantidad<=0) return;
            out.push({ ingredienteId: ing.id, cantidad });
          });
          return out;
        };
        if(exact){
          const hadRecipe = Array.isArray(exact.receta) && exact.receta.length>0;
          if(typeof precio==='number' && !Number.isNaN(precio)) exact.precio = precio;
          // Evitar sobrescribir descripci√≥n si el usuario ya la ajust√≥
          if(descripcion!=null && !hadRecipe && !exact.descripcion) exact.descripcion = descripcion;
          // No sobrescribir la receta existente; s√≥lo establecer si est√° vac√≠a
          if(!hadRecipe){
            exact.receta = mapReceta(receta);
          }
          exact.costo = computeRecipeCost(exact.receta||[]);
          if(typeof saveProductToFirestore === 'function') saveProductToFirestore(exact);
          saveLS(); renderAll();
        } else {
          // Si no existe exacto, usar el helper general (case-insensitive)
          addOrUpdateProductWithRecipe({ nombre, precio, descripcion, receta });
        }
      }catch(e){ console.warn('updateProductRecipeExact', e); }
    }

    // Derivar un subproducto a partir de la receta del padre (p.ej. rebanada)
    function deriveSubProductFrom(parentId, { childName, divisor=8, priceStrategy='keep' } = {}){
      try{
        const parent = (appState.productos||[]).find(p=>p.id===parentId);
        if(!parent){ alert('Producto padre no encontrado'); return; }
        const recetaPadre = Array.isArray(parent.receta) ? parent.receta : [];
        if(recetaPadre.length===0){ alert('El producto padre no tiene receta'); return; }
        const div = Number(divisor)||8;
        const childReceta = recetaPadre.map(r=> ({ ingredienteId: r.ingredienteId, cantidad: (Number(r.cantidad)||0)/div }));
        const targetName = (childName && childName.trim()) ? childName.trim() : `Rebanada de ${parent.nombre}`;
        // Buscar si ya existe un hijo por nombre o v√≠nculo parentId
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        let child = (appState.productos||[]).find(p=> (p.parentId===parent.id && byName(p.nombre)===byName(targetName)) || byName(p.nombre)===byName(targetName));
        const computePrice = ()=>{
          if(priceStrategy==='divide') return Number(((Number(parent.precio)||0)/div).toFixed(2));
          return Number(child?.precio||0) || 0;
        };
        if(child){
          child.nombre = targetName;
          child.receta = childReceta;
          child.parentId = parent.id;
          child.derivedDivisor = div;
          child.precio = computePrice();
          child.descripcion = child.descripcion || ((parent.descripcion||'') + ' (rebanada)');
          child.costo = computeRecipeCost(child.receta||[]);
          if(typeof saveProductToFirestore==='function') saveProductToFirestore(child);
        }else{
          child = {
            id: generateId('p'),
            nombre: targetName,
            precio: computePrice(),
            descripcion: (parent.descripcion||'') + ' (rebanada)',
            receta: childReceta,
            parentId: parent.id,
            derivedDivisor: div,
            costo: 0
          };
          child.costo = computeRecipeCost(child.receta||[]);
          appState.productos.push(child);
          if(typeof saveProductToFirestore==='function') saveProductToFirestore(child);
        }
        saveLS(); renderAll(); renderPosProductList();
        alert(`Subproducto listo: ${child.nombre}`);
        return child;
      }catch(e){ console.warn('deriveSubProductFrom', e); alert('No se pudo derivar el subproducto'); }
    }

    // Recalcular autom√°ticamente los subproductos cuando cambie la receta del padre
    function recomputeDerivedChildren(parentId, divisor=8){
      try{
        const parent = (appState.productos||[]).find(p=>p.id===parentId);
        if(!parent) return;
        const childs = (appState.productos||[]).filter(p=> p.parentId===parentId);
        if(childs.length===0) return;
        const div = Number(divisor)||8;
        const base = Array.isArray(parent.receta)? parent.receta : [];
        childs.forEach(ch=>{
          const d = Number(ch.derivedDivisor)||div;
          ch.receta = base.map(r=> ({ ingredienteId:r.ingredienteId, cantidad:(Number(r.cantidad)||0)/d }));
          ch.costo = computeRecipeCost(ch.receta||[]);
          if(typeof saveProductToFirestore==='function') saveProductToFirestore(ch);
        });
      }catch(e){ console.warn('recomputeDerivedChildren', e); }
    }

    // Reaplicar receta para cualquier variante con nombre "HAMBURGUESA DOBLE" (case-insensitive)
    function ensureHamburguesaDobleRecipe(){
      try{
        const target = 'hamburguesa doble';
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        const receta = [
          { nombre:'QUESO MANCHEGO', cantidad:50 },
          { nombre:'TOCINO', cantidad:1 },
          { nombre:'Vegetales', cantidad:1 },
          { nombre:'CARNE DE HAMBURGUESA', cantidad:2 },
          { nombre:'MAYONESA', cantidad:10 },
          { nombre:'QUESO AMERICANO', cantidad:1 },
          { nombre:'CHAROLA UNISEL', cantidad:1 },
          { nombre:'BOTECITO', cantidad:1 },
          { nombre:'CHILES', cantidad:1 },
          { nombre:'BIMBOLLO', cantidad:1 }
        ];
        const mapReceta = (arr)=>{
          const out=[]; const ln = (x)=> (x||'').toLowerCase();
          (arr||[]).forEach(item=>{
            const ing = (appState.ingredientes||[]).find(i=> ln(i.nombre)===ln(item.nombre));
            if(!ing) return; const cant=Number(item.cantidad)||0; if(cant<=0) return; out.push({ ingredienteId: ing.id, cantidad:cant });
          });
          return out;
        };
        let changed = false;
        (appState.productos||[]).forEach(p=>{
          if(byName(p.nombre)===target){
            // Preservar precio si ya tiene; forzar 130 si no
            if(typeof p.precio !== 'number' || Number.isNaN(p.precio)) p.precio = 130;
            if(!p.descripcion) p.descripcion = 'Hamburguesa doble carne con queso manchego, tocino y vegetales.';
            const hasRecipe = Array.isArray(p.receta) && p.receta.length>0;
            if(!hasRecipe){
              p.receta = mapReceta(receta);
              p.costo = computeRecipeCost(p.receta||[]);
            }
            if(typeof saveProductToFirestore === 'function') saveProductToFirestore(p);
            changed = true;
          }
        });
        if(changed){ saveLS(); renderAll(); }
      }catch(e){ console.warn('ensureHamburguesaDobleRecipe', e); }
    }

    // Reaplicar receta para cualquier variante con nombre "HAMBURGUESA BBQ" (case-insensitive)
    function ensureHamburguesaBBQRecipe(){
      try{
        const target = 'hamburguesa bbq';
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        const receta = [
          { nombre:'TOCINO', cantidad:1 },
          { nombre:'Vegetales', cantidad:1 },
          { nombre:'CARNE DE HAMBURGUESA', cantidad:1 },
          { nombre:'MAYONESA', cantidad:10 },
          { nombre:'QUESO AMERICANO', cantidad:1 },
          { nombre:'CHAROLA UNISEL', cantidad:1 },
          { nombre:'BOTECITO', cantidad:1 },
          { nombre:'CHILES', cantidad:1 },
          { nombre:'BIMBOLLO', cantidad:1 },
          { nombre:'SALSA BBQ', cantidad:30 },
          { nombre:'AROS DE CEBOLLA', cantidad:3 }
        ];
        const mapReceta = (arr)=>{
          const out=[]; const ln = (x)=> (x||'').toLowerCase();
          (arr||[]).forEach(item=>{
            const ing = (appState.ingredientes||[]).find(i=> ln(i.nombre)===ln(item.nombre));
            if(!ing) return; const cant=Number(item.cantidad)||0; if(cant<=0) return; out.push({ ingredienteId: ing.id, cantidad:cant });
          });
          return out;
        };
        let changed = false;
        (appState.productos||[]).forEach(p=>{
          if(byName(p.nombre)===target){
            if(typeof p.precio !== 'number' || Number.isNaN(p.precio)) p.precio = 110;
            if(!p.descripcion) p.descripcion = 'Hamburguesa con salsa BBQ, tocino y vegetales.';
            const hasRecipe = Array.isArray(p.receta) && p.receta.length>0;
            if(!hasRecipe){
              p.receta = mapReceta(receta);
              p.costo = computeRecipeCost(p.receta||[]);
            }
            if(typeof saveProductToFirestore === 'function') saveProductToFirestore(p);
            changed = true;
          }
        });
        if(changed){ saveLS(); renderAll(); }
      }catch(e){ console.warn('ensureHamburguesaBBQRecipe', e); }
    }

    // Reaplicar receta para "HAMBURGUESA BBQ DOBLE" (case-insensitive)
    function ensureHamburguesaBBQDobleRecipe(){
      try{
        const target = 'hamburguesa bbq doble';
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        const receta = [
          { nombre:'TOCINO', cantidad:1 },
          { nombre:'Vegetales', cantidad:1 },
          { nombre:'CARNE DE HAMBURGUESA', cantidad:2 },
          { nombre:'MAYONESA', cantidad:10 },
          { nombre:'QUESO AMERICANO', cantidad:2 },
          { nombre:'CHAROLA UNISEL', cantidad:1 },
          { nombre:'BOTECITO', cantidad:1 },
          { nombre:'CHILES', cantidad:1 },
          { nombre:'BIMBOLLO', cantidad:1 },
          { nombre:'SALSA BBQ', cantidad:30 }
        ];
        const mapReceta = (arr)=>{
          const out=[]; const ln = (x)=> (x||'').toLowerCase();
          (arr||[]).forEach(item=>{
            const ing = (appState.ingredientes||[]).find(i=> ln(i.nombre)===ln(item.nombre));
            if(!ing) return; const cant=Number(item.cantidad)||0; if(cant<=0) return; out.push({ ingredienteId: ing.id, cantidad:cant });
          });
          return out;
        };
        let changed = false;
        (appState.productos||[]).forEach(p=>{
          if(byName(p.nombre)===target){
            if(typeof p.precio !== 'number' || Number.isNaN(p.precio)) p.precio = 140;
            if(!p.descripcion) p.descripcion = 'Hamburguesa doble carne con salsa BBQ, tocino y vegetales.';
            const hasRecipe = Array.isArray(p.receta) && p.receta.length>0;
            if(!hasRecipe){
              p.receta = mapReceta(receta);
              p.costo = computeRecipeCost(p.receta||[]);
            }
            if(typeof saveProductToFirestore === 'function') saveProductToFirestore(p);
            changed = true;
          }
        });
        if(changed){ saveLS(); renderAll(); }
      }catch(e){ console.warn('ensureHamburguesaBBQDobleRecipe', e); }
    }

    // Reaplicar receta para "PAPAS GAJO complemento" (case-insensitive)
    function ensurePapasGajoComplementoRecipe(){
      try{
        const target = 'papas gajo complemento';
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        const receta = [
          { nombre:'PAPAS GAJO', cantidad:140 },
          { nombre:'BOTECITO', cantidad:1 },
          { nombre:'QUESO NACHOS', cantidad:35 }
        ];
        const mapReceta = (arr)=>{
          const out=[]; const ln = (x)=> (x||'').toLowerCase();
          (arr||[]).forEach(item=>{
            const ing = (appState.ingredientes||[]).find(i=> ln(i.nombre)===ln(item.nombre));
            if(!ing) return; const cant=Number(item.cantidad)||0; if(cant<=0) return; out.push({ ingredienteId: ing.id, cantidad:cant });
          });
          return out;
        };
        let changed = false;
        (appState.productos||[]).forEach(p=>{
          if(byName(p.nombre)===target){
            if(typeof p.precio !== 'number' || Number.isNaN(p.precio)) p.precio = 20;
            if(!p.descripcion) p.descripcion = 'Porci√≥n de papas gajo con queso nachos.';
            const hasRecipe = Array.isArray(p.receta) && p.receta.length>0;
            if(!hasRecipe){
              p.receta = mapReceta(receta);
              p.costo = computeRecipeCost(p.receta||[]);
            }
            if(typeof saveProductToFirestore === 'function') saveProductToFirestore(p);
            changed = true;
          }
        });
        if(changed){ saveLS(); renderAll(); }
      }catch(e){ console.warn('ensurePapasGajoComplementoRecipe', e); }
    }

    // Reaplicar receta para "PAPAS FRANCESAS complemento" (case-insensitive)
    function ensurePapasFrancesasComplementoRecipe(){
      try{
        const target = 'papas francesas complemento';
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        const receta = [
          { nombre:'PAPAS FRANCESAS', cantidad:140 },
          { nombre:'BOTECITO', cantidad:1 },
          { nombre:'QUESO NACHOS', cantidad:35 }
        ];
        const mapReceta = (arr)=>{
          const out=[]; const ln = (x)=> (x||'').toLowerCase();
          (arr||[]).forEach(item=>{
            const ing = (appState.ingredientes||[]).find(i=> ln(i.nombre)===ln(item.nombre));
            if(!ing) return; const cant=Number(item.cantidad)||0; if(cant<=0) return; out.push({ ingredienteId: ing.id, cantidad:cant });
          });
          return out;
        };
        let changed = false;
        (appState.productos||[]).forEach(p=>{
          if(byName(p.nombre)===target){
            if(typeof p.precio !== 'number' || Number.isNaN(p.precio)) p.precio = 20;
            if(!p.descripcion) p.descripcion = 'Porci√≥n de papas francesas con queso nachos.';
            const hasRecipe = Array.isArray(p.receta) && p.receta.length>0;
            if(!hasRecipe){
              p.receta = mapReceta(receta);
              p.costo = computeRecipeCost(p.receta||[]);
            }
            if(typeof saveProductToFirestore === 'function') saveProductToFirestore(p);
            changed = true;
          }
        });
        if(changed){ saveLS(); renderAll(); }
      }catch(e){ console.warn('ensurePapasFrancesasComplementoRecipe', e); }
    }

    // Reaplicar receta para "PAPAS GAJO MEDIANAS" (case-insensitive)
    function ensurePapasGajoMedianasRecipe(){
      try{
        const target = 'papas gajo medianas';
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        const receta = [
          { nombre:'PAPAS GAJO', cantidad:280 },
          { nombre:'CHAROLA PEQUE√ëA', cantidad:1 },
          { nombre:'BOTECITO', cantidad:1 },
          { nombre:'QUESO NACHOS', cantidad:35 },
          { nombre:'PAPEL GRADO ALIMENTICIO', cantidad:1 }
        ];
        const mapReceta = (arr)=>{
          const out=[]; const ln = (x)=> (x||'').toLowerCase();
          (arr||[]).forEach(item=>{
            const ing = (appState.ingredientes||[]).find(i=> ln(i.nombre)===ln(item.nombre));
            if(!ing) return; const cant=Number(item.cantidad)||0; if(cant<=0) return; out.push({ ingredienteId: ing.id, cantidad:cant });
          });
          return out;
        };
        let changed = false;
        (appState.productos||[]).forEach(p=>{
          if(byName(p.nombre)===target){
            if(typeof p.precio !== 'number' || Number.isNaN(p.precio)) p.precio = 60;
            if(!p.descripcion) p.descripcion = 'Papas gajo medianas con queso nachos en charola.';
            const hasRecipe = Array.isArray(p.receta) && p.receta.length>0;
            if(!hasRecipe){
              p.receta = mapReceta(receta);
              p.costo = computeRecipeCost(p.receta||[]);
            }
            if(typeof saveProductToFirestore === 'function') saveProductToFirestore(p);
            changed = true;
          }
        });
        if(changed){ saveLS(); renderAll(); }
      }catch(e){ console.warn('ensurePapasGajoMedianasRecipe', e); }
    }

    // Reaplicar receta para "PAPAS FRANCESAS MEDIANAS" (case-insensitive)
    function ensurePapasFrancesasMedianasRecipe(){
      try{
        const target = 'papas francesas medianas';
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        const receta = [
          { nombre:'PAPAS FRANCESAS', cantidad:280 },
          { nombre:'BOTECITO', cantidad:1 },
          { nombre:'QUESO NACHOS', cantidad:35 },
          { nombre:'CHAROLA PEQUE√ëA', cantidad:1 },
          { nombre:'PAPEL GRADO ALIMENTICIO', cantidad:1 }
        ];
        const mapReceta = (arr)=>{
          const out=[]; const ln = (x)=> (x||'').toLowerCase();
          (arr||[]).forEach(item=>{
            const ing = (appState.ingredientes||[]).find(i=> ln(i.nombre)===ln(item.nombre));
            if(!ing) return; const cant=Number(item.cantidad)||0; if(cant<=0) return; out.push({ ingredienteId: ing.id, cantidad:cant });
          });
          return out;
        };
        let changed = false;
        (appState.productos||[]).forEach(p=>{
          if(byName(p.nombre)===target){
            if(typeof p.precio !== 'number' || Number.isNaN(p.precio)) p.precio = 60;
            if(!p.descripcion) p.descripcion = 'Papas francesas medianas con queso nachos en charola.';
            const hasRecipe = Array.isArray(p.receta) && p.receta.length>0;
            if(!hasRecipe){
              p.receta = mapReceta(receta);
              p.costo = computeRecipeCost(p.receta||[]);
            }
            if(typeof saveProductToFirestore === 'function') saveProductToFirestore(p);
            changed = true;
          }
        });
        if(changed){ saveLS(); renderAll(); }
      }catch(e){ console.warn('ensurePapasFrancesasMedianasRecipe', e); }
    }

    // Reaplicar receta para "PAPAS GAJO GRANDES" (case-insensitive)
    function ensurePapasGajoGrandesRecipe(){
      try{
        const target = 'papas gajo grandes';
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        const receta = [
          { nombre:'PAPAS GAJO', cantidad:560 },
          { nombre:'BOTECITO', cantidad:2 },
          { nombre:'QUESO NACHOS', cantidad:75 },
          { nombre:'CHAROLA UNISEL', cantidad:1 },
          { nombre:'PAPEL GRADO ALIMENTICIO', cantidad:1 }
        ];
        const mapReceta = (arr)=>{
          const out=[]; const ln = (x)=> (x||'').toLowerCase();
          (arr||[]).forEach(item=>{
            const ing = (appState.ingredientes||[]).find(i=> ln(i.nombre)===ln(item.nombre));
            if(!ing) return; const cant=Number(item.cantidad)||0; if(cant<=0) return; out.push({ ingredienteId: ing.id, cantidad:cant });
          });
          return out;
        };
        let changed = false;
        (appState.productos||[]).forEach(p=>{
          if(byName(p.nombre)===target){
            if(typeof p.precio !== 'number' || Number.isNaN(p.precio)) p.precio = 120;
            if(!p.descripcion) p.descripcion = 'Papas gajo grandes con queso nachos en charola grande.';
            const hasRecipe = Array.isArray(p.receta) && p.receta.length>0;
            if(!hasRecipe){
              p.receta = mapReceta(receta);
              p.costo = computeRecipeCost(p.receta||[]);
            }
            if(typeof saveProductToFirestore === 'function') saveProductToFirestore(p);
            changed = true;
          }
        });
        if(changed){ saveLS(); renderAll(); }
      }catch(e){ console.warn('ensurePapasGajoGrandesRecipe', e); }
    }

    // Reaplicar receta para "PAPAS FRANCESAS GRANDES" (case-insensitive)
    function ensurePapasFrancesasGrandesRecipe(){
      try{
        const target = 'papas francesas grandes';
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        const receta = [
          { nombre:'PAPAS FRANCESAS', cantidad:560 },
          { nombre:'BOTECITO', cantidad:2 },
          { nombre:'QUESO NACHOS', cantidad:75 },
          { nombre:'CHAROLA UNISEL', cantidad:1 },
          { nombre:'PAPEL GRADO ALIMENTICIO', cantidad:1 }
        ];
        const mapReceta = (arr)=>{
          const out=[]; const ln = (x)=> (x||'').toLowerCase();
          (arr||[]).forEach(item=>{
            const ing = (appState.ingredientes||[]).find(i=> ln(i.nombre)===ln(item.nombre));
            if(!ing) return; const cant=Number(item.cantidad)||0; if(cant<=0) return; out.push({ ingredienteId: ing.id, cantidad:cant });
          });
          return out;
        };
        let changed = false;
        (appState.productos||[]).forEach(p=>{
          if(byName(p.nombre)===target){
            if(typeof p.precio !== 'number' || Number.isNaN(p.precio)) p.precio = 120;
            if(!p.descripcion) p.descripcion = 'Papas francesas grandes con queso nachos en charola grande.';
            const hasRecipe = Array.isArray(p.receta) && p.receta.length>0;
            if(!hasRecipe){
              p.receta = mapReceta(receta);
              p.costo = computeRecipeCost(p.receta||[]);
            }
            if(typeof saveProductToFirestore === 'function') saveProductToFirestore(p);
            changed = true;
          }
        });
        if(changed){ saveLS(); renderAll(); }
      }catch(e){ console.warn('ensurePapasFrancesasGrandesRecipe', e); }
    }

    // Reaplicar receta para "HOTDOG JUMBO"
    function ensureHotdogJumboRecipe(){
      try{
        const target = 'hotdog jumbo';
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        const receta = [
          { nombre:'TOCINO', cantidad:1 },
          { nombre:'Vegetales Hotdog', cantidad:1 },
          { nombre:'SALCHICHAS JUMBO', cantidad:1 },
          { nombre:'MAYONESA', cantidad:10 },
          { nombre:'PAN HOTDOG', cantidad:1 },
          { nombre:'CHAROLA UNISEL', cantidad:1 },
          { nombre:'BOTECITO', cantidad:1 },
          { nombre:'CHILES', cantidad:1 },
          { nombre:'QUESO NACHOS', cantidad:15 }
        ];
        const mapReceta = (arr)=>{
          const out=[]; const ln = (x)=> (x||'').toLowerCase();
          (arr||[]).forEach(item=>{
            const ing = (appState.ingredientes||[]).find(i=> ln(i.nombre)===ln(item.nombre));
            if(!ing) return; const cant=Number(item.cantidad)||0; if(cant<=0) return; out.push({ ingredienteId: ing.id, cantidad:cant });
          });
          return out;
        };
        let changed = false;
        (appState.productos||[]).forEach(p=>{
          if(byName(p.nombre)===target){
            if(typeof p.precio !== 'number' || Number.isNaN(p.precio)) p.precio = 60;
            if(!p.descripcion) p.descripcion = 'Hotdog jumbo con tocino, vegetales y queso nachos.';
            const hasRecipe = Array.isArray(p.receta) && p.receta.length>0;
            if(!hasRecipe){
              p.receta = mapReceta(receta);
              p.costo = computeRecipeCost(p.receta||[]);
            }
            if(typeof saveProductToFirestore === 'function') saveProductToFirestore(p);
            changed = true;
          }
        });
        if(changed){ saveLS(); renderAll(); }
      }catch(e){ console.warn('ensureHotdogJumboRecipe', e); }
    }

    // Reaplicar receta para "HOT DOG SALCHIROJA" (case-insensitive)
    function ensureHotdogSalchirojaRecipe(){
      try{
        const targets = ['hot dog salchiroja','hotdog salchicha roja'];
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        const receta = [
          { nombre:'PAN HOTDOG MEDIA NOCHE', cantidad:1 },
          { nombre:'SALCHICHA BAFAR JALAPE√ëO', cantidad:1 },
          { nombre:'Vegetales Hotdog', cantidad:1 },
          { nombre:'TOCINO', cantidad:1 },
          { nombre:'QUESO MANCHEGO', cantidad:30 },
          { nombre:'CHAROLA PEQUE√ëA', cantidad:1 },
          { nombre:'PAPEL GRADO ALIMENTICIO', cantidad:1 },
          { nombre:'Catsup', cantidad:1 }
        ];
        const mapReceta = (arr)=>{
          const out=[]; const ln = (x)=> (x||'').toLowerCase();
          (arr||[]).forEach(item=>{
            const ing = (appState.ingredientes||[]).find(i=> ln(i.nombre)===ln(item.nombre));
            if(!ing) return; const cant=Number(item.cantidad)||0; if(cant<=0) return; out.push({ ingredienteId: ing.id, cantidad:cant });
          });
          return out;
        };
        let changed = false;
        (appState.productos||[]).forEach(p=>{
          if(targets.includes(byName(p.nombre))){
            if(typeof p.precio !== 'number' || Number.isNaN(p.precio)) p.precio = 60;
            // Mantener descripci√≥n existente si ya tiene; si no, usar una gen√©rica
            if(!p.descripcion) p.descripcion = 'Hot dog salchicha roja con jalape√±o, tocino y queso.';
            const hasRecipe = Array.isArray(p.receta) && p.receta.length>0;
            if(!hasRecipe){
              p.receta = mapReceta(receta);
              p.costo = computeRecipeCost(p.receta||[]);
            }
            if(typeof saveProductToFirestore === 'function') saveProductToFirestore(p);
            changed = true;
          }
        });
        if(changed){ saveLS(); renderAll(); }
      }catch(e){ console.warn('ensureHotdogSalchirojaRecipe', e); }
    }

    // Actualizar recetas de productos seg√∫n lista proporcionada
    function updateAllProductRecipes(){
      try{
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        const mapReceta = (arr)=>{
          const out=[]; const ln = (x)=> (x||'').toLowerCase();
          (arr||[]).forEach(item=>{
            const ing = (appState.ingredientes||[]).find(i=> ln(i.nombre)===ln(item.nombre));
            if(!ing) return; const cant=Number(item.cantidad)||0; if(cant<=0) return; 
            out.push({ ingredienteId: ing.id, cantidad:cant });
          });
          return out;
        };

        const productRecipes = {
          'hamburguesa clasica': [
            { nombre:'PAN XL', cantidad: 1 },
            { nombre:'CARNE DE HAMBURGUESA', cantidad: 1 },
            { nombre:'QUESO GOUDA', cantidad: 30 },
            { nombre:'QUESO AMERICANO', cantidad: 1 },
            { nombre:'CEBOLLA CARAMELIZADA', cantidad: 20 },
            { nombre:'LECHUGA', cantidad: 10 },
            { nombre:'TOMATE', cantidad: 15 },
            { nombre:'TOCINO', cantidad: 1 }
          ],
          'hamburguesa hawaiana': [
            { nombre:'PAN XL', cantidad: 1 },
            { nombre:'CARNE DE HAMBURGUESA', cantidad: 1 },
            { nombre:'QUESO GOUDA', cantidad: 30 },
            { nombre:'QUESO AMERICANO', cantidad: 1 },
            { nombre:'CEBOLLA CARAMELIZADA', cantidad: 20 },
            { nombre:'LECHUGA', cantidad: 10 },
            { nombre:'TOMATE', cantidad: 15 },
            { nombre:'TOCINO', cantidad: 1 },
            { nombre:'PI√ëA', cantidad: 30 }
          ],
          'salchiburger': [
            { nombre:'PAN XL', cantidad: 1 },
            { nombre:'CARNE DE HAMBURGUESA', cantidad: 1 },
            { nombre:'QUESO GOUDA', cantidad: 30 },
            { nombre:'QUESO AMERICANO', cantidad: 1 },
            { nombre:'CEBOLLA CARAMELIZADA', cantidad: 20 },
            { nombre:'LECHUGA', cantidad: 10 },
            { nombre:'TOMATE', cantidad: 15 },
            { nombre:'TOCINO', cantidad: 1 },
            { nombre:'SALCHICHA', cantidad: 1 }
          ],
          'hamburguesa chorizo argentino': [
            { nombre:'PAN XL', cantidad: 1 },
            { nombre:'CARNE DE HAMBURGUESA', cantidad: 1 },
            { nombre:'QUESO GOUDA', cantidad: 30 },
            { nombre:'CEBOLLA CARAMELIZADA', cantidad: 20 },
            { nombre:'CHORIZO ARGENTINO', cantidad: 1 },
            { nombre:'TOCINO', cantidad: 1 }
          ],
          'hamburguesa chistorraburger': [
            { nombre:'PAN XL', cantidad: 1 },
            { nombre:'QUESO GOUDA', cantidad: 30 },
            { nombre:'CEBOLLA CARAMELIZADA', cantidad: 20 },
            { nombre:'CHISTORRA', cantidad: 1 },
            { nombre:'TOCINO', cantidad: 1 }
          ],
          'hamburguesa bbq': [
            { nombre:'PAN XL', cantidad: 1 },
            { nombre:'CARNE DE HAMBURGUESA', cantidad: 1 },
            { nombre:'QUESO AMERICANO', cantidad: 1 },
            { nombre:'CEBOLLA CARAMELIZADA', cantidad: 20 },
            { nombre:'AROS DE CEBOLLA', cantidad: 3 },
            { nombre:'TOCINO', cantidad: 1 },
            { nombre:'SALSA BBQ', cantidad: 30 }
          ],
          'papas francesas medianas': [
            { nombre:'PAPAS FRANCESAS', cantidad: 280 }
          ],
          'papas francesas complemento': [
            { nombre:'PAPAS FRANCESAS', cantidad: 140 }
          ],
          'papas francesas xl': [
            { nombre:'PAPAS FRANCESAS', cantidad: 560 }
          ],
          'papas gajo medianas': [
            { nombre:'PAPAS GAJO', cantidad: 280 }
          ],
          'papas gajo complemento': [
            { nombre:'PAPAS GAJO', cantidad: 140 }
          ],
          'papas gajo xl': [
            { nombre:'PAPAS GAJO', cantidad: 560 }
          ],
          'aros medianos': [
            { nombre:'AROS DE CEBOLLA', cantidad: 8 }
          ],
          'aros xl': [
            { nombre:'AROS DE CEBOLLA', cantidad: 15 }
          ],
          'salchipapas m': [
            { nombre:'PAPAS FRANCESAS', cantidad: 300 },
            { nombre:'SALCHICHA', cantidad: 1 }
          ],
          'salchipapas xl': [
            { nombre:'PAPAS FRANCESAS', cantidad: 600 },
            { nombre:'SALCHICHA', cantidad: 2 }
          ]
        };

        let changed = false;
        (appState.productos||[]).forEach(p=>{
          const pName = byName(p.nombre);
          if(productRecipes[pName]){
            p.receta = mapReceta(productRecipes[pName]);
            p.costo = computeRecipeCost(p.receta||[]);
            if(typeof saveProductToFirestore === 'function') saveProductToFirestore(p);
            changed = true;
          }
        });
        
        if(changed){ 
          saveLS(); 
          renderAll(); 
          console.log('‚úÖ Recetas actualizadas para productos');
        }
      }catch(e){ 
        console.warn('updateAllProductRecipes', e); 
      }
    }

    // Garantizar la presencia de los productos solicitados (precio + descripci√≥n, receta vac√≠a)
    function ensureRequestedProducts(){
      try{
        const want = [
          { nombre:'HAMBURGUESA DOBLE', precio:130, descripcion:'Hamburguesa doble carne con queso manchego, tocino y vegetales.', categoria:'Hamburguesas', estacion:'parrilla' },
          { nombre:'HAMBURGUESA BBQ', precio:110, descripcion:'Hamburguesa con salsa BBQ, tocino y vegetales.', categoria:'Hamburguesas', estacion:'parrilla' },
          { nombre:'HAMBURGUESA BBQ DOBLE', precio:140, descripcion:'Hamburguesa doble carne con salsa BBQ, tocino y vegetales.', categoria:'Hamburguesas', estacion:'parrilla' },
          { nombre:'PAPAS GAJO complemento', precio:20, descripcion:'Porci√≥n de papas gajo con queso nachos.', categoria:'Complementos', estacion:'freidora' },
          { nombre:'PAPAS FRANCESAS complemento', precio:20, descripcion:'Porci√≥n de papas francesas con queso nachos.', categoria:'Complementos', estacion:'freidora' },
          { nombre:'PAPAS GAJO MEDIANAS', precio:60, descripcion:'Papas gajo medianas con queso nachos en charola.', categoria:'Complementos', estacion:'freidora' },
          { nombre:'PAPAS FRANCESAS MEDIANAS', precio:60, descripcion:'Papas francesas medianas con queso nachos en charola.', categoria:'Complementos', estacion:'freidora' },
          { nombre:'PAPAS GAJO GRANDES', precio:120, descripcion:'Papas gajo grandes con queso nachos en charola grande.', categoria:'Complementos', estacion:'freidora' },
          { nombre:'PAPAS FRANCESAS GRANDES', precio:120, descripcion:'Papas francesas grandes con queso nachos en charola grande.', categoria:'Complementos', estacion:'freidora' },
          { nombre:'PAPAS GAJO XL', precio:120, descripcion:'Papas gajo XL con queso nachos en charola grande.', categoria:'Complementos', estacion:'freidora' },
          { nombre:'PAPAS FRANCESAS XL', precio:120, descripcion:'Papas francesas XL con queso nachos en charola grande.', categoria:'Complementos', estacion:'freidora' },
          { nombre:'AROS MEDIANOS', precio:40, descripcion:'8 piezas de aros de cebolla.', categoria:'Complementos', estacion:'parrilla' },
          { nombre:'AROS XL', precio:70, descripcion:'15 piezas de aros de cebolla.', categoria:'Complementos', estacion:'parrilla' },
          { nombre:'HOTDOG JUMBO', precio:60, descripcion:'Hot dog jumbo con salchicha jumbo, tocino, vegetales y queso nachos.', categoria:'Hotdogs', estacion:'parrilla' },
          { nombre:'HOT DOG SALCHIROJA', precio:60, descripcion:'Hot dog con salchicha roja , jalape√±o, queso gouda y tocino.', categoria:'Hotdogs', estacion:'parrilla' }
        ];
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        want.forEach(p=>{
          const existObj = (appState.productos||[]).find(x=> byName(x.nombre)===byName(p.nombre));
          if(!existObj){ addOrUpdateProductWithRecipe({ ...p, receta: [] }); }
          else{
            if(!existObj.categoria && p.categoria){ existObj.categoria = p.categoria; }
            if(!existObj.estacion && p.estacion){ existObj.estacion = p.estacion; if(typeof saveProductToFirestore === 'function') saveProductToFirestore(existObj); }
          }
        });
      }catch(e){ console.warn('ensureRequestedProducts', e); }
    }

    // Charts
    let salesChart, productsChart;
    function renderCharts(){
      // Tweak Chart defaults on small screens
      try{
        if(window.Chart){
          const small = window.matchMedia('(max-width: 640px)').matches;
          Chart.defaults.font.size = small ? 10 : 12;
          Chart.defaults.plugins.legend.labels.boxWidth = small ? 10 : 12;
        }
      }catch(_){ }
      const period = document.getElementById('rep-period-select')?.value || '30d';
      const filterType = document.getElementById('rep-filter-type')?.value || 'all';
      const filterPay = document.getElementById('rep-filter-pay')?.value || 'all';
      let now = new Date();
      let start = new Date(now);
      if(period==='today'){ start.setHours(0,0,0,0); }
      else if(period==='30d'){ start.setDate(start.getDate()-30); }
      else if(period==='month'){ start = new Date(now.getFullYear(), now.getMonth(), 1); }
      else if(period==='all'){ start = new Date(0); }
      else if(period==='custom'){
        const s = document.getElementById('rep-date-start')?.value;
        const e = document.getElementById('rep-date-end')?.value;
        start = s ? new Date(s+'T00:00:00') : new Date(0);
        now = e ? new Date(e+'T23:59:59') : new Date();
      } else { start.setDate(start.getDate()-7); }
      const ventas = (appState.ventas||[]).filter(v=>{
        if(v?.cancelada) return false;
        const d = new Date(v.fecha);
        if(!(d>=start && d<=now)) return false;
        if(filterType!=='all' && (v.tipo||'local')!==filterType) return false;
        const m = v.pago?.metodo || 'Efectivo';
        if(filterPay!=='all' && m!==filterPay) return false;
        return true;
      });

  // KPIs
  const sum = (arr,f)=> arr.reduce((s,x)=> s + (f?f(x):x), 0);
  // Ingresos totales de √≥rdenes (incluyen env√≠os); se muestran como KPI "Ingresos"
  const revenue = sum(ventas, v=> v.total||0);
  // Ingresos de productos para c√°lculo de margen (excluye env√≠os): subtotal menos descuento
  const productRevenue = sum(ventas, v=> (v.subtotal||0) - (v.descuento||0));
      const orders = ventas.length;
      const items = sum(ventas, v=> sum(v.items||[], it=> it.cantidad||0));
      const aov = orders>0 ? revenue/orders : 0;
      // Margen bruto estimado = ventas - costo receta
      const prodLookup = new Map((uniqueByProductName? uniqueByProductName(appState.productos||[]): (appState.productos||[])).map(p=>[p.id,p]));
      const estCost = sum(ventas, v=> sum(v.items||[], it=>{
        const prod = prodLookup.get(it.productoId) || appState.productos.find(p=>p.id===it.productoId);
        const cost = (prod && typeof prod.costo==='number') ? prod.costo : computeRecipeCost(prod?.receta||[]);
        return (cost || 0) * (it.cantidad||0);
      }));
  // Margen bruto estimado = ingresos de productos - costo estimado de recetas
  const gp = productRevenue - estCost;
      const setTxt = (id, txt)=>{ const el=document.getElementById(id); if(el) el.textContent = txt; };
      setTxt('rep-revenue', fmt(revenue));
      setTxt('rep-orders', String(orders));
      setTxt('rep-aov', fmt(aov));
      setTxt('rep-gp', fmt(gp));

    // Promedio de art√≠culos vendidos por semana y mes
    // Semana: √∫ltimos 7 d√≠as
    let startWeek = new Date(); startWeek.setDate(startWeek.getDate()-7);
    let itemsWeek = sum((appState.ventas||[]).filter(v=> !v.cancelada && new Date(v.fecha)>=startWeek), v=> sum(v.items||[], it=> it.cantidad||0));
    setTxt('avg-items-week', Math.round(itemsWeek/7));
    // Mes: √∫ltimos 30 d√≠as
    let startMonth = new Date(); startMonth.setDate(startMonth.getDate()-30);
    let itemsMonth = sum((appState.ventas||[]).filter(v=> !v.cancelada && new Date(v.fecha)>=startMonth), v=> sum(v.items||[], it=> it.cantidad||0));
    setTxt('avg-items-month', Math.round(itemsMonth/30));

      // Charts
  const salesCtx = document.getElementById('sales-chart')?.getContext('2d');
  const prodCtx = document.getElementById('products-chart')?.getContext('2d');
  const typeCtx = document.getElementById('order-type-chart')?.getContext('2d');
  const payCtx = document.getElementById('payment-method-chart')?.getContext('2d');
  const weekCtx = document.getElementById('weekday-chart')?.getContext('2d');
  const topCliCtx = document.getElementById('top-clients-chart')?.getContext('2d');
  const marginCtx = document.getElementById('margin-chart')?.getContext('2d');
  const hourlyCtx = document.getElementById('hourly-report-chart')?.getContext('2d');
      if(salesChart){ salesChart.destroy(); salesChart = undefined; }
      if(productsChart){ productsChart.destroy(); productsChart = undefined; }
  if(window.__typeChart){ window.__typeChart.destroy(); window.__typeChart = undefined; }
  if(window.__payChart){ window.__payChart.destroy(); window.__payChart = undefined; }
  if(window.__weekChart){ window.__weekChart.destroy(); window.__weekChart = undefined; }
  if(window.__topCliChart){ window.__topCliChart.destroy(); window.__topCliChart = undefined; }
  if(window.__marginChart){ window.__marginChart.destroy(); window.__marginChart = undefined; }
  if(window.__hourlyRepChart){ window.__hourlyRepChart.destroy(); window.__hourlyRepChart = undefined; }

      if (salesCtx) {
        const byDay = {};
        ventas.forEach(v=>{ const k = new Date(v.fecha).toISOString().slice(0,10); byDay[k] = (byDay[k]||0) + (v.total||0); });
        const labelsSales = Object.keys(byDay).sort();
        salesChart = new Chart(salesCtx, {
          type: 'line',
          data: { labels: labelsSales, datasets: [ { label: 'Ventas', data: labelsSales.map(k=>byDay[k]), borderColor: '#10B981', backgroundColor: 'rgba(16,185,129,.2)', tension:.3 } ] },
          options: { responsive: true, plugins: { legend: { display: false } }, scales:{ x:{ ticks:{ maxRotation:0, autoSkip:true, maxTicksLimit: (window.innerWidth<640?5:10) } }, y:{ ticks:{ callback:(v)=>'$'+v } } } }
        });
      }
      if (prodCtx) {
        const counts = {};
        ventas.forEach(v=> (v.items||[]).forEach(it=>{ counts[it.nombre] = (counts[it.nombre]||0) + (it.cantidad||0); }));
        const labelsProducts = Object.keys(counts).sort((a,b)=> counts[b]-counts[a]).slice(0,10);
        productsChart = new Chart(prodCtx, { type: 'bar', data: { labels: labelsProducts, datasets: [ { label: 'Cantidad', data: labelsProducts.map(k=>counts[k]), backgroundColor: '#3B82F6' } ] }, options: { responsive: true, plugins: { legend: { display: false } } } });
      }
      if(typeCtx){
        const byType = { local:0, para_llevar:0, envio:0 };
        ventas.forEach(v=>{ byType[v.tipo||'local'] = (byType[v.tipo||'local']||0) + (v.total||0); });
        window.__typeChart = new Chart(typeCtx, { type:'doughnut', data:{ labels:['Local','Para llevar','Env√≠o'], datasets:[{ data:[byType.local||0, byType.para_llevar||0, byType.envio||0], backgroundColor:['#10B981','#F59E0B','#3B82F6'] }] }, options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } } });
      }
      if(payCtx){
        const byPay = {};
        ventas.forEach(v=>{ const m=v.pago?.metodo||'Efectivo'; byPay[m]=(byPay[m]||0)+(v.total||0); });
        const labels = Object.keys(byPay);
        window.__payChart = new Chart(payCtx, { type:'pie', data:{ labels, datasets:[{ data: labels.map(k=>byPay[k]), backgroundColor:['#8B4513','#FF6B35','#10B981','#3B82F6','#F59E0B'] }] }, options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } } });
      }
      if(weekCtx){
        const byDay = [0,0,0,0,0,0,0]; // Domingo..S√°bado
        ventas.forEach(v=>{ const d=new Date(v.fecha).getDay(); byDay[d] += (v.total||0); });
        window.__weekChart = new Chart(weekCtx, { type:'bar', data:{ labels:['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'], datasets:[{ label:'Ingresos', data:byDay, backgroundColor:'#A855F7' }] }, options:{ responsive:true, plugins:{ legend:{ display:false } } } });
      }
      if(topCliCtx){
        const byClient = {};
        ventas.forEach(v=>{ const id=v.clienteId||'general'; byClient[id]=(byClient[id]||0)+(v.total||0); });
        const sorted = Object.entries(byClient).sort((a,b)=> b[1]-a[1]).slice(0,10);
        const labels = sorted.map(([id])=> appState.clientes.find(c=>c.id===id)?.nombre || 'General');
        const values = sorted.map(([,val])=> val);
        window.__topCliChart = new Chart(topCliCtx, { type:'bar', data:{ labels, datasets:[{ label:'Ingresos', data:values, backgroundColor:'#DC143C' }] }, options:{ indexAxis:'y', responsive:true, plugins:{ legend:{ display:false } } } });
      }
      if (marginCtx) {
        const totals = {};
        ventas.forEach(v=> {
          const vSubtotal = v.subtotal||0;
          const vDesc = v.descuento||0;
          (v.items||[]).forEach(it=>{
            const prod = prodLookup.get(it.productoId) || appState.productos.find(p=>p.id===it.productoId);
            const costUnit = (prod && typeof prod.costo==='number') ? prod.costo : computeRecipeCost(prod?.receta||[]);
            const key = it.nombre;
            if(!totals[key]) totals[key] = { qty:0, revenue:0, cost:0 };
            const lineRevenue = (it.precio||0) * (it.cantidad||0);
            const discountShare = vSubtotal>0 ? (vDesc * (lineRevenue / vSubtotal)) : 0;
            const netRevenue = lineRevenue - discountShare;
            totals[key].qty += it.cantidad||0;
            totals[key].revenue += netRevenue;
            totals[key].cost += (costUnit||0) * (it.cantidad||0);
          });
        });
        const entries = Object.entries(totals).map(([name, t])=> [name, Math.max(0, (t.revenue||0) - (t.cost||0))]);
        const top = entries.sort((a,b)=> b[1]-a[1]).slice(0,10);
        window.__marginChart = new Chart(marginCtx, { type:'bar', data:{ labels: top.map(e=>e[0]), datasets:[{ label:'Margen bruto', data: top.map(e=>e[1]), backgroundColor:'#059669' }] }, options:{ indexAxis:'y', responsive:true, plugins:{ legend:{ display:false } } } });
      }
      if (hourlyCtx) {
        const byHour = new Array(24).fill(0);
        ventas.forEach(v=>{ const d=new Date(v.fecha); byHour[d.getHours()] += (v.total||0); });
        window.__hourlyRepChart = new Chart(hourlyCtx, { type:'line', data:{ labels:[...Array(24)].map((_,h)=> h+':00'), datasets:[{ label:'Ingresos', data:byHour, borderColor:'#2563EB', backgroundColor:'rgba(37,99,235,.15)', tension:.3 }] }, options:{ responsive:true, plugins:{ legend:{ display:false } } } });
      }

  // Tambi√©n actualizar desglose de gastos bajo Reportes
  try{ renderExpenseBreakdown(ventas); }catch(_){ }
    }

    // CSV helpers and export wiring
    function toCSV(rows){
      return rows.map(r=> r.map(v=>{
        if(v===null||v===undefined) return '';
        const s = String(v).replaceAll('"','""');
        return (s.includes(',')||s.includes('"')||s.includes('\n')) ? '"'+s+'"' : s;
      }).join(',')).join('\n');
    }
    function downloadCSV(name, rows){
      try{
        const csv = toCSV(rows);
        const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download=name; a.click();
        setTimeout(()=> URL.revokeObjectURL(url), 1000);
      }catch(e){ console.warn('downloadCSV', e); }
    }
    function getFilteredVentas(){
      const period = document.getElementById('rep-period-select')?.value || '30d';
      const filterType = document.getElementById('rep-filter-type')?.value || 'all';
      const filterPay = document.getElementById('rep-filter-pay')?.value || 'all';
      let now = new Date();
      let start = new Date(now);
      if(period==='today'){ start.setHours(0,0,0,0); }
      else if(period==='30d'){ start.setDate(start.getDate()-30); }
      else if(period==='month'){ start = new Date(now.getFullYear(), now.getMonth(), 1); }
      else if(period==='all'){ start = new Date(0); }
      else if(period==='custom'){
        const s = document.getElementById('rep-date-start')?.value;
        const e = document.getElementById('rep-date-end')?.value;
        start = s ? new Date(s+'T00:00:00') : new Date(0);
        now = e ? new Date(e+'T23:59:59') : new Date();
      } else { start.setDate(start.getDate()-7); }
      const ventas = (appState.ventas||[]).filter(v=>{
        const d = new Date(v.fecha);
        if(!(d>=start && d<=now)) return false;
        if(filterType!=='all' && (v.tipo||'local')!==filterType) return false;
        const m = v.pago?.metodo || 'Efectivo';
        if(filterPay!=='all' && m!==filterPay) return false;
        return true;
      });
      return ventas;
    }
    function exportSalesCSV(){
      const ventas = getFilteredVentas();
      const rows = [['ID','Fecha','Cliente','Tipo','Pago','Subtotal','Descuento','Envio','Total','Items']];
      ventas.forEach(v=>{
        const cliente = appState.clientes.find(c=>c.id===v.clienteId)?.nombre || 'General';
        const items = (v.items||[]).reduce((s,i)=> s + (i.cantidad||0), 0);
        rows.push([v.id, new Date(v.fecha).toLocaleString(), cliente, v.tipo||'local', v.pago?.metodo||'Efectivo', fmtNum(v.subtotal||0), fmtNum(v.descuento||0), fmtNum(v.costoEnvio||0), fmtNum(v.total||0), items]);
      });
      downloadCSV('ventas.csv', rows);
    }
    function exportProductsCSV(){
      const ventas = getFilteredVentas();
      const agg = {};
  ventas.forEach(v=> (v.items||[]).forEach(it=>{
  const key = it.nombre;
  const prod = prodLookup.get(it.productoId) || appState.productos.find(p=>p.id===it.productoId);
        const costUnit = (prod && typeof prod.costo==='number') ? prod.costo : computeRecipeCost(prod?.receta||[]);
        if(!agg[key]) agg[key] = { qty:0, revenue:0, cost:0 };
        agg[key].qty += it.cantidad||0;
        agg[key].revenue += (it.precio||0) * (it.cantidad||0);
        agg[key].cost += (costUnit||0) * (it.cantidad||0);
      }));
      const rows = [['Producto','Cantidad','Ingresos','Costo Est.','Margen Est.']];
      Object.entries(agg).forEach(([name, t])=>{
        const margin = Math.max(0, (t.revenue||0)-(t.cost||0));
        rows.push([name, t.qty, fmtNum(t.revenue||0), fmtNum(t.cost||0), fmtNum(margin)]);
      });
      downloadCSV('productos.csv', rows);
    }

    // === Gastos por ingrediente (Reportes) ===
    function currentReportPeriod(){
      const p = document.getElementById('rep-period-select')?.value || '30d';
      let now = new Date();
      let start = new Date(now);
      if(p==='today'){ start.setHours(0,0,0,0); }
      else if(p==='30d'){ start.setDate(start.getDate()-30); }
      else if(p==='month'){ start = new Date(now.getFullYear(), now.getMonth(), 1); }
      else if(p==='all'){ start = new Date(0); }
      else if(p==='custom'){
        const s = document.getElementById('rep-date-start')?.value;
        const e = document.getElementById('rep-date-end')?.value;
        start = s ? new Date(s+'T00:00:00') : new Date(0);
        now = e ? new Date(e+'T23:59:59') : new Date();
      } else { start.setDate(start.getDate()-7); }
      return { start, end: now };
    }
    function renderExpenseBreakdown(ventasFiltradas){
      const body = document.getElementById('exp-ingredientes-body');
      const dough = document.getElementById('expense-ingredient-chart')?.getContext('2d');
      if(!body){ return; }
      body.innerHTML = '';
      const { start, end } = currentReportPeriod();
      // Filtrar compras por rango de fechas
      const compras = (appState.inventario?.compras||[]).filter(c=>{
        if(c?.cancelada) return false;
        const d = new Date(c.fecha);
        return d>=start && d<=end;
      });
      const byIng = {};
      compras.forEach(c=>{
        const ing = getIngredientById(c.ingredienteId);
        if(!byIng[c.ingredienteId]) byIng[c.ingredienteId] = { nombre: ing?.nombre || c.ingredienteId, piezas:0, unidades:0, gasto:0 };
        byIng[c.ingredienteId].piezas += Number(c.piezas||0);
        byIng[c.ingredienteId].unidades += Number(c.piezas||0) * unitsPerPiece(ing);
        byIng[c.ingredienteId].gasto += Number(c.costo||0);
      });
      const rows = Object.values(byIng).sort((a,b)=> b.gasto-a.gasto);
      if(rows.length===0){ body.innerHTML = '<tr><td colspan="4" class="p-3 text-center opacity-60">Sin compras en el periodo</td></tr>'; }
      else{
        body.innerHTML = rows.map(r=> `<tr><td class="p-2">${r.nombre}</td><td class="p-2 text-right">${r.piezas}</td><td class="p-2 text-right">${r.unidades.toFixed(0)}</td><td class="p-2 text-right">${fmt(r.gasto)}</td></tr>`).join('');
      }
      // KPIs de la secci√≥n
      const sum = (arr,f)=> arr.reduce((s,x)=> s + (f?f(x):x), 0);
      const spend = sum(rows, r=> r.gasto||0);
      const revenue = sum(ventasFiltradas||[], v=> v.total||0);
      const cogs = sum(ventasFiltradas||[], v=> sum(v.items||[], it=>{
        const prod = appState.productos.find(p=>p.id===it.productoId);
        const cost = (prod && typeof prod.costo==='number') ? prod.costo : computeRecipeCost(prod?.receta||[]);
        return (cost || 0) * (it.cantidad||0);
      }));
      const gp = revenue - cogs;
      const setTxt = (id, txt)=>{ const el=document.getElementById(id); if(el) el.textContent = txt; };
      setTxt('exp-total-spend', fmt(spend));
      setTxt('exp-revenue', fmt(revenue));
      setTxt('exp-cogs', fmt(cogs));
      setTxt('exp-gp', fmt(gp));
      // Gr√°fica
      const labels = rows.map(r=> r.nombre);
      const dataVals = rows.map(r=> r.gasto||0);
      const emptyMsg = document.getElementById('expense-empty');
      if(window.__expenseChart){ window.__expenseChart.destroy(); window.__expenseChart = undefined; }
      if(dough && dataVals.some(v=> v>0)){
        emptyMsg?.classList.add('hidden');
        window.__expenseChart = new Chart(dough, {
          type:'doughnut',
          data:{ labels, datasets:[{ data:dataVals, backgroundColor:['#1D4ED8','#059669','#DC2626','#F59E0B','#7C3AED','#2563EB','#10B981','#EF4444','#F59E0B','#6366F1'] }] },
          options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } }
        });
      } else { emptyMsg?.classList.remove('hidden'); }
    }
    // CSV export para gastos por ingrediente
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest && e.target.closest('#rep-export-expenses');
      if(!btn) return;
      const body = document.getElementById('exp-ingredientes-body');
      if(!body) return;
      const rows = [['Ingrediente','Piezas','Unidades','Gasto']];
      body.querySelectorAll('tr').forEach(tr=>{
        const tds = tr.querySelectorAll('td');
        if(tds.length===4){
          rows.push([tds[0].textContent.trim(), tds[1].textContent.trim(), tds[2].textContent.trim(), tds[3].textContent.trim()]);
        }
      });
      downloadCSV('gastos_ingredientes.csv', rows);
    });
    // Exportar PDF de compras (historial en periodo actual del dashboard de reportes)
    document.addEventListener('click', async (e)=>{
      const btn = e.target.closest && e.target.closest('#compras-export-pdf');
      if(!btn) return;
    // Merma: agregar desde bot√≥n en insumos
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest && e.target.closest('#btn-add-merma');
      if(!btn) return;
      // Modal para agregar merma
      const opts = (appState.ingredientes||[]).map(i=> ({ label: i.nombre, value: i.id }));
      openFormModal({
        title: 'Registrar merma',
        fields: [
          { name:'ingredienteId', label:'Ingrediente', type:'combobox', options:opts, placeholder:'Buscar o escribir nombre...' },
          { name:'cantidad', label:'Cantidad', type:'number', min:0.01, step:'0.01', placeholder:'Ej. 1.5' },
          { name:'motivo', label:'Motivo (opcional)', type:'text' }
        ],
        submitText:'Guardar',
        onSubmit: (data)=>{
          const ingId = data.ingredienteId;
          const qty = Math.max(0.01, Number(data.cantidad||0));
          if(!ingId || qty<=0){ alert('Selecciona ingrediente y cantidad > 0'); return false; }
          appState.insumosConsumo.merma = appState.insumosConsumo.merma || [];
          appState.insumosConsumo.merma.push({ id: generateId('merma'), ingredienteId: ingId, cantidad: qty, motivo: (data.motivo||'').trim(), fecha: new Date().toISOString() });
          // Sumar a totales consumidos
          appState.insumosConsumo.totales[ingId] = (appState.insumosConsumo.totales[ingId]||0) + qty;
          saveLS();
          renderInsumosView();
          updateDashboard?.();
        }
      });
    });
      try{
        const { jsPDF } = window.jspdf || {};
        if(!jsPDF){ alert('No se pudo cargar jsPDF'); return; }
        const generatedAt = new Date();
        const doc = new jsPDF({ unit:'pt', format:'a4' });
        const logo = await getCompanyLogo();
        const pageW = doc.internal.pageSize.getWidth();
        const pageH = doc.internal.pageSize.getHeight();
        const margin = 40;
        const sizeTitle = 18, sizeSub=11, sizeHeader=12, sizeBody=11, sizeSmall=8.5;
        const padX=8, padY=6, lineH=15;
        let y = margin;

        // Periodo: usa currentReportPeriod si est√° disponible; fallback 30d
        let start, end; try{ const r = currentReportPeriod(); start=r.start; end=r.end; }catch(_){ start=new Date(Date.now()-30*86400000); end=new Date(); }
        // Dataset: compras no canceladas en el periodo
        const compras = (appState.inventario?.compras||[]).filter(c=>{ if(c?.cancelada) return false; const d=new Date(c.fecha); return d>=start && d<=end; }).sort((a,b)=> new Date(a.fecha)-new Date(b.fecha));

        const sum = (arr,f)=> arr.reduce((s,x)=> s+(f?f(x):x),0);
        const fmtMoney = (n)=>{ try{ return (Number(n)||0).toLocaleString('es-MX',{style:'currency',currency:'MXN'}); }catch(_){ return `$${(Number(n)||0).toFixed(2)}`; } };

        // Brand band
        y = pdfDrawBrandBand(doc, logo, 'Gestia', 'Historial de Compras', { margin, bandH: 64, titleSize: sizeTitle, subSize: sizeSub });

        // KPIs
        const total = sum(compras, c=> Number(c.costo)||0);
        doc.setFont('helvetica','normal'); doc.setFontSize(sizeSub);
        doc.text(`Periodo: ${start.toLocaleDateString()} a ${end.toLocaleDateString()} ‚Ä¢ Moneda: MXN`, margin, y); y+= 12;
        doc.setFontSize(9.5);
        doc.text(`Generado: ${generatedAt.toLocaleString()}`, margin, y); y+= 12;

        // Header tabla (anchos relativos, ajustados al ancho disponible de la p√°gina)
        const cols = [
          { key:'fecha', header:'Fecha', w:88, align:'left' },
          { key:'ingrediente', header:'Ingrediente', w:190, align:'left' },
          { key:'upp', header:'Unid/Paquete', w:92, align:'right' },
          { key:'precioUnidad', header:'Precio/Unidad', w:102, align:'right' },
          { key:'piezas', header:'Piezas', w:64, align:'right' },
          { key:'unidades', header:'Unidades', w:74, align:'right' },
          { key:'costo', header:'Costo', w:80, align:'right' }
        ];
        // Escalar columnas para que quepan dentro de los m√°rgenes horizontales
        const baseTotalW = cols.reduce((s,c)=> s + c.w, 0);
        const availableW = Math.max(200, pageW - margin*2);
        const scale = baseTotalW > 0 ? (availableW / baseTotalW) : 1;
        cols.forEach(c=>{ c.w = c.w * scale; });
        const totalW = cols.reduce((s,c)=> s + c.w, 0);
        const header = ()=>{
          const top = y; pdfApplyTableHeaderStyle(doc); doc.rect(margin, top, totalW, lineH+padY*2,'FD');
          let x = margin; doc.setFont('helvetica','bold'); doc.setFontSize(sizeHeader);
          cols.forEach(c=>{ let tx=x+padX; if(c.align==='right') tx=x+c.w-padX; else if(c.align==='center') tx=x+c.w/2; const a=c.align==='right'?{align:'right'}:c.align==='center'?{align:'center'}:{}; doc.text(c.header, tx, top+padY+lineH-3, a); x+=c.w; });
          y = top + lineH + padY*2 + 2; doc.setFont('helvetica','normal'); doc.setFontSize(sizeBody);
        };
        const ensure = (need)=>{ if(y + need > pageH - margin){ doc.addPage(); y=margin; drawWatermark(doc, logo); drawHeaderLogo(doc, logo); header(); } };

        header();
        compras.forEach((c, idx)=>{
          const ing = getIngredientById(c.ingredienteId);
          const upp = unitsPerPiece(ing);
          const precioUnidad = (()=>{ const pu = Number(c.precioUnidad||0); if(pu>0) return pu; const pp=Number(c.precioPaquete||0); return upp>0? pp/upp : 0; })();
          const unidades = Number(c.piezas||0) * upp;
          const row = {
            fecha: new Date(c.fecha).toLocaleDateString(),
            ingrediente: ing?.nombre || c.ingredienteId,
            upp: upp>0? `${upp} ${ing?.unidad||'unid'}`: '‚Äî',
            precioUnidad: precioUnidad>0? fmtMoney(precioUnidad) : '‚Äî',
            piezas: String(c.piezas||0),
            unidades: unidades>0? String(unidades.toFixed(0)) : '‚Äî',
            costo: fmtMoney(c.costo||0)
          };
          // wrap and draw
          const lines = cols.map(col=> doc.splitTextToSize(String(row[col.key]??''), Math.max(10, col.w - padX*2)));
          const maxL = Math.max(1, ...lines.map(a=> a.length));
          const h = maxL*lineH + padY*2; ensure(h+4);
          if(idx%2===1){ doc.setFillColor(255,253,248); doc.rect(margin, y, totalW, h, 'F'); }
          let x = margin;
          cols.forEach((col,i)=>{ const a=col.align==='right'?{align:'right'}:col.align==='center'?{align:'center'}:{}; let tx=x+padX; if(col.align==='right') tx = x+col.w-padX; else if(col.align==='center') tx = x+col.w/2; let ty=y+padY+lineH-3; lines[i].forEach(ln=>{ doc.text(String(ln), tx, ty, a); ty += lineH; }); x += col.w; });
          y += h;
        });

        // Totales
        ensure(40); doc.setDrawColor(220); doc.line(margin, y+4, pageW - margin, y+4); y += 16; doc.setFont('helvetica','bold'); doc.setFontSize(sizeHeader);
        doc.text('Total periodo', margin, y); doc.setFont('courier','bold'); doc.text(fmtMoney(total), pageW - margin, y, { align:'right' }); y += 18;
        doc.setFont('helvetica','normal'); doc.setFontSize(sizeSmall); doc.setTextColor(110); doc.text('Notas: Compras registradas en el periodo seleccionado. Revisa m√≠nimos de compra y disponibilidad.', margin, y);

        pdfFinalizeDocument(doc, { brand:'Gestia', reportName:'Historial de compras', periodText:`${pdfIsoDate(start)} a ${pdfIsoDate(end)}`, generatedAt, margin });
        doc.save(pdfBuildFilename({ brand:'Gestia', report:'Compras_Historial', start, end }));
      }catch(err){ console.warn('compras pdf', err); alert('No se pudo generar el PDF de compras.'); }
    });
  function exportSummaryCSV(){
      const ventas = getFilteredVentas();
      const sum = (arr,f)=> arr.reduce((s,x)=> s + (f?f(x):x), 0);
      const revenue = sum(ventas, v=> v.total||0);
      const orders = ventas.length;
      const items = sum(ventas, v=> sum(v.items||[], it=> it.cantidad||0));
      const aov = orders>0 ? revenue/orders : 0;
      const estCost = sum(ventas, v=> sum(v.items||[], it=>{
        const prod = appState.productos.find(p=>p.id===it.productoId);
        const cost = (prod && typeof prod.costo==='number') ? prod.costo : computeRecipeCost(prod?.receta||[]);
        return (cost || 0) * (it.cantidad||0);
      }));
      const gp = Math.max(0, revenue - estCost);
      const rows = [
        ['M√©trica','Valor'],
        ['Ingresos', fmtNum(revenue)],
        ['√ìrdenes', orders],
        ['Items', items],
        ['Ticket promedio', fmtNum(aov)],
        ['Margen bruto (est.)', fmtNum(gp)]
      ];
      downloadCSV('resumen.csv', rows);
    }

    // PDF general de reportes: ingresos, costos, productos, clientes y gastos por ingrediente
    async function exportDashboardPDF(){
      try{
        const ventas = getFilteredVentas();
        const { start, end } = currentReportPeriod();
        const { jsPDF } = window.jspdf || {};
        if(!jsPDF){ alert('No se pudo cargar jsPDF'); return; }
        const generatedAt = new Date();
        const doc = new jsPDF({ unit:'pt', format:'a4' });
        const logo = await getCompanyLogo();
        const pageW = doc.internal.pageSize.getWidth();
        const pageH = doc.internal.pageSize.getHeight();
        const margin = 40;
        const sizeTitle = 18, sizeSub=11, sizeHeader=11, sizeBody=9, sizeSmall=8;
        let y = margin;

        const sum = (arr,f)=> arr.reduce((s,x)=> s + (f?f(x):x), 0);

        // M√©tricas base
        const revenue = sum(ventas, v=> v.total||0);
        const orders = ventas.length;
        const itemsTotal = sum(ventas, v=> sum(v.items||[], it=> it.cantidad||0));
        const aov = orders>0? revenue/orders : 0;
        const estCost = sum(ventas, v=> sum(v.items||[], it=>{
          const prod = appState.productos.find(p=>p.id===it.productoId);
          const cost = (prod && typeof prod.costo==='number') ? prod.costo : computeRecipeCost(prod?.receta||[]);
          return (cost||0) * (it.cantidad||0);
        }));
        const gp = Math.max(0, revenue - estCost);

        // Gastos por ingrediente en el periodo
        const compras = (appState.inventario?.compras||[]).filter(c=>{
          if(c?.cancelada) return false;
          const d = new Date(c.fecha);
          return d>=start && d<=end;
        });
        const byIng = {};
        compras.forEach(c=>{
          const ing = getIngredientById(c.ingredienteId);
          if(!byIng[c.ingredienteId]) byIng[c.ingredienteId] = { nombre: ing?.nombre || c.ingredienteId, gasto:0 };
          byIng[c.ingredienteId].gasto += Number(c.costo||0);
        });
        const ingRows = Object.values(byIng).sort((a,b)=> b.gasto-a.gasto).slice(0,10);
        const gastoTotalIng = sum(ingRows, r=> r.gasto||0);

        // Top productos vendidos
        const prodAgg = {};
        ventas.forEach(v=> (v.items||[]).forEach(it=>{
          const key = it.nombre;
          if(!prodAgg[key]) prodAgg[key] = { qty:0, rev:0 };
          prodAgg[key].qty += it.cantidad||0;
          prodAgg[key].rev += (it.precio||0) * (it.cantidad||0);
        }));
        const topProducts = Object.entries(prodAgg)
          .map(([name, t])=> ({ nombre:name, qty:t.qty, rev:t.rev }))
          .sort((a,b)=> b.qty-a.qty)
          .slice(0,10);

        // Top clientes por gasto
        const byClient = {};
        ventas.forEach(v=>{
          const id = v.clienteId || 'general';
          byClient[id] = (byClient[id]||0) + (v.total||0);
        });
        const topClients = Object.entries(byClient)
          .map(([id, total])=>{
            const cli = (appState.clientes||[]).find(c=>c.id===id);
            return { nombre: cli?.nombre || 'General', total };
          })
          .sort((a,b)=> b.total-a.total)
          .slice(0,10);

        const fmtMoney = (n)=>{ try{ return (Number(n)||0).toLocaleString('es-MX',{style:'currency',currency:'MXN'}); }catch(_){ return `$${(Number(n)||0).toFixed(2)}`; } };

        // Encabezado
        y = pdfDrawBrandBand(doc, logo, 'Gestia', 'Reporte general de desempe√±o', { margin, bandH: 60, titleSize: sizeTitle, subSize: sizeSub });

        // Resumen del periodo
        doc.setFont('helvetica','normal'); doc.setFontSize(sizeSub);
        doc.text(`Periodo: ${start.toLocaleDateString()} a ${end.toLocaleDateString()} ‚Ä¢ Ventas filtradas: ${orders}`, margin, y);
        y += 14;
        doc.setFontSize(9.5);
        doc.text(`Generado: ${generatedAt.toLocaleString()}`, margin, y);
        y += 18;

        // KPIs principales
        const kpis = [
          ['Ingresos', fmtMoney(revenue)],
          ['√ìrdenes', String(orders)],
          ['Items vendidos', String(itemsTotal)],
          ['Ticket promedio', fmtMoney(aov)],
          ['Costo estimado (COGS)', fmtMoney(estCost)],
          ['Ganancia bruta (est.)', fmtMoney(gp)],
          ['Gasto en ingredientes (Top 10)', fmtMoney(gastoTotalIng)]
        ];
        const colW = (pageW - margin*2) / 2;
        doc.setFontSize(sizeHeader); doc.setFont('helvetica','bold');
        doc.text('Resumen general', margin, y);
        y += 10; doc.setFont('helvetica','normal'); doc.setFontSize(sizeBody);
        let yK = y;
        kpis.forEach((row, idx)=>{
          const x = margin + (idx%2)*colW;
          const yy = yK + Math.floor(idx/2)*14;
          doc.text(`${row[0]}:`, x, yy);
          doc.setFont('courier','bold'); doc.text(row[1], x+150, yy); doc.setFont('helvetica','normal');
        });
        y += Math.ceil(kpis.length/2)*16 + 6;

        // Tabla: gastos por ingrediente (Top 5)
        const ensure = (need)=>{ if(y + need > pageH - margin){ doc.addPage(); y = margin; drawWatermark(doc, logo); drawHeaderLogo(doc, logo); } };
        ensure(80);
        doc.setFont('helvetica','bold'); doc.setFontSize(sizeHeader);
        doc.text('Gastos por ingrediente (Top 5)', margin, y);
        y += 8; doc.setFont('helvetica','normal'); doc.setFontSize(sizeBody);
        const head1 = ['Ingrediente','Gasto'];
        const col1W = [pageW*0.55, pageW*0.25];
        pdfApplyTableHeaderStyle(doc);
        doc.rect(margin, y, col1W[0]+col1W[1], 18,'FD');
        doc.text(head1[0], margin+6, y+12);
        doc.text(head1[1], margin+col1W[0]+col1W[1]-6, y+12, {align:'right'});
        y += 20;
        ingRows.slice(0,5).forEach((r,idx)=>{
          ensure(18);
          if(idx%2===1){ doc.setFillColor(255,253,250); doc.rect(margin, y-2, col1W[0]+col1W[1], 18,'F'); }
          doc.text(r.nombre, margin+6, y+10);
          doc.text(fmtMoney(r.gasto), margin+col1W[0]+col1W[1]-6, y+10, {align:'right'});
          y += 18;
        });

        // Tabla: top productos
        ensure(80);
        doc.setFont('helvetica','bold'); doc.setFontSize(sizeHeader);
        doc.text('Top productos vendidos', margin, y);
        y += 8; doc.setFont('helvetica','normal'); doc.setFontSize(sizeBody);
        const headProd = ['Producto','Cant.','Ingresos'];
        const prodW = [pageW*0.45, pageW*0.15, pageW*0.25];
        pdfApplyTableHeaderStyle(doc);
        doc.rect(margin, y, prodW[0]+prodW[1]+prodW[2], 18,'FD');
        doc.text(headProd[0], margin+6, y+12);
        doc.text(headProd[1], margin+prodW[0]+prodW[1]-6, y+12, {align:'right'});
        doc.text(headProd[2], margin+prodW[0]+prodW[1]+prodW[2]-6, y+12, {align:'right'});
        y += 20;
        topProducts.forEach((p,idx)=>{
          ensure(18);
          if(idx%2===1){ doc.setFillColor(255,253,250); doc.rect(margin, y-2, prodW[0]+prodW[1]+prodW[2], 18,'F'); }
          doc.text(p.nombre, margin+6, y+10);
          doc.text(String(p.qty), margin+prodW[0]+prodW[1]-6, y+10, {align:'right'});
          doc.text(fmtMoney(p.rev), margin+prodW[0]+prodW[1]+prodW[2]-6, y+10, {align:'right'});
          y += 18;
        });

        // Nueva p√°gina: Top clientes
        doc.addPage(); y = margin; drawWatermark(doc, logo); drawHeaderLogo(doc, logo);
        doc.setFont('helvetica','bold'); doc.setFontSize(sizeHeader);
        doc.text('Top clientes por gasto', margin, y);
        y += 8; doc.setFont('helvetica','normal'); doc.setFontSize(sizeBody);
        const headCli = ['Cliente','Gasto'];
        const cliW = [pageW*0.6, pageW*0.25];
        pdfApplyTableHeaderStyle(doc);
        doc.rect(margin, y, cliW[0]+cliW[1], 18,'FD');
        doc.text(headCli[0], margin+6, y+12);
        doc.text(headCli[1], margin+cliW[0]+cliW[1]-6, y+12, {align:'right'});
        y += 20;
        topClients.forEach((c,idx)=>{
          ensure(18);
          if(idx%2===1){ doc.setFillColor(255,253,250); doc.rect(margin, y-2, cliW[0]+cliW[1], 18,'F'); }
          doc.text(c.nombre, margin+6, y+10);
          doc.text(fmtMoney(c.total), margin+cliW[0]+cliW[1]-6, y+10, {align:'right'});
          y += 18;
        });

        // Notas finales
        y += 16;
        doc.setFontSize(sizeSmall); doc.setTextColor(120);
        doc.text('Este reporte resume las ventas filtradas en la vista de Reportes, incluyendo ingresos, costos estimados, gastos por ingrediente, productos m√°s vendidos y clientes clave.', margin, y);

        pdfFinalizeDocument(doc, { brand:'Gestia', reportName:'Reporte general', periodText:`${pdfIsoDate(start)} a ${pdfIsoDate(end)}`, generatedAt, margin });
        doc.save(pdfBuildFilename({ brand:'Gestia', report:'Reporte_General', start, end }));
      }catch(e){ console.warn('exportDashboardPDF', e); alert('No se pudo generar el PDF general.'); }
    }

    // Reportes: wiring de filtros, rango personalizado y exportaciones
    function setupReportFilters(){
      const periodSel = document.getElementById('rep-period-select');
      const typeSel = document.getElementById('rep-filter-type');
      const paySel = document.getElementById('rep-filter-pay');
      const startInp = document.getElementById('rep-date-start');
      const endInp = document.getElementById('rep-date-end');
      const customBox = document.getElementById('rep-custom-range');
      const toggleCustom = ()=>{
        if(!periodSel || !customBox) return;
        const show = periodSel.value==='custom';
        customBox.classList.toggle('hidden', !show);
      };
  const rerender = ()=>{ renderCharts(); };
  periodSel?.addEventListener('change', ()=>{ toggleCustom(); rerender(); });
  typeSel?.addEventListener('change', rerender);
  paySel?.addEventListener('change', rerender);
  startInp?.addEventListener('change', rerender);
  endInp?.addEventListener('change', rerender);
      // Export buttons
      document.getElementById('rep-export-sales')?.addEventListener('click', exportSalesCSV);
      document.getElementById('rep-export-products')?.addEventListener('click', exportProductsCSV);
      document.getElementById('rep-export-summary')?.addEventListener('click', exportSummaryCSV);
      document.getElementById('rep-export-dashboard-pdf')?.addEventListener('click', exportDashboardPDF);
      // Estado inicial
      toggleCustom();
    }

    function setupCajaFilters(){
      const periodSel = document.getElementById('caja-period-select');
      const customBox = document.getElementById('caja-custom-range');
      const toggleCustom = ()=>{
        if(!periodSel || !customBox) return;
        const show = periodSel.value==='custom';
        customBox.classList.toggle('hidden', !show);
      };
      const rerender = ()=>{ renderCaja(); };
      periodSel?.addEventListener('change', ()=>{ toggleCustom(); rerender(); });
      document.getElementById('caja-date-start')?.addEventListener('change', rerender);
      document.getElementById('caja-date-end')?.addEventListener('change', rerender);
      toggleCustom();
    }

    // Render global: tablas, dashboard, selects
    function renderAll(){
      // POS clientes
      const sel = document.getElementById('pos-customer-select');
      if(sel){
        sel.innerHTML = '';
        const optGen = document.createElement('option'); optGen.value=''; optGen.textContent='Cliente General'; sel.appendChild(optGen);
        appState.clientes.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.nombre; sel.appendChild(o); });
      }
      // Heur√≠stica de categor√≠as para productos sin categoria
      try{
        (appState.productos||[]).forEach(p=>{
          if(p.categoria) return;
          const n = (p.nombre||'').toLowerCase();
          if(n.includes('hamburguesa')) p.categoria='Hamburguesas';
          else if(n.includes('hot dog')||n.includes('hotdog')) p.categoria='Hotdogs';
          else if(n.includes('papa')||n.includes('aros')) p.categoria='Complementos';
          else if(n.includes('pastel')||n.includes('rebanada')||n.includes('chesscake')||n.includes('cheesecake')) p.categoria='Postres';
          else if(n.includes('coca')||n.includes('agua')||n.includes('refresco')||n.includes('bebida')) p.categoria='Bebidas';
        });
      }catch(_){ }
      updateDashboard();
      renderProductosFilterButtons();
      renderProductosTabla();
      renderProfitabilityCharts();
      renderEstacionesTabla();
      renderIngredientesTabla();
      renderClientesTabla();
      renderVentasTabla();
  renderInsumosView();
  renderFinanzas();
  renderCaja();
  renderRecomendaciones();
    }

    // ===== Recomendaci√≥n de Compras =====
    function getRangeFor(selectIdPrefix){
      const sel = document.getElementById(`${selectIdPrefix}-period-select`);
      let now = new Date();
      let start = new Date(now);
      const v = sel?.value || '30d';
      if(v==='today') start.setHours(0,0,0,0);
      else if(v==='30d') start.setDate(start.getDate()-30);
      else if(v==='month') start = new Date(now.getFullYear(), now.getMonth(), 1);
      else if(v==='all') start = new Date(0);
      else if(v==='custom'){
        const s = document.getElementById(`${selectIdPrefix}-date-start`)?.value;
        const e = document.getElementById(`${selectIdPrefix}-date-end`)?.value;
        start = s ? new Date(s+'T00:00:00') : new Date(0);
        now = e ? new Date(e+'T23:59:59') : new Date();
      } else { start.setDate(start.getDate()-7); }
      return { start, end: now };
    }
    function averageDailyConsumption(start, end){
      // Retorna Map ingId -> { nombre, unidad, avg }
      const msPerDay = 86400000;
      const days = Math.max(1, Math.ceil((end - start + 1)/msPerDay));
      const map = new Map();
      const hist = (appState.insumosConsumo?.historial||[]).filter(h=>{ const d=new Date(h.fecha); return d>=start && d<=end; });
      const merm = (appState.insumosConsumo?.merma||[]).filter(m=>{ const d=new Date(m.fecha); return d>=start && d<=end; });
      hist.forEach(h=>{
        (h.items||[]).forEach(i=>{
          const curr = map.get(i.ingredienteId) || { nombre:i.nombre, unidad:i.unidad, total:0 };
          curr.total += Number(i.cantidad)||0; map.set(i.ingredienteId, curr);
        });
      });
      merm.forEach(m=>{
        const ing = getIngredientById(m.ingredienteId);
        const curr = map.get(m.ingredienteId) || { nombre: ing?.nombre || m.ingredienteId, unidad: ing?.unidad||'', total:0 };
        curr.total += Number(m.cantidad)||0; map.set(m.ingredienteId, curr);
      });
      const out = new Map();
      map.forEach((v, k)=> out.set(k, { nombre: v.nombre, unidad: v.unidad, avg: (v.total||0)/days }));
      return out;
    }
    function currentAvailability(){
      // disponible = comprasNoCanceladas - (consumo + merma)
      const stock = computeStock();
      const totCons = appState.insumosConsumo?.totales||{};
      const merma = appState.insumosConsumo?.merma||[];
      const mermaBy = {}; merma.forEach(m=>{ mermaBy[m.ingredienteId] = (mermaBy[m.ingredienteId]||0) + Number(m.cantidad||0); });
      const map = new Map();
      (appState.ingredientes||[]).forEach(ing=>{
        const comprado = stock[ing.id]?.compradoUnidades||0;
        const consumido = Number(totCons[ing.id]||0) + Number(mermaBy[ing.id]||0);
        const disponible = Math.max(0, comprado - consumido);
        map.set(ing.id, { nombre: ing.nombre, unidad: ing.unidad||'', disponible });
      });
      return map;
    }
    function renderRecomendaciones(){
      const body = document.getElementById('rec-body');
      const empty = document.getElementById('rec-empty');
      if(!body) return;
      body.innerHTML=''; if(empty) empty.classList.add('hidden');
      const { start, end } = getRangeFor('rec');
      const avgMap = averageDailyConsumption(start, end);
      const availMap = currentAvailability();
      const horizon = Math.max(1, Number(document.getElementById('rec-horizon-days')?.value||3));
      const rows = [];
      // costos estimados por unidad
      const unitCost = (ing)=>{ const up=Number(ing?.unidadesPaquete)||0; const pp=Number(ing?.precioPaquete)||0; return up>0? pp/up : 0; };
      (appState.ingredientes||[]).forEach(ing=>{
        const avg = avgMap.get(ing.id)?.avg || 0;
        if(avg<=0) return; // sin consumo no recomendamos
        const disponible = availMap.get(ing.id)?.disponible || 0;
        const required = avg * horizon;
        const deficit = Math.max(0, required - disponible);
        if(deficit>0){
          const uc = unitCost(ing);
          const estCost = uc * deficit;
          rows.push({ ing, disponible, avg, required, deficit, cost: estCost });
        }
      });
      rows.sort((a,b)=> b.deficit - a.deficit);
      if(rows.length===0){ if(empty) empty.classList.remove('hidden'); return; }
    rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.className = 'ingredientes-table-row';
        const upp = unitsPerPiece(r.ing);
        const pkg = upp>1 ? Math.ceil(r.deficit / upp) : 0;
        const suggestion = upp>1 ? `${pkg} paquetes (~${(pkg*upp).toFixed(0)} ${r.ing.unidad||''})` : `${r.deficit.toFixed(2)} ${r.ing.unidad||''}`;
        tr.innerHTML = `
      <td class="p-2 text-center"><input type="checkbox" class="rec-select" data-id="${r.ing.id}"></td>
          <td class="p-2">${r.ing.nombre}</td>
          <td class="p-2">${r.ing.unidad||''}</td>
          <td class="p-2 text-right num">${r.disponible.toFixed(2)}</td>
          <td class="p-2 text-right num">${r.avg.toFixed(2)}</td>
          <td class="p-2 text-right num">${r.required.toFixed(2)}</td>
          <td class="p-2 text-right num">${r.deficit.toFixed(2)}</td>
          <td class="p-2 text-right num">${suggestion}</td>
          <td class="p-2 text-right num">${fmt(r.cost)}</td>
          <td class="p-2"><button class="px-2 py-1 rounded border text-xs md:text-sm btn-add-compra" data-id="${r.ing.id}">Agregar compra</button></td>`;
        body.appendChild(tr);
      });
    }
    // Wire filtros de recomendaciones
    (function setupRecomFilters(){
      const sel = document.getElementById('rec-period-select');
      const box = document.getElementById('rec-custom-range');
      const s = document.getElementById('rec-date-start');
      const e = document.getElementById('rec-date-end');
      const h = document.getElementById('rec-horizon-days');
      const toggle = ()=>{ if(!sel||!box) return; box.classList.toggle('hidden', sel.value!=='custom'); };
      const rerender = ()=> renderRecomendaciones();
      sel?.addEventListener('change', ()=>{ toggle(); rerender(); });
      s?.addEventListener('change', rerender);
      e?.addEventListener('change', rerender);
      h?.addEventListener('input', rerender);
      // Quick day buttons
      document.querySelectorAll('.rec-quick-days')?.forEach(b=>{
        b.addEventListener('click', ()=>{ const v = Number(b.getAttribute('data-days'))||1; const inp=document.getElementById('rec-horizon-days'); if(inp){ inp.value=String(v); } rerender(); });
      });
      // Select all
      const selAll = document.getElementById('rec-select-all');
      selAll?.addEventListener('change', ()=>{ document.querySelectorAll('#rec-body .rec-select').forEach((cb)=>{ cb.checked = selAll.checked; }); });
      // Export PDF
      document.getElementById('rec-export-pdf')?.addEventListener('click', exportRecPDF);
      document.getElementById('insumos-ventas-pdf')?.addEventListener('click', exportInsumosVentasPDF);
      toggle();
    })();

    function gatherRecRows(){
      const body = document.getElementById('rec-body'); if(!body) return [];
      const rows = [];
      body.querySelectorAll('tr').forEach(tr=>{
        const cb = tr.querySelector('.rec-select');
        if(!cb || !cb.checked) return;
        const tds = tr.querySelectorAll('td');
        // columns: [cb], nombre, unidad, disponible, avg, required, deficit, sugerencia, costo, acciones
        rows.push({
          nombre: tds[1]?.textContent.trim()||'',
          unidad: tds[2]?.textContent.trim()||'',
          disponible: tds[3]?.textContent.trim()||'',
          avg: tds[4]?.textContent.trim()||'',
          requerido: tds[5]?.textContent.trim()||'',
          deficit: tds[6]?.textContent.trim()||'',
          sugerencia: tds[7]?.textContent.trim()||'',
          costo: tds[8]?.textContent.trim()||''
        });
      });
      return rows;
    }
    async function exportRecPDF(){
      try{
        const { jsPDF } = window.jspdf || {};
        if(!jsPDF){ alert('No se pudo cargar jsPDF'); return; }
        const selRows = gatherRecRows();
        if(selRows.length===0){ alert('Selecciona al menos una sugerencia'); return; }
        const { start, end } = getRangeFor('rec');
        const horizonDays = Math.max(1, Number(document.getElementById('rec-horizon-days')?.value||3));
        const generatedAt = new Date();
        const doc = new jsPDF({ unit:'pt', format:'a4' });
        const logo = await getCompanyLogo();
        const pageW = doc.internal.pageSize.getWidth();
        const pageH = doc.internal.pageSize.getHeight();
        const margin = 40;
        // Typography scale for readability
        const sizeTitle = 18;     // band title
        const sizeSub = 11;       // band subtitle
        const sizeHeader = 12;    // table header
        const sizeBody = 11;      // table body
        const sizeKpiLabel = 9.5; // KPI label
        const sizeKpiValue = 13;  // KPI value
        const sizeSmall = 8.5;    // footer
        // Spacing
        const padX = 8;
        const padY = 6;
        const lineH = 15;
        let y = margin;

        // Helpers
        const num = (s)=> Number(String(s||'').replace(/[^0-9.,\-]/g,'').replace(',','.'))||0;
        const money = (n)=> {
          const v = Number(n)||0;
          try{ return v.toLocaleString('es-MX', { style:'currency', currency:'MXN', minimumFractionDigits:2, maximumFractionDigits:2 }); }
          catch(_){ return `$${v.toFixed(2)}`; }
        };

        // Preprocess rows: parse numeric cost/deficit and paquetes estimados
        const processed = selRows.map(r=>{
          const costNum = num(r.costo);
          const deficitNum = num(r.deficit);
          const dispNum = num(r.disponible);
          const avgNum = num(r.avg);
          const reqNum = num(r.requerido);
          const m = /^(\d+)/.exec(String(r.sugerencia||''));
          const paquetes = /paquete/.test(String(r.sugerencia||'').toLowerCase()) ? (m? Number(m[1])||0 : 0) : 0;
          // Normalize unit label to avoid wrapping
          const unitRaw = String(r.unidad||'').trim().toLowerCase();
          let unidad = r.unidad || '';
          if(unitRaw==='unidad' || unitRaw.startsWith('unid')) unidad = 'unid';
          if(unitRaw==='pieza' || unitRaw==='piezas') unidad = 'pz';
          return { ...r, unidad, costNum, deficitNum, dispNum, avgNum, reqNum, paquetes };
        }).sort((a,b)=> b.costNum - a.costNum); // ordenar por costo desc

        const totalCost = processed.reduce((s,r)=> s+r.costNum, 0);
        const totalPaquetes = processed.reduce((s,r)=> s+r.paquetes, 0);
        const totalUnidades = processed.reduce((s,r)=> s+r.deficitNum, 0);

      const theme = getPdfTheme();
      // Premium brand band (full width)
      y = pdfDrawBrandBand(doc, logo, 'Gestia', 'Recomendaci√≥n de Compras ‚Ä¢ Orden sugerida', { margin, bandH: 64, titleSize: sizeTitle, subSize: sizeSub });

        const cols = [
          // Redistributed for comfort (sum = 515)
          { key:'nombre',     header:'Ingrediente', w:127, align:'left' },
          { key:'unidad',     header:'Unidad',      w:42,  align:'center' },
          { key:'disponible', header:'Disp.',       w:44,  align:'right', num:true },
          { key:'avg',        header:'Prom/d√≠a',    w:54,  align:'right', num:true },
          { key:'requerido',  header:'Req(h)',      w:49,  align:'right', num:true },
          { key:'deficit',    header:'D√©ficit',     w:49,  align:'right', num:true },
          { key:'sugerencia', header:'Sugerencia',  w:90,  align:'left' },
          { key:'costo',      header:'Costo',       w:60,  align:'right', num:true }
        ];

        // Executive summary block
        (function summary(){
          doc.setFont('helvetica','normal'); doc.setFontSize(sizeKpiLabel);
          doc.setDrawColor(theme.border.r, theme.border.g, theme.border.b);
          doc.setFillColor(theme.surface2.r, theme.surface2.g, theme.surface2.b);
          const cardW = (cols.reduce((s,c)=> s+c.w, 0) - 12)/3; // 3 KPIs
          const cardH = 40;
          const x0 = margin; let xi = x0;
          const items = [
            { t:'Costo estimado', v: money(totalCost) },
            { t:'Horizonte', v: `${horizonDays} d√≠as` },
            { t:'Seleccionados', v: `${processed.length} √≠tems` }
          ];
          items.forEach((it)=>{
            doc.rect(xi, y, cardW, cardH, 'S');
            doc.setFont('helvetica','bold'); doc.text(it.t, xi+10, y+16);
            doc.setFont('helvetica','normal'); doc.setFontSize(sizeKpiValue); doc.text(it.v, xi+10, y+32);
            doc.setFontSize(sizeKpiLabel);
            xi += cardW + 6;
          });
          y += cardH + 10;
          doc.setFont('helvetica','normal'); doc.setFontSize(sizeSub);
          doc.text(`Periodo: ${start.toLocaleDateString()} a ${end.toLocaleDateString()} ‚Ä¢ Moneda: MXN`, margin, y);
          y += 12;
          doc.setFontSize(9.5);
          doc.text(`Generado: ${generatedAt.toLocaleString()}`, margin, y);
          y += 10;
        })();

        function header(){
          doc.setFont('helvetica','bold');
          doc.setFontSize(sizeHeader);
          // Table header band
          // table header background
          const tableTop = y;
          const totalW = cols.reduce((s,c)=> s+c.w, 0);
          doc.setFillColor(theme.surface2.r, theme.surface2.g, theme.surface2.b);
          doc.setDrawColor(theme.border.r, theme.border.g, theme.border.b);
          doc.rect(margin, tableTop, totalW, lineH + padY*2, 'FD');
          let x = margin;
          doc.setFont('helvetica','bold');
          cols.forEach(c=>{
            let tx = x + padX;
            if(c.align==='right'){ tx = x + c.w - padX; }
            else if(c.align==='center'){ tx = x + c.w/2; }
            const opts = c.align==='right'? { align:'right' } : (c.align==='center'? { align:'center' } : {});
            doc.text(c.header, tx, tableTop + padY + lineH - 3, opts);
            x += c.w;
          });
          y = tableTop + lineH + padY*2 + 2;
          doc.setFont('helvetica','normal'); doc.setFontSize(sizeBody);
        }

      function ensure(need){
          if(y + need > pageH - margin){
      doc.addPage(); y = margin; drawWatermark(doc, logo); drawHeaderLogo(doc, logo); header();
          }
        }

        function drawRow(row, idx){
          // compute wrapped lines per cell and row height
          const linesPerCol = cols.map(c=>{
            let raw = String(row[c.key] ?? '');
            if(c.num){
              // normalize numbers for PDF
              if(c.key==='costo') raw = money(row.costNum);
              else if(c.key==='disponible') raw = (row.dispNum||0).toFixed(2);
              else if(c.key==='avg') raw = (row.avgNum||0).toFixed(2);
              else if(c.key==='requerido') raw = (row.reqNum||0).toFixed(2);
              else if(c.key==='deficit') raw = (row.deficitNum||0).toFixed(2);
            }
            const maxW = c.w - padX*2;
            const wrapped = doc.splitTextToSize(raw, Math.max(10, maxW));
            return wrapped;
          });
          const maxLines = Math.max(1, ...linesPerCol.map(a=> a.length));
          const rowH = maxLines*lineH + padY*2;
          ensure(rowH + 4);
          // zebra background
          if(idx % 2 === 1){ doc.setFillColor(255, 253, 248); doc.rect(margin, y, cols.reduce((s,c)=> s+c.w, 0), rowH, 'F'); }
          // draw text cells
          let x = margin;
          cols.forEach((c, i)=>{
            const lines = linesPerCol[i];
            let tx = x + padX;
            if(c.align==='right'){ tx = x + c.w - padX; }
            else if(c.align==='center'){ tx = x + c.w/2; }
            const opts = c.align==='right'? { align:'right' } : (c.align==='center'? { align:'center' } : {});
            // vertical alignment: top padding then each line
            if(c.num){ doc.setFont('courier','normal'); doc.setFontSize(sizeBody); } else { doc.setFont('helvetica','normal'); doc.setFontSize(sizeBody); }
            let ty = y + padY + lineH - 3;
            lines.forEach((ln)=>{ doc.text(String(ln), tx, ty, opts); ty += lineH; });
            x += c.w;
          });
          y += rowH;
        }

        // Render document
        header();
        let sumCost = 0;
        processed.forEach((r, idx)=>{
          sumCost += r.costNum;
          // Quitar marcador especial en nombre (evita problemas de fuente)
          drawRow(r, idx);
        });

        // total footer
        ensure(40);
    doc.setDrawColor(220); doc.line(margin, y+4, pageW - margin, y+4); y += 16;
    doc.setFont('helvetica','bold'); doc.setFontSize(sizeHeader);
        doc.text('Total estimado', margin, y);
    doc.setFont('courier','bold'); doc.text(money(sumCost), pageW - margin, y, { align:'right' });
    y += 18;
  doc.setFont('helvetica','normal'); doc.setFontSize(sizeSmall); doc.setTextColor(110);
  doc.text('Notas: Los valores son estimaciones de consumo y costo. Ajusta seg√∫n disponibilidad real y m√≠nimos de compra.', margin, y);
  y += 18;
  // Signature lines
  ensure(80);
  const sigW = (pageW - margin*2 - 20)/2;
  doc.setDrawColor(180);
  doc.line(margin+10, y+30, margin+10+sigW, y+30);
  doc.line(margin+20+sigW, y+30, margin+20+sigW+sigW, y+30);
  doc.setFontSize(9); doc.setTextColor(80);
  doc.text('Autorizaci√≥n', margin+10 + sigW/2, y+44, { align:'center' });
  doc.text('Proveedor', margin+20+sigW + sigW/2, y+44, { align:'center' });
  doc.setTextColor(0);
        doc.setTextColor(0);

        pdfFinalizeDocument(doc, { brand:'Gestia', reportName:'Recomendaci√≥n de compras', periodText:`${pdfIsoDate(start)} a ${pdfIsoDate(end)}`, generatedAt, margin });
        doc.save(pdfBuildFilename({ brand:'Gestia', report:'Recomendacion_Compras', start, end, extra:`h${horizonDays}d` }));
      }catch(e){ console.warn('exportRecPDF', e); alert('No se pudo generar el PDF.'); }
    }

    // Exportar PDF de insumos gastados por venta (detalle de consumo)
    async function exportInsumosVentasPDF(){
      try{
        const { jsPDF } = window.jspdf || {};
        if(!jsPDF){ alert('No se pudo cargar jsPDF'); return; }
        const { start, end } = getRangeFor('ins');
        const generatedAt = new Date();
        const ventas = (appState.ventas||[])
          .filter(v=> !v.cancelada)
          .filter(v=>{ const d=new Date(v.fecha); return d>=start && d<=end; })
          .sort((a,b)=> new Date(a.fecha)-new Date(b.fecha));

        if(ventas.length===0){ alert('No hay ventas en el periodo seleccionado.'); return; }

        const doc = new jsPDF({ unit:'pt', format:'a4' });
        const logo = await getCompanyLogo();
        const pageW = doc.internal.pageSize.getWidth();
        const pageH = doc.internal.pageSize.getHeight();
        const margin = 40;
        let y = margin;

        const money = (n)=>{
          const v = Number(n)||0;
          try{ return v.toLocaleString('es-MX', { style:'currency', currency:'MXN', minimumFractionDigits:2, maximumFractionDigits:2 }); }
          catch(_){ return '$'+v.toFixed(2); }
        };
        const ensureSpace = (need)=>{
          if(y + need > pageH - margin){
            doc.addPage();
            y = margin;
            drawWatermark(doc, logo);
            drawHeaderLogo(doc, logo);
          }
        };
        const writeLine = (text, opts={})=>{
          const size=opts.size||10;
          doc.setFontSize(size);
          doc.setFont('helvetica', opts.bold?'bold':'normal');
          doc.text(String(text), margin, y);
          y += opts.leading || 14;
        };

        // Header
        y = pdfDrawBrandBand(doc, logo, 'Gestia', 'Insumos gastados por ventas', { margin, bandH: 60, titleSize: 14, subSize: 10 });
        writeLine(`Periodo: ${start.toLocaleDateString()} a ${end.toLocaleDateString()}`, { size:10, leading:16 });
        writeLine(`Generado: ${generatedAt.toLocaleString()}`, { size:9, leading:14 });
        y += 4;

        // Agregado de costo por venta usando estimateCOGSByIngredientFromVentas
        const cogsAgg = estimateCOGSByIngredientFromVentas(ventas);
        const totalCosto = cogsAgg.total || 0;
        const totalIngresos = ventas.reduce((s,v)=> s + (v.subtotal||0), 0);

        writeLine('Resumen de periodo', { size:12, leading:18, bold:true });
        ensureSpace(60);
        const kpiRows = [
          ['Ventas consideradas', ventas.length],
          ['Ingresos (sin env√≠o)', money(totalIngresos)],
          ['Costo estimado de insumos', money(totalCosto)],
          ['Margen bruto estimado', money(totalIngresos - totalCosto)]
        ];
        kpiRows.forEach(r=>{
          doc.setFontSize(9.5); doc.setFont('helvetica','bold'); doc.text(String(r[0]), margin, y);
          doc.setFontSize(11); doc.setFont('helvetica','normal'); doc.text(String(r[1]), margin+220, y);
          y += 15;
        });
        y += 6;

        // Tabla por venta: fecha, id, total, costo estimado (proporcional)
        writeLine('Detalle por venta', { size:12, leading:18, bold:true });
        ensureSpace(40);
        const headerY = y;
        doc.setFontSize(9);
        doc.setFont('helvetica','bold');
        doc.text('Fecha', margin, headerY);
        doc.text('Venta', margin+140, headerY);
        doc.text('Total', margin+230, headerY, { align:'right' });
        doc.text('Costo insumos (est.)', margin+360, headerY, { align:'right' });
        doc.text('Margen (est.)', margin+500, headerY, { align:'right' });
        y = headerY + 14;
        doc.setFont('helvetica','normal');

        // Para repartir el costo total entre ventas, aproximamos por proporci√≥n del subtotal
        const subtotalTotal = ventas.reduce((s,v)=> s + (v.subtotal||0), 0) || 1;
        ventas.forEach(v=>{
          ensureSpace(18);
          const fechaStr = new Date(v.fecha).toLocaleString();
          const label = (typeof v.saleNumber==='number' && v.saleNumber>0) ? `Venta${v.saleNumber}` : String(v.id).slice(0,8);
          const subtotal = Number(v.subtotal)||0;
          const costoEst = totalCosto * (subtotal / subtotalTotal);
          const margen = subtotal - costoEst;

          doc.setFontSize(9);
          doc.text(fechaStr, margin, y);
          doc.text(label, margin+140, y);
          doc.text(money(subtotal), margin+230, y, { align:'right' });
          doc.text(money(costoEst), margin+360, y, { align:'right' });
          doc.text(money(margen), margin+500, y, { align:'right' });
          y += 13;
        });

        pdfFinalizeDocument(doc, { brand:'Gestia', reportName:'Insumos gastados por ventas', periodText:`${pdfIsoDate(start)} a ${pdfIsoDate(end)}`, generatedAt, margin });
        doc.save(pdfBuildFilename({ brand:'Gestia', report:'Insumos_Gastados_Ventas', start, end }));
      }catch(err){
        console.error(err);
        alert('No se pudo generar el PDF de insumos.');
      }
    }

    // Exportar PDF de insumos gastados de una venta individual
    async function exportInsumosVentaDetallePDF(ventaId){
      try{
        const { jsPDF } = window.jspdf || {};
        if(!jsPDF){ alert('No se pudo cargar jsPDF'); return; }
        const generatedAt = new Date();

        const ventas = Array.isArray(appState.ventas)? appState.ventas : [];
        const venta = ventas.find(v=> v.id===ventaId);
        if(!venta){ alert('No se encontr√≥ la venta seleccionada.'); return; }

        const hist = Array.isArray(appState.insumosConsumo?.historial)? appState.insumosConsumo.historial : [];
        const relacionados = hist.filter(h=> h.ventaId===ventaId);
        if(relacionados.length===0){
          alert('No hay registro de insumos gastados para esta venta.');
          return;
        }

        // Agregar cantidades por ingrediente
        const agg = new Map(); // ingId -> { ingredienteId, nombre, unidad, cantidad }
        relacionados.forEach(h=>{
          (h.items||[]).forEach(i=>{
            const key = i.ingredienteId || i.nombre || 'sin-id';
            const curr = agg.get(key) || { ingredienteId: i.ingredienteId, nombre: i.nombre, unidad: i.unidad||'', cantidad:0 };
            curr.cantidad += Number(i.cantidad)||0;
            agg.set(key, curr);
          });
        });
        const filas = Array.from(agg.values());
        if(filas.length===0){
          alert('No hay detalle de insumos para esta venta.');
          return;
        }

        const doc = new jsPDF({ unit:'pt', format:'a4' });
        const logo = await getCompanyLogo();
        const pageW = doc.internal.pageSize.getWidth();
        const pageH = doc.internal.pageSize.getHeight();
        const margin = 40;
        let y = margin;

        const money = (n)=>{
          const v = Number(n)||0;
          try{ return v.toLocaleString('es-MX', { style:'currency', currency:'MXN', minimumFractionDigits:2, maximumFractionDigits:2 }); }
          catch(_){ return '$'+v.toFixed(2); }
        };
        const ensureSpace = (need)=>{
          if(y + need > pageH - margin){
            doc.addPage();
            y = margin;
            drawWatermark(doc, logo);
            drawHeaderLogo(doc, logo);
          }
        };

        y = pdfDrawBrandBand(doc, logo, 'Gestia', 'Insumos gastados por venta', { margin, bandH: 60, titleSize: 14, subSize: 10 });

        const fechaStr = new Date(venta.fecha).toLocaleString();
        const ventaDate = new Date(venta.fecha);
        const label = (typeof venta.saleNumber==='number' && venta.saleNumber>0)
          ? `Venta${venta.saleNumber}`
          : String(venta.id).slice(0,8);

        // Encabezado (contenido)
        doc.setFont('helvetica','bold');
        doc.setFontSize(12);
        doc.text('Detalle', margin, y);
        y += 18;

        doc.setFont('helvetica','normal');
        doc.setFontSize(10);
        doc.text(`Venta: ${label}`, margin, y); y += 14;
        doc.text(`Fecha: ${fechaStr}`, margin, y); y += 14;
        doc.setFontSize(9);
        doc.text(`Generado: ${generatedAt.toLocaleString()}`, margin, y); y += 14;
        doc.setFontSize(10);
        if(venta.subtotal!=null){
          doc.text(`Total venta: ${money(venta.subtotal)}`, margin, y);
          y += 16;
        }
        y += 4;

        // Art√≠culos vendidos (detalle de la venta)
        if(Array.isArray(venta.items) && venta.items.length){
          ensureSpace(30);
          doc.setFont('helvetica','bold');
          doc.setFontSize(11);
          doc.text('Art√≠culos vendidos', margin, y);
          y += 14;

          doc.setFont('helvetica','normal');
          doc.setFontSize(9.5);
          (venta.items||[]).forEach(it=>{
            ensureSpace(14);
            const qty = Number(it.cantidad)||0;
            const base = Number(it.precio)||0;
            const modsExtra = Array.isArray(it.modifiers)
              ? it.modifiers.reduce((acc,m)=> acc + (Number(m.price)||0), 0)
              : 0;
            const unit = base + modsExtra;
            const lineTotal = unit * (qty||1);
            const nombre = it.nombre || 'Producto';
            const lineLabel = `${qty||1} √ó ${nombre}`;

            doc.text(lineLabel, margin, y);
            if(!Number.isNaN(lineTotal)){
              doc.text(money(lineTotal), margin+300, y, { align:'right' });
            }
            y += 12;

            if(Array.isArray(it.modifiers) && it.modifiers.length){
              const modsText = it.modifiers.map(m=>{
                const baseName = m.name || '';
                const p = Number(m.price)||0;
                return p ? `${baseName} (+${money(p)})` : baseName;
              }).join(', ');
              if(modsText){
                ensureSpace(12);
                doc.setFontSize(8.5);
                doc.text(`Modificadores: ${modsText}`, margin+14, y);
                doc.setFontSize(9.5);
                y += 11;
              }
            }
          });
          y += 6;
        }

        // Tabla de ingredientes
        ensureSpace(40);
        doc.setFont('helvetica','bold');
        doc.setFontSize(10);
        doc.text('Ingrediente', margin, y);
        doc.text('Unidad', margin+220, y);
        doc.text('Cantidad', margin+300, y, { align:'right' });
        doc.text('Costo unitario', margin+400, y, { align:'right' });
        doc.text('Costo total', margin+520, y, { align:'right' });
        y += 12;

        doc.setFont('helvetica','normal');
        let totalCosto = 0;
        filas.forEach(row=>{
          ensureSpace(16);
          const ing = getIngredientById(row.ingredienteId);
          const unitCost = getUnitCost(ing);
          const qty = Number(row.cantidad)||0;
          const lineCost = unitCost * qty;
          totalCosto += lineCost;

          const nombre = row.nombre || ing?.nombre || row.ingredienteId || '‚Äî';
          const unidad = row.unidad || ing?.unidad || '';

          doc.text(String(nombre), margin, y);
          doc.text(String(unidad), margin+220, y);
          doc.text(qty.toLocaleString(), margin+300, y, { align:'right' });
          doc.text(money(unitCost), margin+400, y, { align:'right' });
          doc.text(money(lineCost), margin+520, y, { align:'right' });
          y += 13;
        });

        y += 10;
        ensureSpace(30);
        doc.setFont('helvetica','bold');
        doc.setFontSize(11);
        doc.text(`Costo total estimado de insumos: ${money(totalCosto)}`, margin, y);
        y += 16;
        if(venta.subtotal!=null){
          const margen = Number(venta.subtotal) - totalCosto;
          doc.setFont('helvetica','normal');
          doc.setFontSize(10);
          doc.text(`Ganancia bruta estimada (venta - costo insumos): ${money(margen)}`, margin, y);
        }

        pdfFinalizeDocument(doc, { brand:'Gestia', reportName:'Insumos de venta', periodText: pdfIsoDate(ventaDate) || '', generatedAt, margin });
        doc.save(pdfBuildFilename({ brand:'Gestia', report:'Insumos_Venta', start: ventaDate, end: ventaDate, extra: label }));
      }catch(err){
        console.error(err);
        alert('No se pudo generar el PDF de insumos de la venta.');
      }
    }

    // Filtros de Insumos: periodo y rango personalizado
    (function setupInsumosFilters(){
      const sel = document.getElementById('ins-period-select');
      const box = document.getElementById('ins-custom-range');
      const s = document.getElementById('ins-date-start');
      const e = document.getElementById('ins-date-end');
      const toggle = ()=>{ if(!sel||!box) return; box.classList.toggle('hidden', sel.value!=='custom'); };
      const rerender = ()=>{ renderInsumosView(); };
      sel?.addEventListener('change', ()=>{ toggle(); rerender(); });
      s?.addEventListener('change', rerender);
      e?.addEventListener('change', rerender);
      // inicial
      toggle();
    })();

    // Tabs de Insumos: Totales / Ventas / Mermas
    (function setupInsumosTabs(){
      const buttons = Array.from(document.querySelectorAll('.insumos-tab-btn'));
      const panels = Array.from(document.querySelectorAll('.insumos-tab-panel'));
      if(!buttons.length || !panels.length) return;

      const showPanel = (id)=>{
        panels.forEach(p=>{
          p.classList.toggle('active', p.id === id);
        });
      };

      buttons.forEach(btn=>{
        const target = btn.getAttribute('data-target');
        if(!target) return;
        btn.addEventListener('click', ()=>{
          buttons.forEach(b=> b.classList.remove('active'));
          btn.classList.add('active');
          showPanel(target);
        });
      });

      // Estado inicial: mostrar Totales consumidos
      const first = buttons[0];
      const initialId = first?.getAttribute('data-target') || 'ins-tab-totales';
      buttons.forEach(b=> b.classList.remove('active'));
      if(first) first.classList.add('active');
      showPanel(initialId);
    })();

    // Auth opcional
    async function initializeAuth(){
      try{
        // Esperar a que Firebase est√© listo (los <script type="module"> pueden tardar en m√≥viles/red lenta)
        let tries = 0;
        while((!window.auth || !window.firebaseModules || !window.firebaseModules.onAuthStateChanged) && tries < 80){
          await new Promise(r=>setTimeout(r,150));
          tries++;
        }
        if(!window.auth || !window.firebaseModules){
          console.warn('[Auth] Firebase a√∫n no est√° listo. Revisa que abras la URL correcta y la conexi√≥n.');
          return;
        }
        const { onAuthStateChanged } = window.firebaseModules;
        onAuthStateChanged(window.auth, (user)=>{
          const el = document.getElementById('user-id-display');
          const badge = document.getElementById('user-id-badge');
          const authControls = document.getElementById('auth-controls');
          const authStatus = document.getElementById('auth-status-card');
          const emailOut = document.getElementById('auth-status-email');
          const uidOut = document.getElementById('auth-status-uid');
          const nextUid = (user && !user.isAnonymous) ? user.uid : null;
          const userChanged = nextUid !== __activeUid;

          // Cortar listeners del usuario anterior (si cambia)
          if(userChanged){
            if(typeof unsubscribeProducts === 'function' && unsubscribeProducts){ try{ unsubscribeProducts(); }catch(_){ }
              unsubscribeProducts = null; }
            if(typeof unsubscribeIngredientes === 'function' && unsubscribeIngredientes){ try{ unsubscribeIngredientes(); }catch(_){ } unsubscribeIngredientes = null; }
            if(typeof unsubscribeClientes === 'function' && unsubscribeClientes){ try{ unsubscribeClientes(); }catch(_){ } unsubscribeClientes = null; }
            if(typeof unsubscribeVentas === 'function' && unsubscribeVentas){ try{ unsubscribeVentas(); }catch(_){ } unsubscribeVentas = null; }
            if(typeof unsubscribeCompras === 'function' && unsubscribeCompras){ try{ unsubscribeCompras(); }catch(_){ } unsubscribeCompras = null; }
            if(typeof unsubscribeInsumos === 'function' && unsubscribeInsumos){ try{ unsubscribeInsumos(); }catch(_){ } unsubscribeInsumos = null; }
            if(typeof unsubscribePedidos === 'function' && unsubscribePedidos){ try{ unsubscribePedidos(); }catch(_){ } unsubscribePedidos = null; }
            if(typeof unsubscribeMeta === 'function' && unsubscribeMeta){ try{ unsubscribeMeta(); }catch(_){ } unsubscribeMeta = null; }
            if(typeof unsubscribeEmpleados === 'function' && unsubscribeEmpleados){ try{ unsubscribeEmpleados(); }catch(_){ } unsubscribeEmpleados = null; }
            if(typeof unsubscribeServicios === 'function' && unsubscribeServicios){ try{ unsubscribeServicios(); }catch(_){ } unsubscribeServicios = null; }
            if(typeof unsubscribeUserExtras === 'function' && unsubscribeUserExtras){ try{ unsubscribeUserExtras(); }catch(_){ } unsubscribeUserExtras = null; }
          }

          // Sin sesi√≥n con correo => UI en blanco
          if(!nextUid){
            __activeUid = null;
            el && (el.textContent = 'Sin sesi√≥n');
            badge && (badge.textContent = 'UID: ‚Äî');
            authControls && authControls.classList.remove('hidden');
            authStatus && authStatus.classList.add('hidden');
            if(emailOut) emailOut.textContent = '';
            if(uidOut) uidOut.textContent = '';
            try{ resetAppState({ persist:false }); }catch(_){ }
            return;
          }

          // Usuario con correo
          __activeUid = nextUid;
          el && (el.textContent = user.uid);
          badge && (badge.textContent = 'UID: '+user.uid.slice(0,8));
          authControls && authControls.classList.add('hidden');
          authStatus && authStatus.classList.remove('hidden');
          if(emailOut) emailOut.textContent = user.email || '(sin correo)';
          if(uidOut) uidOut.textContent = user.uid.slice(0,10)+'‚Ä¶';

          // Cargar cache local de ESTE usuario y renderizar antes de Firestore
          if(userChanged){
            try{ resetAppState({ persist:false }); }catch(_){ }
            try{ loadLSForUid(nextUid); }catch(_){ }
            try{ sanitizeState(); }catch(_){ }
            try{ assignSaleNumbersIfMissing(); }catch(_){ }
            try{ recomputeInsumosFromVentas(); }catch(_){ }
            try{ renderAll(); renderPosProductList(); renderPedidosPendientes(); renderCaja(); renderFinanzas(); }catch(_){ }
            try{ renderEstacionesTabla(); }catch(_){ }
            try{ renderMesaSelector(); }catch(_){ }
          }

          // Activar sincronizaci√≥n Firestore por usuario
          if(typeof startFirestoreAllSync==='function') startFirestoreAllSync(); else startFirestoreProductSync?.();
        });
      }catch(e){ console.warn('Auth opcional no disponible', e); }
    }

    // Simple auth UI wiring (email/password). If user is anonymous, we link the account to preserve UID.
  function setupAuthUI(){
    const emailEl = document.getElementById('auth-email');
    const passEl = document.getElementById('auth-pass');
    const btnLogin = document.getElementById('btn-login');
    const btnSignup = document.getElementById('btn-signup');
    const btnResetPass = document.getElementById('btn-reset-pass');
    const btnLogout = document.getElementById('btn-logout');

    // Prefill email if already logged
    try{ const u = window.auth?.currentUser; if(u?.email && emailEl){ emailEl.value = u.email; } }catch(_){ }

    // Ensure modules eventually load
    let M = window.firebaseModules;
    if(!M || !M.createUserWithEmailAndPassword || !M.signInWithEmailAndPassword){
      console.warn('[Auth] Firebase modules no disponibles a√∫n. Esperando‚Ä¶');
      let tries = 0; const t = setInterval(()=>{
        tries++;
        M = window.firebaseModules;
        if(M && M.createUserWithEmailAndPassword && M.signInWithEmailAndPassword){
          clearInterval(t);
        }
        if(tries>60) clearInterval(t);
      }, 200);
    }

    btnLogin?.addEventListener('click', async ()=>{
      try{
        const M = window.firebaseModules || {};
        if(!M.signInWithEmailAndPassword){
          alert('Firebase Auth no est√° cargado a√∫n. Recarga la p√°gina (Ctrl+F5) y aseg√∫rate de abrir la URL correcta.');
          return;
        }
        const email=(emailEl?.value||'').trim();
        const pass=(passEl?.value||'').trim();
        if(!email||!pass){ alert('Ingresa email y contrase√±a'); return; }
        await M.signInWithEmailAndPassword(window.auth, email, pass);
        alert('Sesi√≥n iniciada');
        try{ initializeAuth(); }catch(_){ }
      }catch(err){
        console.warn('login', err);
        const code = err?.code||'';
        if(code==='auth/operation-not-allowed' || code==='auth/unauthorized-domain'){
          alert(`Inicio de sesi√≥n deshabilitado o dominio no autorizado. En Firebase Console ‚Üí Authentication:
1) Sign-in method: habilita Email/Password
2) Settings ‚Üí Authorized domains: agrega "${location.hostname}"`);
        } else if(code==='auth/invalid-credential' || code==='auth/wrong-password'){
          alert('Credenciales inv√°lidas. Verifica email y contrase√±a.');
        } else if(code==='auth/user-not-found'){
          alert('Usuario no encontrado. Presiona "Crear cuenta" para registrarte (si est√°s an√≥nimo se vincular√° y conservar√°s tus datos).');
        } else if(code==='auth/network-request-failed'){
          alert('Fallo de red. Revisa tu conexi√≥n a Internet.');
        } else {
          alert('No se pudo iniciar sesi√≥n ('+code+'): '+(err?.message||''));
        }
      }
    });

    btnSignup?.addEventListener('click', async ()=>{
      try{
        const M = window.firebaseModules || {};
        if(!M.createUserWithEmailAndPassword){
          alert('Firebase Auth no est√° cargado a√∫n. Recarga la p√°gina (Ctrl+F5) y aseg√∫rate de abrir la URL correcta.');
          return;
        }
        const email=(emailEl?.value||'').trim();
        const pass=(passEl?.value||'').trim();
        if(!email||!pass){ alert('Ingresa email y contrase√±a'); return; }
        const user = window.auth.currentUser;
        let newUserCredential;
        if(user && user.isAnonymous && M?.EmailAuthProvider && M?.linkWithCredential){
          const cred = M.EmailAuthProvider.credential(email, pass);
          newUserCredential = await M.linkWithCredential(user, cred);
        } else {
          newUserCredential = await M.createUserWithEmailAndPassword(window.auth, email, pass);
        }
        try{
          const targetUser = newUserCredential?.user || window.auth.currentUser;
          if(targetUser && M.sendEmailVerification){
            await M.sendEmailVerification(targetUser);
            alert('Cuenta creada. Te enviamos un correo de verificaci√≥n. Revisa tu bandeja de entrada o spam.');
          } else {
            alert('Cuenta creada. Tus datos quedar√°n asociados a esta cuenta.');
          }
        }catch(_){
          alert('Cuenta creada. Tus datos quedar√°n asociados a esta cuenta.');
        }
        try{ initializeAuth(); }catch(_){ }
      }catch(err){
        console.warn('signup', err);
        const code = err?.code||'';
        if(code==='auth/operation-not-allowed' || code==='auth/unauthorized-domain'){
          alert(`Proveedor deshabilitado o dominio no autorizado. En Firebase Console ‚Üí Authentication:
1) Sign-in method: habilita Email/Password
2) Settings ‚Üí Authorized domains: agrega "${location.hostname}"`);
        } else if(code==='auth/email-already-in-use'){
          alert('Ese email ya est√° en uso. Inicia sesi√≥n en lugar de registrarte.');
        } else if(code==='auth/weak-password'){
          alert('Contrase√±a d√©bil. Usa al menos 6 caracteres.');
        } else if(code==='auth/network-request-failed'){
          alert('Fallo de red. Revisa tu conexi√≥n a Internet.');
        } else {
          alert('No se pudo crear la cuenta ('+code+'): '+(err?.message||''));
        }
      }
    });

    btnResetPass?.addEventListener('click', async ()=>{
      try{
        const M = window.firebaseModules || {};
        if(!M.sendPasswordResetEmail){
          alert('Recuperaci√≥n de contrase√±a no est√° disponible a√∫n. Recarga la p√°gina (Ctrl+F5) y aseg√∫rate de abrir la URL correcta.');
          return;
        }
        const email = (emailEl?.value||'').trim();
        if(!email){
          alert('Ingresa tu email para enviarte el enlace de recuperaci√≥n.');
          return;
        }
        await M.sendPasswordResetEmail(window.auth, email);
        alert('Listo. Te enviamos un enlace de recuperaci√≥n a tu email (revisa spam).');
      }catch(err){
        console.warn('reset-pass', err);
        const code = err?.code||'';
        if(code==='auth/invalid-email'){
          alert('Email inv√°lido. Verifica que est√© bien escrito.');
        } else if(code==='auth/user-not-found'){
          alert('No existe una cuenta con ese email.');
        } else if(code==='auth/network-request-failed'){
          alert('Fallo de red. Revisa tu conexi√≥n a Internet.');
        } else if(code==='auth/operation-not-allowed' || code==='auth/unauthorized-domain'){
          alert(`Recuperaci√≥n deshabilitada o dominio no autorizado. En Firebase Console ‚Üí Authentication:
1) Sign-in method: habilita Email/Password
2) Settings ‚Üí Authorized domains: agrega "${location.hostname}"`);
        } else {
          alert('No se pudo enviar el correo de recuperaci√≥n ('+code+'): '+(err?.message||''));
        }
      }
    });

    btnLogout?.addEventListener('click', async ()=>{
      try{
        const M = window.firebaseModules || {};
        await (M.signOut? M.signOut(window.auth): Promise.resolve());
        // No borramos datos del usuario (est√°n en Firebase y cacheados por UID).
        // Solo dejamos la UI en blanco para el siguiente usuario.
        resetAppState({ persist:false });
        alert('Sesi√≥n cerrada');
        try{ initializeAuth(); }catch(_){ }
      }catch(err){ console.warn('logout', err); }
    });
  }

    // Datos demo
    function seedIfEmpty(){
      // Intencionalmente vac√≠o: ya no sembramos datos demo.
      // Las nuevas cuentas comienzan sin productos, ingredientes ni estaciones.
    }

    // Init
    document.addEventListener('DOMContentLoaded', ()=>{
      console.log('[INIT] DOMContentLoaded');
      // Failsafe: nunca dejar el loader pegado si algo truena en el init
      setTimeout(()=>{ try{ hideLoading(); }catch(_){ } }, 2500);
      try{
        // Importante: NO cargamos datos de negocio hasta que el usuario inicie sesi√≥n con correo.
        // Esto evita que el siguiente usuario vea los datos del anterior en el mismo dispositivo.
        sanitizeState();
        assignSaleNumbersIfMissing();
        console.log('[INIT] Post-loadLS', {
          productos: appState.productos?.length||0,
          ingredientes: appState.ingredientes?.length||0,
          clientes: appState.clientes?.length||0
        });
        seedIfEmpty();
        console.log('[INIT] Post-seed', {
          productos: appState.productos?.length||0,
          ingredientes: appState.ingredientes?.length||0,
          clientes: appState.clientes?.length||0
        });

      // Ya no importamos ingredientes/clientes ni productos demo autom√°ticamente.

      // Setup filtros de productos por clasificaci√≥n
      document.querySelectorAll('.productos-filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const filter = btn.getAttribute('data-filter');
          currentProductosFilter = filter;
          
          // Actualizar estilos de botones
          document.querySelectorAll('.productos-filter-btn').forEach(b => {
            b.classList.remove('active', 'border-blue-500', 'bg-blue-50', 'text-blue-700');
          });
          btn.classList.add('active', 'border-blue-500', 'bg-blue-50', 'text-blue-700');
          
          // Re-renderizar tabla
          renderProductosTabla();
          renderProfitabilityCharts();
        });
      });
      
      // Ya no forzamos productos demo de hamburguesas; el usuario define sus productos.
      setupSidebar();
      setupNavigation();
  // Dashboard period change
  document.getElementById('db-period-select')?.addEventListener('change', updateDashboard);
  document.getElementById('rep-period-select')?.addEventListener('change', renderCharts);
  setupReportFilters();
      setupCajaFilters();
      wirePosInputs();
      setupCreateButtons();
      setupIngredientesActions();
      setupProductosActions();
      setupEstacionesActions();
      setupCategoriasActions();
  // Precalcular insumos desde ventas existentes (despu√©s de cargar/sembrar datos)
  recomputeInsumosFromVentas();
        renderAll();
        renderPosProductList();
        renderPedidosPendientes();
        renderCharts();
        renderFinanzas();
        initializeAuth();
        setupAuthUI();
  // Toggle del panel de inicio de sesi√≥n
        const authToggleBtn = document.getElementById('btn-auth-toggle');
        const authControls = document.getElementById('auth-controls');
        const authToggleIcon = document.getElementById('auth-toggle-icon');
        authToggleBtn?.addEventListener('click', ()=>{
          if(!authControls) return;
          const isHidden = authControls.classList.toggle('hidden');
          if(authToggleIcon){
            authToggleIcon.textContent = isHidden ? '‚ñº' : '‚ñ≤';
          }
        });
      // Botones hero de inicio
      const heroLogin = document.getElementById('btn-hero-login');
      const heroSignup = document.getElementById('btn-hero-signup');
      const heroGuide = document.getElementById('btn-hero-guide');
      const heroOverlay = document.getElementById('hero-auth-overlay');
      const heroTitle = document.getElementById('hero-auth-title');
      const heroSubtitle = document.getElementById('hero-auth-subtitle');
      const heroEmail = document.getElementById('hero-auth-email');
      const heroPass = document.getElementById('hero-auth-pass');
      const heroClose = document.getElementById('hero-auth-close');
      const heroModalLogin = document.getElementById('hero-modal-login');
      const heroModalSignup = document.getElementById('hero-modal-signup');

        function openAuthModal(mode){
	if(!heroOverlay) return;
	heroOverlay.classList.remove('hidden');
	if(mode==='signup'){
	  if(heroTitle) heroTitle.textContent = 'Crear cuenta en Gestia';
	  if(heroSubtitle) heroSubtitle.textContent = 'Registra una cuenta para sincronizar tu punto de venta.';
	} else {
	  if(heroTitle) heroTitle.textContent = 'Iniciar sesi√≥n en Gestia';
	  if(heroSubtitle) heroSubtitle.textContent = 'Usa tu correo y contrase√±a para continuar donde te quedaste.';
	}
	setTimeout(()=> heroEmail?.focus(), 10);
        }

        function closeAuthModal(){
	if(!heroOverlay) return;
	heroOverlay.classList.add('hidden');
        }

      heroLogin?.addEventListener('click', (e)=>{ e.preventDefault(); openAuthModal('login'); });
      heroSignup?.addEventListener('click', (e)=>{ e.preventDefault(); openAuthModal('signup'); });
      heroClose?.addEventListener('click', (e)=>{ e.preventDefault(); closeAuthModal(); });
      heroGuide?.addEventListener('click', (e)=>{ e.preventDefault(); try{ openGuideModal?.(); }catch(_){ } });

  // Enviar credenciales del modal al formulario lateral y reutilizar la l√≥gica existente de Firebase
        function syncAndTriggerAuth(mode){
	const email = (heroEmail?.value||'').trim();
	const pass = (heroPass?.value||'').trim();
	const emailEl = document.getElementById('auth-email');
	const passEl = document.getElementById('auth-pass');
	const btnLogin = document.getElementById('btn-login');
	const btnSignup = document.getElementById('btn-signup');
	if(emailEl) emailEl.value = email;
	if(passEl) passEl.value = pass;
	if(mode==='login') btnLogin?.click(); else btnSignup?.click();
	closeAuthModal();
        }

      heroModalLogin?.addEventListener('click', (e)=>{ e.preventDefault(); syncAndTriggerAuth('login'); });
      heroModalSignup?.addEventListener('click', (e)=>{ e.preventDefault(); syncAndTriggerAuth('signup'); });
  // La sincronizaci√≥n a Firestore inicia cuando hay sesi√≥n con correo (initializeAuth).
      // Show Firebase project info for quick diagnostics
      try{
        const ind = document.getElementById('firebase-project-indicator');
        if(ind && window.firebaseConfig){
          ind.textContent = `${window.firebaseConfig.projectId || '‚Äî'} ‚Ä¢ ${window.firebaseConfig.authDomain || ''}`;
        }
      }catch(_){ }
      // Wire backup/restore
      document.getElementById('btn-backup')?.addEventListener('click', backupData);
      document.getElementById('btn-restore')?.addEventListener('click', ()=> document.getElementById('restore-file-input')?.click());
      document.getElementById('restore-file-input')?.addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0]; if(!f) return; restoreDataFromFile(f); e.target.value = '';
      });

      // Theme toggle (dark mode)
      try{
        const THEME_KEY = 'gestia-theme';
        const themeBtn = document.getElementById('btn-theme-toggle');
        const themeFab = document.getElementById('btn-theme-fab');
        const themeFabIcon = document.getElementById('btn-theme-fab-icon');
        const getTheme = ()=> (localStorage.getItem(THEME_KEY) || '').toLowerCase();
        const setTheme = (t)=>{
          const theme = (t==='dark') ? 'dark' : 'light';
          document.documentElement.setAttribute('data-theme', theme);
          try{ localStorage.setItem(THEME_KEY, theme); }catch(_){ }
          const isDark = theme==='dark';
          if(themeBtn) themeBtn.textContent = isDark ? '‚òÄÔ∏è Modo claro' : 'üåô Modo oscuro';
          if(themeFabIcon) themeFabIcon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
          if(themeFab){
            themeFab.title = isDark ? 'Cambiar a modo claro' : 'Cambiar a modo oscuro';
            themeFab.setAttribute('aria-label', themeFab.title);
          }
        };
        const initial = getTheme();
        setTheme(initial==='dark' ? 'dark' : 'light');
        const toggle = ()=>{
          const current = (document.documentElement.getAttribute('data-theme')||'light').toLowerCase();
          setTheme(current==='dark' ? 'light' : 'dark');
        };
        themeBtn?.addEventListener('click', toggle);
        themeFab?.addEventListener('click', toggle);
      }catch(_){ }

      // Wire: bot√≥n para igualar compras con consumo (inventario)
      document.getElementById('inv-sync-consumo')?.addEventListener('click', syncInventarioComprasConConsumo);

      }catch(err){
        console.error('[INIT] Error durante el arranque', err);
        try{ alert('Ocurri√≥ un error al iniciar. Abre F12 ‚Üí Console para ver detalles.'); }catch(_){ }
      } finally {
        try{ hideLoading(); }catch(_){ }
      }
    });

    // Bootstrap global de navegaci√≥n (respaldo independiente)
    (function(){
      if(window.__navBootstrap) return; // evitar duplicado
      window.__navBootstrap = true;
      const go = ()=>{
        try{
	  const id = (location.hash||'#inicio').replace('#','');
          const exists = document.getElementById('view-'+id);
          if(exists){ showView(id); }
        }catch(e){ console.warn('nav bootstrap go', e); }
      };
      window.addEventListener('hashchange', go);
      document.addEventListener('click', (e)=>{
        const link = e.target.closest && e.target.closest('a.nav-link');
        if(!link) return;
        e.preventDefault();
        const id = (link.getAttribute('href')||'').replace('#','');
        if(id) showView(id);
      }, { capture:true });
      // inicial
      go();
    })();
  </script>
  <script>
    // ===== Backup / Restore =====
    function backupData(){
      try{
        const payload = {
          version: 1,
          exportedAt: new Date().toISOString(),
          origin: location.origin,
          uid: window.auth?.currentUser?.uid || null,
          appState
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type:'application/json' });
        const ts = new Date();
        const pad = (n)=> String(n).padStart(2,'0');
        const name = `sr-sra-burger-backup-${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}-${pad(ts.getHours())}${pad(ts.getMinutes())}${pad(ts.getSeconds())}.json`;
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = name;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }catch(e){ console.warn('backupData', e); alert('No se pudo generar el respaldo.'); }
    }

    function restoreDataFromFile(file){
      try{
        const reader = new FileReader();
        reader.onload = async ()=>{
          try{
            const json = JSON.parse(reader.result);
            const src = json.appState || json; // permitir archivo con o sin contenedor
            if(!src || typeof src !== 'object'){ alert('Archivo inv√°lido'); return; }
            if(!confirm('Esto reemplazar√° los datos locales (productos, ingredientes, clientes, ventas, etc.). ¬øContinuar?')) return;
            // Reemplazo expl√≠cito por claves conocidas
            const pickArr = (arr)=> Array.isArray(arr) ? arr : [];
            const pickObj = (obj, def)=> obj && typeof obj==='object' ? obj : (def||{});
            appState.productos = pickArr(src.productos);
            appState.ingredientes = pickArr(src.ingredientes);
            appState.clientes = pickArr(src.clientes);
            appState.ventas = pickArr(src.ventas);
            appState.pedidosPendientes = pickArr(src.pedidosPendientes);
            appState.insumosConsumo = pickObj(src.insumosConsumo, { totales:{}, historial:[], merma:[] });
            appState.inventario = pickObj(src.inventario, { compras:[] });
            appState.finanzas = pickObj(src.finanzas, { empleados:[], servicios:[], asignaciones:[], allocBase:'revenue', gastos:[] });
            appState.cajaTransferencias = pickArr(src.cajaTransferencias);
            appState.cajaPendientes = pickArr(src.cajaPendientes);
            appState.cajaIngresos = pickArr(src.cajaIngresos);
            appState.mesas = pickArr(src.mesas);
            appState.mesaOrders = pickObj(src.mesaOrders, {});
            appState.estaciones = pickArr(src.estaciones);
            appState.categorias = pickArr(src.categorias);
            appState.nextSaleNumber = Number(src.nextSaleNumber)||1;
            // Post import housekeeping
            try{ assignSaleNumbersIfMissing(); }catch(_){ }
            try{ recomputeInsumosFromVentas(); }catch(_){ }
            saveLS();
            renderAll(); renderPosProductList(); renderPedidosPendientes();
            try{ renderCaja(); }catch(_){ }
            try{ renderFinanzas(); }catch(_){ }
            try{ renderEstacionesTabla(); }catch(_){ }
            try{ renderMesaSelector(); }catch(_){ }
            // Subir productos a Firestore si est√° disponible
            if(Array.isArray(appState.productos) && typeof saveProductToFirestore==='function'){
              for(const p of appState.productos){ try{ await saveProductToFirestore(p); }catch(_){ } }
            }
            if(Array.isArray(appState.ingredientes) && typeof saveIngredientToFirestore==='function'){
              for(const i of appState.ingredientes){ try{ await saveIngredientToFirestore(i); }catch(_){ } }
            }
            if(Array.isArray(appState.clientes) && typeof saveClienteToFirestore==='function'){
              for(const c of appState.clientes){ try{ await saveClienteToFirestore(c); }catch(_){ } }
            }
            if(Array.isArray(appState.ventas) && typeof saveVentaToFirestore==='function'){
              for(const v of appState.ventas){ try{ await saveVentaToFirestore(v); }catch(_){ } }
            }
            // Subir ‚Äúextras‚Äù (caja/mesas/estaciones/categor√≠as/finanzas extras)
            try{ await saveUserExtrasToFirestore?.(); }catch(_){ }
            alert('‚úÖ Datos restaurados.');
          }catch(e){ console.warn('restore parse', e); alert('Archivo de respaldo inv√°lido.'); }
        };
        reader.onerror = ()=> alert('No se pudo leer el archivo.');
        reader.readAsText(file);
      }catch(e){ console.warn('restoreDataFromFile', e); alert('No se pudo restaurar.'); }
    }
  </script>
</body>
</html>
